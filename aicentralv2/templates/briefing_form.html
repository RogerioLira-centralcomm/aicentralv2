{% extends "base_tailwind.html" %}

{% block title %}{{ acao }} Briefing{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <!-- Header compacto -->
    <div class="flex items-center justify-between mb-2">
        <div class="flex items-center">
            <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost btn-sm mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
            </a>
            <h1 class="text-lg font-bold">{{ acao }} Briefing</h1>
        </div>
        {% if briefing %}
        <form method="post" action="{{ url_for('briefing_delete', briefing_id=briefing.id) }}" 
              onsubmit="return confirm('Deseja realmente excluir este briefing?');" class="inline">
            <button type="submit" class="btn btn-error btn-sm btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </button>
        </form>
        {% endif %}
    </div>

    <!-- Formulario -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-3">
            <form method="post" action="{{ url_for('briefing_create') if not briefing else url_for('briefing_edit', briefing_id=briefing.id) }}">
                
                <!-- Linha 1: Titulo, Status, Cliente, Contato, Resp, Projeto -->
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 mb-2">
                    <div class="form-control md:col-span-2">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Titulo *</span></label>
                        <input type="text" name="titulo" value="{{ briefing.titulo if briefing else '' }}" 
                               class="input input-bordered input-sm bg-white text-gray-900" required placeholder="Campanha...">
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Status</span></label>
                        <select name="status" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                            <option value="rascunho" {% if not briefing or briefing.status == 'rascunho' %}selected{% endif %}>Rascunho</option>
                            <option value="pendente" {% if briefing and briefing.status == 'pendente' %}selected{% endif %}>Pendente</option>
                            <option value="aceito" {% if briefing and briefing.status == 'aceito' %}selected{% endif %}>Aceito</option>
                            <option value="rejeitado" {% if briefing and briefing.status == 'rejeitado' %}selected{% endif %}>Rejeitado</option>
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Cliente *</span></label>
                        <div class="relative">
                            <input type="hidden" name="cliente_id" id="cliente_id" value="{{ briefing.id_cliente if briefing else '' }}" required>
                            <input type="text" id="cliente_busca" class="input input-bordered input-sm w-full bg-white text-gray-900" 
                                   placeholder="Buscar..." value="{% if briefing and briefing.cliente_nome %}{{ briefing.cliente_nome }}{% endif %}"
                                   autocomplete="off" oninput="buscarClientes(this.value)" onfocus="mostrarResultados()" required>
                            <div id="resultados_clientes" class="absolute z-50 w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-48 overflow-y-auto hidden border border-base-300"></div>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Contato</span></label>
                        <select name="id_contato_cliente" id="id_contato_cliente" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                            <option value="">Selecione...</option>
                            {% if briefing and briefing.id_contato_cliente %}
                                {% for contato in contatos_cliente %}
                                    {% if briefing.id_contato_cliente|string == contato.id_contato_cliente|string %}
                                        <option value="{{ contato.id_contato_cliente }}" selected>{{ contato.nome_completo }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Resp. CC</span></label>
                        <select name="responsavel_centralcomm" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                            <option value="">Selecione...</option>
                            {% for resp in responsaveis %}
                                <option value="{{ resp.id_contato_cliente }}" {% if briefing and (briefing.responsavel_centralcomm|string == resp.id_contato_cliente|string) %}selected{% endif %}>{{ resp.nome_completo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Linha 2: Projeto, Budget, Prazo, Plataforma -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-2">
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Projeto</span></label>
                        <select name="id_projeto" id="id_projeto" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                            <option value="">Selecione...</option>
                            {% if briefing and briefing.id_projeto %}
                                {% for projeto in projetos %}
                                    {% if briefing.id_projeto|string == projeto.id|string %}
                                        <option value="{{ projeto.id }}" selected>{{ projeto.nome }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Budget (R$)</span></label>
                        <input type="hidden" name="budget" id="budget_hidden" value="{{ briefing.budget if briefing and briefing.budget else '' }}">
                        <input type="text" id="budget_display" value="" class="input input-bordered input-sm bg-white text-gray-900" 
                               placeholder="0,00" oninput="formatarMoedaReal(this, 'budget_hidden')">
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Prazo</span></label>
                        <div class="join">
                            <button type="button" class="join-item btn btn-sm bg-base-200 px-2" onclick="document.getElementById('prazo_input').showPicker()">
                                <i class="fas fa-calendar-alt text-primary"></i>
                            </button>
                            <input type="date" name="prazo" id="prazo_input" value="{{ briefing.prazo.strftime('%Y-%m-%d') if briefing and briefing.prazo else '' }}" 
                                   class="input input-bordered input-sm join-item w-full">
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Plataforma</span></label>
                        <input type="text" name="plataforma" value="{{ briefing.plataforma if briefing else '' }}" 
                               class="input input-bordered input-sm bg-white text-gray-900" placeholder="Instagram, Facebook...">
                    </div>
                </div>

                <!-- Linha 3: Briefings e Objetivo lado a lado -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Briefing Original</span></label>
                        <textarea name="briefing_original" class="textarea textarea-bordered textarea-sm h-20 bg-white text-gray-900" 
                                  placeholder="Briefing original...">{{ briefing.briefing_original if briefing else '' }}</textarea>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Briefing Melhorado</span></label>
                        <textarea name="briefing_melhorado" class="textarea textarea-bordered textarea-sm h-20 bg-white text-gray-900" 
                                  placeholder="Briefing melhorado...">{{ briefing.briefing_melhorado if briefing else '' }}</textarea>
                    </div>
                    <div class="form-control">
                        <label class="label py-0"><span class="label-text text-xs font-semibold">Objetivo</span></label>
                        <textarea name="objetivo" class="textarea textarea-bordered textarea-sm h-20 bg-white text-gray-900" 
                                  placeholder="Objetivo principal...">{{ briefing.objetivo if briefing else '' }}</textarea>
                    </div>
                </div>

                <!-- Botoes -->
                <div class="flex justify-end gap-2 pt-2 border-t border-base-300">
                    <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost btn-sm">Cancelar</a>
                    <button type="submit" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informacoes de Auditoria -->
    {% if briefing and briefing.created_at %}
    <div class="bg-base-200 rounded-lg p-2 mt-2">
        <div class="flex flex-wrap gap-4 text-xs">
            <div><strong>Criado:</strong> {{ briefing.created_by_nome or 'N/A' }} em {{ briefing.created_at.strftime('%d/%m/%Y %H:%M') }}</div>
            {% if briefing.updated_at %}<div><strong>Atualizado:</strong> {{ briefing.updated_at.strftime('%d/%m/%Y %H:%M') }}</div>{% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
let timeoutId = null;
let currentIndex = -1;

function buscarClientes(termo) {
    clearTimeout(timeoutId);
    
    if (termo.length < 2) {
        document.getElementById('resultados_clientes').style.display = 'none';
        return;
    }
    
    timeoutId = setTimeout(() => {
        fetch('/api/clientes/buscar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nome: termo,
                razao: termo
            })
        })
        .then(response => response.json())
        .then(data => {
            renderizarResultados(data.clientes);
        })
        .catch(error => {
            console.error('Erro ao buscar clientes:', error);
        });
    }, 300);
}

function renderizarResultados(clientes) {
    const resultadosDiv = document.getElementById('resultados_clientes');
    
    if (clientes.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-2 text-xs text-gray-500">Nenhum cliente encontrado</div>';
        resultadosDiv.style.display = 'block';
        return;
    }
    
    resultadosDiv.innerHTML = clientes.map((cliente, index) => `
        <div class="p-2 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0 cliente-resultado" 
             data-index="${index}"
             data-id="${cliente.id_cliente}" 
             data-nome="${cliente.nome_fantasia}">
            <div class="font-semibold text-xs">${cliente.nome_fantasia}</div>
            <div class="text-xs text-gray-500">${cliente.razao_social || ''}</div>
        </div>
    `).join('');
    
    resultadosDiv.style.display = 'block';
    
    document.querySelectorAll('.cliente-resultado').forEach(elem => {
        elem.addEventListener('click', function() {
            const clienteId = this.getAttribute('data-id');
            const clienteNome = this.getAttribute('data-nome');
            
            document.getElementById('cliente_id').value = clienteId;
            document.getElementById('cliente_busca').value = clienteNome;
            resultadosDiv.style.display = 'none';
            
            // Carregar contatos e projetos do cliente selecionado
            carregarContatosCliente(clienteId);
            carregarProjetosCliente(clienteId);
        });
    });
}

function carregarContatosCliente(clienteId) {
    const selectContato = document.getElementById('id_contato_cliente');
    
    if (!clienteId) {
        selectContato.innerHTML = '<option value="">Selecione o cliente primeiro...</option>';
        return;
    }
    
    selectContato.innerHTML = '<option value="">Carregando...</option>';
    
    fetch(`/api/clientes/${clienteId}/contatos-briefing`)
        .then(response => response.json())
        .then(contatos => {
            if (contatos.length === 0) {
                selectContato.innerHTML = '<option value="">Nenhum contato encontrado</option>';
                return;
            }
            
            selectContato.innerHTML = '<option value="">Selecione...</option>' + 
                contatos.map(c => `<option value="${c.id_contato_cliente}">${c.nome_completo}</option>`).join('');
        })
        .catch(error => {
            console.error('Erro ao carregar contatos:', error);
            selectContato.innerHTML = '<option value="">Erro ao carregar contatos</option>';
        });
}

function carregarProjetosCliente(clienteId) {
    const selectProjeto = document.getElementById('id_projeto');
    
    if (!clienteId) {
        selectProjeto.innerHTML = '<option value="">Selecione o cliente primeiro...</option>';
        return;
    }
    
    selectProjeto.innerHTML = '<option value="">Carregando...</option>';
    
    fetch(`/api/clientes/${clienteId}/projetos`)
        .then(response => response.json())
        .then(projetos => {
            if (projetos.length === 0) {
                selectProjeto.innerHTML = '<option value="">Nenhum projeto encontrado</option>';
                return;
            }
            
            selectProjeto.innerHTML = '<option value="">Selecione...</option>' + 
                projetos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
        })
        .catch(error => {
            console.error('Erro ao carregar projetos:', error);
            selectProjeto.innerHTML = '<option value="">Erro ao carregar projetos</option>';
        });
}

function mostrarResultados() {
    const termo = document.getElementById('cliente_busca').value;
    if (termo.length >= 2) {
        document.getElementById('resultados_clientes').style.display = 'block';
    }
}

document.addEventListener('click', function(e) {
    const clienteInput = document.getElementById('cliente_busca');
    const resultados = document.getElementById('resultados_clientes');
    
    if (!clienteInput.contains(e.target) && !resultados.contains(e.target)) {
        resultados.style.display = 'none';
    }
});

document.getElementById('cliente_busca').addEventListener('keydown', function(e) {
    const items = document.querySelectorAll('.cliente-resultado');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentIndex = Math.min(currentIndex + 1, items.length - 1);
        if (items[currentIndex]) {
            items[currentIndex].click();
        }
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentIndex = Math.max(currentIndex - 1, -1);
        if (currentIndex >= 0 && items[currentIndex]) {
            items[currentIndex].click();
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        if (currentIndex >= 0 && items[currentIndex]) {
            items[currentIndex].click();
        }
    }
});

// Formatar moeda brasileira em tempo real
function formatarMoedaReal(input, hiddenFieldId) {
    let value = input.value.replace(/\D/g, '');
    
    if (value === '') {
        input.value = '';
        document.getElementById(hiddenFieldId).value = '';
        return;
    }
    
    // Converter para número com 2 casas decimais
    value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
    
    input.value = value;
    
    // Armazenar valor numérico no campo hidden para enviar ao backend
    const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
    document.getElementById(hiddenFieldId).value = valorNumerico;
}

// Ao carregar a página, formatar o budget se existir e carregar contatos se cliente já selecionado
document.addEventListener('DOMContentLoaded', function() {
    const budgetDisplay = document.getElementById('budget_display');
    const budgetHidden = document.getElementById('budget_hidden');
    if (budgetHidden.value && budgetHidden.value !== '') {
        const valor = parseFloat(budgetHidden.value);
        if (!isNaN(valor)) {
            budgetDisplay.value = valor.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }
    
    // Se já tem cliente selecionado (modo edição), carregar contatos e projetos
    const clienteId = document.getElementById('cliente_id').value;
    const contatoAtual = document.getElementById('id_contato_cliente').value;
    const projetoAtual = document.getElementById('id_projeto').value;
    
    if (clienteId) {
        // Carregar contatos
        fetch(`/api/clientes/${clienteId}/contatos-briefing`)
            .then(response => response.json())
            .then(contatos => {
                const selectContato = document.getElementById('id_contato_cliente');
                if (contatos.length === 0) {
                    selectContato.innerHTML = '<option value="">Nenhum contato encontrado</option>';
                    return;
                }
                
                selectContato.innerHTML = '<option value="">Selecione...</option>' + 
                    contatos.map(c => `<option value="${c.id_contato_cliente}" ${c.id_contato_cliente == contatoAtual ? 'selected' : ''}>${c.nome_completo}</option>`).join('');
            })
            .catch(error => {
                console.error('Erro ao carregar contatos:', error);
            });
        
        // Carregar projetos
        fetch(`/api/clientes/${clienteId}/projetos`)
            .then(response => response.json())
            .then(projetos => {
                const selectProjeto = document.getElementById('id_projeto');
                if (projetos.length === 0) {
                    selectProjeto.innerHTML = '<option value="">Nenhum projeto encontrado</option>';
                    return;
                }
                
                selectProjeto.innerHTML = '<option value="">Selecione...</option>' + 
                    projetos.map(p => `<option value="${p.id}" ${p.id == projetoAtual ? 'selected' : ''}>${p.nome}</option>`).join('');
            })
            .catch(error => {
                console.error('Erro ao carregar projetos:', error);
            });
    }
});
</script>
{% endblock %}
