{% extends "base_tailwind.html" %}

{% block title %}{{ acao }} Briefing{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center mb-6">
        <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost btn-sm mr-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
            </svg>
        </a>
        <h1 class="text-3xl font-bold">{{ acao }} Briefing</h1>
    </div>

    <!-- Formulário -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <form method="post" action="{{ url_for('briefing_create') if not briefing else url_for('briefing_edit', briefing_id=briefing.id) }}">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Título -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Título <span class="text-error">*</span></span>
                        </label>
                        <input type="text" name="titulo" 
                               value="{{ briefing.titulo if briefing else '' }}" 
                               class="input input-bordered" 
                               required
                               placeholder="Ex: Campanha Lançamento Produto X">
                    </div>

                    <!-- Cliente -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Cliente <span class="text-error">*</span></span>
                        </label>
                        <div class="relative">
                            <input type="hidden" name="cliente_id" id="cliente_id" value="{{ briefing.cliente if briefing else '' }}" required>
                            <input 
                                type="text" 
                                id="cliente_busca" 
                                class="input input-bordered w-full" 
                                placeholder="Digite para buscar cliente..."
                                value="{% if briefing %}{{ briefing.cliente }}{% endif %}"
                                autocomplete="off"
                                oninput="buscarClientes(this.value)"
                                onfocus="mostrarResultados()"
                                required
                            >
                            <div id="resultados_clientes" class="absolute z-50 w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
                        </div>
                    </div>

                    <!-- Objetivo -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Objetivo</span>
                        </label>
                        <textarea name="objetivo" 
                                  class="textarea textarea-bordered h-24" 
                                  placeholder="Descreva o objetivo principal da campanha">{{ briefing.objetivo if briefing else '' }}</textarea>
                    </div>

                    <!-- Público-Alvo -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Público-Alvo</span>
                        </label>
                        <textarea name="publico_alvo" 
                                  class="textarea textarea-bordered h-24" 
                                  placeholder="Descreva o público-alvo (idade, perfil, comportamento, etc.)">{{ briefing.publico_alvo if briefing else '' }}</textarea>
                    </div>

                    <!-- Mensagem-Chave -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Mensagem-Chave</span>
                        </label>
                        <textarea name="mensagem_chave" 
                                  class="textarea textarea-bordered h-24" 
                                  placeholder="Qual a mensagem principal que deve ser comunicada?">{{ briefing.mensagem_chave if briefing else '' }}</textarea>
                    </div>

                    <!-- Canais -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Canais</span>
                        </label>
                        <input type="text" name="canais" 
                               value="{{ briefing.canais if briefing else '' }}" 
                               class="input input-bordered" 
                               placeholder="Ex: Instagram, Facebook, Google Ads, Email Marketing">
                        <label class="label">
                            <span class="label-text-alt">Separe por vírgula os canais onde a campanha será veiculada</span>
                        </label>
                    </div>

                    <!-- Budget -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Budget (R$)</span>
                        </label>
                        <input type="number" name="budget" 
                               value="{{ briefing.budget if briefing else '' }}" 
                               step="0.01" 
                               class="input input-bordered" 
                               placeholder="0.00">
                    </div>

                    <!-- Prazo -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Prazo de Entrega</span>
                        </label>
                        <div class="relative">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('prazo_input').showPicker()">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <input type="date" name="prazo" id="prazo_input"
                                   value="{{ briefing.prazo.strftime('%Y-%m-%d') if briefing and briefing.prazo else '' }}" 
                                   class="input input-bordered pl-10 w-full">
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Status</span>
                        </label>
                        <select name="status" class="select select-bordered">
                            <option value="rascunho" 
                                    {% if not briefing or briefing.status == 'rascunho' %}selected{% endif %}>
                                Rascunho
                            </option>
                            <option value="pendente" 
                                    {% if briefing and briefing.status == 'pendente' %}selected{% endif %}>
                                Pendente
                            </option>
                            <option value="em_andamento" 
                                    {% if briefing and briefing.status == 'em_andamento' %}selected{% endif %}>
                                Em Andamento
                            </option>
                            <option value="em_revisao" 
                                    {% if briefing and briefing.status == 'em_revisao' %}selected{% endif %}>
                                Em Revisão
                            </option>
                            <option value="completo" 
                                    {% if briefing and briefing.status == 'completo' %}selected{% endif %}>
                                Completo
                            </option>
                            <option value="arquivado" 
                                    {% if briefing and briefing.status == 'arquivado' %}selected{% endif %}>
                                Arquivado
                            </option>
                        </select>
                    </div>

                    <!-- Observações -->
                    <div class="form-control md:col-span-2">
                        <label class="label">
                            <span class="label-text font-semibold">Observações</span>
                        </label>
                        <textarea name="observacoes" 
                                  class="textarea textarea-bordered h-32" 
                                  placeholder="Informações adicionais, referências, restrições, etc.">{{ briefing.observacoes if briefing else '' }}</textarea>
                    </div>
                </div>

                <!-- Botões -->
                <div class="card-actions justify-end mt-6">
                    <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost">Cancelar</a>
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informações de Auditoria -->
    {% if briefing and briefing.created_at %}
    <div class="card bg-base-200 shadow-xl mt-6">
        <div class="card-body">
            <h3 class="card-title text-sm">Informações de Auditoria</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <strong>Criado por:</strong> {{ briefing.created_by_nome or 'N/A' }}<br>
                    <strong>Em:</strong> {{ briefing.created_at.strftime('%d/%m/%Y %H:%M') if briefing.created_at else 'N/A' }}
                </div>
                {% if briefing.updated_at %}
                <div>
                    <strong>Última atualização:</strong> {{ briefing.updated_at.strftime('%d/%m/%Y %H:%M') }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
let timeoutId = null;
let currentIndex = -1;

function buscarClientes(termo) {
    clearTimeout(timeoutId);
    
    if (termo.length < 2) {
        document.getElementById('resultados_clientes').style.display = 'none';
        return;
    }
    
    timeoutId = setTimeout(() => {
        fetch('/api/clientes/buscar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                nome: termo,
                razao: termo
            })
        })
        .then(response => response.json())
        .then(data => {
            renderizarResultados(data.clientes);
        })
        .catch(error => {
            console.error('Erro ao buscar clientes:', error);
        });
    }, 300);
}

function renderizarResultados(clientes) {
    const resultadosDiv = document.getElementById('resultados_clientes');
    
    if (clientes.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">Nenhum cliente encontrado</div>';
        resultadosDiv.style.display = 'block';
        return;
    }
    
    resultadosDiv.innerHTML = clientes.map((cliente, index) => `
        <div class="p-2 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0 cliente-resultado" 
             data-index="${index}"
             onclick="selecionarCliente(${cliente.id_cliente}, '${cliente.nome_fantasia.replace(/'/g, "\\'")}')">
            <div class="font-medium">${cliente.nome_fantasia}</div>
            <div class="text-sm text-gray-500">${cliente.razao_social || ''}</div>
        </div>
    `).join('');
    
    resultadosDiv.style.display = 'block';
    currentIndex = -1;
}

function selecionarCliente(id, nome) {
    document.getElementById('cliente_id').value = id;
    document.getElementById('cliente_busca').value = nome;
    document.getElementById('resultados_clientes').style.display = 'none';
}

function mostrarResultados() {
    const resultadosDiv = document.getElementById('resultados_clientes');
    if (resultadosDiv.innerHTML.trim() !== '') {
        resultadosDiv.style.display = 'block';
    }
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(event) {
    const clienteBusca = document.getElementById('cliente_busca');
    const resultadosDiv = document.getElementById('resultados_clientes');
    
    if (clienteBusca && resultadosDiv) {
        if (!clienteBusca.contains(event.target) && !resultadosDiv.contains(event.target)) {
            resultadosDiv.style.display = 'none';
        }
    }
});

// Navegar com teclado
document.getElementById('cliente_busca').addEventListener('keydown', function(e) {
    const resultadosDiv = document.getElementById('resultados_clientes');
    const resultados = resultadosDiv.querySelectorAll('.cliente-resultado');
    
    if (resultados.length === 0) return;
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        currentIndex = (currentIndex + 1) % resultados.length;
        atualizarSelecao(resultados);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        currentIndex = currentIndex <= 0 ? resultados.length - 1 : currentIndex - 1;
        atualizarSelecao(resultados);
    } else if (e.key === 'Enter' && currentIndex >= 0) {
        e.preventDefault();
        resultados[currentIndex].click();
    } else if (e.key === 'Escape') {
        resultadosDiv.style.display = 'none';
        currentIndex = -1;
    }
});

function atualizarSelecao(resultados) {
    resultados.forEach((el, idx) => {
        if (idx === currentIndex) {
            el.classList.add('bg-base-200');
            el.scrollIntoView({ block: 'nearest' });
        } else {
            el.classList.remove('bg-base-200');
        }
    });
}

// Limpar cliente_id quando o usuário altera o texto
document.getElementById('cliente_busca').addEventListener('input', function() {
    document.getElementById('cliente_id').value = '';
});
</script>

{% endblock %}
