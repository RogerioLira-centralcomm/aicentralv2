{% extends "base_tailwind.html" %}

{% block title %}Gestão de Briefings{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
    <!-- Header Compacto (max 66px) - Estilo CRM -->
    <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
        <div class="flex items-center justify-between gap-4">
            <!-- Título -->
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-semibold text-gray-800">Briefings</h1>
                <span class="text-xs text-gray-400">Gerenciamento de briefings do CentralX</span>
            </div>
            
            <!-- Filtros Inline -->
            <form id="filtros_form" method="get" action="{{ url_for('briefing_list') }}" class="flex items-center gap-3">
                <!-- Status -->
                <select name="status" onchange="this.form.submit()"
                        class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 140px;">
                    <option value="">Todos</option>
                    <option value="rascunho" {% if filtros.status == 'rascunho' %}selected{% endif %}>Rascunho</option>
                    <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendente</option>
                    <option value="aceito" {% if filtros.status == 'aceito' %}selected{% endif %}>Aceito</option>
                    <option value="rejeitado" {% if filtros.status == 'rejeitado' %}selected{% endif %}>Rejeitado</option>
                </select>
                
                <!-- Cliente Autocomplete -->
                <div class="relative">
                    <input type="hidden" name="cliente_id" id="cliente_id_filtro" value="{{ filtros.cliente_id }}">
                    <input type="text" id="cliente_busca" 
                        class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" 
                        style="min-width: 180px;"
                        placeholder="Buscar cliente..."
                        value="{% if filtros.cliente_id and cliente_selecionado %}{{ cliente_selecionado.nome_fantasia }}{% endif %}"
                        autocomplete="off"
                        oninput="aoDigitarClienteFiltro(this.value)"
                        onfocus="mostrarResultadosFiltro()"
                    >
                    <div id="resultados_clientes_filtro" class="absolute z-50 w-full bg-white shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-gray-200"></div>
                </div>
                
                <!-- Responsável -->
                <select name="responsavel_id" onchange="this.form.submit()"
                        class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 160px;">
                    <option value="">Todos responsáveis</option>
                    <option value="sem_responsavel" {% if filtros.responsavel_id == 'sem_responsavel' %}selected{% endif %}>⚠️ Sem responsável</option>
                    {% for resp in responsaveis %}
                        <option value="{{ resp.id_contato_cliente }}" {% if filtros.responsavel_id == resp.id_contato_cliente|string %}selected{% endif %}>{{ resp.nome_completo }}</option>
                    {% endfor %}
                </select>
                
                <!-- Busca -->
                <input type="text" name="busca" value="{{ filtros.busca }}" 
                       placeholder="Buscar título..." 
                       class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400"
                       style="min-width: 150px;"
                       onkeydown="if(event.key==='Enter'){this.form.submit();}">
                
                <!-- Limpar -->
                {% if filtros.status or filtros.cliente_id or filtros.responsavel_id or filtros.busca %}
                <a href="{{ url_for('briefing_list') }}" class="text-gray-400 hover:text-gray-600 p-1.5" title="Limpar filtros">
                    <i class="fa-solid fa-xmark"></i>
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Lista de Briefings - Desktop -->
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden hidden lg:block">
        <table class="table w-full text-sm">
            <thead class="bg-gray-100">
                <tr>
                    <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Título</th>
                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-24">Status</th>
                    <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Cliente</th>
                    <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Responsável</th>
                    <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Plataforma</th>
                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-24">Prazo</th>
                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-24">Budget</th>
                    <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-16">Ações</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% if briefings %}
                    {% for briefing in briefings %}
                    <tr class="hover:bg-gray-50 {% if not briefing.responsavel_centralcomm %}bg-amber-50{% endif %}">
                        <td class="py-2 px-3">
                            <div class="flex items-center gap-2">
                                {% if not briefing.responsavel_centralcomm %}
                                <span class="text-amber-500" title="Sem responsável definido">
                                    <i class="fa-solid fa-triangle-exclamation text-xs"></i>
                                </span>
                                {% endif %}
                                <a href="javascript:void(0)" onclick="abrirModalBriefing({{ briefing.id }})" class="font-medium text-gray-800 hover:text-blue-600 hover:underline">{{ briefing.titulo }}</a>
                            </div>
                        </td>
                        <td class="py-2 px-3 text-center">
                            {% if briefing.status == 'rascunho' %}
                                <span class="badge badge-sm bg-slate-200 text-slate-700 border-0">Rascunho</span>
                            {% elif briefing.status == 'pendente' %}
                                <span class="badge badge-sm bg-amber-100 text-amber-700 border-0">Pendente</span>
                            {% elif briefing.status == 'aceito' %}
                                <span class="badge badge-sm bg-green-100 text-green-700 border-0">Aceito</span>
                            {% elif briefing.status == 'rejeitado' %}
                                <span class="badge badge-sm bg-red-100 text-red-700 border-0">Rejeitado</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-3 text-sm text-gray-600">{{ briefing.cliente_nome or '-' }}</td>
                        <td class="py-2 px-3 text-sm text-gray-600">
                            {% if briefing.responsavel_nome %}
                                {{ briefing.responsavel_nome }}
                            {% else %}
                                <span class="text-amber-600 font-medium">Não definido</span>
                            {% endif %}
                        </td>
                        <td class="py-2 px-3 text-sm text-gray-600">{{ briefing.plataforma or '-' }}</td>
                        <td class="py-2 px-3 text-sm text-gray-600 text-center">{{ briefing.prazo.strftime('%d/%m/%y') if briefing.prazo else '-' }}</td>
                        <td class="py-2 px-3 text-sm text-gray-600 text-center">{% if briefing.budget %}<span class="text-green-600 font-medium">R$ {{ "%.0f"|format(briefing.budget|float) }}</span>{% else %}-{% endif %}</td>
                        <td class="py-2 px-3 text-center">
                            <button onclick="abrirModalBriefing({{ briefing.id }})" 
                                    class="btn btn-xs btn-ghost text-gray-500 hover:text-gray-700 hover:bg-gray-50"
                                    title="Ver briefing">
                                <i class="fa-solid fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-12 text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fa-solid fa-file-lines text-5xl text-gray-300 mb-4"></i>
                                <p class="text-gray-500 text-sm">Nenhum briefing encontrado.</p>
                                <p class="text-gray-400 text-xs mt-1">Tente ajustar os filtros ou aguarde novos briefings.</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Lista de Briefings - Mobile -->
    <div class="lg:hidden space-y-2">
        {% if briefings %}
            {% for briefing in briefings %}
            <div class="bg-white border border-gray-200 rounded-lg p-3 {% if not briefing.responsavel_centralcomm %}border-l-4 border-l-amber-400{% endif %}">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        {% if not briefing.responsavel_centralcomm %}
                        <span class="text-amber-500"><i class="fa-solid fa-triangle-exclamation text-xs"></i></span>
                        {% endif %}
                        <span class="font-medium text-gray-800">{{ briefing.titulo }}</span>
                    </div>
                    {% if briefing.status == 'rascunho' %}
                        <span class="badge badge-xs bg-slate-200 text-slate-700 border-0">Rascunho</span>
                    {% elif briefing.status == 'pendente' %}
                        <span class="badge badge-xs bg-amber-100 text-amber-700 border-0">Pendente</span>
                    {% elif briefing.status == 'aceito' %}
                        <span class="badge badge-xs bg-green-100 text-green-700 border-0">Aceito</span>
                    {% elif briefing.status == 'rejeitado' %}
                        <span class="badge badge-xs bg-red-100 text-red-700 border-0">Rejeitado</span>
                    {% endif %}
                </div>
                <div class="grid grid-cols-2 gap-1 text-xs text-gray-600 mb-3">
                    <div><strong>Cliente:</strong> {{ briefing.cliente_nome or '-' }}</div>
                    <div><strong>Resp:</strong> {{ briefing.responsavel_nome or 'Não definido' }}</div>
                    <div><strong>Prazo:</strong> {{ briefing.prazo.strftime('%d/%m/%y') if briefing.prazo else '-' }}</div>
                    <div><strong>Budget:</strong> {% if briefing.budget %}R$ {{ "%.0f"|format(briefing.budget|float) }}{% else %}-{% endif %}</div>
                </div>
                <div class="flex justify-end">
                    <button onclick="abrirModalBriefing({{ briefing.id }})" class="btn btn-xs btn-ghost text-gray-600">
                        <i class="fa-solid fa-eye mr-1"></i> Ver
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-12 text-gray-500">
                <div class="flex flex-col items-center justify-center">
                    <i class="fa-solid fa-file-lines text-5xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500 text-sm">Nenhum briefing encontrado.</p>
                    <p class="text-gray-400 text-xs mt-1">Tente ajustar os filtros ou aguarde novos briefings.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Modal Briefing Detalhado -->
<dialog id="modal_briefing" class="modal">
    <div class="modal-box w-11/12 max-w-6xl p-0 overflow-hidden" style="height: 90vh;">
        <!-- Header do Modal -->
        <div class="bg-gray-800 text-white px-6 py-3 flex items-center justify-between">
            <div>
                <h3 id="modal_briefing_titulo" class="text-lg font-semibold">Briefing</h3>
                <p id="modal_briefing_cliente" class="text-sm text-gray-300"></p>
            </div>
            <div class="flex items-center gap-2">
                <span id="modal_briefing_status" class="badge"></span>
                <form method="dialog">
                    <button class="btn btn-sm btn-ghost text-white hover:bg-gray-700">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Conteúdo do Modal - 2 Colunas -->
        <div class="flex h-[calc(90vh-110px)]">
            <!-- Coluna Esquerda - Briefing Original (70%) -->
            <div class="w-[70%] p-4 border-r border-gray-200 flex flex-col">
                <label class="text-sm font-medium text-gray-700 mb-2">
                    <i class="fa-solid fa-file-lines mr-1"></i> Briefing Original
                </label>
                <textarea id="modal_briefing_conteudo" 
                    class="flex-1 w-full p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700 resize-none focus:outline-none"
                    readonly></textarea>
                
                <!-- Briefing Melhorado (se existir) -->
                <div id="briefing_melhorado_container" class="mt-3 hidden">
                    <label class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Briefing Melhorado (IA)
                        <span class="badge badge-xs bg-purple-100 text-purple-700">AI</span>
                    </label>
                    <textarea id="modal_briefing_melhorado" 
                        class="w-full h-32 p-3 bg-purple-50 border border-purple-200 rounded-lg text-sm text-gray-700 resize-none focus:outline-none"
                        readonly></textarea>
                </div>
            </div>
            
            <!-- Coluna Direita - Informações e Ações (30%) -->
            <div class="w-[30%] p-5 bg-gray-50 flex flex-col overflow-y-auto">
                <!-- Informações do Briefing -->
                <div class="space-y-3 flex-shrink-0">
                    <h4 class="text-sm font-semibold text-gray-700 border-b border-gray-200 pb-2">
                        <i class="fa-solid fa-info-circle mr-1"></i> Informações
                    </h4>
                    
                    <div class="bg-white rounded-lg p-3 border border-gray-200">
                        <div class="text-xs text-gray-500">Responsável CC</div>
                        <div id="modal_briefing_responsavel" class="text-sm font-medium text-gray-800">-</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-white rounded-lg p-2 border border-gray-200">
                            <div class="text-xs text-gray-500">Prazo</div>
                            <div id="modal_briefing_prazo" class="text-sm font-medium text-gray-800">-</div>
                        </div>
                        <div class="bg-white rounded-lg p-2 border border-gray-200">
                            <div class="text-xs text-gray-500">Budget</div>
                            <div id="modal_briefing_budget" class="text-sm font-medium text-gray-800">-</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-2 border border-gray-200">
                        <div class="text-xs text-gray-500">Plataforma</div>
                        <div id="modal_briefing_plataforma" class="text-sm font-medium text-gray-800">-</div>
                    </div>
                    
                    <div class="bg-white rounded-lg p-2 border border-gray-200">
                        <div class="text-xs text-gray-500">Objetivo</div>
                        <div id="modal_briefing_objetivo" class="text-sm text-gray-700 max-h-16 overflow-y-auto">-</div>
                    </div>
                </div>
                
                <!-- Ações -->
                <div class="mt-6 space-y-3 pt-4 border-t border-gray-200 flex-shrink-0">
                    <h4 class="text-sm font-semibold text-gray-700 pb-1">
                        <i class="fa-solid fa-bolt mr-1"></i> Ações
                    </h4>
                    
                    <button onclick="aceitarBriefing()" id="btn_aceitar_briefing"
                            class="btn w-full h-12 bg-green-600 hover:bg-green-700 text-white border-0 text-sm font-medium">
                        <i class="fa-solid fa-check mr-2"></i> Aceitar e Iniciar Cotação
                    </button>
                    
                    <button onclick="mostrarDevolucao()" id="btn_devolver_briefing"
                            class="btn w-full h-12 bg-gray-600 hover:bg-gray-700 text-white border-0 text-sm font-medium mb-4">
                        <i class="fa-solid fa-rotate-left mr-2"></i> Devolver ao Cliente
                    </button>
                    
                    <!-- Formulário de Devolução (hidden por padrão) -->
                    <div id="form_devolucao" class="hidden mt-3 p-3 bg-white border border-gray-200 rounded-lg">
                        <label class="text-xs text-gray-600 block mb-1">Motivo da devolução:</label>
                        <textarea id="motivo_devolucao" rows="3" 
                            class="w-full p-2 text-sm border border-gray-200 rounded focus:outline-none focus:border-gray-400"
                            placeholder="Ex: Informações insuficientes, não trabalhamos com este tipo de serviço..."></textarea>
                        <div class="flex gap-2 mt-2">
                            <button onclick="confirmarDevolucao()" class="btn btn-xs bg-red-500 hover:bg-red-600 text-white border-0">
                                Confirmar Devolução
                            </button>
                            <button onclick="cancelarDevolucao()" class="btn btn-xs btn-ghost">Cancelar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer do Modal -->
        <div class="bg-gray-100 px-6 py-2 border-t border-gray-200 flex justify-between items-center">
            <div class="text-xs text-gray-500">
                <span id="modal_briefing_criado_em"></span>
            </div>
            <form method="dialog">
                <button class="btn btn-sm btn-ghost text-gray-600">Fechar</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let timeoutBuscaCliente = null;
let clientesSugeridos = [];

function aoDigitarClienteFiltro(termo) {
  // Limpar o hidden se o campo de texto for modificado
  if (termo.length === 0) {
    document.getElementById('cliente_id_filtro').value = '';
  }
  
  buscarClientesFiltro(termo);
}

async function buscarClientesFiltro(termo) {
  clearTimeout(timeoutBuscaCliente);
  
  if (termo.length < 2) {
    document.getElementById('resultados_clientes_filtro').classList.add('hidden');
    return;
  }
  
  timeoutBuscaCliente = setTimeout(async () => {
    try {
      const response = await fetch('/api/clientes/buscar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: termo, razao: termo })
      });
      
      const data = await response.json();
      
      if (data.success && data.clientes.length > 0) {
        clientesSugeridos = data.clientes;
        renderizarResultadosFiltro();
      } else {
        document.getElementById('resultados_clientes_filtro').innerHTML = '<div class="p-3 text-sm text-base-content/50">Nenhum cliente encontrado</div>';
        document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Erro ao buscar clientes:', error);
    }
  }, 300);
}

function renderizarResultadosFiltro() {
  const container = document.getElementById('resultados_clientes_filtro');
  let html = '';
  
  clientesSugeridos.forEach(cliente => {
    const documento = cliente.cnpj || cliente.cpf || '-';
    const nomeEscapado = (cliente.nome_fantasia || cliente.razao_social).replace(/'/g, "\\'");
    html += `
      <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100" 
           onclick="selecionarClienteFiltro(${cliente.pk_id_tbl_cliente}, '${nomeEscapado}')">
        <div class="font-semibold text-sm text-gray-800">${cliente.nome_fantasia || cliente.razao_social}</div>
        <div class="text-xs text-gray-500">${documento}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.classList.remove('hidden');
}

function selecionarClienteFiltro(clienteId, nomeCliente) {
  document.getElementById('cliente_id_filtro').value = clienteId;
  document.getElementById('cliente_busca').value = nomeCliente;
  document.getElementById('resultados_clientes_filtro').classList.add('hidden');
  
  // Submeter formulário ao selecionar cliente
  document.getElementById('filtros_form').submit();
}

function mostrarResultadosFiltro() {
  if (clientesSugeridos.length > 0) {
    document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
  }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(event) {
  const busca = document.getElementById('cliente_busca');
  const resultados = document.getElementById('resultados_clientes_filtro');
  
  if (busca && resultados && !busca.contains(event.target) && !resultados.contains(event.target)) {
    resultados.classList.add('hidden');
  }
});

// ============================================
// MODAL BRIEFING FUNCTIONS
// ============================================

let briefingAtual = null;

async function abrirModalBriefing(briefingId) {
  try {
    // Buscar dados do briefing
    const response = await fetch(`/api/briefing/${briefingId}`);
    if (!response.ok) throw new Error('Erro ao buscar briefing');
    
    briefingAtual = await response.json();
    
    // Preencher modal
    document.getElementById('modal_briefing_titulo').textContent = briefingAtual.titulo || 'Sem título';
    document.getElementById('modal_briefing_cliente').textContent = briefingAtual.cliente_nome || '-';
    
    // Status badge
    const statusEl = document.getElementById('modal_briefing_status');
    const statusConfig = {
      'rascunho': { bg: 'bg-slate-200', text: 'text-slate-700', label: 'Rascunho' },
      'pendente': { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Pendente' },
      'aceito': { bg: 'bg-green-100', text: 'text-green-700', label: 'Aceito' },
      'rejeitado': { bg: 'bg-red-100', text: 'text-red-700', label: 'Rejeitado' }
    };
    const status = statusConfig[briefingAtual.status] || statusConfig['rascunho'];
    statusEl.className = `badge badge-sm ${status.bg} ${status.text} border-0`;
    statusEl.textContent = status.label;
    
    // Conteúdo do briefing
    document.getElementById('modal_briefing_conteudo').value = briefingAtual.briefing_original || 'Sem conteúdo de briefing.';
    
    // Briefing melhorado (se existir)
    const melhoradoContainer = document.getElementById('briefing_melhorado_container');
    if (briefingAtual.briefing_melhorado) {
      document.getElementById('modal_briefing_melhorado').value = briefingAtual.briefing_melhorado;
      melhoradoContainer.classList.remove('hidden');
    } else {
      melhoradoContainer.classList.add('hidden');
    }
    
    // Informações laterais
    document.getElementById('modal_briefing_responsavel').textContent = briefingAtual.responsavel_nome || 'Não definido';
    document.getElementById('modal_briefing_prazo').textContent = briefingAtual.prazo ? formatarData(briefingAtual.prazo) : '-';
    document.getElementById('modal_briefing_budget').textContent = briefingAtual.budget ? `R$ ${parseFloat(briefingAtual.budget).toLocaleString('pt-BR')}` : '-';
    document.getElementById('modal_briefing_plataforma').textContent = briefingAtual.plataforma || '-';
    document.getElementById('modal_briefing_objetivo').textContent = briefingAtual.objetivo || '-';
    
    // Data de criação
    document.getElementById('modal_briefing_criado_em').textContent = briefingAtual.created_at ? 
      `Criado em ${formatarDataHora(briefingAtual.created_at)}` : '';
    
    // Resetar formulário de devolução
    document.getElementById('form_devolucao').classList.add('hidden');
    document.getElementById('motivo_devolucao').value = '';
    
    // Mostrar/ocultar botões baseado no status
    const btnAceitar = document.getElementById('btn_aceitar_briefing');
    const btnDevolver = document.getElementById('btn_devolver_briefing');
    
    // Só mostrar botões de ação se o briefing estiver pendente
    if (briefingAtual.status === 'pendente') {
      btnAceitar.classList.remove('hidden');
      btnDevolver.classList.remove('hidden');
    } else {
      btnAceitar.classList.add('hidden');
      btnDevolver.classList.add('hidden');
    }
    
    // Abrir modal
    document.getElementById('modal_briefing').showModal();
    
  } catch (error) {
    console.error('Erro ao abrir briefing:', error);
    showToast('Erro ao carregar briefing.', 'error');
  }
}

function formatarData(dataStr) {
  if (!dataStr) return '-';
  const data = new Date(dataStr);
  return data.toLocaleDateString('pt-BR');
}

function formatarDataHora(dataStr) {
  if (!dataStr) return '-';
  const data = new Date(dataStr);
  return data.toLocaleDateString('pt-BR') + ' às ' + data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

async function aceitarBriefing() {
  if (!briefingAtual) return;
  
  if (!confirm('Deseja aceitar este briefing e iniciar uma nova cotação?')) return;
  
  try {
    const response = await fetch(`/api/briefing/${briefingAtual.id}/iniciar-cotacao`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Cotação criada com sucesso!', 'success');
      // Redirecionar para a cotação criada
      window.location.href = `/cotacoes/${data.cotacao_id}/editar`;
    } else {
      showToast(data.error || 'Erro ao criar cotação.', 'error');
    }
  } catch (error) {
    console.error('Erro ao aceitar briefing:', error);
    showToast('Erro ao processar solicitação.', 'error');
  }
}

function mostrarDevolucao() {
  document.getElementById('form_devolucao').classList.remove('hidden');
  document.getElementById('motivo_devolucao').focus();
}

function cancelarDevolucao() {
  document.getElementById('form_devolucao').classList.add('hidden');
  document.getElementById('motivo_devolucao').value = '';
}

async function confirmarDevolucao() {
  if (!briefingAtual) return;
  
  const motivo = document.getElementById('motivo_devolucao').value.trim();
  if (!motivo) {
    showToast('Por favor, informe o motivo da devolução.', 'warning');
    return;
  }
  
  try {
    const response = await fetch(`/api/briefing/${briefingAtual.id}/devolver`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ motivo: motivo })
    });
    
    const data = await response.json();
    
    if (data.success) {
      showToast('Briefing devolvido ao cliente.', 'success');
      document.getElementById('modal_briefing').close();
      // Recarregar a lista
      window.location.reload();
    } else {
      showToast(data.error || 'Erro ao devolver briefing.', 'error');
    }
  } catch (error) {
    console.error('Erro ao devolver briefing:', error);
    showToast('Erro ao processar solicitação.', 'error');
  }
}

// Toast notification helper
function showToast(message, type = 'info') {
  // Verificar se já existe um container de toast
  let toastContainer = document.getElementById('toast-container');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toast-container';
    toastContainer.className = 'fixed bottom-4 right-4 z-50 space-y-2';
    document.body.appendChild(toastContainer);
  }
  
  const bgColors = {
    'success': 'bg-green-500',
    'error': 'bg-red-500',
    'warning': 'bg-amber-500',
    'info': 'bg-blue-500'
  };
  
  const toast = document.createElement('div');
  toast.className = `${bgColors[type] || bgColors['info']} text-white px-4 py-2 rounded-lg shadow-lg text-sm animate-fade-in`;
  toast.textContent = message;
  
  toastContainer.appendChild(toast);
  
  // Remover após 3 segundos
  setTimeout(() => {
    toast.remove();
  }, 3000);
}
</script>

{% endblock %}
