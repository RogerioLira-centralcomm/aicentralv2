{% extends "base_tailwind.html" %}

{% block title %}Gestão de Briefings{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
        <h1 class="text-2xl font-bold text-base-content">Gestão de Briefings</h1>
        <a href="{{ url_for('briefing_create') }}" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            Novo Briefing
        </a>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-2 mb-4">
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Total</div>
                <div class="stat-value text-2xl text-black">{{ stats.total }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Rascunho</div>
                <div class="stat-value text-2xl text-black">{{ stats.rascunho }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Pendente</div>
                <div class="stat-value text-2xl text-black">{{ stats.pendente }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Em Andamento</div>
                <div class="stat-value text-2xl text-black">{{ stats.em_andamento }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Em Revisão</div>
                <div class="stat-value text-2xl text-black">{{ stats.em_revisao }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Completo</div>
                <div class="stat-value text-2xl text-black">{{ stats.completo }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-2 px-3">
                <div class="stat-title text-xs">Arquivado</div>
                <div class="stat-value text-2xl text-black">{{ stats.arquivado }}</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card bg-base-100 border border-base-300 mb-4">
        <div class="card-body p-4">
            <h2 class="card-title text-sm mb-3">Filtros</h2>
            <form method="get" action="{{ url_for('briefing_list') }}" class="grid grid-cols-1 md:grid-cols-4 gap-3">
                <!-- Status -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">Status</span>
                    </label>
                    <select name="status" class="select select-bordered select-sm bg-white text-gray-900 font-medium focus:outline-primary h-8 min-h-8 py-1">
                        <option value="">Todos</option>
                        <option value="rascunho" {% if filtros.status == 'rascunho' %}selected{% endif %}>Rascunho</option>
                        <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendente</option>
                        <option value="em_andamento" {% if filtros.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                        <option value="em_revisao" {% if filtros.status == 'em_revisao' %}selected{% endif %}>Em Revisão</option>
                        <option value="completo" {% if filtros.status == 'completo' %}selected{% endif %}>Completo</option>
                        <option value="arquivado" {% if filtros.status == 'arquivado' %}selected{% endif %}>Arquivado</option>
                    </select>
                </div>

                <!-- Cliente -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">Cliente</span>
                    </label>
                    <div class="relative">
                        <input type="hidden" name="cliente_id" id="cliente_id_filtro" value="{{ filtros.cliente_id }}">
                        <input 
                            type="text" 
                            id="cliente_busca" 
                            class="input input-bordered input-sm w-full h-8 min-h-8" 
                            placeholder="Digite para buscar ou deixe vazio..."
                            value="{% if filtros.cliente_id and cliente_selecionado %}{{ cliente_selecionado.nome_fantasia }}{% endif %}"
                            autocomplete="off"
                            oninput="aoDigitarClienteFiltro(this.value)"
                            onfocus="mostrarResultadosFiltro()"
                        >
                        <div id="resultados_clientes_filtro" class="absolute z-50 w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
                    </div>
                </div>

                <!-- Busca -->
                <div class="form-control">
                    <label class="label py-1">
                        <span class="label-text text-xs">Buscar</span>
                    </label>
                    <input type="text" name="busca" value="{{ filtros.busca }}" 
                           placeholder="Título, objetivo..." class="input input-bordered input-sm">
                </div>

                <!-- Botões -->
                <div class="form-control items-end">
                    <label class="label py-1">
                        <span class="label-text text-xs">&nbsp;</span>
                    </label>
                    <div class="flex gap-2">
                        <button type="submit" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">Filtrar</button>
                        <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost btn-sm">Limpar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Briefings - Desktop -->
    <div class="bg-base-100 rounded-xl overflow-hidden hidden lg:block">
        <table class="table table-zebra w-full text-sm">
            <thead style="background-color: #72cd80;" class="text-white">
                <tr class="text-xs">
                    <th class="w-1/3">Título</th>
                    <th class="w-1/6">Cliente</th>
                    <th class="w-24">Prazo</th>
                    <th class="w-28">Budget</th>
                    <th class="w-32">Status</th>
                    <th class="w-24">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% if briefings %}
                    {% for briefing in briefings %}
                    <tr>
                        <td class="py-2">
                            <div class="font-semibold text-sm">{{ briefing.titulo }}</div>
                            <div class="text-xs opacity-60 truncate max-w-xs">{{ briefing.objetivo }}</div>
                        </td>
                        <td class="py-2 text-xs">{{ briefing.cliente_nome or '-' }}</td>
                        <td class="py-2 text-xs">{{ briefing.prazo.strftime('%d/%m/%Y') if briefing.prazo else '-' }}</td>
                        <td class="py-2 text-xs">
                            {% if briefing.budget %}
                                R$ {{ "%.2f"|format(briefing.budget|float) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="py-2">
                            {% if briefing.status == 'rascunho' %}
                                <span class="badge badge-sm bg-slate-200 text-slate-700 border-0">Rascunho</span>
                            {% elif briefing.status == 'pendente' %}
                                <span class="badge badge-sm bg-amber-100 text-amber-700 border-0">Pendente</span>
                            {% elif briefing.status == 'em_andamento' %}
                                <span class="badge badge-sm bg-blue-100 text-blue-700 border-0">Em Andamento</span>
                            {% elif briefing.status == 'em_revisao' %}
                                <span class="badge badge-sm bg-purple-100 text-purple-700 border-0">Em Revisão</span>
                            {% elif briefing.status == 'completo' %}
                                <span class="badge badge-sm bg-green-100 text-green-700 border-0">Completo</span>
                            {% elif briefing.status == 'arquivado' %}
                                <span class="badge badge-sm bg-gray-100 text-gray-500 border-0">Arquivado</span>
                            {% endif %}
                        </td>
                        <td class="py-2">
                            <div class="flex gap-1">
                                <a href="{{ url_for('briefing_edit', briefing_id=briefing.id) }}" 
                                   class="btn btn-xs btn-ghost" title="Editar">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                    </svg>
                                </a>
                                <form method="post" action="{{ url_for('briefing_delete', briefing_id=briefing.id) }}" 
                                      onsubmit="return confirm('Deseja realmente excluir este briefing?');" class="inline">
                                    <button type="submit" class="btn btn-xs btn-ghost text-error" title="Excluir">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            Nenhum briefing encontrado.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Lista de Briefings - Mobile -->
    <div class="lg:hidden space-y-3">
        {% if briefings %}
            {% for briefing in briefings %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body p-4">
                    <h3 class="card-title text-base">{{ briefing.titulo }}</h3>
                    <div class="space-y-1 text-xs">
                        <div><strong>Cliente:</strong> {{ briefing.cliente_nome or '-' }}</div>
                        <div><strong>Prazo:</strong> {{ briefing.prazo.strftime('%d/%m/%Y') if briefing.prazo else '-' }}</div>
                        <div><strong>Budget:</strong> 
                            {% if briefing.budget %}
                                R$ {{ "%.2f"|format(briefing.budget|float) }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <div><strong>Objetivo:</strong> {{ (briefing.objetivo or '')|truncate(100) }}</div>
                        <div>
                            <strong>Status:</strong>
                            {% if briefing.status == 'rascunho' %}
                                <span class="badge badge-sm bg-slate-200 text-slate-700 border-0">Rascunho</span>
                            {% elif briefing.status == 'pendente' %}
                                <span class="badge badge-sm bg-amber-100 text-amber-700 border-0">Pendente</span>
                            {% elif briefing.status == 'em_andamento' %}
                                <span class="badge badge-sm bg-blue-100 text-blue-700 border-0">Em Andamento</span>
                            {% elif briefing.status == 'em_revisao' %}
                                <span class="badge badge-sm bg-purple-100 text-purple-700 border-0">Em Revisão</span>
                            {% elif briefing.status == 'completo' %}
                                <span class="badge badge-sm bg-green-100 text-green-700 border-0">Completo</span>
                            {% elif briefing.status == 'arquivado' %}
                                <span class="badge badge-sm bg-gray-100 text-gray-500 border-0">Arquivado</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-actions justify-end mt-3">
                        <a href="{{ url_for('briefing_edit', briefing_id=briefing.id) }}" 
                           class="btn btn-xs btn-primary">
                            Editar
                        </a>
                        <form method="post" action="{{ url_for('briefing_delete', briefing_id=briefing.id) }}" 
                              onsubmit="return confirm('Deseja realmente excluir este briefing?');" class="inline">
                            <button type="submit" class="btn btn-xs btn-error">Excluir</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Nenhum briefing encontrado.</span>
            </div>
        {% endif %}
    </div>
</div>

<script>
let timeoutBuscaCliente = null;
let clientesSugeridos = [];

function aoDigitarClienteFiltro(termo) {
  // Limpar o hidden se o campo de texto for modificado
  if (termo.length === 0) {
    document.getElementById('cliente_id_filtro').value = '';
  }
  
  buscarClientesFiltro(termo);
}

async function buscarClientesFiltro(termo) {
  clearTimeout(timeoutBuscaCliente);
  
  if (termo.length < 2) {
    document.getElementById('resultados_clientes_filtro').classList.add('hidden');
    return;
  }
  
  timeoutBuscaCliente = setTimeout(async () => {
    try {
      const response = await fetch('/api/clientes/buscar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: termo, razao: termo })
      });
      
      const data = await response.json();
      
      if (data.success && data.clientes.length > 0) {
        clientesSugeridos = data.clientes;
        renderizarResultadosFiltro();
      } else {
        document.getElementById('resultados_clientes_filtro').innerHTML = '<div class="p-3 text-sm text-base-content/50">Nenhum cliente encontrado</div>';
        document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Erro ao buscar clientes:', error);
    }
  }, 300);
}

function renderizarResultadosFiltro() {
  const container = document.getElementById('resultados_clientes_filtro');
  let html = '';
  
  clientesSugeridos.forEach(cliente => {
    const documento = cliente.cnpj || cliente.cpf || '-';
    html += `
      <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-300" 
           onclick="selecionarClienteFiltro(${cliente.pk_id_tbl_cliente}, '${cliente.nome_fantasia || cliente.razao_social}')">
        <div class="font-semibold text-sm">${cliente.nome_fantasia || cliente.razao_social}</div>
        <div class="text-xs text-base-content/60">${documento}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.classList.remove('hidden');
}

function selecionarClienteFiltro(clienteId, nomeCliente) {
  document.getElementById('cliente_id_filtro').value = clienteId;
  document.getElementById('cliente_busca').value = nomeCliente;
  document.getElementById('resultados_clientes_filtro').classList.add('hidden');
}

function mostrarResultadosFiltro() {
  if (clientesSugeridos.length > 0) {
    document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
  }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(event) {
  const busca = document.getElementById('cliente_busca');
  const resultados = document.getElementById('resultados_clientes_filtro');
  
  if (busca && resultados && !busca.contains(event.target) && !resultados.contains(event.target)) {
    resultados.classList.add('hidden');
  }
});
</script>

{% endblock %}
