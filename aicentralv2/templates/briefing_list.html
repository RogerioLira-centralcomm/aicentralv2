{% extends "base_tailwind.html" %}

{% block title %}Gestão de Briefings{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-2">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2">
        <h1 class="text-xl font-bold text-base-content">Gestão de Briefings</h1>
        <a href="{{ url_for('briefing_create') }}" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
            </svg>
            Novo Briefing
        </a>
    </div>

    <!-- Estatísticas -->
    <div class="grid grid-cols-4 lg:grid-cols-7 gap-1 mb-2">
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Total</div>
                <div class="stat-value text-lg text-black">{{ stats.total }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Rascunho</div>
                <div class="stat-value text-lg text-black">{{ stats.rascunho }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Pendente</div>
                <div class="stat-value text-lg text-black">{{ stats.pendente }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Andamento</div>
                <div class="stat-value text-lg text-black">{{ stats.em_andamento }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Revisão</div>
                <div class="stat-value text-lg text-black">{{ stats.em_revisao }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Completo</div>
                <div class="stat-value text-lg text-black">{{ stats.completo }}</div>
            </div>
        </div>
        <div class="stats shadow bg-base-100">
            <div class="stat py-1 px-2">
                <div class="stat-title text-xs">Arquivado</div>
                <div class="stat-value text-lg text-black">{{ stats.arquivado }}</div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card bg-base-100 border border-base-300 mb-2">
        <div class="card-body p-2">
            <form method="get" action="{{ url_for('briefing_list') }}" class="grid grid-cols-2 md:grid-cols-6 gap-2">
                <!-- Status -->
                <div class="form-control">
                    <label class="label py-0"><span class="label-text text-xs">Status</span></label>
                    <select name="status" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                        <option value="">Todos</option>
                        <option value="rascunho" {% if filtros.status == 'rascunho' %}selected{% endif %}>Rascunho</option>
                        <option value="pendente" {% if filtros.status == 'pendente' %}selected{% endif %}>Pendente</option>
                        <option value="em_andamento" {% if filtros.status == 'em_andamento' %}selected{% endif %}>Em Andamento</option>
                        <option value="em_revisao" {% if filtros.status == 'em_revisao' %}selected{% endif %}>Em Revisão</option>
                        <option value="completo" {% if filtros.status == 'completo' %}selected{% endif %}>Completo</option>
                        <option value="arquivado" {% if filtros.status == 'arquivado' %}selected{% endif %}>Arquivado</option>
                    </select>
                </div>

                <!-- Cliente -->
                <div class="form-control">
                    <label class="label py-0"><span class="label-text text-xs">Cliente</span></label>
                    <div class="relative">
                        <input type="hidden" name="cliente_id" id="cliente_id_filtro" value="{{ filtros.cliente_id }}">
                        <input type="text" id="cliente_busca" 
                            class="input input-bordered input-sm w-full h-8 min-h-8" 
                            placeholder="Buscar..."
                            value="{% if filtros.cliente_id and cliente_selecionado %}{{ cliente_selecionado.nome_fantasia }}{% endif %}"
                            autocomplete="off"
                            oninput="aoDigitarClienteFiltro(this.value)"
                            onfocus="mostrarResultadosFiltro()"
                        >
                        <div id="resultados_clientes_filtro" class="absolute z-50 w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
                    </div>
                </div>

                <!-- Projeto -->
                <div class="form-control">
                    <label class="label py-0"><span class="label-text text-xs">Projeto</span></label>
                    <select name="projeto_id" id="projeto_id_filtro" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                        <option value="">{{ 'Selecione cliente...' if not filtros.cliente_id else 'Todos' }}</option>
                        {% for projeto in projetos %}
                            <option value="{{ projeto.id }}" {% if filtros.projeto_id == projeto.id|string %}selected{% endif %}>{{ projeto.nome }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Responsável -->
                <div class="form-control">
                    <label class="label py-0"><span class="label-text text-xs">Responsável</span></label>
                    <select name="responsavel_id" class="select select-bordered w-full h-8 min-h-[2rem] text-sm leading-tight">
                        <option value="">Todos</option>
                        {% for resp in responsaveis %}
                            <option value="{{ resp.id_contato_cliente }}" {% if filtros.responsavel_id == resp.id_contato_cliente|string %}selected{% endif %}>{{ resp.nome_completo }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Busca -->
                <div class="form-control">
                    <label class="label py-0"><span class="label-text text-xs">Buscar</span></label>
                    <input type="text" name="busca" value="{{ filtros.busca }}" 
                           placeholder="Título..." class="input input-bordered input-sm h-8">
                </div>

                <!-- Botões -->
                <div class="form-control justify-end">
                    <div class="flex gap-1 mt-4">
                        <button type="submit" class="btn text-white btn-xs" style="background-color: #72cd80; border-color: #72cd80;">Filtrar</button>
                        <a href="{{ url_for('briefing_list') }}" class="btn btn-ghost btn-xs">Limpar</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de Briefings - Desktop -->
    <div class="bg-base-100 rounded-xl overflow-hidden hidden lg:block">
        <table class="table table-zebra w-full text-sm">
            <thead style="background-color: #72cd80;" class="text-white">
                <tr class="text-xs">
                    <th>Título</th>
                    <th class="w-20">Status</th>
                    <th>Cliente</th>
                    <th>Projeto</th>
                    <th>Resp.</th>
                    <th>Plataforma</th>
                    <th class="w-20">Prazo</th>
                    <th class="w-20">Budget</th>
                </tr>
            </thead>
            <tbody>
                {% if briefings %}
                    {% for briefing in briefings %}
                    <tr>
                        <td class="py-1">
                            <a href="{{ url_for('briefing_edit', briefing_id=briefing.id) }}" class="hover:text-primary font-semibold text-sm">{{ briefing.titulo }}</a>
                        </td>
                        <td class="py-1">
                            {% if briefing.status == 'rascunho' %}
                                <span class="badge badge-xs bg-slate-200 text-slate-700 border-0">Rascunho</span>
                            {% elif briefing.status == 'pendente' %}
                                <span class="badge badge-xs bg-amber-100 text-amber-700 border-0">Pendente</span>
                            {% elif briefing.status == 'em_andamento' %}
                                <span class="badge badge-xs bg-blue-100 text-blue-700 border-0">Andamento</span>
                            {% elif briefing.status == 'em_revisao' %}
                                <span class="badge badge-xs bg-purple-100 text-purple-700 border-0">Revisão</span>
                            {% elif briefing.status == 'completo' %}
                                <span class="badge badge-xs bg-green-100 text-green-700 border-0">Completo</span>
                            {% elif briefing.status == 'arquivado' %}
                                <span class="badge badge-xs bg-gray-100 text-gray-500 border-0">Arquivado</span>
                            {% endif %}
                        </td>
                        <td class="py-1 text-xs">{{ briefing.cliente_nome or '-' }}</td>
                        <td class="py-1 text-xs">{{ briefing.projeto_nome or '-' }}</td>
                        <td class="py-1 text-xs">{{ briefing.responsavel_nome or '-' }}</td>
                        <td class="py-1 text-xs">{{ briefing.plataforma or '-' }}</td>
                        <td class="py-1 text-xs">{{ briefing.prazo.strftime('%d/%m/%y') if briefing.prazo else '-' }}</td>
                        <td class="py-1 text-xs">{% if briefing.budget %}R$ {{ "%.0f"|format(briefing.budget|float) }}{% else %}-{% endif %}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-8 text-gray-500">
                            Nenhum briefing encontrado.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Lista de Briefings - Mobile -->
    <div class="lg:hidden space-y-3">
        {% if briefings %}
            {% for briefing in briefings %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body p-4">
                    <a href="{{ url_for('briefing_edit', briefing_id=briefing.id) }}" class="hover:text-primary">
                        <h3 class="card-title text-base">{{ briefing.titulo }}</h3>
                    </a>
                    <div class="space-y-1 text-xs">
                        <div><strong>Cliente:</strong> {{ briefing.cliente_nome or '-' }}</div>
                        <div><strong>Responsável:</strong> {{ briefing.responsavel_nome or '-' }}</div>
                        <div><strong>Plataforma:</strong> {{ briefing.plataforma or '-' }}</div>
                        <div><strong>Prazo:</strong> {{ briefing.prazo.strftime('%d/%m/%Y') if briefing.prazo else '-' }}</div>
                        <div><strong>Budget:</strong> 
                            {% if briefing.budget %}
                                R$ {{ "%.2f"|format(briefing.budget|float) }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                        <div><strong>Objetivo:</strong> {{ (briefing.objetivo or '')|truncate(100) }}</div>
                        <div>
                            <strong>Status:</strong>
                            {% if briefing.status == 'rascunho' %}
                                <span class="badge badge-sm bg-slate-200 text-slate-700 border-0">Rascunho</span>
                            {% elif briefing.status == 'pendente' %}
                                <span class="badge badge-sm bg-amber-100 text-amber-700 border-0">Pendente</span>
                            {% elif briefing.status == 'em_andamento' %}
                                <span class="badge badge-sm bg-blue-100 text-blue-700 border-0">Em Andamento</span>
                            {% elif briefing.status == 'em_revisao' %}
                                <span class="badge badge-sm bg-purple-100 text-purple-700 border-0">Em Revisão</span>
                            {% elif briefing.status == 'completo' %}
                                <span class="badge badge-sm bg-green-100 text-green-700 border-0">Completo</span>
                            {% elif briefing.status == 'arquivado' %}
                                <span class="badge badge-sm bg-gray-100 text-gray-500 border-0">Arquivado</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-actions justify-end mt-3">
                        <form method="post" action="{{ url_for('briefing_delete', briefing_id=briefing.id) }}" 
                              onsubmit="return confirm('Deseja realmente excluir este briefing?');" class="inline">
                            <button type="submit" class="btn btn-xs btn-error">Excluir</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Nenhum briefing encontrado.</span>
            </div>
        {% endif %}
    </div>
</div>

<script>
let timeoutBuscaCliente = null;
let clientesSugeridos = [];

function aoDigitarClienteFiltro(termo) {
  // Limpar o hidden se o campo de texto for modificado
  if (termo.length === 0) {
    document.getElementById('cliente_id_filtro').value = '';
  }
  
  buscarClientesFiltro(termo);
}

async function buscarClientesFiltro(termo) {
  clearTimeout(timeoutBuscaCliente);
  
  if (termo.length < 2) {
    document.getElementById('resultados_clientes_filtro').classList.add('hidden');
    return;
  }
  
  timeoutBuscaCliente = setTimeout(async () => {
    try {
      const response = await fetch('/api/clientes/buscar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nome: termo, razao: termo })
      });
      
      const data = await response.json();
      
      if (data.success && data.clientes.length > 0) {
        clientesSugeridos = data.clientes;
        renderizarResultadosFiltro();
      } else {
        document.getElementById('resultados_clientes_filtro').innerHTML = '<div class="p-3 text-sm text-base-content/50">Nenhum cliente encontrado</div>';
        document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
      }
    } catch (error) {
      console.error('Erro ao buscar clientes:', error);
    }
  }, 300);
}

function renderizarResultadosFiltro() {
  const container = document.getElementById('resultados_clientes_filtro');
  let html = '';
  
  clientesSugeridos.forEach(cliente => {
    const documento = cliente.cnpj || cliente.cpf || '-';
    html += `
      <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-300" 
           onclick="selecionarClienteFiltro(${cliente.pk_id_tbl_cliente}, '${cliente.nome_fantasia || cliente.razao_social}')">
        <div class="font-semibold text-sm">${cliente.nome_fantasia || cliente.razao_social}</div>
        <div class="text-xs text-base-content/60">${documento}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.classList.remove('hidden');
}

function selecionarClienteFiltro(clienteId, nomeCliente) {
  document.getElementById('cliente_id_filtro').value = clienteId;
  document.getElementById('cliente_busca').value = nomeCliente;
  document.getElementById('resultados_clientes_filtro').classList.add('hidden');
  
  // Carregar projetos do cliente selecionado
  carregarProjetosFiltro(clienteId);
}

function carregarProjetosFiltro(clienteId) {
  const selectProjeto = document.getElementById('projeto_id_filtro');
  
  if (!clienteId) {
    selectProjeto.innerHTML = '<option value="">Selecione cliente...</option>';
    return;
  }
  
  selectProjeto.innerHTML = '<option value="">Carregando...</option>';
  
  fetch(`/api/clientes/${clienteId}/projetos`)
    .then(response => response.json())
    .then(projetos => {
      if (projetos.length === 0) {
        selectProjeto.innerHTML = '<option value="">Nenhum projeto</option>';
        return;
      }
      
      selectProjeto.innerHTML = '<option value="">Todos</option>' + 
        projetos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
    })
    .catch(error => {
      console.error('Erro ao carregar projetos:', error);
      selectProjeto.innerHTML = '<option value="">Erro ao carregar</option>';
    });
}

function mostrarResultadosFiltro() {
  if (clientesSugeridos.length > 0) {
    document.getElementById('resultados_clientes_filtro').classList.remove('hidden');
  }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(event) {
  const busca = document.getElementById('cliente_busca');
  const resultados = document.getElementById('resultados_clientes_filtro');
  
  if (busca && resultados && !busca.contains(event.target) && !resultados.contains(event.target)) {
    resultados.classList.add('hidden');
  }
});
</script>

{% endblock %}
