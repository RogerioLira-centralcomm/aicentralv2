{% extends 'base_tailwind.html' %}

{% block title %}Base de Audi√™ncias - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-3">
    <h1 class="text-lg font-semibold leading-tight">Base de Audi√™ncias</h1>
    <p class="text-sm text-base-content/70">Cat√°logo completo de audi√™ncias dispon√≠veis para campanhas.</p>
  </div>

  <!-- Filtros -->
  <div class="bg-base-100 rounded-xl shadow-lg p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Categoria</span>
        </label>
        <select id="filtro-categoria" class="select select-bordered w-full h-10 min-h-10">
          <option value="" selected>Todas as categorias</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Subcategoria</span>
        </label>
        <select id="filtro-subcategoria" class="select select-bordered w-full h-10 min-h-10" disabled>
          <option value="" selected>Todas as subcategorias</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text opacity-0">A√ß√µes</span>
        </label>
        <button type="button" id="btn-limpar-filtros" class="btn btn-ghost btn-sm w-full h-10">
          <i class="fas fa-times mr-2"></i>Limpar Filtros
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Stats Cards -->
  {% if stats %}
  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
    <div class="bg-base-100 border border-base-300 rounded-lg p-3 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-base-content/60 uppercase">Total</p>
          <p class="text-lg font-semibold">{{ stats.total }}</p>
        </div>
        <i class="fas fa-users text-xl text-base-content/20"></i>
      </div>
    </div>
    <div class="bg-base-100 border border-success/30 rounded-lg p-3 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-base-content/60 uppercase">Ativas</p>
          <p class="text-lg font-semibold text-success">{{ stats.ativos }}</p>
        </div>
        <i class="fas fa-check-circle text-xl text-success/20"></i>
      </div>
    </div>
    <div class="bg-base-100 border border-error/30 rounded-lg p-3 shadow-sm">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-base-content/60 uppercase">Inativas</p>
          <p class="text-lg font-semibold text-error">{{ stats.inativos }}</p>
        </div>
        <i class="fas fa-ban text-xl text-error/20"></i>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Desktop Table -->
  <div class="bg-base-100 rounded-xl shadow-lg overflow-hidden hidden md:block">
    {% if audiencias %}
      <div class="overflow-x-auto">
        <table class="table table-xs w-full">
          <thead class="bg-gradient-to-r from-primary to-accent text-white">
            <tr>
              <th class="text-left font-bold uppercase">ID Plataforma</th>
              <th class="text-left font-bold uppercase">Fonte</th>
              <th class="text-left font-bold uppercase">Nome</th>
              <th class="text-left font-bold uppercase">Categoria</th>
              <th class="text-left font-bold uppercase">Subcategoria</th>
              <th class="text-center font-bold uppercase w-20">CPMC</th>
              <th class="text-center font-bold uppercase w-20">CPMV</th>
              <th class="text-center font-bold uppercase w-24">Status</th>
              <th class="text-center font-bold uppercase w-32">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for audiencia in audiencias %}
            <tr class="hover">
              <td>
                <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="hover:text-primary">
                  <code class="text-xs bg-base-200 px-2 py-1 rounded">{{ audiencia.id_audiencia_plataforma }}</code>
                </a>
              </td>
              <td>
                <span class="badge badge-sm badge-outline">{{ audiencia.fonte }}</span>
              </td>
              <td>
                <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="hover:text-primary">
                  <div class="font-semibold text-base-content">{{ audiencia.nome }}</div>
                  {% if audiencia.slug %}
                    <div class="text-xs text-base-content/60">{{ audiencia.slug }}</div>
                  {% endif %}
                </a>
              </td>
              <td>
                {% if audiencia.categoria_nome %}
                  <span class="text-base-content">{{ audiencia.categoria_nome }}</span>
                {% else %}
                  <span class="text-base-content/40 italic">-</span>
                {% endif %}
              </td>
              <td>
                {% if audiencia.subcategoria_nome %}
                  <span class="text-base-content/80">{{ audiencia.subcategoria_nome }}</span>
                {% else %}
                  <span class="text-base-content/40 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if audiencia.cpm_custo %}
                  <span class="font-mono text-sm">R$ {{ "%.2f"|format(audiencia.cpm_custo) }}</span>
                {% else %}
                  <span class="text-base-content/40 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if audiencia.cpm_venda %}
                  <span class="font-mono text-sm">R$ {{ "%.2f"|format(audiencia.cpm_venda) }}</span>
                {% else %}
                  <span class="text-base-content/40 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
                  {% if audiencia.is_active %}bg-green-100 text-green-800 border border-green-300{% else %}bg-red-100 text-red-700 border border-red-300{% endif %}">
                  {% if audiencia.is_active %}
                    <i class="fas fa-check-circle mr-1 text-green-500"></i>
                  {% else %}
                    <i class="fas fa-ban mr-1 text-red-500"></i>
                  {% endif %}
                  {{ 'Ativa' if audiencia.is_active else 'Inativa' }}
                </span>
              </td>
              <td>
                <div class="flex items-center justify-center gap-1">
                  <a href="{{ url_for('cadu_audiencia_editar', audiencia_id=audiencia.id) }}" 
                     class="btn btn-xs btn-circle btn-outline btn-primary" 
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button type="button" 
                          class="btn btn-xs btn-circle btn-outline {% if audiencia.imagem_url %}btn-success{% else %}btn-info{% endif %} btn-gerar-imagem" 
                          data-audiencia-id="{{ audiencia.id }}"
                          data-audiencia-nome="{{ audiencia.nome }}"
                          data-audiencia-categoria="{{ audiencia.categoria_nome or '' }}"
                          data-audiencia-descricao="{{ (audiencia.descricao or '')[:200] }}"
                          data-audiencia-imagem="{{ audiencia.imagem_url or '' }}"
                          title="{% if audiencia.imagem_url %}Editar Imagem{% else %}Gerar Imagem{% endif %}">
                    <i class="fas fa-image"></i>
                  </button>
                  <button type="button" 
                          class="btn btn-xs btn-circle btn-outline {% if audiencia.is_active %}btn-warning{% else %}btn-success{% endif %} btn-toggle-status"
                          data-audiencia-id="{{ audiencia.id }}"
                          title="{% if audiencia.is_active %}Desativar{% else %}Ativar{% endif %}">
                    <i class="fas {% if audiencia.is_active %}fa-toggle-on{% else %}fa-toggle-off{% endif %}"></i>
                  </button>
                  <button type="button" 
                          class="btn btn-xs btn-circle btn-outline btn-error btn-delete"
                          data-audiencia-id="{{ audiencia.id }}"
                          data-audiencia-nome="{{ audiencia.nome }}"
                          title="Deletar">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="text-base-content/60 text-sm">Nenhuma audi√™ncia cadastrada.</p>
      </div>
    {% endif %}
  </div>

  <!-- Mobile Cards -->
  <div class="block md:hidden space-y-4">
    {% if audiencias %}
      {% for audiencia in audiencias %}
      <div class="card bg-base-100 shadow-lg">
        <div class="card-body p-4">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="hover:text-primary">
                <h3 class="font-semibold text-sm mb-1">{{ audiencia.nome }}</h3>
              </a>
              <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="hover:text-primary">
                <code class="text-xs bg-base-200 px-2 py-1 rounded">{{ audiencia.id_audiencia_plataforma }}</code>
              </a>
            </div>
            <span class="badge badge-sm badge-outline ml-2">{{ audiencia.fonte }}</span>
          </div>

          <div class="space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-base-content/60">Categoria:</span>
              <span class="font-medium">{{ audiencia.categoria_nome or '-' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Subcategoria:</span>
              <span class="font-medium">{{ audiencia.subcategoria_nome or '-' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">CPMC:</span>
              {% if audiencia.cpm_custo %}
                <span class="font-mono font-medium">R$ {{ "%.2f"|format(audiencia.cpm_custo) }}</span>
              {% else %}
                <span class="text-base-content/40 italic">-</span>
              {% endif %}
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">CPMV:</span>
              {% if audiencia.cpm_venda %}
                <span class="font-mono font-medium">R$ {{ "%.2f"|format(audiencia.cpm_venda) }}</span>
              {% else %}
                <span class="text-base-content/40 italic">-</span>
              {% endif %}
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Status:</span>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
                {% if audiencia.is_active %}bg-green-100 text-green-800 border border-green-300{% else %}bg-red-100 text-red-700 border border-red-300{% endif %}">
                {% if audiencia.is_active %}
                  <i class="fas fa-check-circle mr-1 text-green-500"></i>Ativa
                {% else %}
                  <i class="fas fa-ban mr-1 text-red-500"></i>Inativa
                {% endif %}
              </span>
            </div>
          </div>

          <div class="flex gap-2 mt-4">
            <a href="{{ url_for('cadu_audiencia_editar', audiencia_id=audiencia.id) }}" 
               class="btn btn-sm btn-outline btn-primary flex-1">
              <i class="fas fa-edit mr-1"></i>Editar
            </a>
            <button type="button" 
                    class="btn btn-sm btn-outline {% if audiencia.imagem_url %}btn-success{% else %}btn-info{% endif %} btn-gerar-imagem"
                    data-audiencia-id="{{ audiencia.id }}"
                    data-audiencia-nome="{{ audiencia.nome }}"
                    data-audiencia-categoria="{{ audiencia.categoria_nome or '' }}"
                    data-audiencia-descricao="{{ (audiencia.descricao or '')[:200] }}"
                    data-audiencia-imagem="{{ audiencia.imagem_url or '' }}">
              <i class="fas fa-image mr-1"></i>{% if audiencia.imagem_url %}Editar{% else %}Imagem{% endif %}
            </button>
            <button type="button" 
                    class="btn btn-sm btn-outline {% if audiencia.is_active %}btn-warning{% else %}btn-success{% endif %} btn-toggle-status"
                    data-audiencia-id="{{ audiencia.id }}">
              <i class="fas {% if audiencia.is_active %}fa-toggle-on{% else %}fa-toggle-off{% endif %} mr-1"></i>
              {% if audiencia.is_active %}Desativar{% else %}Ativar{% endif %}
            </button>
            <button type="button" 
                    class="btn btn-sm btn-circle btn-outline btn-error btn-delete"
                    data-audiencia-id="{{ audiencia.id }}"
                    data-audiencia-nome="{{ audiencia.nome }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="text-center py-8 bg-base-100 rounded-xl shadow-lg">
        <p class="text-base-content/60">Nenhuma audi√™ncia cadastrada.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<dialog id="modal-delete" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Confirmar Exclus√£o</h3>
    <p class="py-4">Tem certeza que deseja excluir a audi√™ncia <strong id="delete-audiencia-nome"></strong>?</p>
    <p class="text-sm text-error">Esta a√ß√£o n√£o pode ser desfeita.</p>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancelar</button>
      </form>
      <button id="confirm-delete-btn" class="btn btn-error">
        <i class="fas fa-trash mr-2"></i>Excluir
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let audienciaIdToDelete = null;
  const filtroCategoria = document.getElementById('filtro-categoria');
  const filtroSubcategoria = document.getElementById('filtro-subcategoria');
  const btnLimparFiltros = document.getElementById('btn-limpar-filtros');

  // Carregar subcategorias ao trocar categoria
  filtroCategoria.addEventListener('change', async function() {
    const categoriaId = this.value;
    filtroSubcategoria.innerHTML = '<option value="" selected>Todas as subcategorias</option>';
    filtroSubcategoria.disabled = true;

    if (categoriaId) {
      try {
        const response = await fetch(`/api/cadu-subcategorias?categoria_id=${categoriaId}`);
        const data = await response.json();

        if (data.success && data.subcategorias.length > 0) {
          data.subcategorias.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = sub.nome;
            filtroSubcategoria.appendChild(option);
          });
          filtroSubcategoria.disabled = false;
        }
      } catch (error) {
        console.error('Erro ao carregar subcategorias:', error);
      }
    }

    aplicarFiltros();
  });

  // Aplicar filtro ao trocar subcategoria
  filtroSubcategoria.addEventListener('change', aplicarFiltros);

  // Limpar filtros
  btnLimparFiltros.addEventListener('click', function() {
    filtroCategoria.value = '';
    filtroSubcategoria.innerHTML = '<option value="" selected>Todas as subcategorias</option>';
    filtroSubcategoria.disabled = true;
    aplicarFiltros();
  });

  // Fun√ß√£o para aplicar filtros
  function aplicarFiltros() {
    const categoriaId = filtroCategoria.value;
    const subcategoriaId = filtroSubcategoria.value;

    // Filtrar linhas da tabela desktop
    const tableRows = document.querySelectorAll('table tbody tr');
    tableRows.forEach(row => {
      const categoriaText = row.cells[3].textContent.trim();
      const subcategoriaText = row.cells[4].textContent.trim();
      
      let showRow = true;

      if (categoriaId) {
        const categoriaOption = filtroCategoria.querySelector(`option[value="${categoriaId}"]`);
        const categoriaNome = categoriaOption ? categoriaOption.textContent : '';
        if (categoriaText !== categoriaNome) {
          showRow = false;
        }
      }

      if (subcategoriaId && showRow) {
        const subcategoriaOption = filtroSubcategoria.querySelector(`option[value="${subcategoriaId}"]`);
        const subcategoriaNome = subcategoriaOption ? subcategoriaOption.textContent : '';
        if (subcategoriaText !== subcategoriaNome) {
          showRow = false;
        }
      }

      row.style.display = showRow ? '' : 'none';
    });

    // Filtrar cards mobile
    const mobileCards = document.querySelectorAll('.block.md\\:hidden .card');
    mobileCards.forEach(card => {
      const categoriaElements = card.querySelectorAll('.space-y-2 > div');
      let categoriaText = '';
      let subcategoriaText = '';

      categoriaElements.forEach(div => {
        const label = div.querySelector('.text-base-content\\/60');
        if (label && label.textContent.includes('Categoria:')) {
          categoriaText = div.querySelector('.font-medium').textContent.trim();
        }
        if (label && label.textContent.includes('Subcategoria:')) {
          subcategoriaText = div.querySelector('.font-medium').textContent.trim();
        }
      });

      let showCard = true;

      if (categoriaId) {
        const categoriaOption = filtroCategoria.querySelector(`option[value="${categoriaId}"]`);
        const categoriaNome = categoriaOption ? categoriaOption.textContent : '';
        if (categoriaText !== categoriaNome) {
          showCard = false;
        }
      }

      if (subcategoriaId && showCard) {
        const subcategoriaOption = filtroSubcategoria.querySelector(`option[value="${subcategoriaId}"]`);
        const subcategoriaNome = subcategoriaOption ? subcategoriaOption.textContent : '';
        if (subcategoriaText !== subcategoriaNome) {
          showCard = false;
        }
      }

      card.style.display = showCard ? '' : 'none';
    });

    // Atualizar mensagem de "Nenhuma audi√™ncia" se necess√°rio
    atualizarMensagemVazia();
  }

  function atualizarMensagemVazia() {
    const tableRows = document.querySelectorAll('table tbody tr');
    const visibleRows = Array.from(tableRows).filter(row => row.style.display !== 'none');
    
    const mobileCards = document.querySelectorAll('.block.md\\:hidden .card');
    const visibleCards = Array.from(mobileCards).filter(card => card.style.display !== 'none');

    // N√£o implementar mensagem din√¢mica para manter simplicidade
    // Usu√°rio ver√° a tabela/cards vazios com filtros ativos
  }

  // Toggle Status
  document.querySelectorAll('.btn-toggle-status').forEach(btn => {
    btn.addEventListener('click', async function() {
      const audienciaId = this.dataset.audienciaId;
      
      try {
        const response = await fetch(`/api/cadu-audiencias/toggle-status/${audienciaId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();

        if (data.success) {
          window.location.reload();
        } else {
          alert('Erro ao alterar status: ' + (data.message || 'Erro desconhecido'));
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao alterar status da audi√™ncia');
      }
    });
  });

  // Delete
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', function() {
      audienciaIdToDelete = this.dataset.audienciaId;
      const audienciaNome = this.dataset.audienciaNome;
      
      document.getElementById('delete-audiencia-nome').textContent = audienciaNome;
      document.getElementById('modal-delete').showModal();
    });
  });

  document.getElementById('confirm-delete-btn').addEventListener('click', async function() {
    if (!audienciaIdToDelete) return;

    try {
      const response = await fetch(`/cadu-audiencias/deletar/${audienciaIdToDelete}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        alert('Erro ao excluir: ' + (data.message || 'Erro desconhecido'));
      }
    } catch (error) {
      console.error('Erro:', error);
      alert('Erro ao excluir audi√™ncia');
    }
  });

  // ==================== GERA√á√ÉO DE IMAGENS ====================
  
  // Event listener para bot√µes de gerar imagem
  document.querySelectorAll('.btn-gerar-imagem').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.audienciaId;
      const nome = this.dataset.audienciaNome;
      const categoria = this.dataset.audienciaCategoria;
      const descricao = this.dataset.audienciaDescricao;
      const imagemUrl = this.dataset.audienciaImagem;
      
      abrirModalGerarImagem(id, nome, categoria, descricao, imagemUrl);
    });
  });
  
  let imagemAtualUrl = null;
  let audienciaAtualId = null;

  window.abrirModalGerarImagem = async function(id, nome, categoria, descricao, imagemUrl) {
    console.log('Dados recebidos:', { id, nome, categoria, descricao, imagemUrl });
    console.log('imagemUrl type:', typeof imagemUrl, 'value:', imagemUrl, 'trimmed:', imagemUrl ? imagemUrl.trim() : 'null');
    
    audienciaAtualId = id;
    
    document.getElementById('modal-titulo').textContent = `Gerar Imagem - ${nome}`;
    document.getElementById('modal-categoria').textContent = categoria || 'Sem categoria';
    document.getElementById('audiencia-id').value = id;
    document.getElementById('audiencia-descricao').value = descricao;
    
    // LIMPAR preview anterior PRIMEIRO
    const imgElement = document.getElementById('preview-imagem');
    imgElement.src = '';
    imgElement.onload = null;
    imgElement.onerror = null;
    imagemAtualUrl = null;
    
    // Resetar para estado vazio
    mostrarEstadoPreview('vazio');
    document.getElementById('acoes-imagem').classList.add('hidden');
    
    // Se j√° tem imagem salva, mostra no preview
    if (imagemUrl && imagemUrl.trim() !== '') {
      console.log('TEM IMAGEM SALVA - Carregando preview...');
      imagemAtualUrl = imagemUrl;
      
      // Configurar callbacks ANTES de definir src
      imgElement.onload = () => {
        console.log('‚úÖ IMAGEM EXISTENTE CARREGOU COM SUCESSO!');
        console.log('üìê Tamanho:', imgElement.naturalWidth, 'x', imgElement.naturalHeight);
        
        mostrarEstadoPreview('imagem');
        document.getElementById('acoes-imagem').classList.remove('hidden');
      };
      imgElement.onerror = (e) => {
        console.error('‚ùå ERRO ao carregar imagem existente:', e, 'URL:', imagemUrl);
        mostrarEstadoPreview('vazio');
        document.getElementById('acoes-imagem').classList.add('hidden');
      };
      
      // Agora sim definir src (dispara o onload)
      console.log('üîÑ Definindo src da imagem existente:', imagemUrl);
      imgElement.src = imagemUrl;
    } else {
      console.log('N√ÉO TEM IMAGEM SALVA - Mostrando estado vazio');
    }
    
    document.getElementById('modal-gerar-imagem').showModal();
    
    await prepararPrompt(nome, categoria, descricao);
  };

  async function prepararPrompt(nome, categoria, descricao) {
    // v2 - Descri√ß√£o opcional
    const textarea = document.getElementById('prompt-textarea');
    textarea.value = 'Carregando prompt...';
    textarea.disabled = true;
    
    try {
      // Garantir que pelo menos o nome existe
      if (!nome || nome.trim() === '') {
        throw new Error('Nome da audi√™ncia √© obrigat√≥rio');
      }
      
      const response = await fetch('/api/preparar-prompt-imagem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nome_audiencia: nome.trim(),
          categoria: categoria ? categoria.trim() : '',
          descricao: descricao ? descricao.trim() : ''
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        textarea.value = data.prompt;
        textarea.disabled = false;
      } else {
        throw new Error(data.error || 'Erro ao preparar prompt');
      }
    } catch (error) {
      console.error('Erro:', error);
      textarea.value = 'Erro ao gerar prompt. Tente novamente.';
      textarea.disabled = false;
      mostrarToast('Erro ao preparar prompt', 'error');
    }
  }

  window.regenerarPrompt = async function() {
    const nome = document.getElementById('modal-titulo').textContent.replace('Gerar Imagem - ', '');
    const categoria = document.getElementById('modal-categoria').textContent;
    const descricao = document.getElementById('audiencia-descricao').value;
    await prepararPrompt(nome, categoria, descricao);
  };

  window.gerarImagem = async function() {
    const prompt = document.getElementById('prompt-textarea').value.trim();
    const modelo = document.getElementById('modelo-imagem').value;
    
    if (!prompt || prompt.length < 50) {
      mostrarToast('Prompt muito curto. M√≠nimo 50 caracteres.', 'warning');
      return;
    }
    
    mostrarEstadoPreview('loading');
    document.getElementById('btn-gerar-imagem').disabled = true;
    document.getElementById('status-geracao').textContent = `Gerando com ${modelo.split('/')[1]}...`;
    
    try {
      const response = await fetch('/api/gerar-imagem-audiencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: prompt,
          modelo: modelo,
          audiencia_id: audienciaAtualId
        })
      });
      
      const data = await response.json();
      
      console.log('Resposta da gera√ß√£o:', data);
      
      if (data.success && data.image_url) {
        imagemAtualUrl = data.image_url;
        const imgElement = document.getElementById('preview-imagem');
        console.log('URL da imagem:', data.image_url);
        console.log('Elemento img:', imgElement);
        
        // Configurar callbacks antes de definir src
        imgElement.onload = () => {
          console.log('‚úÖ IMAGEM CARREGOU COM SUCESSO!');
          console.log('üìê Tamanho:', imgElement.naturalWidth, 'x', imgElement.naturalHeight);
          console.log('üé® Elemento:', imgElement);
          console.log('üîç Computed style:', window.getComputedStyle(imgElement).display);
          console.log('üîç Inline style:', imgElement.style.display);
          console.log('üîç Opacity:', window.getComputedStyle(imgElement).opacity);
          console.log('üîç Visibility:', window.getComputedStyle(imgElement).visibility);
          console.log('üîç Z-index:', window.getComputedStyle(imgElement).zIndex);
          
          mostrarEstadoPreview('imagem');
          
          // Verificar DEPOIS de mostrar
          setTimeout(() => {
          console.log('üîç DEPOIS de mostrarEstadoPreview:');
          console.log('  - display:', window.getComputedStyle(imgElement).display);
          console.log('  - opacity:', window.getComputedStyle(imgElement).opacity);
          console.log('  - visibility:', window.getComputedStyle(imgElement).visibility);
          
          // Verificar container pai
          const container = document.getElementById('preview-container');
          console.log('üì¶ Container pai:', container);
          console.log('üì¶ Container display:', window.getComputedStyle(container).display);
          console.log('üì¶ Container overflow:', window.getComputedStyle(container).overflow);
          console.log('üì¶ Container height:', container.offsetHeight);
          console.log('üì¶ Container width:', container.offsetWidth);
          
          // FOR√áAR se necess√°rio
          if (window.getComputedStyle(imgElement).display === 'none') {
            console.error('‚ö†Ô∏è AINDA EST√Å DISPLAY NONE! For√ßando...');
            imgElement.style.display = 'block !important';
          }
          if (window.getComputedStyle(imgElement).opacity === '0') {
            console.error('‚ö†Ô∏è OPACITY √â 0! For√ßando...');
            imgElement.style.opacity = '1';
          }
        }, 100);          document.getElementById('acoes-imagem').classList.remove('hidden');
          document.getElementById('status-geracao').textContent = 'Gerada com sucesso';
          mostrarToast('Imagem gerada com sucesso!', 'success');
        };
        imgElement.onerror = (e) => {
          console.error('‚ùå ERRO ao carregar imagem:', e);
          console.error('URL que falhou:', data.image_url);
          mostrarEstadoPreview('vazio');
          mostrarToast('Erro ao carregar imagem. URL: ' + data.image_url, 'error');
        };
        
        // Agora sim definir a src (isso dispara o onload)
        console.log('üîÑ Definindo src da imagem:', data.image_url);
        imgElement.src = data.image_url;
      } else {
        throw new Error(data.error || 'Erro ao gerar imagem');
      }
    } catch (error) {
      console.error('Erro:', error);
      mostrarEstadoPreview('vazio');
      document.getElementById('status-geracao').textContent = 'Erro na gera√ß√£o';
      mostrarToast('Erro ao gerar imagem. Tente novamente.', 'error');
    } finally {
      document.getElementById('btn-gerar-imagem').disabled = false;
    }
  };

  function mostrarEstadoPreview(estado) {
    console.log('Mostrando estado:', estado);
    const vazio = document.getElementById('preview-vazio');
    const loading = document.getElementById('preview-loading');
    const imagem = document.getElementById('preview-imagem');
    
    console.log('Elementos:', { vazio, loading, imagem });
    
    // Esconder todos
    vazio.style.display = 'none';
    loading.style.display = 'none';
    imagem.style.display = 'none';
    
    // For√ßar reflow (force browser repaint)
    void imagem.offsetHeight;
    
    // Mostrar o estado solicitado
    if (estado === 'vazio') {
      vazio.style.display = 'flex';
    } else if (estado === 'loading') {
      loading.style.display = 'flex';
    } else if (estado === 'imagem') {
      imagem.style.display = 'block';
      imagem.style.opacity = '1';
      imagem.style.visibility = 'visible';
      
      // For√ßar reflow novamente
      void imagem.offsetHeight;
      
      console.log('Imagem deve estar vis√≠vel agora. Style:', imagem.style.display);
      console.log('üé® Classes:', imagem.className);
      console.log('üé® Parent:', imagem.parentElement);
    }
  }

  window.confirmarImagem = async function() {
    if (!imagemAtualUrl || !audienciaAtualId) {
      mostrarToast('Erro: dados incompletos', 'error');
      return;
    }
    
    const btnConfirmar = document.querySelector('#acoes-imagem button');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Salvando...';
    
    try {
      const response = await fetch('/api/salvar-imagem-audiencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          audiencia_id: audienciaAtualId,
          imagem_url: imagemAtualUrl
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarToast('Imagem salva com sucesso!', 'success');
        fecharModalImagem();
        setTimeout(() => location.reload(), 1000);
      } else {
        throw new Error(data.error || 'Erro ao salvar');
      }
    } catch (error) {
      console.error('Erro:', error);
      mostrarToast('Erro ao salvar imagem', 'error');
      btnConfirmar.disabled = false;
      btnConfirmar.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Confirmar e Salvar Imagem';
    }
  };

  window.fecharModalImagem = function() {
    document.getElementById('modal-gerar-imagem').close();
    imagemAtualUrl = null;
    audienciaAtualId = null;
  };

  function mostrarToast(mensagem, tipo = 'info') {
    const tipoClasse = tipo === 'error' ? 'alert-error' : tipo === 'success' ? 'alert-success' : tipo === 'warning' ? 'alert-warning' : 'alert-info';
    const alert = document.createElement('div');
    alert.className = `alert ${tipoClasse} shadow-lg fixed bottom-4 right-4 w-auto z-50`;
    alert.innerHTML = `<span>${mensagem}</span>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
  }
});
</script>

<!-- Modal Gerar Imagem -->
<dialog id="modal-gerar-imagem" class="modal">
  <div class="modal-box max-w-6xl w-full">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <h3 class="font-bold text-xl" id="modal-titulo">Gerar Imagem</h3>
        <p class="text-sm text-base-content/60 mt-1">
          <span class="badge badge-sm" id="modal-categoria">Categoria</span>
        </p>
      </div>
      <button onclick="fecharModalImagem()" class="btn btn-sm btn-circle btn-ghost">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Grid 2 Colunas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      
      <!-- COLUNA 1: Prompt Editor -->
      <div class="space-y-4">
        
        <!-- Seletor de Modelo -->
        <div>
          <label class="label">
            <span class="label-text font-semibold">Modelo de Gera√ß√£o</span>
            <span class="label-text-alt text-xs text-base-content/60">Escolha o modelo AI</span>
          </label>
          <select id="modelo-imagem" class="select select-bordered w-full">
            <option value="google/gemini-2.5-flash-image">Gemini 2.5 Flash Image (Base64)</option>
            <option value="google/gemini-exp-1206:free">Gemini Experimental 1206 (Gratuito)</option>
            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Gratuito)</option>
            <option value="openai/gpt-4o">GPT-4o (Multimodal)</option>
            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Multimodal)</option>
          </select>
          <div class="label">
            <span class="label-text-alt text-xs">‚ö†Ô∏è Nem todos modelos geram imagens. Use Gemini 2.5 Flash Image para garantir.</span>
          </div>
        </div>
        
        <div>
          <label class="label">
            <span class="label-text font-semibold">Prompt para Gera√ß√£o</span>
            <span class="label-text-alt text-xs text-base-content/60">Edit√°vel</span>
          </label>
          <textarea 
            id="prompt-textarea" 
            class="textarea textarea-bordered w-full h-64 font-mono text-sm"
            placeholder="Carregando prompt..."></textarea>
          <div class="label">
            <span class="label-text-alt text-xs">150-500 caracteres, em ingl√™s, formato 16:9</span>
          </div>
        </div>
        
        <!-- A√ß√µes da Coluna 1 -->
        <div class="flex gap-2">
          <button 
            onclick="regenerarPrompt()" 
            id="btn-regenerar-prompt"
            class="btn btn-sm btn-outline gap-2 flex-1">
            <i class="fas fa-sync-alt"></i>
            Gerar Novo Prompt
          </button>
          <button 
            onclick="gerarImagem()" 
            id="btn-gerar-imagem"
            class="btn btn-sm btn-primary gap-2 flex-1">
            <i class="fas fa-magic"></i>
            Gerar Imagem
          </button>
        </div>
      </div>
      
      <!-- COLUNA 2: Preview da Imagem -->
      <div class="space-y-4">
        <div>
          <label class="label">
            <span class="label-text font-semibold">Preview da Imagem</span>
            <span class="label-text-alt text-xs text-base-content/60" id="status-geracao"></span>
          </label>
          
          <!-- Container com aspect ratio 16:9 -->
          <div class="w-full bg-base-200 rounded-lg border-2 border-base-300 flex items-center justify-center overflow-hidden relative" id="preview-container" style="aspect-ratio: 16/9; min-height: 300px;">
            
            <!-- Estado Inicial -->
            <div id="preview-vazio" class="text-center p-6 absolute inset-0 flex flex-col items-center justify-center">
              <i class="fas fa-image text-4xl text-base-content/40 mb-2 block"></i>
              <p class="text-sm text-base-content/60">Clique em "Gerar Imagem" para criar</p>
            </div>
            
            <!-- Loading State (oculto por padr√£o) -->
            <div id="preview-loading" class="absolute inset-0 flex flex-col items-center justify-center p-6" style="display: none;">
              <span class="loading loading-spinner loading-lg text-primary mb-4"></span>
              <p class="text-sm font-semibold mb-1">Gerando imagem...</p>
              <p class="text-xs text-base-content/60">Isso pode levar 20-40 segundos</p>
            </div>
            
            <!-- Imagem Gerada (oculto por padr√£o) -->
            <img id="preview-imagem" class="absolute inset-0 w-full h-full object-cover" style="display: none;" alt="Imagem gerada">
            
          </div>
        </div>
        
        <!-- A√ß√µes da Coluna 2 -->
        <div id="acoes-imagem" class="hidden">
          <button 
            onclick="confirmarImagem()" 
            class="btn btn-success w-full gap-2">
            <i class="fas fa-check-circle"></i>
            Confirmar e Salvar Imagem
          </button>
        </div>
      </div>
      
    </div>
    
    <!-- Informa√ß√µes da Audi√™ncia (oculto, usado pelo JS) -->
    <input type="hidden" id="audiencia-id">
    <input type="hidden" id="audiencia-descricao">
    
  </div>
  
  <!-- Backdrop -->
  <form method="dialog" class="modal-backdrop">
    <button onclick="fecharModalImagem()">fechar</button>
  </form>
</dialog>

<!-- Cache buster: v2.1 - Unsplash placeholder -->

{% endblock %}
