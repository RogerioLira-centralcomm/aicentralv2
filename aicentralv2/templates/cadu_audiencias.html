{% extends 'base_tailwind.html' %}

{% block title %}Audi√™ncias Cadastradas - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto Sticky com Filtros Inline -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- T√≠tulo -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Audi√™ncias</h1>
        <span class="text-xs text-gray-500">(<span id="contador-header">{{ audiencias|length }}</span> registros)</span>
      </div>
      
      <!-- Filtros Inline -->
      <div class="flex items-center gap-3">
        <!-- ID -->
        <input type="text" id="filtro-id" placeholder="Buscar ID..."
               class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 120px;">
        
        <!-- Categoria -->
        <select id="filtro-categoria" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 150px;">
          <option value="" selected>Todas categorias</option>
          {% for categoria in categorias %}
            <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
          {% endfor %}
        </select>
        
        <!-- Subcategoria -->
        <select id="filtro-subcategoria" disabled
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400 disabled:opacity-50" style="min-width: 160px;">
          <option value="" selected>Todas subcategorias</option>
        </select>
        
        <!-- Status Icons -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          <button type="button" id="filtro-status-ativa"
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors" 
                  title="Ativas">
            <i class="fa-solid fa-circle-check text-sm text-gray-400"></i>
          </button>
          <button type="button" id="filtro-status-inativa"
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors" 
                  title="Inativas">
            <i class="fa-solid fa-circle-xmark text-sm text-gray-400"></i>
          </button>
          <button type="button" id="filtro-status-todos"
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors bg-gray-200" 
                  title="Todas">
            <i class="fa-solid fa-list text-sm text-gray-800"></i>
          </button>
        </div>
        
        <!-- Limpar Filtros -->
        <button type="button" id="btn-limpar-filtros" 
                class="p-1.5 rounded hover:bg-gray-100 transition-colors text-gray-400 hover:text-gray-600" 
                title="Limpar Filtros">
          <i class="fas fa-times text-sm"></i>
        </button>
      </div>
      
      <!-- Bot√£o Nova Audi√™ncia -->
      <div class="flex gap-2">
        <button onclick="modal_audiencia.showModal(); document.getElementById('modal_audiencia_title').textContent='Nova Audi√™ncia'; document.getElementById('audiencia_id').value=''; document.getElementById('btn_submit_audiencia_text').textContent='Cadastrar'; document.getElementById('form_audiencia').reset();" 
                class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
          <i class="fas fa-plus mr-1"></i>Nova Audi√™ncia
        </button>
      </div>
    </div>
  </div>
  
  <!-- Hidden select para manter compatibilidade com JS existente -->
  <select id="filtro-status" class="hidden">
    <option value="" selected>Todos os status</option>
    <option value="ativa">Ativa</option>
    <option value="inativa">Inativa</option>
  </select>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Desktop Table -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden hidden md:block">
    {% if audiencias %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">ID Plataforma</th>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Nome</th>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Perfil</th>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Categoria</th>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Subcategoria</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-20">CPMC</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-20">CPMV</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-24">Status</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-32">A√ß√µes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for audiencia in audiencias %}
            <tr class="hover:bg-gray-50 transition-colors" 
                id="audiencia-{{ audiencia.id }}"
                data-status="{{ 'ativa' if audiencia.is_active else 'inativa' }}"
                data-categoria-id="{{ audiencia.categoria_id or '' }}"
                data-subcategoria-id="{{ audiencia.subcategoria_id or '' }}">
              <td class="py-2 px-3">
                <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="block">
                  <code class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-700">{{ audiencia.id_audiencia_plataforma }}</code>
                  <div class="text-xs text-gray-500 mt-1">{{ audiencia.fonte }}</div>
                </a>
              </td>
              <td class="py-2 px-3">
                <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="block">
                  <div class="font-medium text-gray-800 hover:text-gray-600">{{ audiencia.nome }}</div>
                  <div class="text-xs text-gray-400">Clique para ver/editar</div>
                </a>
              </td>
              <td class="py-2 px-3">
                {% if audiencia.perfil_socioeconomico %}
                  <span class="text-gray-700">{{ audiencia.perfil_socioeconomico }}</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="py-2 px-3">
                {% if audiencia.categoria_nome %}
                  <span class="text-gray-700">{{ audiencia.categoria_nome }}</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="py-2 px-3">
                {% if audiencia.subcategoria_nome %}
                  <span class="text-gray-600">{{ audiencia.subcategoria_nome }}</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center py-2 px-2">
                {% if audiencia.cpm_custo %}
                  <span class="font-mono text-sm text-gray-700">R$ {{ "%.2f"|format(audiencia.cpm_custo) }}</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center py-2 px-2">
                {% if audiencia.cpm_venda %}
                  <span class="font-mono text-sm text-gray-700">R$ {{ "%.2f"|format(audiencia.cpm_venda) }}</span>
                {% else %}
                  <span class="text-gray-400 italic">-</span>
                {% endif %}
              </td>
              <td class="text-center py-2 px-2">
                <button type="button"
                        class="text-xs px-2 py-0.5 rounded cursor-pointer transition-all hover:scale-105 btn-toggle-status"
                        style="{% if audiencia.is_active %}background-color: #10b981; color: white;{% else %}background-color: #ef4444; color: white;{% endif %}"
                        data-audiencia-id="{{ audiencia.id }}"
                        title="Clique para {% if audiencia.is_active %}desativar{% else %}ativar{% endif %}">
                  {% if audiencia.is_active %}Ativa{% else %}Inativa{% endif %}
                </button>
              </td>
              <td class="py-2 px-2">
                <div class="flex items-center justify-center gap-2">
                  <button type="button" 
                          class="p-1.5 rounded transition-colors duration-200 btn-gerar-imagem {% if audiencia.imagem_url %}text-green-600 hover:text-green-800 hover:bg-green-50{% else %}text-gray-400 hover:text-gray-600 hover:bg-gray-100{% endif %}" 
                          data-audiencia-id="{{ audiencia.id }}"
                          data-audiencia-nome="{{ audiencia.nome }}"
                          data-audiencia-categoria="{{ audiencia.categoria_nome or '' }}"
                          data-audiencia-descricao="{{ (audiencia.descricao or '')[:200] }}"
                          data-audiencia-imagem="{{ audiencia.imagem_url or '' }}"
                          title="{% if audiencia.imagem_url %}Editar Imagem{% else %}Gerar Imagem{% endif %}">
                    <i class="fas fa-image text-sm"></i>
                  </button>
                  <button type="button" 
                          class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors duration-200 btn-delete"
                          data-audiencia-id="{{ audiencia.id }}"
                          data-audiencia-nome="{{ audiencia.nome }}"
                          title="Deletar">
                    <i class="fas fa-trash text-sm"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="p-3 border-t border-gray-200 bg-gray-50">
        <p class="text-xs text-gray-500">
          Exibindo <strong class="text-gray-700" id="contador-visiveis">{{ audiencias|length }}</strong> de <strong class="text-gray-700">{{ audiencias|length }}</strong> audi√™ncias
        </p>
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="text-gray-500 text-sm">Nenhuma audi√™ncia cadastrada.</p>
      </div>
    {% endif %}
  </div>

  <!-- Mobile Cards -->
  <div class="block md:hidden space-y-4">
    {% if audiencias %}
      {% for audiencia in audiencias %}
      <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow" 
           data-status="{{ 'ativa' if audiencia.is_active else 'inativa' }}"
           data-categoria-id="{{ audiencia.categoria_id or '' }}"
           data-subcategoria-id="{{ audiencia.subcategoria_id or '' }}">
        <div class="card-body p-4">
          <a href="{{ url_for('cadu_audiencia_detalhes', audiencia_id=audiencia.id) }}" class="block mb-3">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-semibold text-sm mb-1 text-primary hover:underline">{{ audiencia.nome }}</h3>
                <code class="text-xs bg-base-200 px-2 py-1 rounded">{{ audiencia.id_audiencia_plataforma }}</code>
                <div class="text-xs text-base-content/50 mt-1">Toque para ver/editar</div>
              </div>
              <span class="badge badge-sm badge-outline ml-2">{{ audiencia.fonte }}</span>
            </div>
          </a>

          <div class="space-y-2 text-xs">
            <div class="flex justify-between">
              <span class="text-base-content/60">Categoria:</span>
              <span class="font-medium">{{ audiencia.categoria_nome or '-' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Subcategoria:</span>
              <span class="font-medium">{{ audiencia.subcategoria_nome or '-' }}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">CPMC:</span>
              {% if audiencia.cpm_custo %}
                <span class="font-mono font-medium">R$ {{ "%.2f"|format(audiencia.cpm_custo) }}</span>
              {% else %}
                <span class="text-base-content/40 italic">-</span>
              {% endif %}
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">CPMV:</span>
              {% if audiencia.cpm_venda %}
                <span class="font-mono font-medium">R$ {{ "%.2f"|format(audiencia.cpm_venda) }}</span>
              {% else %}
                <span class="text-base-content/40 italic">-</span>
              {% endif %}
            </div>
            <div class="flex justify-between">
              <span class="text-base-content/60">Status:</span>
              <button type="button"
                      class="badge badge-sm cursor-pointer transition-all hover:scale-105 btn-toggle-status"
                      style="{% if audiencia.is_active %}background-color: #72cd80; color: white; border-color: #72cd80;{% else %}background-color: #ef4444; color: white; border-color: #ef4444;{% endif %}"
                      data-audiencia-id="{{ audiencia.id }}"
                      title="Clique para {% if audiencia.is_active %}desativar{% else %}ativar{% endif %}">
                {% if audiencia.is_active %}Ativa{% else %}Inativa{% endif %}
              </button>
            </div>
          </div>

          <div class="flex gap-2 mt-4">
            <button type="button" 
                    class="btn btn-sm btn-outline btn-gerar-imagem flex-1"
                    style="{% if not audiencia.imagem_url %}color: #72cd80; border-color: #72cd80;{% else %}color: #22c55e; border-color: #22c55e;{% endif %}"
                    data-audiencia-id="{{ audiencia.id }}"
                    data-audiencia-nome="{{ audiencia.nome }}"
                    data-audiencia-categoria="{{ audiencia.categoria_nome or '' }}"
                    data-audiencia-descricao="{{ (audiencia.descricao or '')[:200] }}"
                    data-audiencia-imagem="{{ audiencia.imagem_url or '' }}">
              <i class="fas fa-image mr-1"></i>{% if audiencia.imagem_url %}Editar{% else %}Imagem{% endif %}
            </button>
            <button type="button" 
                    class="btn btn-sm btn-circle btn-outline btn-error btn-delete"
                    data-audiencia-id="{{ audiencia.id }}"
                    data-audiencia-nome="{{ audiencia.nome }}">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="text-center py-8 bg-base-100 rounded-xl shadow-lg">
        <p class="text-base-content/60">Nenhuma audi√™ncia cadastrada.</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Confirma√ß√£o de Exclus√£o -->
<dialog id="modal-delete" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Confirmar Exclus√£o</h3>
    <p class="py-4">Tem certeza que deseja excluir a audi√™ncia <strong id="delete-audiencia-nome"></strong>?</p>
    <p class="text-sm text-error">Esta a√ß√£o n√£o pode ser desfeita.</p>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn btn-ghost">Cancelar</button>
      </form>
      <button id="confirm-delete-btn" class="btn btn-error">
        <i class="fas fa-trash mr-2"></i>Excluir
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
// Fun√ß√µes do Modal de Audi√™ncia (apenas para edi√ß√£o)
async function abrirModalEditarAudiencia(audienciaId) {
  try {
    const response = await fetch(`/api/cadu-audiencia/${audienciaId}`);
    const audiencia = await response.json();
    
    console.log('üìã Dados da audi√™ncia:', audiencia);
    console.log('üîç propensao_compra:', audiencia.propensao_compra);
    
    document.getElementById('modal_audiencia_title').textContent = 'Editar Audi√™ncia';
    document.getElementById('audiencia_id').value = audienciaId;
    document.getElementById('btn_submit_audiencia_text').textContent = 'Atualizar';
    
    document.getElementById('id_audiencia_plataforma').value = audiencia.id_audiencia_plataforma || '';
    document.getElementById('fonte').value = audiencia.fonte || '';
    document.getElementById('nome_audiencia').value = audiencia.nome || '';
    document.getElementById('slug_audiencia').value = audiencia.slug || '';
    document.getElementById('perfil_socioeconomico').value = audiencia.perfil_socioeconomico || '';
    document.getElementById('titulo_chamativo').value = audiencia.titulo_chamativo || '';
    document.getElementById('descricao_curta').value = audiencia.descricao_curta || '';
    document.getElementById('descricao_audiencia').value = audiencia.descricao || '';
    document.getElementById('descricao_comercial').value = audiencia.descricao_comercial || '';
    document.getElementById('cpm_custo').value = audiencia.cpm_custo || '';
    document.getElementById('cpm_venda').value = audiencia.cpm_venda || '';
    document.getElementById('categoria_id_modal').value = audiencia.categoria_id || '';
    
    // Campos demogr√°ficos
    document.getElementById('publico_estimado').value = audiencia.publico_estimado || '';
    document.getElementById('publico_numero').value = audiencia.publico_numero || '';
    document.getElementById('tamanho').value = audiencia.tamanho || '';
    document.getElementById('propensao_compra').value = audiencia.propensao_compra || '';
    console.log('‚úÖ Propens√£o setada no select:', document.getElementById('propensao_compra').value);
    document.getElementById('demografia_homens').value = audiencia.demografia_homens || '';
    document.getElementById('demografia_mulheres').value = audiencia.demografia_mulheres || '';
    document.getElementById('idade_18_24').value = audiencia.idade_18_24 || '';
    document.getElementById('idade_25_34').value = audiencia.idade_25_34 || '';
    document.getElementById('idade_35_44').value = audiencia.idade_35_44 || '';
    document.getElementById('idade_45_mais').value = audiencia.idade_45_mais || '';
    document.getElementById('dispositivo_mobile').value = audiencia.dispositivo_mobile || '';
    document.getElementById('dispositivo_desktop').value = audiencia.dispositivo_desktop || '';
    document.getElementById('dispositivo_tablet').value = audiencia.dispositivo_tablet || '';
    
    if (audiencia.categoria_id) {
      await carregarSubcategoriasModal(audiencia.categoria_id, audiencia.subcategoria_id);
    }
    
    modal_audiencia.showModal();
  } catch (error) {
    console.error('Erro ao carregar audi√™ncia:', error);
    showToast('Erro ao carregar dados da audi√™ncia.', 'error');
  }
}

async function carregarSubcategoriasModal(categoriaId, subcategoriaSelecionada = null) {
  const select = document.getElementById('subcategoria_id_modal');
  select.innerHTML = '<option value="">Carregando...</option>';
  select.disabled = true;
  
  if (!categoriaId) {
    select.innerHTML = '<option value="">Selecione uma subcategoria</option>';
    select.disabled = false;
    return;
  }
  
  try {
    const response = await fetch(`/api/cadu-subcategorias?categoria_id=${categoriaId}`);
    const data = await response.json();
    
    select.innerHTML = '<option value="">Selecione uma subcategoria</option>';
    
    if (data.success && data.subcategorias && data.subcategorias.length > 0) {
      data.subcategorias.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.nome;
        if (subcategoriaSelecionada && sub.id == subcategoriaSelecionada) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Erro ao carregar subcategorias:', error);
    select.innerHTML = '<option value="">Erro ao carregar</option>';
  } finally {
    select.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  console.log('‚úÖ Script de audi√™ncias carregado');
  
  let audienciaIdToDelete = null;
  let statusFiltroAtual = ''; // '', 'ativa', 'inativa'
  
  const filtroId = document.getElementById('filtro-id');
  const filtroCategoria = document.getElementById('filtro-categoria');
  const filtroSubcategoria = document.getElementById('filtro-subcategoria');
  const filtroStatus = document.getElementById('filtro-status');
  const btnLimparFiltros = document.getElementById('btn-limpar-filtros');
  
  // Bot√µes de status (novos √≠cones)
  const btnStatusAtiva = document.getElementById('filtro-status-ativa');
  const btnStatusInativa = document.getElementById('filtro-status-inativa');
  const btnStatusTodos = document.getElementById('filtro-status-todos');

  console.log('Elementos encontrados:', {
    filtroId: !!filtroId,
    filtroCategoria: !!filtroCategoria,
    filtroSubcategoria: !!filtroSubcategoria,
    filtroStatus: !!filtroStatus,
    btnLimparFiltros: !!btnLimparFiltros,
    btnStatusAtiva: !!btnStatusAtiva,
    btnStatusInativa: !!btnStatusInativa,
    btnStatusTodos: !!btnStatusTodos
  });
  
  // Fun√ß√£o para atualizar visual dos bot√µes de status
  function atualizarBotoesStatus(status) {
    statusFiltroAtual = status;
    
    // Reset all buttons
    [btnStatusAtiva, btnStatusInativa, btnStatusTodos].forEach(btn => {
      if (btn) {
        btn.classList.remove('bg-gray-200');
        btn.querySelector('i').classList.remove('text-gray-800');
        btn.querySelector('i').classList.add('text-gray-400');
      }
    });
    
    // Highlight active button
    let activeBtn = null;
    if (status === 'ativa') activeBtn = btnStatusAtiva;
    else if (status === 'inativa') activeBtn = btnStatusInativa;
    else activeBtn = btnStatusTodos;
    
    if (activeBtn) {
      activeBtn.classList.add('bg-gray-200');
      activeBtn.querySelector('i').classList.remove('text-gray-400');
      activeBtn.querySelector('i').classList.add('text-gray-800');
    }
    
    // Sync hidden select for compatibility
    if (filtroStatus) filtroStatus.value = status;
  }
  
  // Status filter button events
  if (btnStatusAtiva) {
    btnStatusAtiva.addEventListener('click', function() {
      atualizarBotoesStatus('ativa');
      aplicarFiltros();
    });
  }
  if (btnStatusInativa) {
    btnStatusInativa.addEventListener('click', function() {
      atualizarBotoesStatus('inativa');
      aplicarFiltros();
    });
  }
  if (btnStatusTodos) {
    btnStatusTodos.addEventListener('click', function() {
      atualizarBotoesStatus('');
      aplicarFiltros();
    });
  }

  // Verificar se deve abrir modal de edi√ß√£o
  const urlParams = new URLSearchParams(window.location.search);
  const editarId = urlParams.get('editar');
  if (editarId) {
    abrirModalEditarAudiencia(parseInt(editarId));
  }
  
  // Destacar linha editada (scroll e highlight)
  const destaqueId = urlParams.get('destaque');
  if (destaqueId) {
    const linhaDestaque = document.getElementById('audiencia-' + destaqueId);
    if (linhaDestaque) {
      // Scroll suave para a linha
      setTimeout(() => {
        linhaDestaque.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Destacar com anima√ß√£o
        linhaDestaque.style.transition = 'background-color 0.3s';
        linhaDestaque.style.backgroundColor = '#72cd8040';
        setTimeout(() => {
          linhaDestaque.style.backgroundColor = '';
        }, 3000);
      }, 300);
    }
  }

  // Event listeners do Modal de Audi√™ncia
  const formAudiencia = document.getElementById('form_audiencia');
  const nomeAudiencia = document.getElementById('nome_audiencia');
  const slugAudiencia = document.getElementById('slug_audiencia');
  const categoriaModal = document.getElementById('categoria_id_modal');
  
  // Auto-gerar slug
  nomeAudiencia.addEventListener('input', function() {
    if (!slugAudiencia.dataset.manual) {
      const slug = this.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugAudiencia.value = slug;
    }
  });
  
  slugAudiencia.addEventListener('input', function() {
    this.dataset.manual = 'true';
  });
  
  // Carregar subcategorias no modal
  categoriaModal.addEventListener('change', function() {
    carregarSubcategoriasModal(this.value);
  });
  
  // Submit do formul√°rio de audi√™ncia
  formAudiencia.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const audienciaId = document.getElementById('audiencia_id').value;
    const formData = new FormData(formAudiencia);
    const url = audienciaId ? `/cadu-audiencias/editar/${audienciaId}` : '/cadu-audiencias/nova';
    
    try {
      const response = await fetch(url, {
        method: 'POST',
        body: formData,
        redirect: 'follow'
      });
      
      if (response.ok || response.redirected) {
        modal_audiencia.close();
        showToast(audienciaId ? 'Audi√™ncia atualizada com sucesso!' : 'Audi√™ncia cadastrada com sucesso!', 'success');
        // Seguir o redirect do servidor para ir para a linha correta
        window.location.href = response.url;
      } else {
        showToast('Erro ao salvar audi√™ncia.', 'error');
      }
    } catch (error) {
      console.error('Erro:', error);
      showToast('Erro ao salvar audi√™ncia.', 'error');
    }
  });

  // Carregar subcategorias ao trocar categoria nos filtros
  filtroCategoria.addEventListener('change', async function() {
    console.log('üîç Categoria mudou para:', this.value);
    const categoriaId = this.value;
    filtroSubcategoria.innerHTML = '<option value="" selected>Todas as subcategorias</option>';
    filtroSubcategoria.disabled = true;

    if (categoriaId) {
      try {
        const response = await fetch(`/api/cadu-subcategorias?categoria_id=${categoriaId}`);
        const data = await response.json();

        if (data.success && data.subcategorias.length > 0) {
          data.subcategorias.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = sub.nome;
            filtroSubcategoria.appendChild(option);
          });
          filtroSubcategoria.disabled = false;
        }
      } catch (error) {
        console.error('Erro ao carregar subcategorias:', error);
      }
    }

    aplicarFiltros();
  });

  // Aplicar filtro ao trocar subcategoria
  filtroSubcategoria.addEventListener('change', aplicarFiltros);

  // Aplicar filtro ao digitar ID
  filtroId.addEventListener('input', aplicarFiltros);

  // Limpar filtros
  btnLimparFiltros.addEventListener('click', function() {
    filtroId.value = '';
    filtroCategoria.value = '';
    filtroSubcategoria.innerHTML = '<option value="" selected>Todas subcategorias</option>';
    filtroSubcategoria.disabled = true;
    atualizarBotoesStatus('');
    aplicarFiltros();
  });

  // Inicializar contador na carga da p√°gina
  atualizarMensagemVazia();

  // Fun√ß√£o para aplicar filtros
  function aplicarFiltros() {
    const idFiltro = filtroId.value.trim().toLowerCase();
    const categoriaId = filtroCategoria.value;
    const subcategoriaId = filtroSubcategoria.value;
    const statusFiltro = statusFiltroAtual;

    console.log('Filtros aplicados:', { idFiltro, categoriaId, subcategoriaId, statusFiltro });

    // Filtrar linhas da tabela desktop
    const tableRows = document.querySelectorAll('table tbody tr');
    let visibleCount = 0;
    tableRows.forEach(row => {
      const rowCategoriaId = row.getAttribute('data-categoria-id');
      const rowSubcategoriaId = row.getAttribute('data-subcategoria-id');
      const statusAttr = row.getAttribute('data-status');
      const rowId = row.cells[0]?.textContent.trim().toLowerCase() || '';
      
      let showRow = true;

      if (idFiltro) {
        if (!rowId.includes(idFiltro)) {
          showRow = false;
        }
      }

      if (categoriaId && showRow) {
        if (String(rowCategoriaId) !== String(categoriaId)) {
          showRow = false;
        }
      }

      if (subcategoriaId && showRow) {
        if (String(rowSubcategoriaId) !== String(subcategoriaId)) {
          showRow = false;
        }
      }

      if (statusFiltro && showRow) {
        if (statusAttr !== statusFiltro) {
          showRow = false;
        }
      }

      row.style.display = showRow ? '' : 'none';
      if (showRow) visibleCount++;
    });

    console.log(`Linhas vis√≠veis: ${visibleCount} de ${tableRows.length}`);

    // Filtrar cards mobile
    const mobileCards = document.querySelectorAll('.block.md\\:hidden .card');
    mobileCards.forEach(card => {
      const cardCategoriaId = card.getAttribute('data-categoria-id');
      const cardSubcategoriaId = card.getAttribute('data-subcategoria-id');
      const statusAttr = card.getAttribute('data-status');
      const cardIdElement = card.querySelector('.badge-neutral');
      const cardId = cardIdElement ? cardIdElement.textContent.replace('#', '').trim().toLowerCase() : '';

      let showCard = true;

      if (idFiltro) {
        if (!cardId.includes(idFiltro)) {
          showCard = false;
        }
      }

      if (categoriaId && showCard) {
        if (String(cardCategoriaId) !== String(categoriaId)) {
          showCard = false;
        }
      }

      if (subcategoriaId && showCard) {
        if (String(cardSubcategoriaId) !== String(subcategoriaId)) {
          showCard = false;
        }
      }

      if (statusFiltro && showCard) {
        if (statusAttr !== statusFiltro) {
          showCard = false;
        }
      }

      card.style.display = showCard ? '' : 'none';
    });

    // Atualizar mensagem de "Nenhuma audi√™ncia" se necess√°rio
    atualizarMensagemVazia();
  }

  function atualizarMensagemVazia() {
    const tableRows = document.querySelectorAll('table tbody tr');
    const visibleRows = Array.from(tableRows).filter(row => {
      const display = row.style.display;
      return display !== 'none';
    });
    
    const mobileCards = document.querySelectorAll('.block.md\\:hidden .card');
    const visibleCards = Array.from(mobileCards).filter(card => {
      const display = card.style.display;
      return display !== 'none';
    });

    // Atualizar contador
    const contadorElement = document.getElementById('contador-visiveis');
    if (contadorElement) {
      contadorElement.textContent = visibleRows.length;
    }
    
    // Atualizar contador do header
    const contadorHeader = document.getElementById('contador-header');
    if (contadorHeader) {
      contadorHeader.textContent = visibleRows.length;
    }
  }

  // Toggle Status
  document.querySelectorAll('.btn-toggle-status').forEach(btn => {
    btn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const audienciaId = this.dataset.audienciaId;
      const button = this;
      
      console.log('Toggle status para audiencia:', audienciaId);
      
      try {
        const response = await fetch(`/api/cadu-audiencias/toggle-status/${audienciaId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
          // Atualizar visualmente sem reload
          const isActive = data.new_status === 'ativa';
          button.textContent = isActive ? 'Ativa' : 'Inativa';
          button.style.backgroundColor = isActive ? '#10b981' : '#ef4444';
          button.style.color = 'white';
          button.title = `Clique para ${isActive ? 'desativar' : 'ativar'}`;
          
          // Atualizar data-status da linha para os filtros funcionarem
          const row = button.closest('tr');
          if (row) {
            row.dataset.status = isActive ? 'ativa' : 'inativa';
          }
          
          // Toast de sucesso
          mostrarToast(data.message || 'Status alterado com sucesso!', 'success');
        } else {
          mostrarToast('Erro ao alterar status: ' + (data.message || 'Erro desconhecido'), 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarToast('Erro ao alterar status da audi√™ncia', 'error');
      }
    });
  });

  // Delete
  document.querySelectorAll('.btn-delete').forEach(btn => {
    btn.addEventListener('click', function() {
      audienciaIdToDelete = this.dataset.audienciaId;
      const audienciaNome = this.dataset.audienciaNome;
      
      document.getElementById('delete-audiencia-nome').textContent = audienciaNome;
      document.getElementById('modal-delete').showModal();
    });
  });

  document.getElementById('confirm-delete-btn').addEventListener('click', async function() {
    if (!audienciaIdToDelete) return;

    try {
      const response = await fetch(`/cadu-audiencias/deletar/${audienciaIdToDelete}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.success) {
        window.location.reload();
      } else {
        showToast('Erro ao excluir: ' + (data.message || 'Erro desconhecido'), 'error');
      }
    } catch (error) {
      console.error('Erro:', error);
      showToast('Erro ao excluir audi√™ncia', 'error');
    }
  });

  // ==================== GERA√á√ÉO DE IMAGENS ====================
  
  // Event listener para bot√µes de gerar imagem
  document.querySelectorAll('.btn-gerar-imagem').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.dataset.audienciaId;
      const nome = this.dataset.audienciaNome;
      const categoria = this.dataset.audienciaCategoria;
      const descricao = this.dataset.audienciaDescricao;
      const imagemUrl = this.dataset.audienciaImagem;
      
      abrirModalGerarImagem(id, nome, categoria, descricao, imagemUrl);
    });
  });
  
  let imagemAtualUrl = null;
  let audienciaAtualId = null;

  window.abrirModalGerarImagem = async function(id, nome, categoria, descricao, imagemUrl) {
    console.log('Dados recebidos:', { id, nome, categoria, descricao, imagemUrl });
    console.log('imagemUrl type:', typeof imagemUrl, 'value:', imagemUrl, 'trimmed:', imagemUrl ? imagemUrl.trim() : 'null');
    
    audienciaAtualId = id;
    
    document.getElementById('modal-titulo').textContent = `Gerar Imagem - ${nome}`;
    document.getElementById('modal-categoria').textContent = categoria || 'Sem categoria';
    document.getElementById('audiencia-id').value = id;
    document.getElementById('audiencia-descricao').value = descricao;
    
    // LIMPAR preview anterior PRIMEIRO
    const imgElement = document.getElementById('preview-imagem');
    imgElement.src = '';
    imgElement.onload = null;
    imgElement.onerror = null;
    imagemAtualUrl = null;
    
    // Resetar para estado vazio
    mostrarEstadoPreview('vazio');
    document.getElementById('acoes-imagem').classList.add('hidden');
    
    // Se j√° tem imagem salva, mostra no preview
    if (imagemUrl && imagemUrl.trim() !== '') {
      console.log('TEM IMAGEM SALVA - Carregando preview...');
      imagemAtualUrl = imagemUrl;
      
      // Configurar callbacks ANTES de definir src
      imgElement.onload = () => {
        console.log('‚úÖ IMAGEM EXISTENTE CARREGOU COM SUCESSO!');
        console.log('üìê Tamanho:', imgElement.naturalWidth, 'x', imgElement.naturalHeight);
        
        mostrarEstadoPreview('imagem');
        document.getElementById('acoes-imagem').classList.remove('hidden');
      };
      imgElement.onerror = (e) => {
        console.error('‚ùå ERRO ao carregar imagem existente:', e, 'URL:', imagemUrl);
        mostrarEstadoPreview('vazio');
        document.getElementById('acoes-imagem').classList.add('hidden');
      };
      
      // Agora sim definir src (dispara o onload)
      console.log('üîÑ Definindo src da imagem existente:', imagemUrl);
      imgElement.src = imagemUrl;
    } else {
      console.log('N√ÉO TEM IMAGEM SALVA - Mostrando estado vazio');
    }
    
    document.getElementById('modal-gerar-imagem').showModal();
    
    await prepararPrompt(nome, categoria, descricao);
  };

  async function prepararPrompt(nome, categoria, descricao) {
    // v2 - Descri√ß√£o opcional
    const textarea = document.getElementById('prompt-textarea');
    textarea.value = 'Carregando prompt...';
    textarea.disabled = true;
    
    try {
      // Garantir que pelo menos o nome existe
      if (!nome || nome.trim() === '') {
        throw new Error('Nome da audi√™ncia √© obrigat√≥rio');
      }
      
      const response = await fetch('/api/preparar-prompt-imagem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nome_audiencia: nome.trim(),
          categoria: categoria ? categoria.trim() : '',
          descricao: descricao ? descricao.trim() : ''
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        textarea.value = data.prompt;
        textarea.disabled = false;
      } else {
        throw new Error(data.error || 'Erro ao preparar prompt');
      }
    } catch (error) {
      console.error('Erro:', error);
      textarea.value = 'Erro ao gerar prompt. Tente novamente.';
      textarea.disabled = false;
      mostrarToast('Erro ao preparar prompt', 'error');
    }
  }

  window.regenerarPrompt = async function() {
    const nome = document.getElementById('modal-titulo').textContent.replace('Gerar Imagem - ', '');
    const categoria = document.getElementById('modal-categoria').textContent;
    const descricao = document.getElementById('audiencia-descricao').value;
    await prepararPrompt(nome, categoria, descricao);
  };

  window.gerarImagem = async function() {
    const prompt = document.getElementById('prompt-textarea').value.trim();
    const modelo = document.getElementById('modelo-imagem').value;
    
    if (!prompt || prompt.length < 50) {
      mostrarToast('Prompt muito curto. M√≠nimo 50 caracteres.', 'warning');
      return;
    }
    
    mostrarEstadoPreview('loading');
    document.getElementById('btn-gerar-imagem').disabled = true;
    document.getElementById('status-geracao').textContent = `Gerando com ${modelo.split('/')[1]}...`;
    
    try {
      const response = await fetch('/api/gerar-imagem-audiencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: prompt,
          modelo: modelo,
          audiencia_id: audienciaAtualId
        })
      });
      
      const data = await response.json();
      
      console.log('Resposta da gera√ß√£o:', data);
      
      if (data.success && data.image_url) {
        imagemAtualUrl = data.image_url;
        const imgElement = document.getElementById('preview-imagem');
        console.log('URL da imagem:', data.image_url);
        console.log('Elemento img:', imgElement);
        
        // Configurar callbacks antes de definir src
        imgElement.onload = () => {
          console.log('‚úÖ IMAGEM CARREGOU COM SUCESSO!');
          console.log('üìê Tamanho:', imgElement.naturalWidth, 'x', imgElement.naturalHeight);
          console.log('üé® Elemento:', imgElement);
          console.log('üîç Computed style:', window.getComputedStyle(imgElement).display);
          console.log('üîç Inline style:', imgElement.style.display);
          console.log('üîç Opacity:', window.getComputedStyle(imgElement).opacity);
          console.log('üîç Visibility:', window.getComputedStyle(imgElement).visibility);
          console.log('üîç Z-index:', window.getComputedStyle(imgElement).zIndex);
          
          mostrarEstadoPreview('imagem');
          
          // Verificar DEPOIS de mostrar
          setTimeout(() => {
          console.log('üîç DEPOIS de mostrarEstadoPreview:');
          console.log('  - display:', window.getComputedStyle(imgElement).display);
          console.log('  - opacity:', window.getComputedStyle(imgElement).opacity);
          console.log('  - visibility:', window.getComputedStyle(imgElement).visibility);
          
          // Verificar container pai
          const container = document.getElementById('preview-container');
          console.log('üì¶ Container pai:', container);
          console.log('üì¶ Container display:', window.getComputedStyle(container).display);
          console.log('üì¶ Container overflow:', window.getComputedStyle(container).overflow);
          console.log('üì¶ Container height:', container.offsetHeight);
          console.log('üì¶ Container width:', container.offsetWidth);
          
          // FOR√áAR se necess√°rio
          if (window.getComputedStyle(imgElement).display === 'none') {
            console.error('‚ö†Ô∏è AINDA EST√Å DISPLAY NONE! For√ßando...');
            imgElement.style.display = 'block !important';
          }
          if (window.getComputedStyle(imgElement).opacity === '0') {
            console.error('‚ö†Ô∏è OPACITY √â 0! For√ßando...');
            imgElement.style.opacity = '1';
          }
        }, 100);          document.getElementById('acoes-imagem').classList.remove('hidden');
          document.getElementById('status-geracao').textContent = 'Gerada com sucesso';
          mostrarToast('Imagem gerada com sucesso!', 'success');
        };
        imgElement.onerror = (e) => {
          console.error('‚ùå ERRO ao carregar imagem:', e);
          console.error('URL que falhou:', data.image_url);
          mostrarEstadoPreview('vazio');
          mostrarToast('Erro ao carregar imagem. URL: ' + data.image_url, 'error');
        };
        
        // Agora sim definir a src (isso dispara o onload)
        console.log('üîÑ Definindo src da imagem:', data.image_url);
        imgElement.src = data.image_url;
      } else {
        throw new Error(data.error || 'Erro ao gerar imagem');
      }
    } catch (error) {
      console.error('Erro:', error);
      mostrarEstadoPreview('vazio');
      document.getElementById('status-geracao').textContent = 'Erro na gera√ß√£o';
      mostrarToast('Erro ao gerar imagem. Tente novamente.', 'error');
    } finally {
      document.getElementById('btn-gerar-imagem').disabled = false;
    }
  };

  function mostrarEstadoPreview(estado) {
    console.log('Mostrando estado:', estado);
    const vazio = document.getElementById('preview-vazio');
    const loading = document.getElementById('preview-loading');
    const imagem = document.getElementById('preview-imagem');
    
    console.log('Elementos:', { vazio, loading, imagem });
    
    // Esconder todos
    vazio.style.display = 'none';
    loading.style.display = 'none';
    imagem.style.display = 'none';
    
    // For√ßar reflow (force browser repaint)
    void imagem.offsetHeight;
    
    // Mostrar o estado solicitado
    if (estado === 'vazio') {
      vazio.style.display = 'flex';
    } else if (estado === 'loading') {
      loading.style.display = 'flex';
    } else if (estado === 'imagem') {
      imagem.style.display = 'block';
      imagem.style.opacity = '1';
      imagem.style.visibility = 'visible';
      
      // For√ßar reflow novamente
      void imagem.offsetHeight;
      
      console.log('Imagem deve estar vis√≠vel agora. Style:', imagem.style.display);
      console.log('üé® Classes:', imagem.className);
      console.log('üé® Parent:', imagem.parentElement);
    }
  }

  window.confirmarImagem = async function() {
    if (!imagemAtualUrl || !audienciaAtualId) {
      mostrarToast('Erro: dados incompletos', 'error');
      return;
    }
    
    const btnConfirmar = document.querySelector('#acoes-imagem button');
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Salvando...';
    
    try {
      const response = await fetch('/api/salvar-imagem-audiencia', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          audiencia_id: audienciaAtualId,
          imagem_url: imagemAtualUrl
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        mostrarToast('Imagem salva com sucesso!', 'success');
        fecharModalImagem();
        setTimeout(() => location.reload(), 1000);
      } else {
        throw new Error(data.error || 'Erro ao salvar');
      }
    } catch (error) {
      console.error('Erro:', error);
      mostrarToast('Erro ao salvar imagem', 'error');
      btnConfirmar.disabled = false;
      btnConfirmar.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Confirmar e Salvar Imagem';
    }
  };

  window.fecharModalImagem = function() {
    document.getElementById('modal-gerar-imagem').close();
    imagemAtualUrl = null;
    audienciaAtualId = null;
  };

  function mostrarToast(mensagem, tipo = 'info') {
    const tipoClasse = tipo === 'error' ? 'alert-error' : tipo === 'success' ? 'alert-success' : tipo === 'warning' ? 'alert-warning' : 'alert-info';
    const alert = document.createElement('div');
    alert.className = `alert ${tipoClasse} shadow-lg fixed bottom-4 right-4 w-auto z-50`;
    alert.innerHTML = `<span>${mensagem}</span>`;
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 3000);
  }
});
</script>

<!-- Modal Gerar Imagem -->
<dialog id="modal-gerar-imagem" class="modal">
  <div class="modal-box max-w-5xl w-full p-4">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-3">
      <div>
        <h3 class="font-bold text-base" id="modal-titulo">Gerar Imagem</h3>
        <p class="text-xs text-base-content/60">
          <span class="badge badge-xs" id="modal-categoria">Categoria</span>
        </p>
      </div>
      <button onclick="fecharModalImagem()" class="btn btn-xs btn-circle btn-ghost">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <!-- Grid 2 Colunas -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      
      <!-- COLUNA 1: Prompt Editor -->
      <div class="space-y-2">
        
        <!-- Seletor de Modelo -->
        <div>
          <label class="label py-0">
            <span class="label-text text-xs font-semibold">Modelo de Gera√ß√£o</span>
          </label>
          <select id="modelo-imagem" class="select select-bordered select-sm w-full">
            <option value="google/gemini-2.5-flash-image">Gemini 2.5 Flash Image (Base64)</option>
            <option value="google/gemini-exp-1206:free">Gemini Experimental 1206 (Gratuito)</option>
            <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Gratuito)</option>
            <option value="openai/gpt-4o">GPT-4o (Multimodal)</option>
            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet (Multimodal)</option>
          </select>
        </div>
        
        <div>
          <label class="label py-0">
            <span class="label-text text-xs font-semibold">Prompt para Gera√ß√£o</span>
            <span class="label-text-alt text-[10px] text-base-content/60">Edit√°vel</span>
          </label>
          <textarea 
            id="prompt-textarea" 
            class="textarea textarea-bordered w-full h-40 font-mono text-xs"
            placeholder="Carregando prompt..."></textarea>
          <div class="label py-0">
            <span class="label-text-alt text-[10px]">150-500 caracteres, em ingl√™s, formato 16:9</span>
          </div>
        </div>
        
        <!-- A√ß√µes da Coluna 1 -->
        <div class="flex gap-2">
          <button 
            onclick="regenerarPrompt()" 
            id="btn-regenerar-prompt"
            class="btn btn-xs btn-outline gap-1 flex-1">
            <i class="fas fa-sync-alt"></i>
            Novo Prompt
          </button>
          <button 
            onclick="gerarImagem()" 
            id="btn-gerar-imagem"
            class="btn btn-xs gap-1 flex-1 text-white" style="background-color: #72cd80; border-color: #72cd80;">
            <i class="fas fa-magic"></i>
            Gerar Imagem
          </button>
        </div>
      </div>
      
      <!-- COLUNA 2: Preview da Imagem -->
      <div class="space-y-2">
        <div>
          <label class="label py-0">
            <span class="label-text text-xs font-semibold">Preview da Imagem</span>
            <span class="label-text-alt text-[10px] text-base-content/60" id="status-geracao"></span>
          </label>
          
          <!-- Container com aspect ratio 16:9 - REDUZIDO -->
          <div class="w-full bg-base-200 rounded-lg border-2 border-base-300 flex items-center justify-center overflow-hidden relative" id="preview-container" style="aspect-ratio: 16/9; min-height: 180px; max-height: 220px;">
            
            <!-- Estado Inicial -->
            <div id="preview-vazio" class="text-center p-4 absolute inset-0 flex flex-col items-center justify-center">
              <i class="fas fa-image text-2xl text-base-content/40 mb-1 block"></i>
              <p class="text-xs text-base-content/60">Clique em "Gerar Imagem" para criar</p>
            </div>
            
            <!-- Loading State (oculto por padr√£o) -->
            <div id="preview-loading" class="absolute inset-0 flex flex-col items-center justify-center p-4" style="display: none;">
              <span class="loading loading-spinner loading-md text-primary mb-2"></span>
              <p class="text-xs font-semibold mb-1">Gerando imagem...</p>
              <p class="text-[10px] text-base-content/60">Isso pode levar 20-40 segundos</p>
            </div>
            
            <!-- Imagem Gerada (oculto por padr√£o) -->
            <img id="preview-imagem" class="absolute inset-0 w-full h-full object-cover" style="display: none;" alt="Imagem gerada">
            
          </div>
        </div>
        
        <!-- A√ß√µes da Coluna 2 -->
        <div id="acoes-imagem" class="hidden">
          <button 
            onclick="confirmarImagem()" 
            class="btn btn-success btn-sm w-full gap-2">
            <i class="fas fa-check-circle"></i>
            Confirmar e Salvar Imagem
          </button>
        </div>
      </div>
      
    </div>
    
    <!-- Informa√ß√µes da Audi√™ncia (oculto, usado pelo JS) -->
    <input type="hidden" id="audiencia-id">
    <input type="hidden" id="audiencia-descricao">
    
  </div>
  
  <!-- Backdrop -->
  <form method="dialog" class="modal-backdrop">
    <button onclick="fecharModalImagem()">fechar</button>
  </form>
</dialog>

<!-- Modal de Audi√™ncia -->
<dialog id="modal_audiencia" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-5xl w-[90vw] p-4 max-h-none overflow-visible">
    
    <h3 class="font-bold text-base mb-3">
      <span id="modal_audiencia_title">Nova Audi√™ncia</span>
    </h3>
    
    <form id="form_audiencia" method="post">
      <input type="hidden" id="audiencia_id" name="audiencia_id" value="">
      
      <!-- LINHA 1: ID + Nome + Slug + Categoria + Subcategoria + Fonte -->
      <div class="grid grid-cols-6 gap-2 mb-2">
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">ID Plataforma *</label>
          <input type="text" name="id_audiencia_plataforma" id="id_audiencia_plataforma" required 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="1234567890">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Nome *</label>
          <input type="text" name="nome" id="nome_audiencia" required 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Nome da audi√™ncia">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Slug *</label>
          <input type="text" name="slug" id="slug_audiencia" required 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="slug-automatico">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Categoria *</label>
          <select name="categoria_id" id="categoria_id_modal" class="select select-bordered h-8 min-h-[2rem] text-sm leading-tight w-full" required>
            <option value="">Selecione</option>
            {% for categoria in categorias %}
              <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Subcategoria</label>
          <select name="subcategoria_id" id="subcategoria_id_modal" class="select select-bordered h-8 min-h-[2rem] text-sm leading-tight w-full">
            <option value="">Selecione</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Fonte</label>
          <input type="text" name="fonte" id="fonte" class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Navegg">
        </div>
      </div>

      <!-- LINHA 2: Perfil + P√∫blico + Tamanho + Propens√£o + CPMs -->
      <div class="grid grid-cols-7 gap-2 mb-2">
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Perfil Socioecon.</label>
          <input type="text" name="perfil_socioeconomico" id="perfil_socioeconomico" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="A e B">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">P√∫blico Est.</label>
          <input type="text" name="publico_estimado" id="publico_estimado" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="5M">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">P√∫blico N¬∫</label>
          <input type="number" name="publico_numero" id="publico_numero" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Tamanho</label>
          <input type="text" name="tamanho" id="tamanho" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Grande">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Propens√£o</label>
          <select name="propensao_compra" id="propensao_compra" class="select select-bordered h-8 min-h-[2rem] text-sm leading-tight w-full">
            <option value="">-</option>
            <option value="Baixa">Baixa</option>
            <option value="M√©dia">M√©dia</option>
            <option value="Alta">Alta</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">CPM Custo</label>
          <input type="number" step="0.01" name="cpm_custo" id="cpm_custo" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0.00">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">CPM Venda</label>
          <input type="number" step="0.01" name="cpm_venda" id="cpm_venda" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0.00">
        </div>
      </div>

      <!-- LINHA 3: Demografia + Idade + Dispositivos -->
      <div class="grid grid-cols-9 gap-2 mb-2">
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Homens %</label>
          <input type="number" step="0.01" name="demografia_homens" id="demografia_homens" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Mulheres %</label>
          <input type="number" step="0.01" name="demografia_mulheres" id="demografia_mulheres" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">18-24 %</label>
          <input type="number" step="0.01" name="idade_18_24" id="idade_18_24" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">25-34 %</label>
          <input type="number" step="0.01" name="idade_25_34" id="idade_25_34" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">35-44 %</label>
          <input type="number" step="0.01" name="idade_35_44" id="idade_35_44" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">45+ %</label>
          <input type="number" step="0.01" name="idade_45_mais" id="idade_45_mais" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Mobile %</label>
          <input type="number" step="0.01" name="dispositivo_mobile" id="dispositivo_mobile" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Desktop %</label>
          <input type="number" step="0.01" name="dispositivo_desktop" id="dispositivo_desktop" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Tablet %</label>
          <input type="number" step="0.01" name="dispositivo_tablet" id="dispositivo_tablet" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="0" min="0" max="100">
        </div>
      </div>

      <!-- LINHA 4: T√≠tulo + Descri√ß√µes -->
      <div class="grid grid-cols-4 gap-2 mb-2">
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">T√≠tulo Chamativo</label>
          <input type="text" name="titulo_chamativo" id="titulo_chamativo" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="T√≠tulo de impacto">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Descri√ß√£o Curta</label>
          <input type="text" name="descricao_curta" id="descricao_curta" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Resumo">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Descri√ß√£o Completa</label>
          <input type="text" name="descricao" id="descricao_audiencia" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Descri√ß√£o detalhada">
        </div>
        <div class="form-control">
          <label class="label py-0 text-xs font-semibold">Descri√ß√£o Comercial</label>
          <input type="text" name="descricao_comercial" id="descricao_comercial" 
                 class="input input-bordered h-8 min-h-[2rem] text-sm w-full" placeholder="Pitch de vendas">
        </div>
      </div>

      <!-- Bot√µes -->
      <div class="modal-action mt-3 pt-3 border-t">
        <button type="button" onclick="modal_audiencia.close()" class="btn btn-ghost btn-sm">Cancelar</button>
        <button type="submit" class="btn btn-sm text-white" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-save mr-1"></i><span id="btn_submit_audiencia_text">Cadastrar</span>
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Cache buster: v2.1 - Unsplash placeholder -->

{% endblock %}
