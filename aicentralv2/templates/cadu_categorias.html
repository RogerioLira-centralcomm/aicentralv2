{% extends 'base_tailwind.html' %}

{% block title %}Cadu Categorias - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Cadu Categorias</h1>
      <p class="text-sm text-base-content/70 mt-1">Gerencie as categorias do catálogo de audiências</p>
    </div>
    <a href="{{ url_for('cadu_categorias_novo') }}" class="btn btn-primary">
      <i class="fas fa-plus mr-2"></i>Nova Categoria
    </a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="bg-base-100 rounded-xl overflow-hidden">
    {% if categorias %}
      <!-- Filtros -->
      <div class="p-4 border-b border-base-300">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <!-- Pesquisa por Descrição -->
          <div class="flex items-center gap-3">
            <label class="label font-semibold text-sm py-1">Pesquisar:</label>
            <input 
              type="text" 
              id="pesquisa_categoria" 
              oninput="filtrarCategorias()" 
              class="input input-bordered input-sm flex-1" 
              placeholder="Digite o nome ou descrição..."
            >
          </div>
          
          <!-- Filtro por Status -->
          <div class="flex items-center gap-3">
            <label class="label font-semibold text-sm py-1">Status:</label>
            <select id="filtro_status" onchange="filtrarCategorias()" class="select select-bordered select-sm flex-1 h-10 min-h-10">
              <option value="">Todos os status</option>
              <option value="ativa">Ativas</option>
              <option value="inativa">Inativas</option>
            </select>
          </div>
        </div>
        <div class="mt-2">
          <span id="contador_filtro" class="text-sm text-base-content/70"></span>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="table table-xs w-full" id="tabela_categorias">
          <thead class="bg-primary text-white">
            <tr>
              <th class="text-left font-bold uppercase">Categoria</th>
              <th class="text-left font-bold uppercase">Descrição</th>
              <th class="text-center font-bold uppercase w-24">Audiências</th>
              <th class="text-center font-bold uppercase w-20">Ordem</th>
              <th class="text-center font-bold uppercase w-24">Status</th>
              <th class="text-center font-bold uppercase w-32">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for cat in categorias %}
            <tr class="hover {% if not cat.is_active %}opacity-60{% endif %}" data-status="{{ 'ativa' if cat.is_active else 'inativa' }}">
              <td>
                <div class="flex items-center gap-3">
                  {% if cat.icone %}
                  <div class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-lg w-8 h-8 flex items-center justify-center">
                      <i class="{{ cat.icone }} text-sm"></i>
                    </div>
                  </div>
                  {% elif cat.cor_hex %}
                  <div class="w-8 h-8 rounded-lg border-2 border-base-300" style="background-color: {{ cat.cor_hex }};"></div>
                  {% else %}
                  <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-lg w-8 h-8">
                      <span class="text-xs">{{ cat.nome[0:2]|upper if cat.nome else 'CA' }}</span>
                    </div>
                  </div>
                  {% endif %}
                  <div>
                    <div class="font-semibold text-base-content flex items-center gap-2">
                      {{ cat.nome }}
                      {% if cat.is_featured %}
                      <i class="fas fa-star text-warning text-xs" title="Destaque"></i>
                      {% endif %}
                    </div>
                    {% if cat.slug %}
                    <div class="text-xs text-base-content/50 font-mono">{{ cat.slug }}</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <div class="text-xs text-base-content/70 line-clamp-2 max-w-md">
                  {{ cat.descricao or '-' }}
                </div>
              </td>
              <td class="text-center">
                <span class="badge badge-sm badge-info badge-ghost">{{ cat.total_audiencias or 0 }}</span>
              </td>
              <td class="text-center">
                <span class="text-xs">{{ cat.ordem_exibicao or 0 }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-sm {% if cat.is_active %}badge-success{% else %}badge-error{% endif %}">
                  {{ 'Ativa' if cat.is_active else 'Inativa' }}
                </span>
              </td>
              <td class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <a href="{{ url_for('cadu_categorias_detalhes', id_categoria=cat.id) }}" 
                     class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors duration-200"
                     title="Ver detalhes">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ url_for('cadu_categorias_editar', id_categoria=cat.id) }}" 
                     class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors duration-200"
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="mb-2 text-base-content/60 text-sm">Nenhuma categoria cadastrada.</p>
        <a href="{{ url_for('cadu_categorias_novo') }}" class="btn btn-primary btn-sm">
          <i class="fas fa-plus mr-2 text-xs"></i>Criar Primeira Categoria
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
function filtrarCategorias() {
  const pesquisa = document.getElementById('pesquisa_categoria').value.toLowerCase();
  const statusFiltro = document.getElementById('filtro_status').value.toLowerCase();
  const tabela = document.getElementById('tabela_categorias');
  const linhas = tabela.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
  
  let visivel = 0;
  let total = linhas.length;
  
  for (let i = 0; i < linhas.length; i++) {
    const linha = linhas[i];
    const nome = linha.cells[0].textContent.toLowerCase();
    const descricao = linha.cells[1].textContent.toLowerCase();
    const statusLinha = linha.getAttribute('data-status');
    
    let mostrarPesquisa = true;
    let mostrarStatus = true;
    
    // Filtro de pesquisa
    if (pesquisa) {
      mostrarPesquisa = nome.includes(pesquisa) || descricao.includes(pesquisa);
    }
    
    // Filtro de status
    if (statusFiltro) {
      mostrarStatus = statusLinha === statusFiltro;
    }
    
    if (mostrarPesquisa && mostrarStatus) {
      linha.style.display = '';
      visivel++;
    } else {
      linha.style.display = 'none';
    }
  }
  
  // Atualizar contador
  document.getElementById('contador_filtro').textContent = 
    `Mostrando ${visivel} de ${total} categoria(s)`;
}

// Inicializar contador ao carregar
document.addEventListener('DOMContentLoaded', function() {
  filtrarCategorias();
});
</script>
{% endblock %}
