{% extends 'base_tailwind.html' %}

{% block title %}Cotações - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (estilo CRM) -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Título + Link CRM -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Cotações</h1>
        <a href="{{ url_for('crm_pipeline') }}" class="text-xs text-gray-500 hover:text-gray-700">
          <i class="fa-solid fa-columns mr-1"></i>Pipeline
        </a>
      </div>
      
      <!-- Filtros Inline -->
      <form id="filtros_form" class="flex items-center gap-3">
        <!-- Executivo -->
        <select name="executivo_id" id="filtro_executivo" onchange="aplicarFiltros()" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 160px;">
          <option value="">Todos executivos</option>
          {% for vendedor in vendedores %}
            <option value="{{ vendedor.id_contato_cliente }}" {% if request.args.get('responsavel_comercial')|string == vendedor.id_contato_cliente|string %}selected{% endif %}>
              {{ vendedor.nome_completo }}
            </option>
          {% endfor %}
        </select>
        
        <!-- Mês -->
        <select name="mes" id="filtro_mes" onchange="aplicarFiltros()" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 120px;">
          <option value="">Todos meses</option>
          <option value="01" {% if request.args.get('mes') == '01' %}selected{% endif %}>Janeiro</option>
          <option value="02" {% if request.args.get('mes') == '02' %}selected{% endif %}>Fevereiro</option>
          <option value="03" {% if request.args.get('mes') == '03' %}selected{% endif %}>Março</option>
          <option value="04" {% if request.args.get('mes') == '04' %}selected{% endif %}>Abril</option>
          <option value="05" {% if request.args.get('mes') == '05' %}selected{% endif %}>Maio</option>
          <option value="06" {% if request.args.get('mes') == '06' %}selected{% endif %}>Junho</option>
          <option value="07" {% if request.args.get('mes') == '07' %}selected{% endif %}>Julho</option>
          <option value="08" {% if request.args.get('mes') == '08' %}selected{% endif %}>Agosto</option>
          <option value="09" {% if request.args.get('mes') == '09' %}selected{% endif %}>Setembro</option>
          <option value="10" {% if request.args.get('mes') == '10' %}selected{% endif %}>Outubro</option>
          <option value="11" {% if request.args.get('mes') == '11' %}selected{% endif %}>Novembro</option>
          <option value="12" {% if request.args.get('mes') == '12' %}selected{% endif %}>Dezembro</option>
        </select>
        
        <!-- Busca Cliente -->
        <div class="relative">
          <input type="text" name="busca" id="filtro_busca" 
                 value="{{ request.args.get('busca', '') }}"
                 placeholder="Buscar cliente..."
                 class="text-sm bg-gray-50 border border-gray-200 rounded pl-8 pr-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" 
                 style="min-width: 180px;"
                 onkeyup="debounceAplicarFiltros()">
          <i class="fa-solid fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
        </div>
        
        <!-- Status Icons -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          {% set status_icons = [
            ('Rascunho', 'fa-file-pen', request.args.get('status') == 'Rascunho'),
            ('Em Análise', 'fa-magnifying-glass', request.args.get('status') == 'Em Análise'),
            ('Enviada', 'fa-paper-plane', request.args.get('status') == 'Enviada'),
            ('Aprovada', 'fa-circle-check', request.args.get('status') == 'Aprovada'),
            ('Rejeitada', 'fa-circle-xmark', request.args.get('status') == 'Rejeitada')
          ] %}
          {% for status, icon, active in status_icons %}
          <button type="button" onclick="filtrarPorStatus('{{ status }}')" 
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors {% if active %}bg-gray-200{% endif %}" 
                  title="{{ status }}">
            <i class="fa-solid {{ icon }} text-sm text-gray-{% if active %}800{% else %}400{% endif %}"></i>
          </button>
          {% endfor %}
        </div>
      </form>
      
      <!-- Botão Nova Cotação -->
      <a href="{{ url_for('cotacao_nova') }}" class="btn btn-sm text-white" style="background-color: #72cd80; border-color: #72cd80;">
        <i class="fas fa-plus mr-1"></i>Nova
      </a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="alert alert-sm {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span class="text-sm">{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabela de Cotações -->
  <div class="bg-white rounded border border-gray-200 overflow-hidden">
    {% if cotacoes %}
      <table class="table table-sm table-fixed w-full">
        <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
          <tr>
            <th class="font-semibold py-3 w-32">Cotação</th>
            <th class="font-semibold w-48">Cliente / Campanha</th>
            <th class="font-semibold w-24">Executivo</th>
            <th class="font-semibold text-center w-20">Período</th>
            <th class="font-semibold text-right w-28">Valor</th>
            <th class="font-semibold text-center w-20">Status</th>
            <th class="font-semibold text-center w-24">Itens</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          {% for cotacao in cotacoes %}
          {% set hoje = now().date() %}
          {% set dias_para_inicio = (cotacao.periodo_inicio - hoje).days if cotacao.periodo_inicio else none %}
          {% set status_enviada = cotacao.status == 'Enviada' %}
          {% set sem_responsavel = not cotacao.responsavel_nome %}
          {% set urgente = status_enviada and dias_para_inicio is not none and dias_para_inicio >= 0 and dias_para_inicio <= 7 %}
          
          <tr class="border-b border-gray-100 hover:bg-gray-50 cursor-pointer {% if urgente %}bg-amber-50{% endif %}" 
              onclick="window.location.href='/cotacoes/{{ cotacao.id }}/detalhes'">
            <!-- Cotação -->
            <td class="py-3" onclick="event.stopPropagation()">
              <div class="flex flex-col">
                <a href="/cotacoes/{{ cotacao.id }}/detalhes" class="font-mono text-xs font-semibold text-gray-700 hover:text-gray-900 hover:underline">
                  {{ cotacao.numero_cotacao }}
                </a>
                <span class="text-xs text-gray-400">{{ cotacao.created_at.strftime('%d/%m/%Y') if cotacao.created_at else '-' }}</span>
              </div>
            </td>
            
            <!-- Cliente / Campanha -->
            <td>
              <div class="flex flex-col">
                <span class="font-medium text-gray-800 truncate">{{ cotacao.cliente_nome or 'Sem cliente' }}</span>
                <span class="text-xs text-gray-500 truncate max-w-[180px]">{{ cotacao.nome_campanha or '-' }}</span>
              </div>
            </td>
            
            <!-- Executivo -->
            <td>
              {% if sem_responsavel %}
              <div class="flex items-center gap-1 text-amber-600">
                <i class="fa-solid fa-triangle-exclamation text-xs"></i>
                <span class="text-xs font-medium">Sem responsável</span>
              </div>
              {% else %}
              <span class="text-sm text-gray-700">{{ cotacao.responsavel_nome }}</span>
              {% endif %}
            </td>
            
            <!-- Período -->
            <td class="text-center">
              {% if cotacao.periodo_inicio %}
              <div class="flex flex-col items-center">
                <span class="text-xs text-gray-600">
                  {{ cotacao.periodo_inicio.strftime('%d/%m') if cotacao.periodo_inicio else '-' }}
                  {% if cotacao.periodo_fim %} - {{ cotacao.periodo_fim.strftime('%d/%m') }}{% endif %}
                </span>
                {% if status_enviada and dias_para_inicio is not none %}
                  {% if dias_para_inicio < 0 %}
                  <span class="text-xs font-medium text-red-600"><i class="fa-solid fa-clock mr-1"></i>Já iniciou</span>
                  {% elif dias_para_inicio == 0 %}
                  <span class="text-xs font-medium text-red-600"><i class="fa-solid fa-clock mr-1"></i>Inicia hoje!</span>
                  {% elif dias_para_inicio <= 3 %}
                  <span class="text-xs font-medium text-red-600"><i class="fa-solid fa-clock mr-1"></i>{{ dias_para_inicio }}d para início</span>
                  {% elif dias_para_inicio <= 7 %}
                  <span class="text-xs font-medium text-amber-600"><i class="fa-solid fa-clock mr-1"></i>{{ dias_para_inicio }}d para início</span>
                  {% else %}
                  <span class="text-xs text-gray-400">{{ dias_para_inicio }}d para início</span>
                  {% endif %}
                {% endif %}
              </div>
              {% else %}
              <span class="text-xs text-gray-400">-</span>
              {% endif %}
            </td>
            
            <!-- Valor -->
            <td class="text-right">
              {% if cotacao.valor_total_proposta %}
              <span class="font-semibold text-gray-800">R$ {{ "{:,.2f}".format(cotacao.valor_total_proposta).replace(',', '_').replace('.', ',').replace('_', '.') }}</span>
              {% else %}
              <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            
            <!-- Status (escala de cinza) -->
            <td class="text-center">
              {% set status_display = 'Rascunho' if (cotacao.status == 'Pendente' or not cotacao.status) else cotacao.status %}
              {% if status_display == 'Enviada' %}
              <span class="inline-flex items-center px-2 py-1 text-xs font-semibold rounded bg-gray-800 text-white">
                {{ status_display }}
              </span>
              {% elif status_display == 'Aprovada' %}
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-gray-200 text-gray-700">
                {{ status_display }}
              </span>
              {% elif status_display == 'Rejeitada' %}
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-gray-300 text-gray-600 line-through">
                {{ status_display }}
              </span>
              {% else %}
              <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-500">
                {{ status_display }}
              </span>
              {% endif %}
            </td>
            
            <!-- Contadores -->
            <td class="text-center">
              <div class="flex items-center justify-center gap-2">
                <span class="text-xs text-gray-500" title="Itens"><i class="fa-solid fa-list text-gray-400"></i> {{ cotacao.total_linhas or 0 }}</span>
                <span class="text-xs text-gray-500" title="Audiências"><i class="fa-solid fa-users text-gray-400"></i> {{ cotacao.total_audiencias or 0 }}</span>
                <span class="text-xs text-gray-500" title="Anexos"><i class="fa-solid fa-paperclip text-gray-400"></i> {{ cotacao.total_anexos or 0 }}</span>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Rodapé com contagem -->
      <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex items-center justify-between">
        <p class="text-sm text-gray-600">
          <strong>{{ cotacoes|length }}</strong> cotação(ões)
          {% if request.args.get('status') %}
          <span class="text-gray-400">• Filtro: {{ request.args.get('status') }}</span>
          {% endif %}
        </p>
        
        <!-- Legenda rápida -->
        <div class="flex items-center gap-4 text-xs text-gray-500">
          <span><i class="fa-solid fa-paper-plane text-gray-800 mr-1"></i>Enviada = Aguardando aprovação</span>
          <span><i class="fa-solid fa-triangle-exclamation text-amber-600 mr-1"></i>Sem responsável</span>
          <span class="px-2 py-0.5 bg-amber-50 rounded">Urgente (&lt;7 dias)</span>
        </div>
      </div>
    {% else %}
      <div class="p-8 text-center">
        <i class="fas fa-file-invoice text-4xl text-gray-300 mb-3"></i>
        <p class="text-gray-500">Nenhuma cotação encontrada.</p>
        <a href="{{ url_for('cotacao_nova') }}" class="btn btn-sm mt-4 text-white" style="background-color: #72cd80;">
          <i class="fas fa-plus mr-2"></i>Criar Cotação
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
let debounceTimer;

function debounceAplicarFiltros() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(aplicarFiltros, 500);
}

function aplicarFiltros() {
  const executivo = document.getElementById('filtro_executivo').value;
  const mes = document.getElementById('filtro_mes').value;
  const busca = document.getElementById('filtro_busca').value.trim();
  const urlParams = new URLSearchParams(window.location.search);
  const status = urlParams.get('status');
  
  let params = new URLSearchParams();
  if (executivo) params.set('responsavel_comercial', executivo);
  if (mes) params.set('mes', mes);
  if (busca) params.set('busca', busca);
  if (status) params.set('status', status);
  
  window.location.href = '/cotacoes' + (params.toString() ? '?' + params.toString() : '');
}

function filtrarPorStatus(status) {
  const urlParams = new URLSearchParams(window.location.search);
  const currentStatus = urlParams.get('status');
  
  // Toggle: se já está no status, remove o filtro
  if (currentStatus === status) {
    urlParams.delete('status');
  } else {
    urlParams.set('status', status);
  }
  
  window.location.href = '/cotacoes' + (urlParams.toString() ? '?' + urlParams.toString() : '');
}

function duplicarCotacao(cotacaoId) {
  if (!confirm('Deseja duplicar esta cotação?')) return;
  
  fetch(`/api/cotacoes/${cotacaoId}/duplicar`, {
    method: 'POST'
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast('Cotação duplicada com sucesso!', 'success');
      window.location.href = `/cotacoes/${data.nova_cotacao_id}/detalhes`;
    } else {
      showToast(data.message || 'Erro ao duplicar', 'error');
    }
  })
  .catch(err => {
    console.error(err);
    showToast('Erro ao duplicar cotação', 'error');
  });
}
</script>
{% endblock %}
