{% extends 'base_tailwind.html' %}

{% block title %}Cotação {{ cotacao.numero_cotacao }} - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold">Cotação {{ cotacao.numero_cotacao }}</h1>
      <p class="text-base-content/70">{{ cotacao.cliente_nome if cotacao.cliente_nome else 'Cliente não especificado' }}</p>
    </div>
    <div class="flex gap-2">
      <a href="{{ url_for('cotacoes_list') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>Voltar
      </a>
      
      <!-- Dropdown Ações Rápidas -->
      <div class="dropdown dropdown-end">
        <label tabindex="0" class="btn text-white" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-bolt mr-2"></i>Ações Rápidas
          <i class="fas fa-chevron-down ml-2"></i>
        </label>
        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-lg bg-base-100 rounded-box w-64 mt-2">
          <li><a onclick="document.getElementById('modal_link_publico').showModal()"><i class="fas fa-link mr-2"></i>Ver Link Público</a></li>
          <li class="menu-title"><span>Emails</span></li>
          <li><a onclick="abrirModalEmail('enviar_cotacao')"><i class="fas fa-paper-plane mr-2"></i>Enviar Cotação</a></li>
          <li><a onclick="abrirModalEmail('email_aprovacao')"><i class="fas fa-check-circle mr-2 text-success"></i>Email de Aprovação</a></li>
          <li><a onclick="abrirModalEmail('email_recusa')"><i class="fas fa-times-circle mr-2 text-error"></i>Email de Recusa</a></li>
          <li class="menu-title"><span>Outras ações</span></li>
          <li><a onclick="duplicarCotacao()"><i class="fas fa-copy mr-2"></i>Duplicar Cotação</a></li>
          <li><a onclick="exportarPDF()"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF</a></li>
        </ul>
      </div>
      
      <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-error btn-deletar">
        <i class="fas fa-trash"></i>Deletar
      </button>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Coluna Principal (2/3) -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Informações Básicas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Informações Básicas</h2>
            <button onclick="document.getElementById('modal_basico').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Cliente</p>
              <p class="font-semibold">{{ cotacao.cliente_nome if cotacao.cliente_nome else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Campanha</p>
              <p class="font-semibold">{{ cotacao.nome_campanha if cotacao.nome_campanha else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Responsável Comercial</p>
              <p class="font-semibold">{{ cotacao.responsavel_nome if cotacao.responsavel_nome else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Contato do Cliente</p>
              <p class="font-semibold">{{ cotacao.contato_cliente_nome if cotacao.contato_cliente_nome else '-' }}</p>
            </div>
            {% if cotacao.briefing_id %}
            <div>
              <p class="text-sm text-base-content/70">Briefing</p>
              <p class="font-semibold">
                {% if briefing_atual %}
                  <a href="{{ url_for('briefing_edit', briefing_id=cotacao.briefing_id) }}" class="link link-primary">
                    {{ briefing_atual.titulo }}
                  </a>
                  {% if briefing_atual.status %}
                    <span class="badge badge-sm ml-2">{{ briefing_atual.status }}</span>
                  {% endif %}
                {% else %}
                  ID: {{ cotacao.briefing_id }}
                {% endif %}
              </p>
            </div>
            {% endif %}
            <div>
              <p class="text-sm text-base-content/70">Origem</p>
              <p class="font-semibold">
                {% if cotacao.origem == 'CADU_WEB' %}
                  CADU Web
                {% elif cotacao.origem == 'API' %}
                  API
                {% elif cotacao.origem == 'ADMIN' %}
                  Admin
                {% else %}
                  {{ cotacao.origem if cotacao.origem else '-' }}
                {% endif %}
              </p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Status</p>
              <div class="badge" 
                {% if cotacao.status == 'aprovada' %}
                  badge-success
                {% elif cotacao.status == 'rejeitada' %}
                  badge-error
                {% elif cotacao.status == 'expirada' %}
                  badge-warning
                {% else %}
                  badge-info
                {% endif %}>
                {{ cotacao.status if cotacao.status else 'pendente' }}
              </div>
            </div>
          </div>

          {% if cotacao.objetivo_campanha %}
          <div class="mt-4 pt-4 border-t">
            <p class="text-sm text-base-content/70 mb-2">Objetivo da Campanha</p>
            <p class="text-sm">{{ cotacao.objetivo_campanha }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Datas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Datas</h2>
            <button onclick="document.getElementById('modal_datas').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Início da Campanha</p>
              <p class="font-semibold">{{ cotacao.periodo_inicio.strftime('%d/%m/%Y') if cotacao.periodo_inicio else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Término da Campanha</p>
              <p class="font-semibold">{{ cotacao.periodo_fim.strftime('%d/%m/%Y') if cotacao.periodo_fim else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Expiração da Cotação</p>
              <p class="font-semibold">{{ cotacao.expires_at.strftime('%d/%m/%Y %H:%M') if cotacao.expires_at else '-' }}</p>
            </div>
            {% if cotacao.proposta_enviada_em %}
            <div>
              <p class="text-sm text-base-content/70">Proposta Enviada em</p>
              <p class="font-semibold">{{ cotacao.proposta_enviada_em.strftime('%d/%m/%Y %H:%M') }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Valores -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Valores</h2>
            <button onclick="document.getElementById('modal_valores').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Budget Estimado</p>
              <p class="font-semibold text-lg">R$ {{ "{:,.2f}".format(cotacao.budget_estimado).replace(',', 'X').replace('.', ',').replace('X', '.') if cotacao.budget_estimado else '0,00' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Valor Total da Proposta</p>
              <p class="font-semibold text-lg text-success">R$ {{ "{:,.2f}".format(cotacao.valor_total_proposta).replace(',', 'X').replace('.', ',').replace('X', '.') if cotacao.valor_total_proposta else '0,00' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalhes da Peça removido - campos estão em linhas -->

    </div>

    <!-- Sidebar (1/3) -->
    <div class="space-y-6">

      <!-- Card de Status -->
      <div class="card bg-base-300">
        <div class="card-body">
          <h3 class="card-title text-lg mb-4">Resumo</h3>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Status:</span>
              <span class="font-semibold">{{ cotacao.status if cotacao.status else 'Pendente' }}</span>
            </div>
            
            <div class="flex justify-between">
              <span>Nº Cotação:</span>
              <span class="font-mono font-semibold">{{ cotacao.numero_cotacao }}</span>
            </div>
            
            <div class="flex justify-between">
              <span>Origem:</span>
              <span class="font-semibold">{{ cotacao.origem if cotacao.origem else '-' }}</span>
            </div>
            
            {% if cotacao.link_publico_ativo %}
            <div class="flex justify-between items-center">
              <span>Link Público:</span>
              <span class="badge badge-success">Ativo</span>
            </div>
            {% endif %}
          </div>

          <div class="divider"></div>

          <div class="flex gap-2">
            {% if cotacao.status != 'aprovada' %}
            <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-success btn-sm flex-1 btn-aprovar">
              <i class="fas fa-check"></i>Aprovar
            </button>
            {% endif %}
            
            {% if cotacao.status != 'rejeitada' %}
            <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-warning btn-sm flex-1 btn-rejeitar">
              <i class="fas fa-times"></i>Rejeitar
            </button>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Card de Datas Importantes -->
      <div class="card bg-base-100">
        <div class="card-body">
          <h3 class="font-bold mb-3">Datas Importantes</h3>
          
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-base-content/70">Criada em:</span>
              <span class="font-semibold">{{ cotacao.created_at.strftime('%d/%m/%Y') if cotacao.created_at else '-' }}</span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-base-content/70">Atualizada em:</span>
              <span class="font-semibold">{{ cotacao.updated_at.strftime('%d/%m/%Y') if cotacao.updated_at else '-' }}</span>
            </div>
            
            {% if cotacao.proposta_enviada_em %}
            <div class="flex justify-between">
              <span class="text-base-content/70">Proposta Enviada:</span>
              <span class="font-semibold">{{ cotacao.proposta_enviada_em.strftime('%d/%m/%Y') }}</span>
            </div>
            {% endif %}
            
            {% if cotacao.aprovada_em %}
            <div class="flex justify-between">
              <span class="text-base-content/70">Aprovada em:</span>
              <span class="font-semibold text-success">{{ cotacao.aprovada_em.strftime('%d/%m/%Y') }}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Card de Ações Rápidas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <h3 class="font-bold mb-3">Ações Rápidas</h3>
          
          <div class="space-y-2">
            <button onclick="document.getElementById('modal_basico').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-edit"></i>Editar Básico
            </button>
            <button onclick="document.getElementById('modal_datas').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-calendar"></i>Editar Datas
            </button>
            <button onclick="document.getElementById('modal_valores').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-dollar-sign"></i>Editar Valores
            </button>
            <button onclick="document.getElementById('modal_observacoes').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-sticky-note"></i>Editar Observações
            </button>
          </div>
        </div>
      </div>

    </div>

  </div>

  <!-- Linhas da Cotação (Largura Total) -->
  <div class="card bg-base-100 mt-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Linhas da Cotação</h2>
        <button onclick="document.getElementById('modal_nova_linha').showModal()" class="btn btn-sm text-white" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-plus mr-1"></i>Nova Linha
        </button>
      </div>

      {% if linhas and linhas|length > 0 %}
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Plataforma</th>
              <th>Produto</th>
              <th>Segmentação</th>
              <th>Formatos</th>
              <th>Canal</th>
              <th>Objetivo/KPI</th>
              <th>Período</th>
              <th>Volume</th>
              <th>Valor Unit.</th>
              <th>Investimento</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for linha in linhas %}
            <tr>
              <td>{{ linha.plataforma if linha.plataforma else '-' }}</td>
              <td>{{ linha.produto if linha.produto else '-' }}</td>
              <td>
                <div class="max-w-xs truncate" title="{{ linha.segmentacao if linha.segmentacao else '-' }}">
                  {{ linha.segmentacao if linha.segmentacao else '-' }}
                </div>
              </td>
              <td>
                <div class="max-w-xs truncate" title="{{ linha.formatos if linha.formatos else '-' }}">
                  {{ linha.formatos if linha.formatos else '-' }}
                </div>
              </td>
              <td>{{ linha.canal if linha.canal else '-' }}</td>
              <td>
                <span class="badge badge-sm badge-{{ 'primary' if linha.objetivo_kpi == 'CPM' else 'neutral' }}">
                  {{ linha.objetivo_kpi if linha.objetivo_kpi else '-' }}
                </span>
              </td>
              <td class="text-xs">
                {% if linha.data_inicio and linha.data_fim %}
                  {{ linha.data_inicio.strftime('%d/%m') if linha.data_inicio else '' }} - {{ linha.data_fim.strftime('%d/%m') if linha.data_fim else '' }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ "{:,}".format(linha.volume_contratado|int).replace(',', '.') if linha.volume_contratado else '-' }}</td>
              <td class="text-xs">
                {% if linha.valor_unitario %}
                  R$ {{ "%.2f"|format(linha.valor_unitario) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if linha.investimento_bruto %}
                  R$ {{ "{:,.2f}".format(linha.investimento_bruto).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <div class="flex gap-1">
                  <button onclick="editarLinha({{ linha.id }})" class="btn btn-xs btn-ghost" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="removerLinha({{ linha.id }})" class="btn btn-xs btn-ghost text-error" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="font-bold">
              <td colspan="9" class="text-right">Total Geral:</td>
              <td>
                {% set total = namespace(value=0) %}
                {% for linha in linhas %}
                  {% if linha.investimento_bruto %}
                    {% set total.value = total.value + linha.investimento_bruto %}
                  {% elif linha.valor_total %}
                    {% set total.value = total.value + linha.valor_total %}
                  {% endif %}
                {% endfor %}
                R$ {{ "{:,.2f}".format(total.value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <p class="text-center text-base-content/50 py-8">Nenhuma linha adicionada ainda</p>
      {% endif %}
    </div>
  </div>

  <!-- Audiências da Cotação (Largura Total) -->
  <div class="card bg-base-100 mt-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Audiências</h2>
        <button onclick="document.getElementById('modal_adicionar_audiencia').showModal()" class="btn btn-sm text-white" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-plus mr-1"></i>Adicionar Audiência
        </button>
      </div>

      {% if audiencias and audiencias|length > 0 %}
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Público</th>
              <th>Categoria</th>
              <th>CPM</th>
              <th>Investimento</th>
              <th>Impressões</th>
              <th>Incluído</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for aud in audiencias %}
            <tr class="{% if not aud.incluido_proposta %}opacity-50{% endif %}">
              <td>{{ aud.audiencia_nome }}</td>
              <td>{{ aud.audiencia_publico if aud.audiencia_publico else '-' }}</td>
              <td>{{ aud.audiencia_categoria if aud.audiencia_categoria else '-' }}</td>
              <td>
                {% if aud.cpm_estimado %}
                  R$ {{ "%.2f"|format(aud.cpm_estimado)|replace('.', ',') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if aud.investimento_sugerido %}
                  R$ {{ "{:,.2f}".format(aud.investimento_sugerido).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ "{:,}".format(aud.impressoes_estimadas).replace(',', '.') if aud.impressoes_estimadas else '-' }}</td>
              <td>
                <input type="checkbox" class="toggle toggle-sm" {% if aud.incluido_proposta %}checked{% endif %} 
                       onchange="toggleIncluirAudiencia({{ aud.id }}, this.checked)">
              </td>
              <td>
                <div class="flex gap-1">
                  <button onclick="editarAudienciaCotacao({{ aud.id }})" class="btn btn-xs btn-ghost" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="removerAudienciaCotacao({{ aud.id }})" class="btn btn-xs btn-ghost text-error" title="Remover">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="font-bold">
              <td colspan="4" class="text-right">Total Investimento:</td>
              <td>
                {% set total_inv = namespace(value=0) %}
                {% for aud in audiencias %}
                  {% if aud.incluido_proposta and aud.investimento_sugerido %}
                    {% set total_inv.value = total_inv.value + aud.investimento_sugerido %}
                  {% endif %}
                {% endfor %}
                R$ {{ "{:,.2f}".format(total_inv.value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
              </td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <p class="text-center text-base-content/50 py-8">Nenhuma audiência adicionada ainda</p>
      {% endif %}
    </div>
  </div>

  <!-- Anexos da Cotação (Largura Total) -->
  <div class="card bg-base-100 mt-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Anexos</h2>
        <button onclick="document.getElementById('modal_adicionar_anexo').showModal()" class="btn btn-sm text-white" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-plus mr-1"></i>Adicionar Anexo
        </button>
      </div>

      <div id="lista_anexos">
        <!-- Lista será carregada via JavaScript -->
        <div class="flex justify-center items-center py-8">
          <span class="loading loading-spinner loading-md"></span>
        </div>
      </div>
    </div>
  </div>

<!-- Comentários da Cotação (Largura Total) -->
<div class="container mx-auto mt-6 px-4 max-w-7xl">
  <div class="card bg-base-100">
    <div class="card-body py-4">
      <!-- Header colapsável -->
      <div class="flex justify-between items-center cursor-pointer" onclick="toggleComentarios()">
        <div class="flex items-center gap-2">
          <h2 class="text-sm font-semibold text-base-content/70">Comentários</h2>
          <span class="badge badge-sm badge-ghost">{{ comentarios|length if comentarios else 0 }}</span>
        </div>
        <i id="icon-comentarios" class="fas fa-chevron-down text-base-content/50 text-xs"></i>
      </div>
      
      <!-- Lista de Comentários (colapsável) -->
      <div id="comentarios-container" class="mt-3 hidden">
        <div id="comentarios-lista" class="mb-4 max-h-64 overflow-y-auto">
          {% if comentarios and comentarios|length > 0 %}
          <div class="space-y-2">
            {% for c in comentarios %}
            <div class="flex justify-between items-start p-2 bg-base-200/50 rounded text-xs">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-medium text-base-content/80">{{ c.user_nome }}</span>
                  <span class="text-base-content/40">{{ c.created_at.strftime('%d/%m/%Y %H:%M') if c.created_at else '' }}</span>
                </div>
                <p class="text-base-content/70 whitespace-pre-wrap">{{ c.comentario }}</p>
              </div>
              {% if session.get('is_admin') %}
              <button onclick="removerComentario({{ c.id }})" class="btn btn-ghost btn-xs text-error opacity-50 hover:opacity-100" title="Remover">
                <i class="fas fa-trash text-xs"></i>
              </button>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-center text-base-content/40 py-3 text-xs">Nenhum comentário ainda</p>
          {% endif %}
        </div>
    </div>
  </div>
</div>

  <!-- Observações (Largura Total) -->
  <div class="card bg-base-100 mt-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Observações</h2>
        <button onclick="document.getElementById('modal_observacoes').showModal()" class="btn btn-sm btn-ghost">
          <i class="fas fa-edit"></i>Editar
        </button>
      </div>
      
      {% if cotacao.observacoes %}
      <div class="mb-4">
        <p class="text-sm text-base-content/70 mb-1">Observações</p>
        <p class="text-sm bg-base-200 p-3 rounded">{{ cotacao.observacoes }}</p>
      </div>
      {% else %}
      <div class="mb-4">
        <p class="text-sm text-base-content/70 mb-1">Observações</p>
        <p class="text-sm text-base-content/50 italic">Sem observações</p>
      </div>
      {% endif %}
      
      {% if cotacao.observacoes_internas %}
      <div>
        <p class="text-sm text-base-content/70 mb-1">Observações Internas</p>
        <p class="text-sm bg-base-200 p-3 rounded">{{ cotacao.observacoes_internas }}</p>
      </div>
      {% else %}
      <div>
        <p class="text-sm text-base-content/70 mb-1">Observações Internas</p>
        <p class="text-sm text-base-content/50 italic">Sem observações internas</p>
      </div>
      {% endif %}
    </div>
  </div>

<!-- ==================== MODAIS DE EDIÇÃO ==================== -->

<!-- Modal Informações Básicas -->
<dialog id="modal_basico" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Informações Básicas</h3>
    
    <form id="form_basico" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Nome da Campanha</span>
        </label>
        <input type="text" id="nome_campanha" class="input input-bordered" value="{{ cotacao.nome_campanha }}">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Responsável Comercial</span>
        </label>
        <select id="responsavel_comercial" class="select select-bordered">
          <option value="">Selecione um responsável</option>
          {% for vendedor in vendedores %}
          <option value="{{ vendedor.id_contato_cliente }}" {% if cotacao.responsavel_comercial == vendedor.id_contato_cliente %}selected{% endif %}>
            {{ vendedor.nome_completo }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Contato do Cliente</span>
        </label>
        <select id="client_user_id" class="select select-bordered">
          <option value="">Selecione um contato</option>
          {% for contato in contatos_cliente %}
          <option value="{{ contato.id_contato_cliente }}" {% if cotacao.client_user_id == contato.id_contato_cliente %}selected{% endif %}>
            {{ contato.nome_completo }}{% if contato.email %} - {{ contato.email }}{% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Briefing</span>
        </label>
        <select id="briefing_id" class="select select-bordered">
          <option value="">Selecione um briefing</option>
          {% for briefing in briefings %}
          <option value="{{ briefing.id }}" {% if cotacao.briefing_id == briefing.id %}selected{% endif %}>
            {{ briefing.titulo }}{% if briefing.status %} ({{ briefing.status }}){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Objetivo da Campanha</span>
        </label>
        <textarea id="objetivo_campanha" class="textarea textarea-bordered" rows="2">{{ cotacao.objetivo_campanha if cotacao.objetivo_campanha else '' }}</textarea>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Status</span>
        </label>
        <select id="status" class="select select-bordered">
          <option value="pendente" {% if cotacao.status == 'pendente' %}selected{% endif %}>Pendente</option>
          <option value="aprovada" {% if cotacao.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
          <option value="rejeitada" {% if cotacao.status == 'rejeitada' %}selected{% endif %}>Rejeitada</option>
          <option value="expirada" {% if cotacao.status == 'expirada' %}selected{% endif %}>Expirada</option>
        </select>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_basico').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="basico" class="btn text-white btn-salvar" style="background-color: #72cd80; border-color: #72cd80;">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Datas -->
<dialog id="modal_datas" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Datas</h3>
    
    <form id="form_datas" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Data de Início</span>
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('periodo_inicio').showPicker()">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <input type="date" id="periodo_inicio" class="input input-bordered pl-10 w-full" value="{% if cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%Y-%m-%d') }}{% endif %}">
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Data de Término</span>
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('periodo_fim').showPicker()">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <input type="date" id="periodo_fim" class="input input-bordered pl-10 w-full" value="{% if cotacao.periodo_fim %}{{ cotacao.periodo_fim.strftime('%Y-%m-%d') }}{% endif %}">
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Expiração da Cotação</span>
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('expires_at').showPicker()">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <input type="datetime-local" id="expires_at" class="input input-bordered pl-10 w-full" value="{% if cotacao.expires_at %}{{ cotacao.expires_at.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
        </div>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_datas').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="datas" class="btn text-white btn-salvar" style="background-color: #72cd80; border-color: #72cd80;">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Valores -->
<dialog id="modal_valores" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Valores</h3>
    
    <form id="form_valores" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Budget Estimado (R$)</span>
        </label>
        <input type="text" id="budget_estimado" class="input input-bordered" placeholder="0,00" value="{{ "%.2f"|format(cotacao.budget_estimado) if cotacao.budget_estimado else '' }}" oninput="formatarMoedaReal(this, 'budget_estimado_hidden')">
        <input type="hidden" id="budget_estimado_hidden">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Valor Total da Proposta (R$)</span>
        </label>
        <input type="text" id="valor_total_proposta" class="input input-bordered" placeholder="0,00" value="{{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao.valor_total_proposta else '' }}" oninput="formatarMoedaReal(this, 'valor_total_proposta_hidden')">
        <input type="hidden" id="valor_total_proposta_hidden">
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_valores').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="valores" class="btn text-white btn-salvar" style="background-color: #72cd80; border-color: #72cd80;">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Peça -->
<!-- Modal Peca removido - campos estão em linhas -->

<!-- Modal Observações -->
<dialog id="modal_link_publico" class="modal">
  <div class="modal-box w-11/12 max-w-3xl">
    <h3 class="font-bold text-lg mb-4">
      <i class="fas fa-link mr-2"></i>Gerenciar Link Público
    </h3>
    
    <!-- Status atual -->
    <div class="alert {% if cotacao.link_publico_ativo %}alert-success{% else %}alert-info{% endif %} mb-4">
      <i class="fas {% if cotacao.link_publico_ativo %}fa-check-circle{% else %}fa-info-circle{% endif %}"></i>
      <div>
        <p class="font-semibold">Status: {% if cotacao.link_publico_ativo %}Ativo{% else %}Inativo{% endif %}</p>
        <p class="text-sm">{% if cotacao.link_publico_ativo %}O link público está ativo e pode ser compartilhado{% else %}Ative o link para permitir visualização pública da cotação{% endif %}</p>
      </div>
    </div>
    
    {% if cotacao.link_publico_token %}
    <!-- Link atual -->
    <div class="bg-base-200 p-4 rounded-lg mb-4">
      <p class="text-sm text-base-content/70 mb-2">Link Público Atual:</p>
      <div class="flex gap-2 items-center">
        <input type="text" readonly value="{{ request.url_root }}cotacao/publico/{{ cotacao.link_publico_token }}" class="input input-bordered input-sm flex-1 font-mono text-xs" id="link_publico_url">
        <button onclick="copiarLinkPublico('{{ request.url_root }}cotacao/publico/{{ cotacao.link_publico_token }}')" class="btn btn-sm btn-primary" title="Copiar link">
          <i class="fas fa-copy mr-1"></i>Copiar
        </button>
        <a href="{{ request.url_root }}cotacao/publico/{{ cotacao.link_publico_token }}" target="_blank" class="btn btn-sm btn-ghost" title="Abrir em nova aba">
          <i class="fas fa-external-link-alt"></i>
        </a>
      </div>
      
      <div class="mt-3 flex items-center gap-4 text-xs text-base-content/60">
        <div>
          <i class="fas fa-fingerprint mr-1"></i>
          Token: <span class="font-mono">{{ cotacao.link_publico_token }}</span>
        </div>
        {% if cotacao.link_publico_expires_at %}
        <div>
          <i class="fas fa-clock mr-1"></i>
          Expira: {{ cotacao.link_publico_expires_at.strftime('%d/%m/%Y %H:%M') }}
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <form id="form_link_publico" class="space-y-4">
      <div class="form-control">
        <label class="label cursor-pointer justify-start gap-3">
          <input type="checkbox" id="link_publico_ativo" class="checkbox checkbox-primary" {% if cotacao.link_publico_ativo %}checked{% endif %}>
          <span class="label-text font-semibold">Habilitar Link Público</span>
        </label>
        <label class="label">
          <span class="label-text-alt text-base-content/60">Permite que a cotação seja visualizada sem login através de um link compartilhável</span>
        </label>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Token do Link (opcional)</span>
        </label>
        <input type="text" id="link_publico_token" class="input input-bordered font-mono text-xs" value="{{ cotacao.link_publico_token if cotacao.link_publico_token else '' }}" placeholder="Deixe em branco para gerar automaticamente">
        <label class="label">
          <span class="label-text-alt text-base-content/60">Token personalizado ou deixe vazio para gerar automaticamente</span>
        </label>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Data de Expiração</span>
        </label>
        <div class="relative">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('link_publico_expires_at').showPicker()">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
          </svg>
          <input type="datetime-local" id="link_publico_expires_at" class="input input-bordered pl-10 w-full" value="{% if cotacao.link_publico_expires_at %}{{ cotacao.link_publico_expires_at.strftime('%Y-%m-%dT%H:%M') if cotacao.link_publico_expires_at.strftime else cotacao.link_publico_expires_at }}{% endif %}">
        </div>
        <label class="label">
          <span class="label-text-alt text-base-content/60">Deixe vazio para link sem expiração</span>
        </label>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_link_publico').close()" class="btn btn-ghost">Fechar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="link_publico" class="btn text-white btn-salvar" style="background-color: #72cd80; border-color: #72cd80;">
        <i class="fas fa-save mr-2"></i>Salvar Alterações
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Observações -->
<dialog id="modal_observacoes" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Observações</h3>
    
    <form id="form_observacoes" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Observações</span>
        </label>
        <textarea id="observacoes" class="textarea textarea-bordered" rows="3">{{ cotacao.observacoes if cotacao.observacoes else '' }}</textarea>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Observações Internas</span>
        </label>
        <textarea id="observacoes_internas" class="textarea textarea-bordered" rows="3">{{ cotacao.observacoes_internas if cotacao.observacoes_internas else '' }}</textarea>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_observacoes').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="observacoes" class="btn text-white btn-salvar" style="background-color: #72cd80; border-color: #72cd80;">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
// Formatar moeda brasileira
function formatarMoedaReal(input, hiddenFieldId) {
  let value = input.value.replace(/\D/g, '');
  
  if (value === '') {
    input.value = '';
    if (hiddenFieldId) document.getElementById(hiddenFieldId).value = '';
    return;
  }
  
  value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  input.value = value;
  
  if (hiddenFieldId) {
    const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
    document.getElementById(hiddenFieldId).value = valorNumerico;
  }
}

// Salvar edição via AJAX
async function salvarEdicao(tipo, cotacao_id) {
  const data = {};
  
  // Coletar dados conforme o tipo de edição
  if (tipo === 'basico') {
    data.nome_campanha = document.getElementById('nome_campanha').value;
    data.responsavel_comercial = document.getElementById('responsavel_comercial').value;
    data.client_user_id = document.getElementById('client_user_id').value;
    data.briefing_id = document.getElementById('briefing_id').value;
    data.objetivo_campanha = document.getElementById('objetivo_campanha').value;
    data.status = document.getElementById('status').value;
  } else if (tipo === 'datas') {
    data.periodo_inicio = document.getElementById('periodo_inicio').value;
    data.periodo_fim = document.getElementById('periodo_fim').value;
    data.expires_at = document.getElementById('expires_at').value;
  } else if (tipo === 'valores') {
    const budget = document.getElementById('budget_estimado_hidden').value || document.getElementById('budget_estimado').value;
    const valor = document.getElementById('valor_total_proposta_hidden').value || document.getElementById('valor_total_proposta').value;
    data.budget_estimado = budget ? parseFloat(budget) : null;
    data.valor_total_proposta = valor ? parseFloat(valor) : null;
  } else if (tipo === 'peca') {
    data.meio = document.getElementById('meio').value;
    data.tipo_peca = document.getElementById('tipo_peca').value;
    data.briefing_id = document.getElementById('briefing_id').value;
  } else if (tipo === 'link_publico') {
    const linkAtivo = document.getElementById('link_publico_ativo').checked;
    const token = document.getElementById('link_publico_token').value.trim();
    
    // Se ativou o link mas não tem token, gerar um novo
    if (linkAtivo && !token) {
      try {
        const gerarResponse = await fetch(`/api/cotacoes/${cotacao_id}/link-publico/gerar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dias_validade: 30 })
        });
        
        if (gerarResponse.ok) {
          mostrarToast('Link público gerado com sucesso!', 'success');
          setTimeout(() => location.reload(), 1000);
          return;
        } else {
          mostrarToast('Erro ao gerar link público', 'error');
          return;
        }
      } catch (error) {
        mostrarToast('Erro ao gerar link público: ' + error.message, 'error');
        return;
      }
    }
    
    data.link_publico_ativo = linkAtivo;
    data.link_publico_token = token;
    data.link_publico_expires_at = document.getElementById('link_publico_expires_at').value;
  } else if (tipo === 'observacoes') {
    data.observacoes = document.getElementById('observacoes').value;
    data.observacoes_internas = document.getElementById('observacoes_internas').value;
  }
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacao_id}/atualizar`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      mostrarToast('Alterações salvas com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      const error = await response.json();
      mostrarToast(`Erro ao salvar: ${error.message}`, 'error');
    }
  } catch (error) {
    mostrarToast(`Erro: ${error.message}`, 'error');
  }
}

// Aprovar cotação
let cotacaoIdParaAprovar = null;

function aprovarCotacao(cotacao_id) {
  cotacaoIdParaAprovar = cotacao_id;
  document.getElementById('modal_confirmar_aprovar').showModal();
}

async function confirmarAprovacao() {
  if (!cotacaoIdParaAprovar) return;
  
  document.getElementById('modal_confirmar_aprovar').close();
  
  try {
    const dataAtual = new Date().toISOString().split('T')[0];
    const response = await fetch(`/api/cotacoes/${cotacaoIdParaAprovar}/atualizar`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'aprovada', aprovada_em: dataAtual })
    });
    
    if (response.ok) {
      mostrarToast('Cotação aprovada com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      const data = await response.json();
      mostrarToast(`Erro ao aprovar cotação: ${data.message || 'Erro desconhecido'}`, 'error');
    }
  } catch (error) {
    mostrarToast(`Erro: ${error.message}`, 'error');
  }
}

// Rejeitar cotação
let cotacaoIdParaRejeitar = null;

function rejeitarCotacao(cotacao_id) {
  cotacaoIdParaRejeitar = cotacao_id;
  document.getElementById('modal_confirmar_rejeitar').showModal();
}

async function confirmarRejeicao() {
  if (!cotacaoIdParaRejeitar) return;
  
  document.getElementById('modal_confirmar_rejeitar').close();
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoIdParaRejeitar}/atualizar`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: 'rejeitada' })
    });
    
    if (response.ok) {
      mostrarToast('Cotação rejeitada!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro ao rejeitar cotação', 'error');
    }
  } catch (error) {
    mostrarToast(`Erro: ${error.message}`, 'error');
  }
}

// Confirmar deleção
let cotacaoIdParaDeletar = null;

function confirmarDelecao(cotacao_id) {
  cotacaoIdParaDeletar = cotacao_id;
  document.getElementById('modal_confirmar_deletar_cotacao').showModal();
}

async function confirmarDeletarCotacao() {
  if (!cotacaoIdParaDeletar) return;
  
  document.getElementById('modal_confirmar_deletar_cotacao').close();
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoIdParaDeletar}/deletar`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      mostrarToast('Cotação deletada com sucesso!', 'success');
      setTimeout(() => window.location.href = '/cotacoes', 1000);
    } else {
      mostrarToast('Erro ao deletar cotação', 'error');
    }
  } catch (error) {
    mostrarToast(`Erro: ${error.message}`, 'error');
  }
}

// Copiar link público
function copiarLinkPublico(link) {
  navigator.clipboard.writeText(link).then(() => {
    mostrarToast('Link copiado para a área de transferência!', 'success');
  }).catch(err => {
    console.error('Erro ao copiar:', err);
    mostrarToast('Erro ao copiar link', 'error');
  });
}

// Ao carregar a página, formatar os valores
document.addEventListener('DOMContentLoaded', function() {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    if (displayInput && displayInput.value) {
      formatarMoedaReal(displayInput, campo + '_hidden');
    }
  });

  // Event listeners para botões com data attributes
  document.querySelectorAll('.btn-salvar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      const tipo = this.dataset.tipo;
      salvarEdicao(tipo, cotacaoId);
    });
  });

  document.querySelectorAll('.btn-deletar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      confirmarDelecao(cotacaoId);
    });
  });

  document.querySelectorAll('.btn-aprovar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      aprovarCotacao(cotacaoId);
    });
  });

  document.querySelectorAll('.btn-rejeitar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      rejeitarCotacao(cotacaoId);
    });
  });
});
</script>

<!-- Modal Nova Linha -->
<dialog id="modal_nova_linha" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 class="font-bold text-lg mb-4">Nova Linha de Cotação</h3>
    
    <form id="form_nova_linha" class="space-y-4">
      
      <!-- Segmentação -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Segmentação *</span></label>
        <textarea id="segmentacao" class="textarea textarea-bordered" rows="3" required minlength="10" placeholder="Descreva a segmentação da audiência..."></textarea>
        <label class="label"><span class="label-text-alt text-error hidden" id="erro_segmentacao">Mínimo 10 caracteres</span></label>
      </div>

      <!-- Formatos (múltipla escolha) -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formatos * <span class="text-xs text-base-content/60">(múltipla escolha)</span></span></label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Carroussel" class="checkbox checkbox-sm">
            <span class="label-text">Carroussel</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Video" class="checkbox checkbox-sm">
            <span class="label-text">Video</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Display" class="checkbox checkbox-sm">
            <span class="label-text">Display</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="CTV" class="checkbox checkbox-sm">
            <span class="label-text">CTV</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Audio" class="checkbox checkbox-sm">
            <span class="label-text">Audio</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Interativos" class="checkbox checkbox-sm">
            <span class="label-text">Interativos</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="formatos" value="Outros" class="checkbox checkbox-sm">
            <span class="label-text">Outros</span>
          </label>
        </div>
        <label class="label"><span class="label-text-alt text-error hidden" id="erro_formatos">Selecione ao menos 1 formato</span></label>
      </div>

      <!-- Plataforma -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Plataforma</span></label>
        <select id="plataforma" class="select select-bordered w-full">
          <option value="">Selecione...</option>
          <option value="DV360">DV360</option>
          <option value="Programática">Programática</option>
          <option value="Amazon DSP">Amazon DSP</option>
          <option value="Meta Ads">Meta Ads</option>
          <option value="Google Ads">Google Ads</option>
          <option value="TikTok Ads">TikTok Ads</option>
          <option value="LinkedIn Ads">LinkedIn Ads</option>
        </select>
      </div>

      <!-- Canal (múltipla escolha) -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Canal <span class="text-xs text-base-content/60">(múltipla escolha)</span></span></label>
        <div class="flex gap-4">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="canal" value="FEED" class="checkbox checkbox-sm">
            <span class="label-text">FEED</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="canal" value="STORY" class="checkbox checkbox-sm">
            <span class="label-text">STORY</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="canal" value="Outros" class="checkbox checkbox-sm">
            <span class="label-text">Outros</span>
          </label>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- Objetivo/KPI/Métrica -->
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Objetivo/KPI *</span></label>
          <select id="objetivo_kpi" class="select select-bordered w-full" required onchange="atualizarLabelVolume()">
            <option value="">Selecione...</option>
            <option value="CPM">CPM (Custo por Mil)</option>
            <option value="CPC">CPC (Custo por Clique)</option>
            <option value="CPA">CPA (Custo por Aquisição)</option>
            <option value="CPV">CPV (Custo por View)</option>
            <option value="CPL">CPL (Custo por Lead)</option>
            <option value="Fixo">Fixo</option>
          </select>
        </div>

        <!-- Viewability Mínimo -->
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Viewability Mínimo (%)</span></label>
          <input type="text" id="viewability_minimo" class="input input-bordered" placeholder="70,00" oninput="aplicarMascaraDinheiro(this)">
        </div>

      </div>

      <!-- Período -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Data Início *</span></label>
          <div class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('data_inicio').showPicker()">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <input type="date" id="data_inicio" class="input input-bordered pl-10 w-full" required>
          </div>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Data Fim *</span></label>
          <div class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('data_fim').showPicker()">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <input type="date" id="data_fim" class="input input-bordered pl-10 w-full" required>
          </div>
        </div>
      </div>

      <!-- Valores -->
      <div class="divider">Valores</div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Investimento Bruto * <span class="text-xs text-base-content/60">(preencher 1º)</span></span></label>
          <input type="text" id="investimento_bruto" class="input input-bordered" required oninput="aplicarMascaraDinheiro(this); calcularVolume()">
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Valor Unitário * <span class="text-xs text-base-content/60">(R$)</span></span></label>
          <input type="text" id="valor_unitario" class="input input-bordered" required oninput="aplicarMascaraDinheiro(this); calcularVolume()">
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text font-semibold" id="label_volume">Volume Contratado</span></label>
          <input type="text" id="volume_contratado" class="input input-bordered bg-base-200" readonly>
        </div>
      </div>

      <!-- Produto -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Produto</span></label>
        <textarea id="produto" class="textarea textarea-bordered" rows="2"></textarea>
      </div>

      <!-- Especificações -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Especificações</span></label>
        <textarea id="especificacoes" class="textarea textarea-bordered" rows="3" placeholder="Detalhes técnicos, restrições, observações..."></textarea>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_nova_linha').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarNovaLinha()" class="btn btn-primary" id="btn_salvar_linha">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Editar Linha -->
<dialog id="modal_editar_linha" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 class="font-bold text-lg mb-4">Editar Linha de Cotação</h3>
    
    <input type="hidden" id="edit_linha_id">
    
    <form id="form_editar_linha" class="space-y-4">
      
      <!-- Segmentação -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Segmentação *</span></label>
        <textarea id="edit_segmentacao" class="textarea textarea-bordered" rows="3" required minlength="10" placeholder="Descreva a segmentação da audiência..."></textarea>
        <label class="label"><span class="label-text-alt text-error hidden" id="edit_erro_segmentacao">Mínimo 10 caracteres</span></label>
      </div>

      <!-- Formatos (múltipla escolha) -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formatos * <span class="text-xs text-base-content/60">(múltipla escolha)</span></span></label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Carroussel" class="checkbox checkbox-sm">
            <span class="label-text">Carroussel</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Video" class="checkbox checkbox-sm">
            <span class="label-text">Video</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Display" class="checkbox checkbox-sm">
            <span class="label-text">Display</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="CTV" class="checkbox checkbox-sm">
            <span class="label-text">CTV</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Audio" class="checkbox checkbox-sm">
            <span class="label-text">Audio</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Interativos" class="checkbox checkbox-sm">
            <span class="label-text">Interativos</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_formatos" value="Outros" class="checkbox checkbox-sm">
            <span class="label-text">Outros</span>
          </label>
        </div>
        <label class="label"><span class="label-text-alt text-error hidden" id="edit_erro_formatos">Selecione ao menos 1 formato</span></label>
      </div>

      <!-- Plataforma -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Plataforma</span></label>
        <select id="edit_plataforma" class="select select-bordered w-full">
          <option value="">Selecione...</option>
          <option value="DV360">DV360</option>
          <option value="Programática">Programática</option>
          <option value="Amazon DSP">Amazon DSP</option>
          <option value="Meta Ads">Meta Ads</option>
          <option value="Google Ads">Google Ads</option>
          <option value="TikTok Ads">TikTok Ads</option>
          <option value="LinkedIn Ads">LinkedIn Ads</option>
        </select>
      </div>

      <!-- Canal (múltipla escolha) -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Canal <span class="text-xs text-base-content/60">(múltipla escolha)</span></span></label>
        <div class="flex gap-4">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_canal" value="FEED" class="checkbox checkbox-sm">
            <span class="label-text">FEED</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_canal" value="STORY" class="checkbox checkbox-sm">
            <span class="label-text">STORY</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" name="edit_canal" value="Outros" class="checkbox checkbox-sm">
            <span class="label-text">Outros</span>
          </label>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- Objetivo/KPI/Métrica -->
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Objetivo/KPI *</span></label>
          <select id="edit_objetivo_kpi" class="select select-bordered w-full" required onchange="atualizarLabelVolumeEdit()">
            <option value="">Selecione...</option>
            <option value="CPM">CPM (Custo por Mil)</option>
            <option value="CPC">CPC (Custo por Clique)</option>
            <option value="CPA">CPA (Custo por Aquisição)</option>
            <option value="CPV">CPV (Custo por View)</option>
            <option value="CPL">CPL (Custo por Lead)</option>
            <option value="Fixo">Fixo</option>
          </select>
        </div>

        <!-- Viewability Mínimo -->
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Viewability Mínimo (%)</span></label>
          <input type="text" id="edit_viewability_minimo" class="input input-bordered" placeholder="70,00" oninput="aplicarMascaraDinheiro(this)">
        </div>

      </div>

      <!-- Período -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Data Início *</span></label>
          <div class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('edit_data_inicio').showPicker()">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <input type="date" id="edit_data_inicio" class="input input-bordered pl-10 w-full" required>
          </div>
        </div>
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Data Fim *</span></label>
          <div class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 cursor-pointer text-base-content/50" onclick="document.getElementById('edit_data_fim').showPicker()">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <input type="date" id="edit_data_fim" class="input input-bordered pl-10 w-full" required>
          </div>
        </div>
      </div>

      <!-- Valores -->
      <div class="divider">Valores</div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Investimento Bruto * <span class="text-xs text-base-content/60">(preencher 1º)</span></span></label>
          <input type="text" id="edit_investimento_bruto" class="input input-bordered" required oninput="aplicarMascaraDinheiro(this); calcularVolumeEdit()">
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text font-semibold">Valor Unitário * <span class="text-xs text-base-content/60">(R$)</span></span></label>
          <input type="text" id="edit_valor_unitario" class="input input-bordered" required oninput="aplicarMascaraDinheiro(this); calcularVolumeEdit()">
        </div>

        <div class="form-control">
          <label class="label"><span class="label-text font-semibold" id="edit_label_volume">Volume Contratado</span></label>
          <input type="text" id="edit_volume_contratado" class="input input-bordered bg-base-200" readonly>
        </div>
      </div>

      <!-- Produto -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Produto</span></label>
        <textarea id="edit_produto" class="textarea textarea-bordered" rows="2"></textarea>
      </div>

      <!-- Especificações -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Especificações</span></label>
        <textarea id="edit_especificacoes" class="textarea textarea-bordered" rows="3" placeholder="Detalhes técnicos, restrições, observações..."></textarea>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_editar_linha').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarEdicaoLinha()" class="btn btn-primary" id="btn_salvar_edicao">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modais de Confirmação -->
<dialog id="modal_confirmar_aprovar" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Aprovar Cotação</h3>
    <p class="py-4">Deseja realmente aprovar esta cotação?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_aprovar').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarAprovacao()" class="btn btn-success">Aprovar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_rejeitar" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Rejeitar Cotação</h3>
    <p class="py-4">Deseja realmente rejeitar esta cotação?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_rejeitar').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarRejeicao()" class="btn btn-error">Rejeitar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_deletar_cotacao" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4 text-error">Deletar Cotação</h3>
    <p class="py-4">Tem certeza que deseja deletar esta cotação? <strong>Esta ação não pode ser desfeita.</strong></p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_deletar_cotacao').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarDeletarCotacao()" class="btn btn-error">Deletar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_remover_linha" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Remover Linha</h3>
    <p class="py-4">Deseja realmente remover esta linha da cotação?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_remover_linha').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarRemoverLinha()" class="btn btn-error">Remover</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_remover_audiencia" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Remover Audiência</h3>
    <p class="py-4">Tem certeza que deseja remover esta audiência?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_remover_audiencia').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarRemoverAudiencia()" class="btn btn-error">Remover</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_remover_comentario" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Remover Comentário</h3>
    <p class="py-4">Deseja realmente remover este comentário?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_remover_comentario').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarRemoverComentario()" class="btn btn-error">Remover</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<dialog id="modal_confirmar_remover_anexo" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Remover Anexo</h3>
    <p class="py-4">Deseja realmente remover este anexo?</p>
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_confirmar_remover_anexo').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="confirmarRemoverAnexo()" class="btn btn-error">Remover</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modais de Email -->
<dialog id="modal_email" class="modal">
  <div class="modal-box max-w-4xl">
    <h3 class="font-bold text-lg mb-4" id="modal_email_titulo">Enviar Email</h3>
    
    <form id="form_email" class="space-y-4">
      <input type="hidden" id="email_tipo">
      
      <!-- Destinatário -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Para *</span></label>
        <input type="email" id="email_destinatario" class="input input-bordered" placeholder="cliente@empresa.com" required>
      </div>
      
      <!-- CC (opcional) -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">CC (opcional)</span></label>
        <input type="text" id="email_cc" class="input input-bordered" placeholder="contato1@empresa.com, contato2@empresa.com">
        <label class="label"><span class="label-text-alt">Separe múltiplos emails com vírgula</span></label>
      </div>
      
      <!-- Assunto -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Assunto *</span></label>
        <input type="text" id="email_assunto" class="input input-bordered" required>
      </div>
      
      <!-- Corpo do email -->
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Mensagem *</span></label>
        <textarea id="email_mensagem" class="textarea textarea-bordered h-64" required></textarea>
        <label class="label"><span class="label-text-alt">Você pode personalizar a mensagem antes de enviar</span></label>
      </div>
      
      <!-- Preview das informações -->
      <div class="alert alert-info">
        <i class="fas fa-info-circle"></i>
        <div>
          <p class="font-semibold">Informações da cotação incluídas:</p>
          <ul class="text-sm mt-1 ml-4 list-disc">
            <li>Número: {{ cotacao.numero_cotacao }}</li>
            <li>Cliente: {{ cotacao.cliente_nome if cotacao.cliente_nome else 'Não especificado' }}</li>
            <li>Valor Total: R$ {{ "{:,.2f}".format(cotacao.valor_total_proposta or 0).replace(',', 'X').replace('.', ',').replace('X', '.') }}</li>
          </ul>
        </div>
      </div>
    </form>
    
    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_email').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="enviarEmail()" class="btn btn-primary">
        <i class="fas fa-paper-plane mr-2"></i>Enviar Email
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Adicionar Audiência -->
<dialog id="modal_adicionar_audiencia" class="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">Adicionar Audiência</h3>
    
    <form id="form_nova_audiencia" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Nome da Audiência *</span></label>
        <div class="relative">
          <input type="hidden" id="audiencia_id_selecionada">
          <input type="text" id="audiencia_nome" class="input input-bordered input-sm" 
                 placeholder="Digite para buscar..." 
                 autocomplete="off"
                 oninput="buscarAudiencias(this.value)"
                 onfocus="mostrarResultadosAudiencias()"
                 required>
          <div id="resultados_busca_audiencias" class="absolute z-[9999] w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
        </div>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Público</span></label>
        <input type="text" id="audiencia_publico" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Categoria</span></label>
        <input type="text" id="audiencia_categoria" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Subcategoria</span></label>
        <input type="text" id="audiencia_subcategoria" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">CPM Estimado (R$)</span></label>
        <input type="number" id="cpm_estimado" class="input input-bordered input-sm" step="0.01">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Investimento Sugerido (R$)</span></label>
        <input type="text" id="investimento_sugerido" class="input input-bordered input-sm" placeholder="0,00">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Impressões Estimadas</span></label>
        <input type="text" id="impressoes_estimadas" class="input input-bordered input-sm" placeholder="0">
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">Incluir na Proposta?</span>
          <input type="checkbox" id="incluido_proposta" class="checkbox" checked>
        </label>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_adicionar_audiencia').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarNovaAudiencia()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Editar Audiência -->
<dialog id="modal_editar_audiencia" class="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">Editar Audiência</h3>
    
    <input type="hidden" id="edit_audiencia_id">
    
    <form id="form_editar_audiencia" class="grid grid-cols-1 gap-4">
      
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Nome da Audiência</span></label>
        <input type="text" id="edit_audiencia_nome" class="input input-bordered" disabled>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">CPM Estimado (R$)</span></label>
        <input type="text" id="edit_cpm_estimado" class="input input-bordered" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Investimento Sugerido (R$)</span></label>
        <input type="text" id="edit_investimento_sugerido" class="input input-bordered" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Impressões Estimadas</span></label>
        <input type="text" id="edit_impressoes_estimadas" class="input input-bordered" oninput="aplicarMascaraNumero(this)">
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">Incluir na Proposta?</span>
          <input type="checkbox" id="edit_incluido_proposta" class="checkbox">
        </label>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_editar_audiencia').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarEdicaoAudiencia()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Adicionar Anexo -->
<dialog id="modal_adicionar_anexo" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Adicionar Anexo</h3>
    
    <form id="form_novo_anexo" enctype="multipart/form-data">
      
      <div class="form-control mb-4">
        <label class="label"><span class="label-text font-semibold">Arquivo *</span></label>
        <input type="file" id="anexo_arquivo" class="file-input file-input-bordered file-input-sm w-full" required>
        <label class="label"><span class="label-text-alt">Tamanho máximo: 15MB</span></label>
      </div>

      <div class="form-control mb-4">
        <label class="label"><span class="label-text font-semibold">Descrição</span></label>
        <textarea id="anexo_descricao" class="textarea textarea-bordered" rows="3" placeholder="Descrição do arquivo (opcional)"></textarea>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_adicionar_anexo').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarNovoAnexo()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Editar Anexo -->
<dialog id="modal_editar_anexo" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg mb-4">Editar Anexo</h3>
    
    <input type="hidden" id="edit_anexo_id">
    
    <form id="form_editar_anexo">
      
      <div class="form-control mb-4">
        <label class="label"><span class="label-text font-semibold">Nome do Arquivo</span></label>
        <input type="text" id="edit_anexo_nome" class="input input-bordered input-sm" required>
      </div>

      <div class="form-control mb-4">
        <label class="label"><span class="label-text font-semibold">Descrição</span></label>
        <textarea id="edit_anexo_descricao" class="textarea textarea-bordered" rows="3"></textarea>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_editar_anexo').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarEdicaoAnexo()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
let timeoutBuscaAudiencias = null;
let audienciasSugeridas = [];

// Máscara de moeda brasileira
function aplicarMascaraDinheiro(input) {
  let valor = input.value.replace(/\D/g, '');
  valor = (parseInt(valor) / 100).toFixed(2);
  valor = valor.replace('.', ',');
  valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
  input.value = valor;
}

function removerMascaraDinheiro(valor) {
  if (!valor) return null;
  return parseFloat(valor.replace(/\./g, '').replace(',', '.'));
}

// Máscara de número inteiro (com separador de milhar)
function aplicarMascaraNumero(input) {
  let valor = input.value.replace(/\D/g, '');
  valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
  input.value = valor;
}

function removerMascaraNumero(valor) {
  if (!valor) return null;
  return parseInt(valor.replace(/\./g, ''));
}

// Aplicar máscara ao campo investimento_sugerido
document.addEventListener('DOMContentLoaded', function() {
  const inputInvestimento = document.getElementById('investimento_sugerido');
  if (inputInvestimento) {
    inputInvestimento.addEventListener('input', function() {
      aplicarMascaraDinheiro(this);
    });
  }
  
  const inputImpressoes = document.getElementById('impressoes_estimadas');
  if (inputImpressoes) {
    inputImpressoes.addEventListener('input', function() {
      aplicarMascaraNumero(this);
    });
  }
});

async function buscarAudiencias(termo) {
  clearTimeout(timeoutBuscaAudiencias);
  
  console.log('Buscando audiências para termo:', termo);
  
  if (termo.length < 2) {
    document.getElementById('resultados_busca_audiencias').classList.add('hidden');
    return;
  }

  timeoutBuscaAudiencias = setTimeout(async () => {
    try {
      console.log('Fazendo requisição para API...');
      const response = await fetch(`/api/audiencias/buscar?q=${encodeURIComponent(termo)}`);
      console.log('Response status:', response.status);
      
      audienciasSugeridas = await response.json();
      console.log('Audiências encontradas:', audienciasSugeridas);
      
      const resultadosDiv = document.getElementById('resultados_busca_audiencias');
      
      if (!audienciasSugeridas || audienciasSugeridas.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-3 text-sm text-base-content/50">Nenhuma audiência encontrada</div>';
        resultadosDiv.classList.remove('hidden');
        console.log('Nenhuma audiência encontrada, mostrando mensagem');
        return;
      }
      
      resultadosDiv.innerHTML = audienciasSugeridas.map(aud => `
        <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0" 
             onclick="selecionarAudiencia(${aud.id})">
          <div class="font-semibold text-sm">${aud.nome}</div>
          <div class="text-xs text-base-content/60 mt-1">
            ${aud.perfil_socioeconomico ? aud.perfil_socioeconomico : ''}
          </div>
          ${aud.cpm_venda ? `<div class="text-xs text-primary mt-1">CPM: R$ ${parseFloat(aud.cpm_venda).toFixed(2)}</div>` : ''}
        </div>
      `).join('');
      
      resultadosDiv.classList.remove('hidden');
      console.log('Resultados exibidos, div visível:', !resultadosDiv.classList.contains('hidden'));
    } catch (error) {
      console.error('Erro ao buscar audiências:', error);
      const resultadosDiv = document.getElementById('resultados_busca_audiencias');
      resultadosDiv.innerHTML = '<div class="p-3 text-sm text-error">Erro ao buscar audiências</div>';
      resultadosDiv.classList.remove('hidden');
    }
  }, 300);
}

function mostrarResultadosAudiencias() {
  const resultadosDiv = document.getElementById('resultados_busca_audiencias');
  if (resultadosDiv.innerHTML && !resultadosDiv.classList.contains('hidden')) {
    return;
  }
  const termo = document.getElementById('audiencia_nome').value;
  if (termo.length >= 2) {
    buscarAudiencias(termo);
  }
}

async function selecionarAudiencia(audienciaId) {
  try {
    console.log('Buscando dados completos da audiência:', audienciaId);
    
    const response = await fetch(`/api/audiencias/${audienciaId}`);
    if (!response.ok) {
      throw new Error('Erro ao buscar audiência');
    }
    
    const audiencia = await response.json();
    console.log('Audiência completa:', audiencia);
    
    document.getElementById('audiencia_id_selecionada').value = audiencia.id;
    document.getElementById('audiencia_nome').value = audiencia.nome;
    document.getElementById('audiencia_publico').value = audiencia.publico_estimado || '';
    document.getElementById('audiencia_categoria').value = audiencia.categoria_nome || '';
    document.getElementById('audiencia_subcategoria').value = audiencia.subcategoria_nome || '';
    document.getElementById('cpm_estimado').value = audiencia.cpm_venda || audiencia.cpm_custo || '';
    
    console.log('Campos preenchidos - Categoria:', audiencia.categoria_nome, 'Subcategoria:', audiencia.subcategoria_nome);
    
    document.getElementById('resultados_busca_audiencias').classList.add('hidden');
  } catch (error) {
    console.error('Erro ao selecionar audiência:', error);
    mostrarToast('Erro ao carregar dados da audiência', 'error');
  }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(e) {
  const inputAud = document.getElementById('audiencia_nome');
  const resultadosDiv = document.getElementById('resultados_busca_audiencias');
  if (inputAud && resultadosDiv && !inputAud.contains(e.target) && !resultadosDiv.contains(e.target)) {
    resultadosDiv.classList.add('hidden');
  }
});

async function salvarNovaAudiencia() {
  const nome = document.getElementById('audiencia_nome').value;
  if (!nome) {
    mostrarToast('Nome da audiência é obrigatório!', 'warning');
    return;
  }

  const data = {
    cotacao_id: {{ cotacao.id }},
    audiencia_id: document.getElementById('audiencia_id_selecionada').value || null,
    audiencia_nome: nome,
    audiencia_publico: document.getElementById('audiencia_publico').value || null,
    audiencia_categoria: document.getElementById('audiencia_categoria').value || null,
    audiencia_subcategoria: document.getElementById('audiencia_subcategoria').value || null,
    cpm_estimado: document.getElementById('cpm_estimado').value || null,
    investimento_sugerido: removerMascaraDinheiro(document.getElementById('investimento_sugerido').value),
    impressoes_estimadas: removerMascaraNumero(document.getElementById('impressoes_estimadas').value),
    incluido_proposta: document.getElementById('incluido_proposta').checked
  };

  try {
    const response = await fetch('/api/cotacoes/audiencias', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    
    if (response.ok) {
      mostrarToast('Audiência adicionada com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao salvar audiência'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao salvar audiência', 'error');
  }
}

// ==================== FUNÇÕES DE CÁLCULO E VALIDAÇÃO ====================

// Atualizar label do volume conforme objetivo selecionado
function atualizarLabelVolume() {
  const objetivo = document.getElementById('objetivo_kpi').value;
  const label = document.getElementById('label_volume');
  
  if (objetivo === 'CPM') {
    label.textContent = 'Volume Contratado (Impressões)';
  } else {
    label.textContent = 'Volume Contratado (Unidades)';
  }
  
  calcularVolume();
}

function atualizarLabelVolumeEdit() {
  const objetivo = document.getElementById('edit_objetivo_kpi').value;
  const label = document.getElementById('edit_label_volume');
  
  if (objetivo === 'CPM') {
    label.textContent = 'Volume Contratado (Impressões)';
  } else {
    label.textContent = 'Volume Contratado (Unidades)';
  }
  
  calcularVolumeEdit();
}

// Calcular volume automaticamente (Nova Linha)
function calcularVolume() {
  const investimentoInput = document.getElementById('investimento_bruto');
  const valorUnitarioInput = document.getElementById('valor_unitario');
  const volumeInput = document.getElementById('volume_contratado');
  const objetivoSelect = document.getElementById('objetivo_kpi');
  
  const investimento = parseFloat(removerMascaraDinheiro(investimentoInput.value)) || 0;
  const valorUnitario = parseFloat(removerMascaraDinheiro(valorUnitarioInput.value)) || 0;
  const objetivo = objetivoSelect.value;
  
  if (investimento > 0 && valorUnitario > 0) {
    let volume;
    
    if (objetivo === 'CPM') {
      // CPM = custo por mil impressões
      // Volume (impressões) = (Investimento / Valor Unitário) * 1000
      volume = (investimento / valorUnitario) * 1000;
    } else {
      // CPC, CPA, CPV, CPL, Fixo = 1:1
      // Volume (unidades) = Investimento / Valor Unitário
      volume = investimento / valorUnitario;
    }
    
    volumeInput.value = formatarNumero(Math.round(volume));
  } else {
    volumeInput.value = '';
  }
  
  validarCamposObrigatorios();
}

// Calcular volume automaticamente (Editar Linha)
function calcularVolumeEdit() {
  const investimentoInput = document.getElementById('edit_investimento_bruto');
  const valorUnitarioInput = document.getElementById('edit_valor_unitario');
  const volumeInput = document.getElementById('edit_volume_contratado');
  const objetivoSelect = document.getElementById('edit_objetivo_kpi');
  
  const investimento = parseFloat(removerMascaraDinheiro(investimentoInput.value)) || 0;
  const valorUnitario = parseFloat(removerMascaraDinheiro(valorUnitarioInput.value)) || 0;
  const objetivo = objetivoSelect.value;
  
  if (investimento > 0 && valorUnitario > 0) {
    let volume;
    
    if (objetivo === 'CPM') {
      volume = (investimento / valorUnitario) * 1000;
    } else {
      volume = investimento / valorUnitario;
    }
    
    volumeInput.value = formatarNumero(Math.round(volume));
  } else {
    volumeInput.value = '';
  }
  
  validarCamposObrigatoriosEdit();
}

// Validação inline (Nova Linha)
function validarCamposObrigatorios() {
  const segmentacao = document.getElementById('segmentacao').value;
  const erroSegmentacao = document.getElementById('erro_segmentacao');
  const formatos = document.querySelectorAll('input[name="formatos"]:checked');
  const erroFormatos = document.getElementById('erro_formatos');
  const btnSalvar = document.getElementById('btn_salvar_linha');
  
  let valido = true;
  
  // Validar segmentação
  if (segmentacao.length > 0 && segmentacao.length < 10) {
    erroSegmentacao.classList.remove('hidden');
    valido = false;
  } else {
    erroSegmentacao.classList.add('hidden');
  }
  
  // Validar formatos
  if (formatos.length === 0 && document.getElementById('segmentacao').value.length > 0) {
    erroFormatos.classList.remove('hidden');
    valido = false;
  } else {
    erroFormatos.classList.add('hidden');
  }
  
  // Habilitar/desabilitar botão salvar
  const investimento = document.getElementById('investimento_bruto').value;
  const valorUnitario = document.getElementById('valor_unitario').value;
  const objetivo = document.getElementById('objetivo_kpi').value;
  const dataInicio = document.getElementById('data_inicio').value;
  const dataFim = document.getElementById('data_fim').value;
  
  const todosObrigatoriosPreenchidos = 
    segmentacao.length >= 10 && 
    formatos.length > 0 && 
    objetivo && 
    investimento && 
    valorUnitario && 
    dataInicio && 
    dataFim;
  
  btnSalvar.disabled = !todosObrigatoriosPreenchidos || !valido;
}

// Validação inline (Editar Linha)
function validarCamposObrigatoriosEdit() {
  const segmentacao = document.getElementById('edit_segmentacao').value;
  const erroSegmentacao = document.getElementById('edit_erro_segmentacao');
  const formatos = document.querySelectorAll('input[name="edit_formatos"]:checked');
  const erroFormatos = document.getElementById('edit_erro_formatos');
  const btnSalvar = document.getElementById('btn_salvar_edicao');
  
  let valido = true;
  
  if (segmentacao.length > 0 && segmentacao.length < 10) {
    erroSegmentacao.classList.remove('hidden');
    valido = false;
  } else {
    erroSegmentacao.classList.add('hidden');
  }
  
  if (formatos.length === 0 && segmentacao.length > 0) {
    erroFormatos.classList.remove('hidden');
    valido = false;
  } else {
    erroFormatos.classList.add('hidden');
  }
  
  const investimento = document.getElementById('edit_investimento_bruto').value;
  const valorUnitario = document.getElementById('edit_valor_unitario').value;
  const objetivo = document.getElementById('edit_objetivo_kpi').value;
  const dataInicio = document.getElementById('edit_data_inicio').value;
  const dataFim = document.getElementById('edit_data_fim').value;
  
  const todosObrigatoriosPreenchidos = 
    segmentacao.length >= 10 && 
    formatos.length > 0 && 
    objetivo && 
    investimento && 
    valorUnitario && 
    dataInicio && 
    dataFim;
  
  btnSalvar.disabled = !todosObrigatoriosPreenchidos || !valido;
}

// Preencher datas padrão ao abrir modal Nova Linha
document.addEventListener('DOMContentLoaded', function() {
  const btnNovaLinha = document.querySelector('[onclick*="modal_nova_linha"]');
  if (btnNovaLinha) {
    btnNovaLinha.addEventListener('click', function() {
      setTimeout(() => {
        // Data início = hoje
        const hoje = new Date();
        document.getElementById('data_inicio').value = hoje.toISOString().split('T')[0];
        
        // Data fim = último dia do mês atual
        const ultimoDia = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
        document.getElementById('data_fim').value = ultimoDia.toISOString().split('T')[0];
        
        // Desabilitar botão salvar inicialmente
        document.getElementById('btn_salvar_linha').disabled = true;
      }, 100);
    });
  }
  
  // Adicionar listeners de validação nos campos
  const camposValidacao = ['segmentacao', 'investimento_bruto', 'valor_unitario', 'objetivo_kpi', 'data_inicio', 'data_fim'];
  camposValidacao.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.addEventListener('input', validarCamposObrigatorios);
      campo.addEventListener('change', validarCamposObrigatorios);
    }
  });
  
  // Listeners para checkboxes de formatos
  document.querySelectorAll('input[name="formatos"]').forEach(checkbox => {
    checkbox.addEventListener('change', validarCamposObrigatorios);
  });
  
  // Mesmos listeners para modal de edição
  const camposValidacaoEdit = ['edit_segmentacao', 'edit_investimento_bruto', 'edit_valor_unitario', 'edit_objetivo_kpi', 'edit_data_inicio', 'edit_data_fim'];
  camposValidacaoEdit.forEach(id => {
    const campo = document.getElementById(id);
    if (campo) {
      campo.addEventListener('input', validarCamposObrigatoriosEdit);
      campo.addEventListener('change', validarCamposObrigatoriosEdit);
    }
  });
  
  document.querySelectorAll('input[name="edit_formatos"]').forEach(checkbox => {
    checkbox.addEventListener('change', validarCamposObrigatoriosEdit);
  });
});

async function salvarNovaLinha() {
  // Coletar formatos selecionados
  const formatosSelecionados = Array.from(document.querySelectorAll('input[name="formatos"]:checked'))
    .map(cb => cb.value);
  
  // Coletar canais selecionados
  const canaisSelecionados = Array.from(document.querySelectorAll('input[name="canal"]:checked'))
    .map(cb => cb.value);
  
  const data = {
    cotacao_id: {{ cotacao.id }},
    segmentacao: document.getElementById('segmentacao').value,
    formatos: formatosSelecionados.join(', '),
    canal: canaisSelecionados.join(', '),
    plataforma: document.getElementById('plataforma').value,
    objetivo_kpi: document.getElementById('objetivo_kpi').value,
    viewability_minimo: removerMascaraDinheiro(document.getElementById('viewability_minimo').value),
    data_inicio: document.getElementById('data_inicio').value,
    data_fim: document.getElementById('data_fim').value,
    investimento_bruto: removerMascaraDinheiro(document.getElementById('investimento_bruto').value),
    valor_unitario: removerMascaraDinheiro(document.getElementById('valor_unitario').value),
    volume_contratado: removerMascaraNumero(document.getElementById('volume_contratado').value),
    produto: document.getElementById('produto').value,
    especificacoes: document.getElementById('especificacoes').value,
    // Campos mantidos por compatibilidade (podem ficar vazios)
    pedido_sugestao: document.getElementById('segmentacao').value.substring(0, 100), // usar início da segmentação
    detalhamento: document.getElementById('especificacoes').value
  };

  try {
    const response = await fetch('/api/cotacoes/linhas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    
    if (response.ok) {
      document.getElementById('modal_nova_linha').close();
      // Usar toast ao invés de alert
      mostrarToast('Linha adicionada com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao salvar linha'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao salvar linha', 'error');
  }
}

// ==================== EDIÇÃO DE LINHAS ====================

async function editarLinha(linhaId) {
  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaId}`);
    const data = await response.json();
    
    if (data.success) {
      const linha = data.linha;
      
      document.getElementById('edit_linha_id').value = linha.id;
      
      // Novos campos
      document.getElementById('edit_segmentacao').value = linha.segmentacao || linha.pedido_sugestao || '';
      document.getElementById('edit_plataforma').value = linha.plataforma || '';
      document.getElementById('edit_produto').value = linha.produto || '';
      document.getElementById('edit_especificacoes').value = linha.especificacoes || linha.detalhamento || '';
      document.getElementById('edit_objetivo_kpi').value = linha.objetivo_kpi || linha.formato_compra || '';
      document.getElementById('edit_data_inicio').value = linha.data_inicio || '';
      document.getElementById('edit_data_fim').value = linha.data_fim || '';
      
      // Formatos múltiplos
      const formatos = linha.formatos ? linha.formatos.split(', ') : [];
      document.querySelectorAll('input[name="edit_formatos"]').forEach(cb => {
        cb.checked = formatos.includes(cb.value);
      });
      
      // Canal múltiplo
      const canais = linha.canal ? linha.canal.split(', ') : [];
      document.querySelectorAll('input[name="edit_canal"]').forEach(cb => {
        cb.checked = canais.includes(cb.value);
      });
      
      // Aplicar máscaras aos valores numéricos
      const viewabilityInput = document.getElementById('edit_viewability_minimo');
      viewabilityInput.value = linha.viewability_minimo ? formatarMoeda(linha.viewability_minimo) : '';
      
      const investimentoInput = document.getElementById('edit_investimento_bruto');
      investimentoInput.value = linha.investimento_bruto ? formatarMoeda(linha.investimento_bruto) : (linha.valor_total ? formatarMoeda(linha.valor_total) : '');
      
      const volumeInput = document.getElementById('edit_volume_contratado');
      volumeInput.value = linha.volume_contratado ? formatarNumero(linha.volume_contratado) : '';
      
      const valorUnitarioInput = document.getElementById('edit_valor_unitario');
      valorUnitarioInput.value = linha.valor_unitario ? formatarMoeda(linha.valor_unitario) : '';
      
      // Atualizar label e recalcular
      atualizarLabelVolumeEdit();
      validarCamposObrigatoriosEdit();
      
      document.getElementById('modal_editar_linha').showModal();
    } else {
      mostrarToast('Erro ao carregar dados da linha', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao carregar linha', 'error');
  }
}

async function salvarEdicaoLinha() {
  const linhaId = document.getElementById('edit_linha_id').value;
  
  // Coletar formatos selecionados
  const formatosSelecionados = Array.from(document.querySelectorAll('input[name="edit_formatos"]:checked'))
    .map(cb => cb.value);
  
  // Coletar canais selecionados
  const canaisSelecionados = Array.from(document.querySelectorAll('input[name="edit_canal"]:checked'))
    .map(cb => cb.value);
  
  const dados = {
    segmentacao: document.getElementById('edit_segmentacao').value,
    formatos: formatosSelecionados.join(', '),
    canal: canaisSelecionados.join(', '),
    plataforma: document.getElementById('edit_plataforma').value,
    objetivo_kpi: document.getElementById('edit_objetivo_kpi').value,
    viewability_minimo: removerMascaraDinheiro(document.getElementById('edit_viewability_minimo').value),
    data_inicio: document.getElementById('edit_data_inicio').value,
    data_fim: document.getElementById('edit_data_fim').value,
    investimento_bruto: removerMascaraDinheiro(document.getElementById('edit_investimento_bruto').value),
    valor_unitario: removerMascaraDinheiro(document.getElementById('edit_valor_unitario').value),
    volume_contratado: removerMascaraNumero(document.getElementById('edit_volume_contratado').value),
    produto: document.getElementById('edit_produto').value,
    especificacoes: document.getElementById('edit_especificacoes').value,
    // Campos de compatibilidade
    pedido_sugestao: document.getElementById('edit_segmentacao').value.substring(0, 100),
    detalhamento: document.getElementById('edit_especificacoes').value
  };

  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });

    const result = await response.json();
    
    if (response.ok) {
      document.getElementById('modal_editar_linha').close();
      mostrarToast('Linha atualizada com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao atualizar linha'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao atualizar linha', 'error');
  }
}

let linhaIdParaRemover = null;

function removerLinha(linhaId) {
  linhaIdParaRemover = linhaId;
  document.getElementById('modal_confirmar_remover_linha').showModal();
}

async function confirmarRemoverLinha() {
  if (!linhaIdParaRemover) return;
  
  document.getElementById('modal_confirmar_remover_linha').close();
  
  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaIdParaRemover}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    
    if (response.ok) {
      mostrarToast('Linha removida com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao remover linha'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao remover linha', 'error');
  }
}

// Função toast simples para feedback (substituir alerts)
function mostrarToast(mensagem, tipo = 'info') {
  // Criar elemento toast
  const toast = document.createElement('div');
  toast.className = `alert alert-${tipo === 'success' ? 'success' : tipo === 'error' ? 'error' : 'info'} fixed bottom-4 right-4 w-auto max-w-md shadow-lg z-50`;
  toast.innerHTML = `
    <span>${mensagem}</span>
  `;
  
  document.body.appendChild(toast);
  
  // Remover após 3 segundos
  setTimeout(() => {
    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ==================== EDIÇÃO DE AUDIÊNCIAS ====================

async function editarAudienciaCotacao(audienciaId) {
  try {
    // Buscar dados da audiência
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}/dados`);
    const data = await response.json();
    
    if (data.success) {
      const aud = data.audiencia;
      
      document.getElementById('edit_audiencia_id').value = aud.id;
      document.getElementById('edit_audiencia_nome').value = aud.audiencia_nome;
      
      // Aplicar máscaras aos valores
      const cpmInput = document.getElementById('edit_cpm_estimado');
      cpmInput.value = aud.cpm_estimado ? formatarMoeda(aud.cpm_estimado) : '';
      
      const invInput = document.getElementById('edit_investimento_sugerido');
      invInput.value = aud.investimento_sugerido ? formatarMoeda(aud.investimento_sugerido) : '';
      
      const impInput = document.getElementById('edit_impressoes_estimadas');
      impInput.value = aud.impressoes_estimadas ? formatarNumero(aud.impressoes_estimadas) : '';
      
      document.getElementById('edit_incluido_proposta').checked = aud.incluido_proposta;
      
      document.getElementById('modal_editar_audiencia').showModal();
    } else {
      mostrarToast('Erro ao carregar dados da audiência', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao carregar audiência', 'error');
  }
}

async function salvarEdicaoAudiencia() {
  const audienciaId = document.getElementById('edit_audiencia_id').value;
  
  const cpmValor = removerMascaraDinheiro(document.getElementById('edit_cpm_estimado').value);
  const invValor = removerMascaraDinheiro(document.getElementById('edit_investimento_sugerido').value);
  const impValor = removerMascaraNumero(document.getElementById('edit_impressoes_estimadas').value);
  
  const dados = {
    cpm_estimado: cpmValor,
    investimento_sugerido: invValor,
    impressoes_estimadas: impValor,
    incluido_proposta: document.getElementById('edit_incluido_proposta').checked
  };

  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });

    const result = await response.json();
    
    if (response.ok) {
      mostrarToast('Audiência atualizada com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.message || 'Erro ao atualizar audiência'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao atualizar audiência', 'error');
  }
}

function formatarMoeda(valor) {
  if (!valor || valor === '' || valor === null || valor === undefined) return '';
  const num = typeof valor === 'string' ? parseFloat(valor) : valor;
  if (isNaN(num)) return '';
  return num.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
}

function formatarNumero(valor) {
  if (!valor || valor === '' || valor === null || valor === undefined) return '';
  const num = typeof valor === 'string' ? parseInt(valor) : valor;
  if (isNaN(num)) return '';
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

async function toggleIncluirAudiencia(audienciaId, incluir) {
  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ incluido_proposta: incluir })
    });

    const result = await response.json();
    
    if (response.ok) {
      mostrarToast('Audiência atualizada!', 'success');
      setTimeout(() => location.reload(), 800);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao atualizar audiência'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao atualizar audiência', 'error');
  }
}

let audienciaIdParaRemover = null;

function removerAudienciaCotacao(audienciaId) {
  audienciaIdParaRemover = audienciaId;
  document.getElementById('modal_confirmar_remover_audiencia').showModal();
}

async function confirmarRemoverAudiencia() {
  if (!audienciaIdParaRemover) return;
  
  document.getElementById('modal_confirmar_remover_audiencia').close();

  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaIdParaRemover}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    
    if (response.ok) {
      mostrarToast('Audiência removida com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro: ' + (result.error || 'Erro ao remover audiência'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao remover audiência', 'error');
  } finally {
    audienciaIdParaRemover = null;
  }
}

// ==================== COMENTÁRIOS ====================

// Remover comentário
let comentarioIdParaRemover = null;

function removerComentario(comentarioId) {
  comentarioIdParaRemover = comentarioId;
  document.getElementById('modal_confirmar_remover_comentario').showModal();
}

async function confirmarRemoverComentario() {
  if (!comentarioIdParaRemover) return;
  
  document.getElementById('modal_confirmar_remover_comentario').close();
  
  try {
    const response = await fetch(`/api/cotacoes/comentarios/${comentarioIdParaRemover}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      mostrarToast('Comentário removido com sucesso!', 'success');
      setTimeout(() => location.reload(), 1000);
    } else {
      mostrarToast('Erro ao remover comentário: ' + data.message, 'error');
    }
  } catch (error) {
    console.error('Erro ao remover comentário:', error);
    mostrarToast('Erro ao remover comentário', 'error');
  } finally {
    comentarioIdParaRemover = null;
  }
}

// ==================== ANEXOS ====================

// Carregar anexos ao iniciar
document.addEventListener('DOMContentLoaded', function() {
  carregarAnexos();
});

async function carregarAnexos() {
  try {
    const response = await fetch(`/api/cotacoes/{{ cotacao.id }}/anexos`);
    const data = await response.json();
    
    if (data.success) {
      renderizarAnexos(data.anexos);
    } else {
      document.getElementById('lista_anexos').innerHTML = '<p class="text-center text-base-content/50 py-8">Erro ao carregar anexos</p>';
    }
  } catch (error) {
    console.error('Erro ao carregar anexos:', error);
    document.getElementById('lista_anexos').innerHTML = '<p class="text-center text-error py-8">Erro ao carregar anexos</p>';
  }
}

function renderizarAnexos(anexos) {
  const container = document.getElementById('lista_anexos');
  
  if (!anexos || anexos.length === 0) {
    container.innerHTML = '<p class="text-center text-base-content/50 py-8">Nenhum anexo adicionado ainda</p>';
    return;
  }
  
  let html = '<div class="overflow-x-auto"><table class="table table-sm">';
  html += '<thead><tr><th>Arquivo</th><th>Descrição</th><th>Tamanho</th><th>Enviado em</th><th>Ações</th></tr></thead><tbody>';
  
  anexos.forEach(anexo => {
    const tamanhoKB = anexo.tamanho_bytes ? (anexo.tamanho_bytes / 1024).toFixed(2) : '-';
    const dataFormatada = anexo.created_at ? new Date(anexo.created_at).toLocaleString('pt-BR') : '-';
    
    html += `<tr>
      <td>
        <a href="${anexo.url_arquivo}" target="_blank" class="link link-primary">
          <i class="fas fa-file mr-1"></i>${anexo.nome_original}
        </a>
      </td>
      <td>${anexo.descricao || '-'}</td>
      <td>${tamanhoKB} KB</td>
      <td>${dataFormatada}</td>
      <td>
        <div class="flex gap-1">
          <button onclick="editarAnexo(${anexo.id})" class="btn btn-xs btn-ghost" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button onclick="deletarAnexo(${anexo.id})" class="btn btn-xs btn-ghost text-error" title="Remover">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </td>
    </tr>`;
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
}

async function salvarNovoAnexo() {
  const arquivo = document.getElementById('anexo_arquivo').files[0];
  const descricao = document.getElementById('anexo_descricao').value;
  
  if (!arquivo) {
    mostrarToast('Selecione um arquivo', 'warning');
    return;
  }
  
  // Validar tamanho (15MB)
  if (arquivo.size > 15 * 1024 * 1024) {
    mostrarToast('Arquivo muito grande. Tamanho máximo: 15MB', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('arquivo', arquivo);
  formData.append('descricao', descricao);
  
  try {
    const response = await fetch(`/api/cotacoes/{{ cotacao.id }}/anexos`, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('modal_adicionar_anexo').close();
      document.getElementById('form_novo_anexo').reset();
      mostrarToast('Anexo adicionado com sucesso!', 'success');
      setTimeout(() => carregarAnexos(), 800);
    } else {
      mostrarToast('Erro: ' + data.message, 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao adicionar anexo', 'error');
  }
}

async function editarAnexo(anexoId) {
  try {
    const response = await fetch(`/api/cotacoes/{{ cotacao.id }}/anexos/${anexoId}`);
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('edit_anexo_id').value = data.anexo.id;
      document.getElementById('edit_anexo_nome').value = data.anexo.nome_original;
      document.getElementById('edit_anexo_descricao').value = data.anexo.descricao || '';
      
      document.getElementById('modal_editar_anexo').showModal();
    } else {
      mostrarToast('Erro ao carregar anexo', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao carregar anexo', 'error');
  }
}

async function salvarEdicaoAnexo() {
  const anexoId = document.getElementById('edit_anexo_id').value;
  const nomeOriginal = document.getElementById('edit_anexo_nome').value;
  const descricao = document.getElementById('edit_anexo_descricao').value;
  
  if (!nomeOriginal.trim()) {
    mostrarToast('Nome do arquivo é obrigatório', 'warning');
    return;
  }
  
  try {
    const response = await fetch(`/api/cotacoes/{{ cotacao.id }}/anexos/${anexoId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome_original: nomeOriginal,
        descricao: descricao
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('modal_editar_anexo').close();
      mostrarToast('Anexo atualizado com sucesso!', 'success');
      setTimeout(() => carregarAnexos(), 800);
    } else {
      mostrarToast('Erro: ' + data.message, 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao atualizar anexo', 'error');
  }
}

let anexoIdParaRemover = null;

function deletarAnexo(anexoId) {
  anexoIdParaRemover = anexoId;
  document.getElementById('modal_confirmar_remover_anexo').showModal();
}

async function confirmarRemoverAnexo() {
  if (!anexoIdParaRemover) return;
  
  document.getElementById('modal_confirmar_remover_anexo').close();
  
  try {
    const response = await fetch(`/api/cotacoes/{{ cotacao.id }}/anexos/${anexoIdParaRemover}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      mostrarToast('Anexo removido com sucesso!', 'success');
      setTimeout(() => carregarAnexos(), 1000);
    } else {
      mostrarToast('Erro: ' + data.message, 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao remover anexo', 'error');
  } finally {
    anexoIdParaRemover = null;
  }
}

// ==================== AÇÕES RÁPIDAS - EMAILS ====================

function abrirModalEmail(tipo) {
  const modal = document.getElementById('modal_email');
  const titulo = document.getElementById('modal_email_titulo');
  const assunto = document.getElementById('email_assunto');
  const mensagem = document.getElementById('email_mensagem');
  const tipoInput = document.getElementById('email_tipo');
  
  tipoInput.value = tipo;
  
  const numeroCotacao = '{{ cotacao.numero_cotacao }}';
  const clienteNome = '{{ cotacao.cliente_nome if cotacao.cliente_nome else "Cliente" }}';
  const valorTotal = 'R$ {{ "{:,.2f}".format(cotacao.valor_total_proposta or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}';
  const linkPublico = '{{ url_for("cotacao_publica", token=cotacao.link_publico_token, _external=True) if cotacao.link_publico_token else "" }}';
  
  if (tipo === 'enviar_cotacao') {
    titulo.textContent = 'Enviar Cotação ao Cliente';
    assunto.value = `Cotação ${numeroCotacao} - ${clienteNome}`;
    mensagem.value = `Olá,\n\nSegue em anexo a cotação ${numeroCotacao} para sua análise.\n\nValor Total: ${valorTotal}\n\n` + 
      (linkPublico ? `Você pode visualizar a cotação online através do link:\n${linkPublico}\n\n` : '') +
      `Aguardamos seu retorno.\n\nAtenciosamente,\nEquipe {{ current_user.nome if current_user else 'CentralComm' }}`;
      
  } else if (tipo === 'email_aprovacao') {
    titulo.textContent = 'Email de Aprovação';
    assunto.value = `✅ Cotação ${numeroCotacao} Aprovada`;
    mensagem.value = `Olá,\n\nTemos o prazer de informar que a cotação ${numeroCotacao} foi aprovada!\n\nValor Total: ${valorTotal}\n\nEm breve entraremos em contato para os próximos passos da implementação.\n\nObrigado pela confiança!\n\nAtenciosamente,\nEquipe {{ current_user.nome if current_user else 'CentralComm' }}`;
    
  } else if (tipo === 'email_recusa') {
    titulo.textContent = 'Email de Recusa';
    assunto.value = `Cotação ${numeroCotacao} - Feedback`;
    mensagem.value = `Olá,\n\nAgradeçemos pelo tempo dedicado à análise da cotação ${numeroCotacao}.\n\nGostaríamos de entender melhor os motivos que levaram à não aprovação desta proposta, para que possamos melhorar nossas futuras cotações.\n\nEstamos à disposição para discutir alternativas ou ajustes.\n\nAtenciosamente,\nEquipe {{ current_user.nome if current_user else 'CentralComm' }}`;
  }
  
  // Preencher email do cliente se disponível
  const emailCliente = '{{ cotacao.cliente_email if cotacao.cliente_email else "" }}';
  if (emailCliente) {
    document.getElementById('email_destinatario').value = emailCliente;
  }
  
  modal.showModal();
}

async function enviarEmail() {
  const tipo = document.getElementById('email_tipo').value;
  const destinatario = document.getElementById('email_destinatario').value;
  const cc = document.getElementById('email_cc').value;
  const assunto = document.getElementById('email_assunto').value;
  const mensagem = document.getElementById('email_mensagem').value;
  
  if (!destinatario || !assunto || !mensagem) {
    mostrarToast('Preencha todos os campos obrigatórios', 'warning');
    return;
  }
  
  // Validar formato de email
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(destinatario)) {
    mostrarToast('Email do destinatário inválido', 'error');
    return;
  }
  
  try {
    const response = await fetch('/api/cotacoes/{{ cotacao.id }}/enviar-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        tipo: tipo,
        destinatario: destinatario,
        cc: cc,
        assunto: assunto,
        mensagem: mensagem
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      document.getElementById('modal_email').close();
      mostrarToast('Email enviado com sucesso!', 'success');
      
      // Limpar formulário
      document.getElementById('form_email').reset();
    } else {
      mostrarToast('Erro ao enviar email: ' + (data.message || 'Erro desconhecido'), 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    mostrarToast('Erro ao enviar email', 'error');
  }
}

function duplicarCotacao() {
  mostrarToast('Funcionalidade de duplicar cotação em desenvolvimento', 'info');
}

function exportarPDF() {
  mostrarToast('Funcionalidade de exportar PDF em desenvolvimento', 'info');
}

// ==================== TOGGLE COMENTÁRIOS ====================

function toggleComentarios() {
  const container = document.getElementById('comentarios-container');
  const icon = document.getElementById('icon-comentarios');
  
  if (container.classList.contains('hidden')) {
    container.classList.remove('hidden');
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-up');
  } else {
    container.classList.add('hidden');
    icon.classList.remove('fa-chevron-up');
    icon.classList.add('fa-chevron-down');
  }
}

</script>

</div>
{% endblock %}