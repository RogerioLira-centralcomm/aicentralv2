{% extends 'base_tailwind.html' %}

{% block title %}Cotação {{ cotacao.numero_cotacao }} - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
  <div class="mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold">Cotação {{ cotacao.numero_cotacao }}</h1>
      <p class="text-base-content/70">{{ cotacao.cliente_nome if cotacao.cliente_nome else 'Cliente não especificado' }}</p>
    </div>
    <div class="flex gap-2">
      <a href="{{ url_for('cotacoes_list') }}" class="btn btn-ghost">
        <i class="fas fa-arrow-left"></i>Voltar
      </a>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-error btn-deletar">
        <i class="fas fa-trash"></i>Deletar
      </button>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Coluna Principal (2/3) -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Informações Básicas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Informações Básicas</h2>
            <button onclick="document.getElementById('modal_basico').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Cliente</p>
              <p class="font-semibold">{{ cotacao.cliente_nome if cotacao.cliente_nome else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Campanha</p>
              <p class="font-semibold">{{ cotacao.nome_campanha if cotacao.nome_campanha else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Responsável Comercial</p>
              <p class="font-semibold">{{ cotacao.responsavel_nome if cotacao.responsavel_nome else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Contato do Cliente</p>
              <p class="font-semibold">{{ cotacao.contato_cliente_nome if cotacao.contato_cliente_nome else '-' }}</p>
            </div>
            {% if cotacao.briefing_id %}
            <div>
              <p class="text-sm text-base-content/70">Briefing</p>
              <p class="font-semibold">
                {% if briefing_atual %}
                  <a href="{{ url_for('briefing_edit', briefing_id=cotacao.briefing_id) }}" class="link link-primary">
                    {{ briefing_atual.titulo }}
                  </a>
                  {% if briefing_atual.status %}
                    <span class="badge badge-sm ml-2">{{ briefing_atual.status }}</span>
                  {% endif %}
                {% else %}
                  ID: {{ cotacao.briefing_id }}
                {% endif %}
              </p>
            </div>
            {% endif %}
            <div>
              <p class="text-sm text-base-content/70">Status</p>
              <div class="badge" 
                {% if cotacao.status == 'aprovada' %}
                  badge-success
                {% elif cotacao.status == 'rejeitada' %}
                  badge-error
                {% elif cotacao.status == 'expirada' %}
                  badge-warning
                {% else %}
                  badge-info
                {% endif %}>
                {{ cotacao.status if cotacao.status else 'pendente' }}
              </div>
            </div>
          </div>

          {% if cotacao.objetivo_campanha %}
          <div class="mt-4 pt-4 border-t">
            <p class="text-sm text-base-content/70 mb-2">Objetivo da Campanha</p>
            <p class="text-sm">{{ cotacao.objetivo_campanha }}</p>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Datas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Datas</h2>
            <button onclick="document.getElementById('modal_datas').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Início da Campanha</p>
              <p class="font-semibold">{{ cotacao.periodo_inicio.strftime('%d/%m/%Y') if cotacao.periodo_inicio else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Término da Campanha</p>
              <p class="font-semibold">{{ cotacao.periodo_fim.strftime('%d/%m/%Y') if cotacao.periodo_fim else '-' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Expiração da Cotação</p>
              <p class="font-semibold">{{ cotacao.expires_at.strftime('%d/%m/%Y %H:%M') if cotacao.expires_at else '-' }}</p>
            </div>
            {% if cotacao.proposta_enviada_em %}
            <div>
              <p class="text-sm text-base-content/70">Proposta Enviada em</p>
              <p class="font-semibold">{{ cotacao.proposta_enviada_em.strftime('%d/%m/%Y %H:%M') }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Valores -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Valores</h2>
            <button onclick="document.getElementById('modal_valores').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-base-content/70">Budget Estimado</p>
              <p class="font-semibold text-lg">R$ {{ "%.2f"|format(cotacao.budget_estimado) if cotacao.budget_estimado else '0,00' }}</p>
            </div>
            <div>
              <p class="text-sm text-base-content/70">Valor Total da Proposta</p>
              <p class="font-semibold text-lg text-success">R$ {{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao.valor_total_proposta else '0,00' }}</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalhes da Peça removido - campos estão em linhas -->

      <!-- Link Público -->
      <div class="card bg-base-100">
        <div class="card-body">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-bold">Link Público</h2>
            <button onclick="document.getElementById('modal_link_publico').showModal()" class="btn btn-sm btn-ghost">
              <i class="fas fa-edit"></i>Editar
            </button>
          </div>
          
          <div class="grid grid-cols-1 gap-3">
            <div>
              <p class="text-sm text-base-content/70">Status do Link</p>
              <div class="badge {% if cotacao.link_publico_ativo %}badge-success{% else %}badge-ghost{% endif %}">
                {{ 'Ativo' if cotacao.link_publico_ativo else 'Inativo' }}
              </div>
            </div>
            
            {% if cotacao.link_publico_token %}
            <div>
              <p class="text-sm text-base-content/70">Token do Link</p>
              <p class="font-semibold font-mono text-xs">{{ cotacao.link_publico_token }}</p>
            </div>
            {% endif %}
            
            {% if cotacao.link_publico_expires_at %}
            <div>
              <p class="text-sm text-base-content/70">Expira em</p>
              <p class="font-semibold">{{ cotacao.link_publico_expires_at.strftime('%d/%m/%Y %H:%M') if cotacao.link_publico_expires_at else '-' }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

    </div>

    <!-- Sidebar (1/3) -->
    <div class="space-y-6">

      <!-- Card de Status -->
      <div class="card bg-primary text-primary-content">
        <div class="card-body">
          <h3 class="card-title text-lg mb-4">Resumo</h3>
          
          <div class="space-y-3">
            <div class="flex justify-between">
              <span>Status:</span>
              <span class="font-semibold">{{ cotacao.status if cotacao.status else 'Pendente' }}</span>
            </div>
            
            <div class="flex justify-between">
              <span>Nº Cotação:</span>
              <span class="font-mono font-semibold">{{ cotacao.numero_cotacao }}</span>
            </div>
            
            <div class="flex justify-between">
              <span>Origem:</span>
              <span class="font-semibold">{{ cotacao.origem if cotacao.origem else '-' }}</span>
            </div>
            
            {% if cotacao.link_publico_ativo %}
            <div class="flex justify-between items-center">
              <span>Link Público:</span>
              <span class="badge badge-success">Ativo</span>
            </div>
            {% endif %}
          </div>

          <div class="divider"></div>

          <div class="flex gap-2">
            {% if cotacao.status != 'aprovada' %}
            <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-success btn-sm flex-1 btn-aprovar">
              <i class="fas fa-check"></i>Aprovar
            </button>
            {% endif %}
            
            {% if cotacao.status != 'rejeitada' %}
            <button type="button" data-cotacao-id="{{ cotacao.id }}" class="btn btn-warning btn-sm flex-1 btn-rejeitar">
              <i class="fas fa-times"></i>Rejeitar
            </button>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Card de Datas Importantes -->
      <div class="card bg-base-100">
        <div class="card-body">
          <h3 class="font-bold mb-3">Datas Importantes</h3>
          
          <div class="space-y-3 text-sm">
            <div class="flex justify-between">
              <span class="text-base-content/70">Criada em:</span>
              <span class="font-semibold">{{ cotacao.created_at.strftime('%d/%m/%Y') if cotacao.created_at else '-' }}</span>
            </div>
            
            <div class="flex justify-between">
              <span class="text-base-content/70">Atualizada em:</span>
              <span class="font-semibold">{{ cotacao.updated_at.strftime('%d/%m/%Y') if cotacao.updated_at else '-' }}</span>
            </div>
            
            {% if cotacao.proposta_enviada_em %}
            <div class="flex justify-between">
              <span class="text-base-content/70">Proposta Enviada:</span>
              <span class="font-semibold">{{ cotacao.proposta_enviada_em.strftime('%d/%m/%Y') }}</span>
            </div>
            {% endif %}
            
            {% if cotacao.aprovada_em %}
            <div class="flex justify-between">
              <span class="text-base-content/70">Aprovada em:</span>
              <span class="font-semibold text-success">{{ cotacao.aprovada_em.strftime('%d/%m/%Y') }}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Card de Ações Rápidas -->
      <div class="card bg-base-100">
        <div class="card-body">
          <h3 class="font-bold mb-3">Ações Rápidas</h3>
          
          <div class="space-y-2">
            <button onclick="document.getElementById('modal_basico').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-edit"></i>Editar Básico
            </button>
            <button onclick="document.getElementById('modal_datas').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-calendar"></i>Editar Datas
            </button>
            <button onclick="document.getElementById('modal_valores').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-dollar-sign"></i>Editar Valores
            </button>
            <button onclick="document.getElementById('modal_observacoes').showModal()" class="btn btn-sm btn-outline w-full justify-start">
              <i class="fas fa-sticky-note"></i>Editar Observações
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Observações (Largura Total) -->
<div class="container mx-auto mt-6 px-4">
  <div class="card bg-base-100">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Observações</h2>
        <button onclick="document.getElementById('modal_observacoes').showModal()" class="btn btn-sm btn-ghost">
          <i class="fas fa-edit"></i>Editar
        </button>
      </div>
      
      {% if cotacao.observacoes %}
      <div class="mb-4">
        <p class="text-sm text-base-content/70 mb-1">Observações</p>
        <p class="text-sm bg-base-200 p-3 rounded">{{ cotacao.observacoes }}</p>
      </div>
      {% else %}
      <div class="mb-4">
        <p class="text-sm text-base-content/70 mb-1">Observações</p>
        <p class="text-sm text-base-content/50 italic">Sem observações</p>
      </div>
      {% endif %}
      
      {% if cotacao.observacoes_internas %}
      <div>
        <p class="text-sm text-base-content/70 mb-1">Observações Internas</p>
        <p class="text-sm bg-base-200 p-3 rounded">{{ cotacao.observacoes_internas }}</p>
      </div>
      {% else %}
      <div>
        <p class="text-sm text-base-content/70 mb-1">Observações Internas</p>
        <p class="text-sm text-base-content/50 italic">Sem observações internas</p>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Comentários da Cotação (Largura Total) -->
<div class="container mx-auto mt-6 px-4">
  <div class="card bg-base-100">
    <div class="card-body">
      <h2 class="text-lg font-bold mb-4">Comentários</h2>
      
      <!-- Lista de Comentários -->
      <div id="comentarios-lista" class="mb-6 max-h-96 overflow-y-auto">
        {% if comentarios and comentarios|length > 0 %}
        <ul class="menu bg-base-200 rounded-box">
          {% for c in comentarios %}
          <li class="border-b border-base-300 last:border-b-0">
            <div class="flex justify-between items-start p-3">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-semibold text-sm">{{ c.user_nome }}</span>
                  <span class="text-xs text-base-content/50">{{ c.created_at.strftime('%d/%m/%Y %H:%M') if c.created_at else '' }}</span>
                </div>
                <p class="text-sm whitespace-pre-wrap">{{ c.comentario }}</p>
              </div>
              {% if session.get('is_admin') %}
              <button onclick="removerComentario({{ c.id }})" class="btn btn-ghost btn-xs text-error" title="Remover">
                <i class="fas fa-trash"></i>
              </button>
              {% endif %}
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="text-center text-base-content/50 py-4">Nenhum comentário ainda</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Linhas da Cotação (Largura Total) -->
<div class="container mx-auto mt-6 px-4">
  <div class="card bg-base-100">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Linhas da Cotação</h2>
        <button onclick="document.getElementById('modal_nova_linha').showModal()" class="btn btn-sm btn-primary">
          <i class="fas fa-plus mr-1"></i>Nova Linha
        </button>
      </div>

      {% if linhas and linhas|length > 0 %}
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Pedido/Sugestão</th>
              <th>Target</th>
              <th>Veículo</th>
              <th>Plataforma</th>
              <th>Produto</th>
              <th>Formato</th>
              <th>Período</th>
              <th>Volume</th>
              <th>Valor Unit.</th>
              <th>Valor Total</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for linha in linhas %}
            <tr class="{% if linha.is_header %}font-bold bg-base-200{% elif linha.is_subtotal %}font-semibold bg-base-300{% endif %}">
              <td>{{ linha.pedido_sugestao if linha.pedido_sugestao else '-' }}</td>
              <td>{{ linha.target if linha.target else '-' }}</td>
              <td>{{ linha.veiculo if linha.veiculo else '-' }}</td>
              <td>{{ linha.plataforma if linha.plataforma else '-' }}</td>
              <td>{{ linha.produto if linha.produto else '-' }}</td>
              <td>{{ linha.formato if linha.formato else '-' }}</td>
              <td>{{ linha.periodo if linha.periodo else '-' }}</td>
              <td>{{ linha.volume_contratado|int if linha.volume_contratado else '-' }}</td>
              <td>
                {% if linha.valor_unitario %}
                  R$ {{ "%.2f"|format(linha.valor_unitario) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if linha.valor_total %}
                  R$ {{ "{:,.2f}".format(linha.valor_total).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if not linha.is_header and not linha.is_subtotal %}
                <div class="flex gap-1">
                  <button onclick="editarLinha({{ linha.id }})" class="btn btn-xs btn-ghost" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="removerLinha({{ linha.id }})" class="btn btn-xs btn-ghost text-error" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="font-bold">
              <td colspan="9" class="text-right">Total Geral:</td>
              <td>
                {% set total = namespace(value=0) %}
                {% for linha in linhas %}
                  {% if linha.valor_total %}
                    {% set total.value = total.value + linha.valor_total %}
                  {% endif %}
                {% endfor %}
                R$ {{ "{:,.2f}".format(total.value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
              </td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <p class="text-center text-base-content/50 py-8">Nenhuma linha adicionada ainda</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Audiências da Cotação (Largura Total) -->
<div class="container mx-auto mt-6 px-4">
  <div class="card bg-base-100">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-bold">Audiências</h2>
        <button onclick="document.getElementById('modal_adicionar_audiencia').showModal()" class="btn btn-sm btn-primary">
          <i class="fas fa-plus mr-1"></i>Adicionar Audiência
        </button>
      </div>

      {% if audiencias and audiencias|length > 0 %}
      <div class="overflow-x-auto">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Público</th>
              <th>Categoria</th>
              <th>CPM</th>
              <th>Investimento</th>
              <th>Impressões</th>
              <th>Incluído</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for aud in audiencias %}
            <tr class="{% if not aud.incluido_proposta %}opacity-50{% endif %}">
              <td>{{ aud.audiencia_nome }}</td>
              <td>{{ aud.audiencia_publico if aud.audiencia_publico else '-' }}</td>
              <td>{{ aud.audiencia_categoria if aud.audiencia_categoria else '-' }}</td>
              <td>
                {% if aud.cpm_estimado %}
                  R$ {{ "%.2f"|format(aud.cpm_estimado)|replace('.', ',') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if aud.investimento_sugerido %}
                  R$ {{ "{:,.2f}".format(aud.investimento_sugerido).replace(',', 'X').replace('.', ',').replace('X', '.') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ "{:,}".format(aud.impressoes_estimadas).replace(',', '.') if aud.impressoes_estimadas else '-' }}</td>
              <td>
                <input type="checkbox" class="toggle toggle-sm" {% if aud.incluido_proposta %}checked{% endif %} 
                       onchange="toggleIncluirAudiencia({{ aud.id }}, this.checked)">
              </td>
              <td>
                <div class="flex gap-1">
                  <button onclick="editarAudienciaCotacao({{ aud.id }})" class="btn btn-xs btn-ghost" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="removerAudienciaCotacao({{ aud.id }})" class="btn btn-xs btn-ghost text-error" title="Remover">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="font-bold">
              <td colspan="4" class="text-right">Total Investimento:</td>
              <td>
                {% set total_inv = namespace(value=0) %}
                {% for aud in audiencias %}
                  {% if aud.incluido_proposta and aud.investimento_sugerido %}
                    {% set total_inv.value = total_inv.value + aud.investimento_sugerido %}
                  {% endif %}
                {% endfor %}
                R$ {{ "{:,.2f}".format(total_inv.value).replace(',', 'X').replace('.', ',').replace('X', '.') }}
              </td>
              <td colspan="3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
      {% else %}
      <p class="text-center text-base-content/50 py-8">Nenhuma audiência adicionada ainda</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ==================== MODAIS DE EDIÇÃO ==================== -->

<!-- Modal Informações Básicas -->
<dialog id="modal_basico" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Informações Básicas</h3>
    
    <form id="form_basico" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Nome da Campanha</span>
        </label>
        <input type="text" id="nome_campanha" class="input input-bordered" value="{{ cotacao.nome_campanha }}">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Responsável Comercial</span>
        </label>
        <select id="responsavel_comercial" class="select select-bordered">
          <option value="">Selecione um responsável</option>
          {% for vendedor in vendedores %}
          <option value="{{ vendedor.id_contato_cliente }}" {% if cotacao.responsavel_comercial == vendedor.id_contato_cliente %}selected{% endif %}>
            {{ vendedor.nome_completo }}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Contato do Cliente</span>
        </label>
        <select id="client_user_id" class="select select-bordered">
          <option value="">Selecione um contato</option>
          {% for contato in contatos_cliente %}
          <option value="{{ contato.id_contato_cliente }}" {% if cotacao.client_user_id == contato.id_contato_cliente %}selected{% endif %}>
            {{ contato.nome_completo }}{% if contato.email %} - {{ contato.email }}{% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Briefing</span>
        </label>
        <select id="briefing_id" class="select select-bordered">
          <option value="">Selecione um briefing</option>
          {% for briefing in briefings %}
          <option value="{{ briefing.id }}" {% if cotacao.briefing_id == briefing.id %}selected{% endif %}>
            {{ briefing.titulo }}{% if briefing.status %} ({{ briefing.status }}){% endif %}
          </option>
          {% endfor %}
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Objetivo da Campanha</span>
        </label>
        <textarea id="objetivo_campanha" class="textarea textarea-bordered" rows="2">{{ cotacao.objetivo_campanha if cotacao.objetivo_campanha else '' }}</textarea>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Status</span>
        </label>
        <select id="status" class="select select-bordered">
          <option value="pendente" {% if cotacao.status == 'pendente' %}selected{% endif %}>Pendente</option>
          <option value="aprovada" {% if cotacao.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
          <option value="rejeitada" {% if cotacao.status == 'rejeitada' %}selected{% endif %}>Rejeitada</option>
          <option value="expirada" {% if cotacao.status == 'expirada' %}selected{% endif %}>Expirada</option>
        </select>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_basico').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="basico" class="btn btn-primary btn-salvar">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Datas -->
<dialog id="modal_datas" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Datas</h3>
    
    <form id="form_datas" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Data de Início</span>
        </label>
        <input type="date" id="periodo_inicio" class="input input-bordered" value="{% if cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%Y-%m-%d') }}{% endif %}">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Data de Término</span>
        </label>
        <input type="date" id="periodo_fim" class="input input-bordered" value="{% if cotacao.periodo_fim %}{{ cotacao.periodo_fim.strftime('%Y-%m-%d') }}{% endif %}">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Expiração da Cotação</span>
        </label>
        <input type="datetime-local" id="expires_at" class="input input-bordered" value="{% if cotacao.expires_at %}{{ cotacao.expires_at.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_datas').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="datas" class="btn btn-primary btn-salvar">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Valores -->
<dialog id="modal_valores" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Valores</h3>
    
    <form id="form_valores" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Budget Estimado (R$)</span>
        </label>
        <input type="text" id="budget_estimado" class="input input-bordered" placeholder="0,00" value="{{ "%.2f"|format(cotacao.budget_estimado) if cotacao.budget_estimado else '' }}" oninput="formatarMoedaReal(this, 'budget_estimado_hidden')">
        <input type="hidden" id="budget_estimado_hidden">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Valor Total da Proposta (R$)</span>
        </label>
        <input type="text" id="valor_total_proposta" class="input input-bordered" placeholder="0,00" value="{{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao.valor_total_proposta else '' }}" oninput="formatarMoedaReal(this, 'valor_total_proposta_hidden')">
        <input type="hidden" id="valor_total_proposta_hidden">
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_valores').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="valores" class="btn btn-primary btn-salvar">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Peça -->
<!-- Modal Peca removido - campos estão em linhas -->

<!-- Modal Observações -->
<dialog id="modal_link_publico" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Link Público</h3>
    
    <form id="form_link_publico" class="space-y-4">
      <div class="form-control">
        <label class="label cursor-pointer justify-start gap-3">
          <input type="checkbox" id="link_publico_ativo" class="checkbox" {% if cotacao.link_publico_ativo %}checked{% endif %}>
          <span class="label-text font-semibold">Habilitar Link Público</span>
        </label>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Token do Link</span>
        </label>
        <input type="text" id="link_publico_token" class="input input-bordered font-mono text-xs" value="{{ cotacao.link_publico_token if cotacao.link_publico_token else '' }}" placeholder="Será gerado automaticamente se deixar em branco">
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Link Expira em</span>
        </label>
        <input type="datetime-local" id="link_publico_expires_at" class="input input-bordered" value="{% if cotacao.link_publico_expires_at %}{{ cotacao.link_publico_expires_at.strftime('%Y-%m-%dT%H:%M') if cotacao.link_publico_expires_at.strftime else cotacao.link_publico_expires_at }}{% endif %}">
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_link_publico').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="link_publico" class="btn btn-primary btn-salvar">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Observações -->
<dialog id="modal_observacoes" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Editar Observações</h3>
    
    <form id="form_observacoes" class="space-y-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Observações</span>
        </label>
        <textarea id="observacoes" class="textarea textarea-bordered" rows="3">{{ cotacao.observacoes if cotacao.observacoes else '' }}</textarea>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-semibold">Observações Internas</span>
        </label>
        <textarea id="observacoes_internas" class="textarea textarea-bordered" rows="3">{{ cotacao.observacoes_internas if cotacao.observacoes_internas else '' }}</textarea>
      </div>
    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_observacoes').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" data-cotacao-id="{{ cotacao.id }}" data-tipo="observacoes" class="btn btn-primary btn-salvar">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
// Formatar moeda brasileira
function formatarMoedaReal(input, hiddenFieldId) {
  let value = input.value.replace(/\D/g, '');
  
  if (value === '') {
    input.value = '';
    if (hiddenFieldId) document.getElementById(hiddenFieldId).value = '';
    return;
  }
  
  value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  input.value = value;
  
  if (hiddenFieldId) {
    const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
    document.getElementById(hiddenFieldId).value = valorNumerico;
  }
}

// Salvar edição via AJAX
async function salvarEdicao(tipo, cotacao_id) {
  const data = {};
  
  // Coletar dados conforme o tipo de edição
  if (tipo === 'basico') {
    data.nome_campanha = document.getElementById('nome_campanha').value;
    data.responsavel_comercial = document.getElementById('responsavel_comercial').value;
    data.client_user_id = document.getElementById('client_user_id').value;
    data.briefing_id = document.getElementById('briefing_id').value;
    data.objetivo_campanha = document.getElementById('objetivo_campanha').value;
    data.status = document.getElementById('status').value;
  } else if (tipo === 'datas') {
    data.periodo_inicio = document.getElementById('periodo_inicio').value;
    data.periodo_fim = document.getElementById('periodo_fim').value;
    data.expires_at = document.getElementById('expires_at').value;
  } else if (tipo === 'valores') {
    const budget = document.getElementById('budget_estimado_hidden').value || document.getElementById('budget_estimado').value;
    const valor = document.getElementById('valor_total_proposta_hidden').value || document.getElementById('valor_total_proposta').value;
    data.budget_estimado = budget ? parseFloat(budget) : null;
    data.valor_total_proposta = valor ? parseFloat(valor) : null;
  } else if (tipo === 'peca') {
    data.meio = document.getElementById('meio').value;
    data.tipo_peca = document.getElementById('tipo_peca').value;
    data.briefing_id = document.getElementById('briefing_id').value;
  } else if (tipo === 'link_publico') {
    data.link_publico_ativo = document.getElementById('link_publico_ativo').checked;
    data.link_publico_token = document.getElementById('link_publico_token').value;
    data.link_publico_expires_at = document.getElementById('link_publico_expires_at').value;
  } else if (tipo === 'observacoes') {
    data.observacoes = document.getElementById('observacoes').value;
    data.observacoes_internas = document.getElementById('observacoes_internas').value;
  }
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacao_id}/atualizar`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    if (response.ok) {
      alert('Alterações salvas com sucesso!');
      location.reload();
    } else {
      const error = await response.json();
      alert(`Erro ao salvar: ${error.message}`);
    }
  } catch (error) {
    alert(`Erro: ${error.message}`);
  }
}

// Aprovar cotação
async function aprovarCotacao(cotacao_id) {
  if (!confirm('Deseja aprovar esta cotação?')) return;
  
  try {
    const dataAtual = new Date().toISOString().split('T')[0]; // Formato: YYYY-MM-DD
    const response = await fetch(`/api/cotacoes/${cotacao_id}/atualizar`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        status: 'aprovada', 
        aprovada_em: dataAtual 
      })
    });
    
    if (response.ok) {
      alert('Cotação aprovada com sucesso!');
      location.reload();
    } else {
      const data = await response.json();
      alert(`Erro ao aprovar cotação: ${data.message || 'Erro desconhecido'}`);
    }
  } catch (error) {
    alert(`Erro: ${error.message}`);
  }
}

// Rejeitar cotação
async function rejeitarCotacao(cotacao_id) {
  if (!confirm('Deseja rejeitar esta cotação?')) return;
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacao_id}/atualizar`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ status: 'rejeitada' })
    });
    
    if (response.ok) {
      alert('Cotação rejeitada!');
      location.reload();
    } else {
      alert('Erro ao rejeitar cotação');
    }
  } catch (error) {
    alert(`Erro: ${error.message}`);
  }
}

// Confirmar deleção
function confirmarDelecao(cotacao_id) {
  if (confirm('Tem certeza que deseja deletar esta cotação? Esta ação não pode ser desfeita.')) {
    deletarCotacao(cotacao_id);
  }
}

// Deletar cotação
async function deletarCotacao(cotacao_id) {
  try {
    const response = await fetch(`/api/cotacoes/${cotacao_id}/deletar`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      alert('Cotação deletada com sucesso!');
      window.location.href = '/cotacoes';
    } else {
      alert('Erro ao deletar cotação');
    }
  } catch (error) {
    alert(`Erro: ${error.message}`);
  }
}

// Ao carregar a página, formatar os valores
document.addEventListener('DOMContentLoaded', function() {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    if (displayInput && displayInput.value) {
      formatarMoedaReal(displayInput, campo + '_hidden');
    }
  });

  // Event listeners para botões com data attributes
  document.querySelectorAll('.btn-salvar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      const tipo = this.dataset.tipo;
      salvarEdicao(tipo, cotacaoId);
    });
  });

  document.querySelectorAll('.btn-deletar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      confirmarDelecao(cotacaoId);
    });
  });

  document.querySelectorAll('.btn-aprovar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      aprovarCotacao(cotacaoId);
    });
  });

  document.querySelectorAll('.btn-rejeitar').forEach(btn => {
    btn.addEventListener('click', function() {
      const cotacaoId = this.dataset.cotacaoId;
      rejeitarCotacao(cotacaoId);
    });
  });
});
</script>

<!-- Modal Nova Linha -->
<dialog id="modal_nova_linha" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 class="font-bold text-lg mb-4">Nova Linha de Cotação</h3>
    
    <form id="form_nova_linha" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Pedido/Sugestão</span></label>
        <input type="text" id="pedido_sugestao" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Target</span></label>
        <input type="text" id="target" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Veículo</span></label>
        <input type="text" id="veiculo" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Plataforma</span></label>
        <select id="plataforma" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="DV360">DV360</option>
          <option value="Programática">Programática</option>
          <option value="Amazon DSP">Amazon DSP</option>
          <option value="Meta Ads">Meta Ads</option>
          <option value="Google Ads">Google Ads</option>
          <option value="TikTok Ads">TikTok Ads</option>
          <option value="LinkedIn Ads">LinkedIn Ads</option>
        </select>
      </div>

      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Produto</span></label>
        <textarea id="produto" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
      </div>

      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Detalhamento</span></label>
        <textarea id="detalhamento" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formato</span></label>
        <input type="text" id="formato" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formato Compra</span></label>
        <select id="formato_compra" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="CPM">CPM</option>
          <option value="CPV">CPV</option>
          <option value="CPC">CPC</option>
          <option value="CPA">CPA</option>
          <option value="CPL">CPL</option>
          <option value="Fixo">Fixo</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Período</span></label>
        <input type="text" id="periodo" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Viewability Mínimo (%)</span></label>
        <input type="text" id="viewability_minimo" class="input input-bordered input-sm" placeholder="70,00" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Volume Contratado</span></label>
        <input type="text" id="volume_contratado" class="input input-bordered input-sm" oninput="aplicarMascaraNumero(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Valor Unitário</span></label>
        <input type="text" id="valor_unitario" class="input input-bordered input-sm" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Valor Total</span></label>
        <input type="text" id="valor_total" class="input input-bordered input-sm" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Meio</span></label>
        <select id="meio_linha" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="INTERNET">INTERNET</option>
          <option value="TV">TV</option>
          <option value="RADIO">RADIO</option>
          <option value="OOH">OOH</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Tipo de Peça</span></label>
        <select id="tipo_peca_linha" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="BANNERS">BANNERS</option>
          <option value="VIDEO">VIDEO</option>
          <option value="AUDIO">AUDIO</option>
          <option value="IMPRESSO">IMPRESSO</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">É Cabeçalho?</span>
          <input type="checkbox" id="is_header" class="checkbox">
        </label>
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">É Subtotal?</span>
          <input type="checkbox" id="is_subtotal" class="checkbox">
        </label>
      </div>

      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Label Subtotal</span></label>
        <input type="text" id="subtotal_label" class="input input-bordered input-sm">
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_nova_linha').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarNovaLinha()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Editar Linha -->
<dialog id="modal_editar_linha" class="modal">
  <div class="modal-box w-11/12 max-w-5xl">
    <h3 class="font-bold text-lg mb-4">Editar Linha de Cotação</h3>
    
    <input type="hidden" id="edit_linha_id">
    
    <form id="form_editar_linha" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Pedido/Sugestão</span></label>
        <input type="text" id="edit_pedido_sugestao" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Target</span></label>
        <input type="text" id="edit_target" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Veículo</span></label>
        <input type="text" id="edit_veiculo" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Plataforma</span></label>
        <select id="edit_plataforma" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="DV360">DV360</option>
          <option value="Programática">Programática</option>
          <option value="Amazon DSP">Amazon DSP</option>
          <option value="Meta Ads">Meta Ads</option>
          <option value="Google Ads">Google Ads</option>
          <option value="TikTok Ads">TikTok Ads</option>
          <option value="LinkedIn Ads">LinkedIn Ads</option>
        </select>
      </div>

      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Produto</span></label>
        <textarea id="edit_produto" class="textarea textarea-bordered textarea-sm" rows="2"></textarea>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formato</span></label>
        <input type="text" id="edit_formato" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Formato Compra</span></label>
        <select id="edit_formato_compra" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="CPM">CPM</option>
          <option value="CPV">CPV</option>
          <option value="CPC">CPC</option>
          <option value="CPA">CPA</option>
          <option value="CPL">CPL</option>
          <option value="Fixo">Fixo</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Período</span></label>
        <input type="text" id="edit_periodo" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Viewability Mínimo (%)</span></label>
        <input type="text" id="edit_viewability_minimo" class="input input-bordered input-sm" placeholder="70,00" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Volume Contratado</span></label>
        <input type="text" id="edit_volume_contratado" class="input input-bordered input-sm" oninput="aplicarMascaraNumero(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Valor Unitário</span></label>
        <input type="text" id="edit_valor_unitario" class="input input-bordered input-sm" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Valor Total</span></label>
        <input type="text" id="edit_valor_total" class="input input-bordered input-sm" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Meio</span></label>
        <select id="edit_meio_linha" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="INTERNET">INTERNET</option>
          <option value="TV">TV</option>
          <option value="RADIO">RADIO</option>
          <option value="OOH">OOH</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Tipo de Peça</span></label>
        <select id="edit_tipo_peca_linha" class="select select-bordered select-sm w-full h-10 min-h-10">
          <option value="">Selecione...</option>
          <option value="BANNERS">BANNERS</option>
          <option value="VIDEO">VIDEO</option>
          <option value="AUDIO">AUDIO</option>
          <option value="IMPRESSO">IMPRESSO</option>
        </select>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_editar_linha').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarEdicaoLinha()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Adicionar Audiência -->
<dialog id="modal_adicionar_audiencia" class="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">Adicionar Audiência</h3>
    
    <form id="form_nova_audiencia" class="grid grid-cols-1 md:grid-cols-2 gap-4">
      
      <div class="form-control md:col-span-2">
        <label class="label"><span class="label-text font-semibold">Nome da Audiência *</span></label>
        <div class="relative">
          <input type="hidden" id="audiencia_id_selecionada">
          <input type="text" id="audiencia_nome" class="input input-bordered input-sm" 
                 placeholder="Digite para buscar..." 
                 autocomplete="off"
                 oninput="buscarAudiencias(this.value)"
                 onfocus="mostrarResultadosAudiencias()"
                 required>
          <div id="resultados_busca_audiencias" class="absolute z-[9999] w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
        </div>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Público</span></label>
        <input type="text" id="audiencia_publico" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Categoria</span></label>
        <input type="text" id="audiencia_categoria" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Subcategoria</span></label>
        <input type="text" id="audiencia_subcategoria" class="input input-bordered input-sm">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">CPM Estimado (R$)</span></label>
        <input type="number" id="cpm_estimado" class="input input-bordered input-sm" step="0.01">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Investimento Sugerido (R$)</span></label>
        <input type="text" id="investimento_sugerido" class="input input-bordered input-sm" placeholder="0,00">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Impressões Estimadas</span></label>
        <input type="text" id="impressoes_estimadas" class="input input-bordered input-sm" placeholder="0">
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">Incluir na Proposta?</span>
          <input type="checkbox" id="incluido_proposta" class="checkbox" checked>
        </label>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_adicionar_audiencia').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarNovaAudiencia()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<!-- Modal Editar Audiência -->
<dialog id="modal_editar_audiencia" class="modal">
  <div class="modal-box max-w-3xl">
    <h3 class="font-bold text-lg mb-4">Editar Audiência</h3>
    
    <input type="hidden" id="edit_audiencia_id">
    
    <form id="form_editar_audiencia" class="grid grid-cols-1 gap-4">
      
      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Nome da Audiência</span></label>
        <input type="text" id="edit_audiencia_nome" class="input input-bordered" disabled>
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">CPM Estimado (R$)</span></label>
        <input type="text" id="edit_cpm_estimado" class="input input-bordered" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Investimento Sugerido (R$)</span></label>
        <input type="text" id="edit_investimento_sugerido" class="input input-bordered" oninput="aplicarMascaraDinheiro(this)">
      </div>

      <div class="form-control">
        <label class="label"><span class="label-text font-semibold">Impressões Estimadas</span></label>
        <input type="text" id="edit_impressoes_estimadas" class="input input-bordered" oninput="aplicarMascaraNumero(this)">
      </div>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text font-semibold">Incluir na Proposta?</span>
          <input type="checkbox" id="edit_incluido_proposta" class="checkbox">
        </label>
      </div>

    </form>

    <div class="modal-action">
      <button type="button" onclick="document.getElementById('modal_editar_audiencia').close()" class="btn btn-ghost">Cancelar</button>
      <button type="button" onclick="salvarEdicaoAudiencia()" class="btn btn-primary">Salvar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>Fechar</button>
  </form>
</dialog>

<script>
let timeoutBuscaAudiencias = null;
let audienciasSugeridas = [];

// Máscara de moeda brasileira
function aplicarMascaraDinheiro(input) {
  let valor = input.value.replace(/\D/g, '');
  valor = (parseInt(valor) / 100).toFixed(2);
  valor = valor.replace('.', ',');
  valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
  input.value = valor;
}

function removerMascaraDinheiro(valor) {
  if (!valor) return null;
  return parseFloat(valor.replace(/\./g, '').replace(',', '.'));
}

// Máscara de número inteiro (com separador de milhar)
function aplicarMascaraNumero(input) {
  let valor = input.value.replace(/\D/g, '');
  valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
  input.value = valor;
}

function removerMascaraNumero(valor) {
  if (!valor) return null;
  return parseInt(valor.replace(/\./g, ''));
}

// Aplicar máscara ao campo investimento_sugerido
document.addEventListener('DOMContentLoaded', function() {
  const inputInvestimento = document.getElementById('investimento_sugerido');
  if (inputInvestimento) {
    inputInvestimento.addEventListener('input', function() {
      aplicarMascaraDinheiro(this);
    });
  }
  
  const inputImpressoes = document.getElementById('impressoes_estimadas');
  if (inputImpressoes) {
    inputImpressoes.addEventListener('input', function() {
      aplicarMascaraNumero(this);
    });
  }
});

async function buscarAudiencias(termo) {
  clearTimeout(timeoutBuscaAudiencias);
  
  console.log('Buscando audiências para termo:', termo);
  
  if (termo.length < 2) {
    document.getElementById('resultados_busca_audiencias').classList.add('hidden');
    return;
  }

  timeoutBuscaAudiencias = setTimeout(async () => {
    try {
      console.log('Fazendo requisição para API...');
      const response = await fetch(`/api/audiencias/buscar?q=${encodeURIComponent(termo)}`);
      console.log('Response status:', response.status);
      
      audienciasSugeridas = await response.json();
      console.log('Audiências encontradas:', audienciasSugeridas);
      
      const resultadosDiv = document.getElementById('resultados_busca_audiencias');
      
      if (!audienciasSugeridas || audienciasSugeridas.length === 0) {
        resultadosDiv.innerHTML = '<div class="p-3 text-sm text-base-content/50">Nenhuma audiência encontrada</div>';
        resultadosDiv.classList.remove('hidden');
        console.log('Nenhuma audiência encontrada, mostrando mensagem');
        return;
      }
      
      resultadosDiv.innerHTML = audienciasSugeridas.map(aud => `
        <div class="p-3 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0" 
             onclick="selecionarAudiencia(${aud.id})">
          <div class="font-semibold text-sm">${aud.nome}</div>
          <div class="text-xs text-base-content/60 mt-1">
            ${aud.perfil_socioeconomico ? aud.perfil_socioeconomico : ''}
          </div>
          ${aud.cpm_venda ? `<div class="text-xs text-primary mt-1">CPM: R$ ${parseFloat(aud.cpm_venda).toFixed(2)}</div>` : ''}
        </div>
      `).join('');
      
      resultadosDiv.classList.remove('hidden');
      console.log('Resultados exibidos, div visível:', !resultadosDiv.classList.contains('hidden'));
    } catch (error) {
      console.error('Erro ao buscar audiências:', error);
      const resultadosDiv = document.getElementById('resultados_busca_audiencias');
      resultadosDiv.innerHTML = '<div class="p-3 text-sm text-error">Erro ao buscar audiências</div>';
      resultadosDiv.classList.remove('hidden');
    }
  }, 300);
}

function mostrarResultadosAudiencias() {
  const resultadosDiv = document.getElementById('resultados_busca_audiencias');
  if (resultadosDiv.innerHTML && !resultadosDiv.classList.contains('hidden')) {
    return;
  }
  const termo = document.getElementById('audiencia_nome').value;
  if (termo.length >= 2) {
    buscarAudiencias(termo);
  }
}

async function selecionarAudiencia(audienciaId) {
  try {
    console.log('Buscando dados completos da audiência:', audienciaId);
    
    const response = await fetch(`/api/audiencias/${audienciaId}`);
    if (!response.ok) {
      throw new Error('Erro ao buscar audiência');
    }
    
    const audiencia = await response.json();
    console.log('Audiência completa:', audiencia);
    
    document.getElementById('audiencia_id_selecionada').value = audiencia.id;
    document.getElementById('audiencia_nome').value = audiencia.nome;
    document.getElementById('audiencia_publico').value = audiencia.publico_estimado || '';
    document.getElementById('audiencia_categoria').value = audiencia.categoria_nome || '';
    document.getElementById('audiencia_subcategoria').value = audiencia.subcategoria_nome || '';
    document.getElementById('cpm_estimado').value = audiencia.cpm_venda || audiencia.cpm_custo || '';
    
    console.log('Campos preenchidos - Categoria:', audiencia.categoria_nome, 'Subcategoria:', audiencia.subcategoria_nome);
    
    document.getElementById('resultados_busca_audiencias').classList.add('hidden');
  } catch (error) {
    console.error('Erro ao selecionar audiência:', error);
    alert('Erro ao carregar dados da audiência');
  }
}

// Fechar resultados ao clicar fora
document.addEventListener('click', function(e) {
  const inputAud = document.getElementById('audiencia_nome');
  const resultadosDiv = document.getElementById('resultados_busca_audiencias');
  if (inputAud && resultadosDiv && !inputAud.contains(e.target) && !resultadosDiv.contains(e.target)) {
    resultadosDiv.classList.add('hidden');
  }
});

async function salvarNovaAudiencia() {
  const nome = document.getElementById('audiencia_nome').value;
  if (!nome) {
    alert('Nome da audiência é obrigatório!');
    return;
  }

  const data = {
    cotacao_id: {{ cotacao.id }},
    audiencia_id: document.getElementById('audiencia_id_selecionada').value || null,
    audiencia_nome: nome,
    audiencia_publico: document.getElementById('audiencia_publico').value || null,
    audiencia_categoria: document.getElementById('audiencia_categoria').value || null,
    audiencia_subcategoria: document.getElementById('audiencia_subcategoria').value || null,
    cpm_estimado: document.getElementById('cpm_estimado').value || null,
    investimento_sugerido: removerMascaraDinheiro(document.getElementById('investimento_sugerido').value),
    impressoes_estimadas: removerMascaraNumero(document.getElementById('impressoes_estimadas').value),
    incluido_proposta: document.getElementById('incluido_proposta').checked
  };

  try {
    const response = await fetch('/api/cotacoes/audiencias', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Audiência adicionada com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao salvar audiência'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao salvar audiência');
  }
}

async function salvarNovaLinha() {
  const data = {
    cotacao_id: {{ cotacao.id }},
    pedido_sugestao: document.getElementById('pedido_sugestao').value,
    target: document.getElementById('target').value,
    veiculo: document.getElementById('veiculo').value,
    plataforma: document.getElementById('plataforma').value,
    produto: document.getElementById('produto').value,
    detalhamento: document.getElementById('detalhamento').value,
    formato: document.getElementById('formato').value,
    formato_compra: document.getElementById('formato_compra').value,
    periodo: document.getElementById('periodo').value,
    viewability_minimo: removerMascaraDinheiro(document.getElementById('viewability_minimo').value),
    volume_contratado: removerMascaraNumero(document.getElementById('volume_contratado').value),
    valor_unitario: removerMascaraDinheiro(document.getElementById('valor_unitario').value),
    valor_total: removerMascaraDinheiro(document.getElementById('valor_total').value),
    meio: document.getElementById('meio_linha').value,
    tipo_peca: document.getElementById('tipo_peca_linha').value,
    is_header: document.getElementById('is_header').checked,
    is_subtotal: document.getElementById('is_subtotal').checked,
    subtotal_label: document.getElementById('subtotal_label').value
  };

  try {
    const response = await fetch('/api/cotacoes/linhas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Linha adicionada com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao salvar linha'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao salvar linha');
  }
}

// ==================== EDIÇÃO DE LINHAS ====================

async function editarLinha(linhaId) {
  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaId}`);
    const data = await response.json();
    
    if (data.success) {
      const linha = data.linha;
      
      document.getElementById('edit_linha_id').value = linha.id;
      document.getElementById('edit_pedido_sugestao').value = linha.pedido_sugestao || '';
      document.getElementById('edit_target').value = linha.target || '';
      document.getElementById('edit_veiculo').value = linha.veiculo || '';
      document.getElementById('edit_plataforma').value = linha.plataforma || '';
      document.getElementById('edit_produto').value = linha.produto || '';
      document.getElementById('edit_formato').value = linha.formato || '';
      document.getElementById('edit_formato_compra').value = linha.formato_compra || '';
      document.getElementById('edit_periodo').value = linha.periodo || '';
      
      // Aplicar máscaras aos valores numéricos
      const viewabilityInput = document.getElementById('edit_viewability_minimo');
      viewabilityInput.value = linha.viewability_minimo ? formatarMoeda(linha.viewability_minimo) : '';
      
      const volumeInput = document.getElementById('edit_volume_contratado');
      volumeInput.value = linha.volume_contratado ? formatarNumero(linha.volume_contratado) : '';
      
      const valorUnitarioInput = document.getElementById('edit_valor_unitario');
      valorUnitarioInput.value = linha.valor_unitario ? formatarMoeda(linha.valor_unitario) : '';
      
      const valorTotalInput = document.getElementById('edit_valor_total');
      valorTotalInput.value = linha.valor_total ? formatarMoeda(linha.valor_total) : '';
      
      document.getElementById('edit_meio_linha').value = linha.meio || '';
      document.getElementById('edit_tipo_peca_linha').value = linha.tipo_peca || '';
      
      document.getElementById('modal_editar_linha').showModal();
    } else {
      alert('Erro ao carregar dados da linha');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao carregar linha');
  }
}

async function salvarEdicaoLinha() {
  const linhaId = document.getElementById('edit_linha_id').value;
  
  const dados = {
    pedido_sugestao: document.getElementById('edit_pedido_sugestao').value,
    target: document.getElementById('edit_target').value,
    veiculo: document.getElementById('edit_veiculo').value,
    plataforma: document.getElementById('edit_plataforma').value,
    produto: document.getElementById('edit_produto').value,
    formato: document.getElementById('edit_formato').value,
    formato_compra: document.getElementById('edit_formato_compra').value,
    periodo: document.getElementById('edit_periodo').value,
    viewability_minimo: removerMascaraDinheiro(document.getElementById('edit_viewability_minimo').value),
    volume_contratado: removerMascaraNumero(document.getElementById('edit_volume_contratado').value),
    valor_unitario: removerMascaraDinheiro(document.getElementById('edit_valor_unitario').value),
    valor_total: removerMascaraDinheiro(document.getElementById('edit_valor_total').value),
    meio: document.getElementById('edit_meio_linha').value,
    tipo_peca: document.getElementById('edit_tipo_peca_linha').value
  };

  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Linha atualizada com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao atualizar linha'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao atualizar linha');
  }
}

async function removerLinha(linhaId) {
  if (!confirm('Deseja realmente remover esta linha?')) return;
  
  try {
    const response = await fetch(`/api/cotacoes/linhas/${linhaId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Linha removida com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao remover linha'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao remover linha');
  }
}

// ==================== EDIÇÃO DE AUDIÊNCIAS ====================

async function editarAudienciaCotacao(audienciaId) {
  try {
    // Buscar dados da audiência
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}/dados`);
    const data = await response.json();
    
    if (data.success) {
      const aud = data.audiencia;
      
      document.getElementById('edit_audiencia_id').value = aud.id;
      document.getElementById('edit_audiencia_nome').value = aud.audiencia_nome;
      
      // Aplicar máscaras aos valores
      const cpmInput = document.getElementById('edit_cpm_estimado');
      cpmInput.value = aud.cpm_estimado ? formatarMoeda(aud.cpm_estimado) : '';
      
      const invInput = document.getElementById('edit_investimento_sugerido');
      invInput.value = aud.investimento_sugerido ? formatarMoeda(aud.investimento_sugerido) : '';
      
      const impInput = document.getElementById('edit_impressoes_estimadas');
      impInput.value = aud.impressoes_estimadas ? formatarNumero(aud.impressoes_estimadas) : '';
      
      document.getElementById('edit_incluido_proposta').checked = aud.incluido_proposta;
      
      document.getElementById('modal_editar_audiencia').showModal();
    } else {
      alert('Erro ao carregar dados da audiência');
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao carregar audiência');
  }
}

async function salvarEdicaoAudiencia() {
  const audienciaId = document.getElementById('edit_audiencia_id').value;
  
  const cpmValor = removerMascaraDinheiro(document.getElementById('edit_cpm_estimado').value);
  const invValor = removerMascaraDinheiro(document.getElementById('edit_investimento_sugerido').value);
  const impValor = removerMascaraNumero(document.getElementById('edit_impressoes_estimadas').value);
  
  const dados = {
    cpm_estimado: cpmValor,
    investimento_sugerido: invValor,
    impressoes_estimadas: impValor,
    incluido_proposta: document.getElementById('edit_incluido_proposta').checked
  };

  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Audiência atualizada com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.message || 'Erro ao atualizar audiência'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao atualizar audiência');
  }
}

function formatarMoeda(valor) {
  if (!valor || valor === '' || valor === null || valor === undefined) return '';
  const num = typeof valor === 'string' ? parseFloat(valor) : valor;
  if (isNaN(num)) return '';
  return num.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
}

function formatarNumero(valor) {
  if (!valor || valor === '' || valor === null || valor === undefined) return '';
  const num = typeof valor === 'string' ? parseInt(valor) : valor;
  if (isNaN(num)) return '';
  return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

async function toggleIncluirAudiencia(audienciaId, incluir) {
  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ incluido_proposta: incluir })
    });

    const result = await response.json();
    
    if (response.ok) {
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao atualizar audiência'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao atualizar audiência');
  }
}

async function removerAudienciaCotacao(audienciaId) {
  if (!confirm('Tem certeza que deseja remover esta audiência?')) {
    return;
  }

  try {
    const response = await fetch(`/api/cotacoes/audiencias/${audienciaId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    
    if (response.ok) {
      alert('Audiência removida com sucesso!');
      location.reload();
    } else {
      alert('Erro: ' + (result.error || 'Erro ao remover audiência'));
    }
  } catch (error) {
    console.error('Erro:', error);
    alert('Erro ao remover audiência');
  }
}

// ==================== COMENTÁRIOS ====================

// Remover comentário
async function removerComentario(comentarioId) {
  if (!confirm('Deseja realmente remover este comentário?')) return;
  
  try {
    const response = await fetch(`/api/cotacoes/comentarios/${comentarioId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      location.reload();
    } else {
      alert('Erro ao remover comentário: ' + data.message);
    }
  } catch (error) {
    console.error('Erro ao remover comentário:', error);
    alert('Erro ao remover comentário');
  }
}
</script>

{% endblock %}
