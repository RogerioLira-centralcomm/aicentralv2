{% extends 'base_tailwind.html' %}

{% block title %}{% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %} - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="mb-2">
    <h1 class="text-lg font-semibold">{% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %}</h1>
    <p class="text-xs text-base-content/70">{% if modo == 'novo' %}Criar nova cotação{% else %}Atualizar dados da cotação{% endif %}</p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-2">
        {% for category, message in messages %}
          <div class="alert alert-sm py-1 {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% else %}alert-info{% endif %}">
            <span class="text-sm">{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card bg-base-100 shadow-sm">
    <div class="card-body p-4">
      <form method="POST" class="space-y-3">
        
        <!-- LINHA 1: Informações Básicas -->
        <div>
          <h2 class="text-sm font-bold mb-2 pb-1 border-b text-primary">Informações Básicas</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
            {% if modo == 'editar' and cotacao %}
            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Nº Cotação</span></label>
              <input type="text" value="{{ cotacao.numero_cotacao }}" class="input input-bordered input-sm" disabled>
            </div>
            {% endif %}

            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Cliente *</span></label>
              <input type="hidden" name="client_id" id="client_id" value="{% if modo == 'editar' and cotacao %}{{ cotacao.client_id }}{% elif cliente_selecionado %}{{ cliente_selecionado }}{% endif %}" required>
              <div class="flex gap-1 items-center">
                <div class="flex-1 px-2 py-1.5 border border-base-300 rounded bg-base-100 text-sm truncate h-8 flex items-center">
                  <span id="nome_cliente_selecionado">{% if modo == 'editar' and cotacao %}{{ cotacao.cliente_nome }}{% else %}Selecione...{% endif %}</span>
                </div>
                <button type="button" onclick="document.getElementById('modal_escolher_cliente').showModal()" class="btn btn-sm btn-square btn-outline" style="color:#72cd80;border-color:#72cd80;">
                  <i class="fas fa-search text-xs"></i>
                </button>
              </div>
            </div>

            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Nome da Campanha *</span></label>
              <input type="text" name="nome_campanha" value="{{ cotacao.nome_campanha if cotacao else '' }}" class="input input-bordered input-sm" placeholder="Ex: Campanha Verão 2025" required>
            </div>

            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Responsável Comercial</span></label>
              <select name="responsavel_comercial" class="select select-bordered h-9 min-h-0 text-sm">
                <option value="">Selecione...</option>
                {% for vendedor in vendedores %}
                <option value="{{ vendedor.id_contato_cliente }}" {% if cotacao and cotacao.responsavel_comercial == vendedor.id_contato_cliente %}selected{% endif %}>{{ vendedor.nome_completo }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Contato do Cliente</span></label>
              <select name="client_user_id" id="client_user_id" class="select select-bordered h-9 min-h-0 text-sm">
                <option value="">Selecione...</option>
                {% if cotacao and contatos_cliente %}
                  {% for contato in contatos_cliente %}
                  <option value="{{ contato.id_contato_cliente }}" {% if cotacao.client_user_id == contato.id_contato_cliente %}selected{% endif %}>{{ contato.nome_completo }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Briefing</span></label>
              <select name="briefing_id" id="briefing_id" class="select select-bordered h-9 min-h-0 text-sm">
                <option value="">Selecione...</option>
                {% if briefings %}
                  {% for briefing in briefings %}
                  <option value="{{ briefing.id }}" {% if cotacao and cotacao.briefing_id == briefing.id %}selected{% endif %}>{{ briefing.titulo }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>
        </div>

        <!-- LINHA 2: Datas e Valores -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <!-- Início -->
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Início *</span></label>
            <div class="join">
              <button type="button" class="join-item btn btn-sm bg-base-200 px-2" onclick="document.getElementById('periodo_inicio').showPicker()">
                <i class="fas fa-calendar-alt text-primary"></i>
              </button>
              <input type="date" id="periodo_inicio" name="periodo_inicio" value="{% if cotacao and cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%Y-%m-%d') if cotacao.periodo_inicio.strftime else cotacao.periodo_inicio }}{% endif %}" class="input input-bordered input-sm join-item w-full" required>
            </div>
          </div>
          <!-- Término -->
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Término</span></label>
            <div class="join">
              <button type="button" class="join-item btn btn-sm bg-base-200 px-2" onclick="document.getElementById('periodo_fim').showPicker()">
                <i class="fas fa-calendar-alt text-primary"></i>
              </button>
              <input type="date" id="periodo_fim" name="periodo_fim" value="{% if cotacao and cotacao.periodo_fim %}{{ cotacao.periodo_fim.strftime('%Y-%m-%d') if cotacao.periodo_fim.strftime else cotacao.periodo_fim }}{% endif %}" class="input input-bordered input-sm join-item w-full">
            </div>
          </div>
          <!-- Budget Estimado -->
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Budget Est. (R$)</span></label>
            <input type="text" id="budget_estimado" name="budget_estimado_display" value="{{ "%.2f"|format(cotacao.budget_estimado) if cotacao and cotacao.budget_estimado else '' }}" class="input input-bordered input-sm" placeholder="0,00" oninput="formatarMoedaReal(this, 'budget_estimado_hidden')">
            <input type="hidden" id="budget_estimado_hidden" name="budget_estimado">
          </div>
          <!-- Valor Total -->
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Valor Total (R$) *</span></label>
            <input type="text" id="valor_total_proposta" name="valor_total_proposta_display" value="{{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao and cotacao.valor_total_proposta else '' }}" class="input input-bordered input-sm" placeholder="0,00" oninput="formatarMoedaReal(this, 'valor_total_proposta_hidden')" required>
            <input type="hidden" id="valor_total_proposta_hidden" name="valor_total_proposta">
          </div>
        </div>

        {% if modo == 'editar' %}
        <!-- LINHA 3: Status (só em edição) -->
        <div>
          <h2 class="text-sm font-bold mb-2 pb-1 border-b text-primary">Status</h2>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="form-control">
              <label class="label py-0.5"><span class="label-text text-xs font-medium">Status</span></label>
              <select name="status" class="select select-bordered h-9 min-h-0 text-sm">
                <option value="Pendente" {% if cotacao.status == 'Pendente' %}selected{% endif %}>Pendente</option>
                <option value="Rascunho" {% if cotacao.status == 'Rascunho' %}selected{% endif %}>Rascunho</option>
                <option value="Em Análise" {% if cotacao.status == 'Em Análise' %}selected{% endif %}>Em Análise</option>
                <option value="Enviada" {% if cotacao.status == 'Enviada' %}selected{% endif %}>Enviada</option>
                <option value="Aprovada" {% if cotacao.status == 'Aprovada' %}selected{% endif %}>Aprovada</option>
                <option value="Rejeitada" {% if cotacao.status == 'Rejeitada' %}selected{% endif %}>Rejeitada</option>
                <option value="Expirada" {% if cotacao.status == 'Expirada' %}selected{% endif %}>Expirada</option>
              </select>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- LINHA 4: Objetivo e Observações lado a lado -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Objetivo da Campanha</span></label>
            <textarea name="objetivo_campanha" class="textarea textarea-bordered textarea-sm text-sm" rows="2" placeholder="Descreva o objetivo...">{{ cotacao.objetivo_campanha if cotacao else '' }}</textarea>
          </div>
          <div class="form-control">
            <label class="label py-0.5"><span class="label-text text-xs font-medium">Observações</span></label>
            <textarea name="observacoes" class="textarea textarea-bordered textarea-sm text-sm" rows="2" placeholder="Notas gerais...">{{ cotacao.observacoes if cotacao else '' }}</textarea>
          </div>
        </div>

        {% if modo == 'editar' %}
        <div class="form-control">
          <label class="label py-0.5"><span class="label-text text-xs font-medium">Observações Internas</span></label>
          <textarea name="observacoes_internas" class="textarea textarea-bordered textarea-sm text-sm" rows="2" placeholder="Notas internas (não visíveis ao cliente)...">{{ cotacao.observacoes_internas if cotacao else '' }}</textarea>
        </div>
        {% endif %}

        <input type="hidden" name="origem" value="Admin">

        <!-- Botões lado a lado à direita -->
        <div class="flex justify-end gap-2 pt-2 border-t">
          <a href="{{ url_for('cotacoes_list') }}" class="btn btn-sm btn-ghost">
            <i class="fas fa-arrow-left mr-1"></i>Voltar
          </a>
          <button type="submit" class="btn btn-sm text-white" style="background-color:#72cd80;border-color:#72cd80;">
            <i class="fas fa-save mr-1"></i>{% if modo == 'novo' %}Criar Cotação{% else %}Salvar{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Busca de Cliente -->
<dialog id="modal_escolher_cliente" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Buscar Cliente</h3>
    
    <div class="flex gap-2 mb-4">
      <input 
        type="text" 
        id="busca_cliente_modal" 
        placeholder="Digite nome, CNPJ, razão social..." 
        class="input input-bordered flex-1"
        onkeyup="buscarClientesModal()"
      >
      <button onclick="limparBuscaModal()" class="btn btn-ghost">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="resultados_modal" class="max-h-96 overflow-y-auto mb-4">
      <p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Cancelar</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
async function buscarClientesModal() {
  const termo = document.getElementById('busca_cliente_modal').value.trim();
  const resultados = document.getElementById('resultados_modal');

  if (termo.length < 2) {
    resultados.innerHTML = '<p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>';
    return;
  }

  try {
    const response = await fetch('/api/clientes/buscar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome: termo,
        razao: termo
      })
    });

    const result = await response.json();

    if (result.success && result.clientes.length > 0) {
      let html = '<div class="space-y-2">';
      result.clientes.forEach(cliente => {
        const documento = cliente.cnpj || '-';
        const clienteId = cliente.pk_id_tbl_cliente;
        html += `
          <div class="border border-base-300 rounded-lg p-3 hover:bg-base-200 cursor-pointer transition" 
               onclick="selecionarClienteForm('${clienteId}', '${cliente.nome_fantasia.replace(/'/g, "\\'")}')">
            <p class="font-semibold text-sm">${cliente.nome_fantasia}</p>
            <p class="text-xs text-base-content/60">${cliente.razao_social || '-'}</p>
            <p class="text-xs text-base-content/50">${documento}</p>
          </div>
        `;
      });
      html += '</div>';
      resultados.innerHTML = html;
    } else {
      resultados.innerHTML = '<p class="text-center text-base-content/50 py-8">Nenhum cliente encontrado</p>';
    }
  } catch (error) {
    console.error('Erro ao buscar:', error);
    resultados.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao buscar clientes</p>';
  }
}

function limparBuscaModal() {
  document.getElementById('busca_cliente_modal').value = '';
  document.getElementById('resultados_modal').innerHTML = '<p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>';
}

function selecionarClienteForm(clienteId, nomeFantasia) {
  // Preencher campo hidden
  document.getElementById('client_id').value = clienteId;
  
  // Atualizar texto exibido
  document.getElementById('nome_cliente_selecionado').textContent = nomeFantasia;
  
  // Disparar evento change para carregar contatos e briefings
  const event = new Event('change', { bubbles: true });
  document.getElementById('client_id').dispatchEvent(event);
  
  // Fechar modal
  document.getElementById('modal_escolher_cliente').close();
}
</script>

<script>
// Auto-preencher datas ao carregar (somente para nova cotação)
document.addEventListener('DOMContentLoaded', function() {
    const periodoInicio = document.getElementById('periodo_inicio');
    const periodoFim = document.getElementById('periodo_fim');
    
    // Só preencher se os campos estiverem vazios (nova cotação)
    if (periodoInicio && !periodoInicio.value) {
        const hoje = new Date();
        const dataInicio = new Date(hoje);
        dataInicio.setDate(dataInicio.getDate() + 7); // +7 dias
        periodoInicio.value = dataInicio.toISOString().split('T')[0];
    }
    
    if (periodoFim && !periodoFim.value) {
        const hoje = new Date();
        const dataFim = new Date(hoje);
        dataFim.setDate(dataFim.getDate() + 37); // +37 dias
        periodoFim.value = dataFim.toISOString().split('T')[0];
    }
});

// Formatar moeda brasileira em tempo real
function formatarMoedaReal(input, hiddenFieldId) {
  let value = input.value.replace(/\D/g, '');
  
  if (value === '') {
    input.value = '';
    document.getElementById(hiddenFieldId).value = '';
    return;
  }
  
  // Converter para número com 2 casas decimais
  value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  input.value = value;
  
  // Armazenar valor numérico no campo hidden para enviar ao backend
  const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
  document.getElementById(hiddenFieldId).value = valorNumerico;
}

// Ao submeter o formulário, garantir que os valores corretos são enviados
document.querySelector('form').addEventListener('submit', function(e) {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    const hiddenInput = document.getElementById(campo + '_hidden');
    if (displayInput && displayInput.value) {
      if (!displayInput.value.includes(',')) {
        formatarMoedaReal(displayInput, campo + '_hidden');
      }
    }
  });
});

// Ao carregar a página, formatar os valores se existirem
document.addEventListener('DOMContentLoaded', function() {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    if (displayInput && displayInput.value) {
      formatarMoedaReal(displayInput, campo + '_hidden');
    }
  });
  
  // Atualizar briefings e contatos quando o cliente for alterado
  const clienteSelect = document.getElementById('client_id');
  if (clienteSelect) {
    clienteSelect.addEventListener('change', async function() {
      const clienteId = this.value;
      const briefingSelect = document.getElementById('briefing_id');
      const contatoSelect = document.getElementById('client_user_id');
      
      // Limpar opções atuais
      briefingSelect.innerHTML = '<option value="">Selecione um briefing</option>';
      contatoSelect.innerHTML = '<option value="">Selecione um contato</option>';
      
      if (clienteId) {
        try {
          // Buscar briefings
          const responseBriefings = await fetch(`/api/briefings/cliente/${clienteId}`);
          if (responseBriefings.ok) {
            const briefings = await responseBriefings.json();
            briefings.forEach(briefing => {
              const option = document.createElement('option');
              option.value = briefing.id;
              option.textContent = briefing.titulo + (briefing.status ? ` (${briefing.status})` : '');
              briefingSelect.appendChild(option);
            });
          }
          
          // Buscar contatos do cliente (setores Comercial e Operações)
          const responseContatos = await fetch(`/api/clientes/${clienteId}/contatos-briefing`);
          if (responseContatos.ok) {
            const contatos = await responseContatos.json();
            contatos.forEach(contato => {
              const option = document.createElement('option');
              option.value = contato.id_contato_cliente;
              option.textContent = contato.nome_completo + (contato.email ? ` - ${contato.email}` : '');
              contatoSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Erro ao carregar dados do cliente:', error);
        }
      }
    });
  }
});

</script>
{% endblock %}
