{% extends 'base_tailwind.html' %}

{% block title %}{% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %} - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
  <div class="mb-3">
    <h1 class="text-lg font-semibold leading-tight">
      {% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %}
    </h1>
    <p class="text-sm text-base-content/70">
      {% if modo == 'novo' %}Criar uma nova cotação{% else %}Atualizar dados da cotação{% endif %}
    </p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <form method="POST" class="space-y-6">
        
        <!-- Informações Básicas -->
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Informações Básicas</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Número da Cotação (somente leitura em edição) -->
            {% if modo == 'editar' and cotacao %}
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Número da Cotação</span>
              </label>
              <input type="text" value="{{ cotacao.numero_cotacao }}" class="input input-bordered" disabled>
            </div>
            {% endif %}

            <!-- Cliente -->
            <div class="form-control">
              <label class="label" id="label_cliente">
                <span class="label-text font-semibold">Cliente *</span>
              </label>
              <input type="hidden" name="client_id" id="client_id" value="{% if modo == 'editar' and cotacao %}{{ cotacao.client_id }}{% elif cliente_selecionado %}{{ cliente_selecionado }}{% endif %}" required>
              <div class="flex gap-2 items-center">
                <div class="flex-1 px-3 py-2 border border-base-300 rounded-lg bg-base-100">
                  <span id="nome_cliente_selecionado" class="text-sm">
                    {% if modo == 'editar' and cotacao %}
                      {{ cotacao.cliente_nome }}
                    {% else %}
                      Nenhum cliente selecionado
                    {% endif %}
                  </span>
                </div>
                <button type="button" onclick="document.getElementById('modal_escolher_cliente').showModal()" class="btn btn-sm btn-outline btn-primary" title="Buscar cliente">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>

            <!-- Nome da Campanha -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Nome da Campanha *</span>
              </label>
              <input 
                type="text" 
                name="nome_campanha" 
                value="{{ cotacao.nome_campanha if cotacao else '' }}" 
                class="input input-bordered" 
                placeholder="Ex: Campanha Verão 2025"
                required
              >
            </div>

            <!-- Responsável Comercial -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Responsável Comercial</span>
              </label>
              <select name="responsavel_comercial" class="select select-bordered">
                <option value="">Selecione um responsável</option>
                {% for vendedor in vendedores %}
                <option value="{{ vendedor.id_contato_cliente }}" {% if cotacao and cotacao.responsavel_comercial == vendedor.id_contato_cliente %}selected{% endif %}>
                  {{ vendedor.nome_completo }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Contato do Cliente -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Contato do Cliente</span>
              </label>
              <select name="client_user_id" id="client_user_id" class="select select-bordered">
                <option value="">Selecione um contato</option>
                {% if cotacao and contatos_cliente %}
                  {% for contato in contatos_cliente %}
                  <option value="{{ contato.id_contato_cliente }}" {% if cotacao.client_user_id == contato.id_contato_cliente %}selected{% endif %}>
                    {{ contato.nome_completo }}{% if contato.email %} - {{ contato.email }}{% endif %}
                  </option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>

          <!-- Objetivo da Campanha -->
          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text font-semibold">Objetivo da Campanha</span>
            </label>
            <textarea 
              name="objetivo_campanha" 
              class="textarea textarea-bordered" 
              rows="2"
              placeholder="Descreva o objetivo principal da campanha..."
            >{{ cotacao.objetivo_campanha if cotacao else '' }}</textarea>
          </div>
        </div>

        <!-- Datas da Campanha -->
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Datas</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Período Início -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Data de Início *</span>
              </label>
              <input 
                type="date" 
                name="periodo_inicio" 
                value="{% if cotacao and cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%Y-%m-%d') if cotacao.periodo_inicio.strftime else cotacao.periodo_inicio }}{% endif %}"
                class="input input-bordered"
                required
              >
            </div>

            <!-- Período Fim -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Data de Término</span>
              </label>
              <input 
                type="date" 
                name="periodo_fim" 
                value="{% if cotacao and cotacao.periodo_fim %}{{ cotacao.periodo_fim.strftime('%Y-%m-%d') if cotacao.periodo_fim.strftime else cotacao.periodo_fim }}{% endif %}"
                class="input input-bordered"
              >
            </div>

            <!-- Expires At (Expiração da Cotação) -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Expiração da Cotação</span>
              </label>
              <input 
                type="datetime-local" 
                name="expires_at" 
                value="{% if cotacao and cotacao.expires_at %}{{ cotacao.expires_at.strftime('%Y-%m-%dT%H:%M') if cotacao.expires_at.strftime else cotacao.expires_at }}{% endif %}"
                class="input input-bordered"
              >
            </div>

            <!-- Proposta Enviada Em (somente leitura) -->
            {% if modo == 'editar' and cotacao and cotacao.proposta_enviada_em %}
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Proposta Enviada em</span>
              </label>
              <input type="text" value="{{ cotacao.proposta_enviada_em.strftime('%d/%m/%Y %H:%M') if cotacao.proposta_enviada_em.strftime else cotacao.proposta_enviada_em }}" class="input input-bordered" disabled>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Detalhes da Peça -->
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Detalhes da Peça/Campanha</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Meio -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Meio</span>
              </label>
              <input 
                type="text" 
                name="meio" 
                value="{{ cotacao.meio if cotacao else '' }}" 
                class="input input-bordered" 
                placeholder="Ex: Digital, TV, Rádio, Mídia Impressa"
              >
            </div>

            <!-- Tipo de Peça -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Tipo de Peça</span>
              </label>
              <input 
                type="text" 
                name="tipo_peca" 
                value="{{ cotacao.tipo_peca if cotacao else '' }}" 
                class="input input-bordered" 
                placeholder="Ex: Banner, Vídeo, Anúncio, Conteúdo"
              >
            </div>

            <!-- Briefing -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Briefing</span>
              </label>
              <select 
                name="briefing_id" 
                id="briefing_id"
                class="select select-bordered"
              >
                <option value="">Selecione um briefing</option>
                {% for briefing in briefings %}
                <option value="{{ briefing.id }}" {% if cotacao and cotacao.briefing_id == briefing.id %}selected{% endif %}>
                  {{ briefing.titulo }}{% if briefing.status %} ({{ briefing.status }}){% endif %}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Valores da Cotação -->
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Valores</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Budget Estimado -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Budget Estimado (R$)</span>
              </label>
              <input 
                type="text" 
                id="budget_estimado" 
                name="budget_estimado_display" 
                value="{{ "%.2f"|format(cotacao.budget_estimado) if cotacao and cotacao.budget_estimado else '' }}" 
                class="input input-bordered" 
                placeholder="0,00"
                oninput="formatarMoedaReal(this, 'budget_estimado_hidden')"
              >
              <input type="hidden" id="budget_estimado_hidden" name="budget_estimado">
            </div>

            <!-- Valor Total da Proposta -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Valor Total da Proposta (R$) *</span>
              </label>
              <input 
                type="text" 
                id="valor_total_proposta" 
                name="valor_total_proposta_display" 
                value="{{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao and cotacao.valor_total_proposta else '' }}" 
                class="input input-bordered" 
                placeholder="0,00"
                oninput="formatarMoedaReal(this, 'valor_total_proposta_hidden')"
                required
              >
              <input type="hidden" id="valor_total_proposta_hidden" name="valor_total_proposta">
            </div>
          </div>
        </div>

        <!-- Status e Links Públicos -->
        {% if modo == 'editar' %}
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Status e Link Público</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Status -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Status</span>
              </label>
              <select name="status" class="select select-bordered">
                <option value="pendente" {% if cotacao.status == 'pendente' %}selected{% endif %}>Pendente</option>
                <option value="aprovada" {% if cotacao.status == 'aprovada' %}selected{% endif %}>Aprovada</option>
                <option value="rejeitada" {% if cotacao.status == 'rejeitada' %}selected{% endif %}>Rejeitada</option>
                <option value="expirada" {% if cotacao.status == 'expirada' %}selected{% endif %}>Expirada</option>
              </select>
            </div>

            <!-- Link Público Ativo -->
            <div class="form-control">
              <label class="label cursor-pointer">
                <span class="label-text font-semibold">Habilitar Link Público</span>
                <input type="checkbox" name="link_publico_ativo" class="checkbox" {% if cotacao and cotacao.link_publico_ativo %}checked{% endif %}>
              </label>
            </div>

            <!-- Token do Link Público -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Token do Link</span>
              </label>
              <input 
                type="text" 
                name="link_publico_token" 
                value="{{ cotacao.link_publico_token if cotacao and cotacao.link_publico_token else '' }}" 
                class="input input-bordered font-mono text-xs"
                placeholder="Deixe em branco para gerar automaticamente"
              >
            </div>

            <!-- Aprovada Em (somente leitura) -->
            {% if cotacao and cotacao.aprovada_em %}
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Aprovada em</span>
              </label>
              <input type="text" value="{{ cotacao.aprovada_em.strftime('%d/%m/%Y %H:%M') if cotacao.aprovada_em.strftime else cotacao.aprovada_em }}" class="input input-bordered" disabled>
            </div>
            {% endif %}

            <!-- Link Público Expira Em -->
            <div class="form-control">
              <label class="label">
                <span class="label-text font-semibold">Link Expira em</span>
              </label>
              <input 
                type="datetime-local" 
                name="link_publico_expires_at" 
                value="{% if cotacao and cotacao.link_publico_expires_at %}{{ cotacao.link_publico_expires_at.strftime('%Y-%m-%dT%H:%M') if cotacao.link_publico_expires_at.strftime else cotacao.link_publico_expires_at }}{% endif %}"
                class="input input-bordered"
              >
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Observações -->
        <div>
          <h2 class="text-lg font-bold mb-4 pb-2 border-b">Observações</h2>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Observações</span>
            </label>
            <textarea 
              name="observacoes" 
              class="textarea textarea-bordered" 
              rows="3"
              placeholder="Notas gerais sobre a cotação..."
            >{{ cotacao.observacoes if cotacao else '' }}</textarea>
          </div>

          {% if modo == 'editar' %}
          <div class="form-control mt-4">
            <label class="label">
              <span class="label-text font-semibold">Observações Internas</span>
            </label>
            <textarea 
              name="observacoes_internas" 
              class="textarea textarea-bordered" 
              rows="3"
              placeholder="Notas internas (não visíveis ao cliente)..."
            >{{ cotacao.observacoes_internas if cotacao else '' }}</textarea>
          </div>
          {% endif %}
        </div>

        <!-- Origem -->
        <div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Origem</span>
            </label>
            <input 
              type="text" 
              name="origem" 
              value="{{ cotacao.origem if cotacao else '' }}" 
              class="input input-bordered" 
              placeholder="Ex: Website, LinkedIn, Referência"
            >
          </div>
        </div>

        <!-- Ações -->
        <div class="divider"></div>

        <div class="flex justify-between gap-3">
          <a href="{{ url_for('cotacoes_list') }}" class="btn btn-ghost">
            <i class="fas fa-arrow-left mr-2"></i>Voltar
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save mr-2"></i>
            {% if modo == 'novo' %}Criar Cotação{% else %}Salvar Alterações{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Busca de Cliente -->
<dialog id="modal_escolher_cliente" class="modal">
  <div class="modal-box w-11/12 max-w-2xl">
    <h3 class="font-bold text-lg mb-4">Buscar Cliente</h3>
    
    <div class="flex gap-2 mb-4">
      <input 
        type="text" 
        id="busca_cliente_modal" 
        placeholder="Digite nome, CNPJ, razão social..." 
        class="input input-bordered flex-1"
        onkeyup="buscarClientesModal()"
      >
      <button onclick="limparBuscaModal()" class="btn btn-ghost">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div id="resultados_modal" class="max-h-96 overflow-y-auto mb-4">
      <p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>
    </div>

    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Cancelar</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
async function buscarClientesModal() {
  const termo = document.getElementById('busca_cliente_modal').value.trim();
  const resultados = document.getElementById('resultados_modal');

  if (termo.length < 2) {
    resultados.innerHTML = '<p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>';
    return;
  }

  try {
    const response = await fetch('/api/clientes/buscar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome: termo,
        razao: termo
      })
    });

    const result = await response.json();

    if (result.success && result.clientes.length > 0) {
      let html = '<div class="space-y-2">';
      result.clientes.forEach(cliente => {
        const documento = cliente.cnpj || '-';
        const clienteId = cliente.pk_id_tbl_cliente;
        html += `
          <div class="border border-base-300 rounded-lg p-3 hover:bg-base-200 cursor-pointer transition" 
               onclick="selecionarClienteForm('${clienteId}', '${cliente.nome_fantasia.replace(/'/g, "\\'")}')">
            <p class="font-semibold text-sm">${cliente.nome_fantasia}</p>
            <p class="text-xs text-base-content/60">${cliente.razao_social || '-'}</p>
            <p class="text-xs text-base-content/50">${documento}</p>
          </div>
        `;
      });
      html += '</div>';
      resultados.innerHTML = html;
    } else {
      resultados.innerHTML = '<p class="text-center text-base-content/50 py-8">Nenhum cliente encontrado</p>';
    }
  } catch (error) {
    console.error('Erro ao buscar:', error);
    resultados.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao buscar clientes</p>';
  }
}

function limparBuscaModal() {
  document.getElementById('busca_cliente_modal').value = '';
  document.getElementById('resultados_modal').innerHTML = '<p class="text-center text-base-content/50 py-8">Digite para buscar clientes...</p>';
}

function selecionarClienteForm(clienteId, nomeFantasia) {
  // Preencher campo hidden
  document.getElementById('client_id').value = clienteId;
  
  // Atualizar texto exibido
  document.getElementById('nome_cliente_selecionado').textContent = nomeFantasia;
  
  // Disparar evento change para carregar contatos e briefings
  const event = new Event('change', { bubbles: true });
  document.getElementById('client_id').dispatchEvent(event);
  
  // Fechar modal
  document.getElementById('modal_escolher_cliente').close();
}
</script>

<script>
// Formatar moeda brasileira em tempo real
function formatarMoedaReal(input, hiddenFieldId) {
  let value = input.value.replace(/\D/g, '');
  
  if (value === '') {
    input.value = '';
    document.getElementById(hiddenFieldId).value = '';
    return;
  }
  
  // Converter para número com 2 casas decimais
  value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  input.value = value;
  
  // Armazenar valor numérico no campo hidden para enviar ao backend
  const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
  document.getElementById(hiddenFieldId).value = valorNumerico;
}

// Ao submeter o formulário, garantir que os valores corretos são enviados
document.querySelector('form').addEventListener('submit', function(e) {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    const hiddenInput = document.getElementById(campo + '_hidden');
    if (displayInput && displayInput.value) {
      if (!displayInput.value.includes(',')) {
        formatarMoedaReal(displayInput, campo + '_hidden');
      }
    }
  });
});

// Ao carregar a página, formatar os valores se existirem
document.addEventListener('DOMContentLoaded', function() {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    if (displayInput && displayInput.value) {
      formatarMoedaReal(displayInput, campo + '_hidden');
    }
  });
  
  // Atualizar briefings e contatos quando o cliente for alterado
  const clienteSelect = document.getElementById('client_id');
  if (clienteSelect) {
    clienteSelect.addEventListener('change', async function() {
      const clienteId = this.value;
      const briefingSelect = document.getElementById('briefing_id');
      const contatoSelect = document.getElementById('client_user_id');
      
      // Limpar opções atuais
      briefingSelect.innerHTML = '<option value="">Selecione um briefing</option>';
      contatoSelect.innerHTML = '<option value="">Selecione um contato</option>';
      
      if (clienteId) {
        try {
          // Buscar briefings
          const responseBriefings = await fetch(`/api/briefings/cliente/${clienteId}`);
          if (responseBriefings.ok) {
            const briefings = await responseBriefings.json();
            briefings.forEach(briefing => {
              const option = document.createElement('option');
              option.value = briefing.id;
              option.textContent = briefing.titulo + (briefing.status ? ` (${briefing.status})` : '');
              briefingSelect.appendChild(option);
            });
          }
          
          // Buscar contatos do cliente
          const responseContatos = await fetch(`/api/clientes/${clienteId}/contatos`);
          if (responseContatos.ok) {
            const contatos = await responseContatos.json();
            contatos.forEach(contato => {
              const option = document.createElement('option');
              option.value = contato.id_contato_cliente;
              option.textContent = contato.nome_completo + (contato.email ? ` - ${contato.email}` : '');
              contatoSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Erro ao carregar dados do cliente:', error);
        }
      }
    });
  }
});
</script>
{% endblock %}
