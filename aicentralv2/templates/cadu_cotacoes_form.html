{% extends 'base_tailwind.html' %}

{% block title %}{% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %} - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (max 66px) estilo CRM -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Voltar + Título -->
      <div class="flex items-center gap-3">
        <a href="{{ url_for('cotacoes_list') }}" class="p-1.5 rounded hover:bg-gray-100 transition-colors text-gray-500" title="Voltar">
          <i class="fas fa-arrow-left text-sm"></i>
        </a>
        <div>
          <h1 class="text-lg font-semibold text-gray-800">{% if modo == 'novo' %}Nova Cotação{% else %}Editar Cotação{% endif %}</h1>
          <p class="text-xs text-gray-500">{% if modo == 'novo' %}Criar nova cotação{% else %}Atualizar dados da cotação{% endif %}</p>
        </div>
      </div>
      
      <!-- Ações -->
      <div class="flex items-center gap-2">
        <button type="submit" form="cotacao_form" class="px-3 py-1.5 text-sm rounded text-white transition-colors" style="background-color: #72cd80;">
          <i class="fas fa-save mr-1"></i>{% if modo == 'novo' %}Criar{% else %}Salvar{% endif %}
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="px-4 py-2 rounded border text-sm {% if category == 'error' %}bg-red-50 border-red-200 text-red-700{% elif category == 'success' %}bg-green-50 border-green-200 text-green-700{% else %}bg-blue-50 border-blue-200 text-blue-700{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="bg-white rounded border border-gray-200 p-4">
    <form id="cotacao_form" method="POST" class="space-y-4">
      
      <!-- LINHA 1: Informações Básicas -->
      <div>
        <h2 class="text-sm font-semibold text-gray-800 mb-3 pb-1 border-b border-gray-200">Informações Básicas</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          {% if modo == 'editar' and cotacao %}
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Nº Cotação</label>
            <input type="text" value="{{ cotacao.numero_cotacao }}" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-100 text-gray-500" disabled>
          </div>
          {% endif %}

          <!-- Cliente e Contato do Cliente (empilhados) -->
          <div class="space-y-2">
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Cliente *</label>
              <input type="hidden" name="client_id" id="client_id" value="{% if modo == 'editar' and cotacao %}{{ cotacao.client_id }}{% elif cliente_selecionado %}{{ cliente_selecionado }}{% endif %}" required>
              <div class="flex gap-1 items-center">
                <div class="flex-1 px-3 py-1.5 border border-gray-200 rounded bg-white text-sm truncate h-8 flex items-center text-gray-700">
                  <span id="nome_cliente_selecionado">{% if modo == 'editar' and cotacao %}{{ cotacao.cliente_nome }}{% else %}Selecione...{% endif %}</span>
                </div>
                <button type="button" onclick="document.getElementById('modal_escolher_cliente').showModal()" class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 transition-colors" style="color:#72cd80;border-color:#72cd80;">
                  <i class="fas fa-search text-xs"></i>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Contato do Cliente</label>
              <select name="client_user_id" id="client_user_id" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none">
                <option value="">Selecione...</option>
                {% if cotacao and contatos_cliente %}
                  {% for contato in contatos_cliente %}
                  <option value="{{ contato.id_contato_cliente }}" {% if cotacao.client_user_id == contato.id_contato_cliente %}selected{% endif %}>{{ contato.nome_completo }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>

          <!-- Agência e Contato Agência (empilhados) -->
          <div class="space-y-2">
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Agência</label>
              <input type="hidden" name="agencia_id" id="agencia_id" value="{% if modo == 'editar' and cotacao and cotacao.agencia_id %}{{ cotacao.agencia_id }}{% endif %}">
              <div class="flex gap-1 items-center">
                <div class="flex-1 px-3 py-1.5 border border-gray-200 rounded bg-white text-sm truncate h-8 flex items-center text-gray-700">
                  <span id="nome_agencia_selecionada">{% if modo == 'editar' and cotacao and cotacao.agencia_nome %}{{ cotacao.agencia_nome }}{% else %}Nenhuma{% endif %}</span>
                </div>
                <button type="button" onclick="document.getElementById('modal_escolher_agencia').showModal()" class="p-1.5 rounded border border-gray-300 hover:bg-gray-50 transition-colors" style="color:#72cd80;border-color:#72cd80;">
                  <i class="fas fa-search text-xs"></i>
                </button>
                <button type="button" onclick="limparAgenciaSelecionada()" class="p-1.5 rounded hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors" title="Limpar">
                  <i class="fas fa-times text-xs"></i>
                </button>
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-600 mb-1">Contato Agência</label>
              <select name="agencia_user_id" id="agencia_user_id" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none">
                <option value="">Selecione...</option>
                {% if cotacao and contatos_agencia %}
                  {% for contato in contatos_agencia %}
                  <option value="{{ contato.id_contato_cliente }}" {% if cotacao.agencia_user_id == contato.id_contato_cliente %}selected{% endif %}>{{ contato.nome_completo }}</option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>

          <!-- Dados da Campanha -->
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Nome da Campanha *</label>
            <input type="text" name="nome_campanha" value="{{ cotacao.nome_campanha if cotacao else '' }}" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" placeholder="Ex: Campanha Verão 2025" required>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Responsável Comercial</label>
            <select name="responsavel_comercial" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none">
              <option value="">Selecione...</option>
              {% for vendedor in vendedores %}
              <option value="{{ vendedor.id_contato_cliente }}" {% if cotacao and cotacao.responsavel_comercial == vendedor.id_contato_cliente %}selected{% endif %}>{{ vendedor.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Briefing</label>
            <input type="hidden" name="briefing_id" id="briefing_id" value="{% if cotacao and cotacao.briefing_id %}{{ cotacao.briefing_id }}{% endif %}">
            <div class="relative">
              <div class="flex gap-1 items-center">
                <input type="text" 
                       id="briefing_busca" 
                       class="flex-1 text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none"
                       placeholder="Digite para buscar briefing..."
                       value="{% if cotacao and cotacao.briefing_titulo %}{{ cotacao.briefing_titulo }}{% endif %}"
                       oninput="buscarBriefingsAutocomplete(this.value)"
                       onfocus="mostrarSugestoesBriefing()"
                       autocomplete="off">
                <button type="button" onclick="limparBriefingSelecionado()" class="p-1.5 rounded hover:bg-gray-100 text-gray-400 hover:text-red-500 transition-colors" title="Limpar">
                  <i class="fas fa-times text-xs"></i>
                </button>
              </div>
              <div id="briefing_sugestoes" class="absolute z-50 w-full bg-white border border-gray-200 rounded-b shadow-lg max-h-48 overflow-y-auto hidden">
                <!-- Sugestões serão inseridas aqui -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- LINHA 2: Datas e Valores -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <!-- Início -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Início *</label>
          <div class="flex">
            <button type="button" class="px-2 py-1.5 bg-gray-100 border border-r-0 border-gray-200 rounded-l text-gray-500" onclick="document.getElementById('periodo_inicio').showPicker()">
              <i class="fas fa-calendar-alt text-xs"></i>
            </button>
            <input type="date" id="periodo_inicio" name="periodo_inicio" value="{% if cotacao and cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%Y-%m-%d') if cotacao.periodo_inicio.strftime else cotacao.periodo_inicio }}{% endif %}" class="flex-1 text-sm border border-gray-200 rounded-r px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" required>
          </div>
        </div>
        <!-- Término -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Término</label>
          <div class="flex">
            <button type="button" class="px-2 py-1.5 bg-gray-100 border border-r-0 border-gray-200 rounded-l text-gray-500" onclick="document.getElementById('periodo_fim').showPicker()">
              <i class="fas fa-calendar-alt text-xs"></i>
            </button>
            <input type="date" id="periodo_fim" name="periodo_fim" value="{% if cotacao and cotacao.periodo_fim %}{{ cotacao.periodo_fim.strftime('%Y-%m-%d') if cotacao.periodo_fim.strftime else cotacao.periodo_fim }}{% endif %}" class="flex-1 text-sm border border-gray-200 rounded-r px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none">
          </div>
        </div>
        <!-- Budget Estimado -->
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Budget Est. (R$)</label>
          <input type="text" id="budget_estimado" name="budget_estimado_display" value="{{ "%.2f"|format(cotacao.budget_estimado) if cotacao and cotacao.budget_estimado else '' }}" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" placeholder="0,00" oninput="formatarMoedaReal(this, 'budget_estimado_hidden')">
          <input type="hidden" id="budget_estimado_hidden" name="budget_estimado">
        </div>
        <!-- Valor Total (somente em modo edição) -->
        {% if modo == 'editar' %}
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Valor Total (R$)</label>
          <input type="text" id="valor_total_proposta" name="valor_total_proposta_display" value="{{ "%.2f"|format(cotacao.valor_total_proposta) if cotacao and cotacao.valor_total_proposta else '' }}" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none" placeholder="0,00" oninput="formatarMoedaReal(this, 'valor_total_proposta_hidden')">
          <input type="hidden" id="valor_total_proposta_hidden" name="valor_total_proposta">
        </div>
        {% endif %}
      </div>

      {% if modo == 'editar' %}
      <!-- LINHA 3: Status (só em edição) -->
      <div>
        <h2 class="text-sm font-semibold text-gray-800 mb-3 pb-1 border-b border-gray-200">Status</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Status</label>
            <select name="status" class="w-full text-sm border border-gray-200 rounded px-3 py-1.5 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none">
              <option value="Rascunho" {% if cotacao.status == 'Rascunho' or cotacao.status == 'Pendente' %}selected{% endif %}>Rascunho</option>
              <option value="Em Análise" {% if cotacao.status == 'Em Análise' %}selected{% endif %}>Em Análise</option>
              <option value="Enviada" {% if cotacao.status == 'Enviada' %}selected{% endif %}>Enviada</option>
              <option value="Negociação" {% if cotacao.status == 'Negociação' %}selected{% endif %}>Negociação</option>
              <option value="Aprovada" {% if cotacao.status == 'Aprovada' %}selected{% endif %}>Aprovada</option>
              <option value="Rejeitada" {% if cotacao.status == 'Rejeitada' %}selected{% endif %}>Rejeitada</option>
              <option value="Expirada" {% if cotacao.status == 'Expirada' %}selected{% endif %}>Expirada</option>
            </select>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- LINHA 4: Objetivo e Observações lado a lado -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Objetivo da Campanha</label>
          <textarea name="objetivo_campanha" class="w-full text-sm border border-gray-200 rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none resize-none" rows="2" placeholder="Descreva o objetivo...">{{ cotacao.objetivo_campanha if cotacao else '' }}</textarea>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600 mb-1">Observações</label>
          <textarea name="observacoes" class="w-full text-sm border border-gray-200 rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none resize-none" rows="2" placeholder="Notas gerais...">{{ cotacao.observacoes if cotacao else '' }}</textarea>
        </div>
      </div>

      {% if modo == 'editar' %}
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Observações Internas</label>
        <textarea name="observacoes_internas" class="w-full text-sm border border-gray-200 rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none resize-none" rows="2" placeholder="Notas internas (não visíveis ao cliente)...">{{ cotacao.observacoes_internas if cotacao else '' }}</textarea>
      </div>
      {% endif %}

      <input type="hidden" name="origem" value="Admin">
    </form>
  </div>
</div>

<!-- Modal de Busca de Cliente -->
<dialog id="modal_escolher_cliente" class="modal">
  <div class="modal-box w-11/12 max-w-2xl bg-white p-0 rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h3 class="font-semibold text-lg text-gray-800">Buscar Cliente</h3>
    </div>
    
    <div class="p-6">
      <div class="flex gap-2 mb-4">
        <input 
          type="text" 
          id="busca_cliente_modal" 
          placeholder="Digite nome, CNPJ, razão social..." 
          class="flex-1 text-sm border border-gray-200 rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none"
          onkeyup="buscarClientesModal()"
        >
        <button onclick="limparBuscaModal()" class="p-2 rounded hover:bg-gray-100 text-gray-400">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="resultados_modal" class="max-h-96 overflow-y-auto">
        <p class="text-center text-gray-400 py-8">Digite para buscar clientes...</p>
      </div>
    </div>

    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
      <form method="dialog">
        <button class="px-4 py-2 text-sm border border-gray-300 rounded hover:bg-gray-100 text-gray-700">Cancelar</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button>close</button>
  </form>
</dialog>

<!-- Modal de Busca de Agência -->
<dialog id="modal_escolher_agencia" class="modal">
  <div class="modal-box w-11/12 max-w-2xl bg-white p-0 rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h3 class="font-semibold text-lg text-gray-800">Buscar Agência</h3>
    </div>
    
    <div class="p-6">
      <div class="flex gap-2 mb-4">
        <input 
          type="text" 
          id="busca_agencia_modal" 
          placeholder="Digite nome da agência..." 
          class="flex-1 text-sm border border-gray-200 rounded px-3 py-2 bg-gray-50 focus:bg-white focus:border-gray-400 focus:outline-none"
          onkeyup="buscarAgenciasModal()"
        >
        <button onclick="limparBuscaAgenciaModal()" class="p-2 rounded hover:bg-gray-100 text-gray-400">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div id="resultados_agencia_modal" class="max-h-96 overflow-y-auto">
        <p class="text-center text-gray-400 py-8">Digite para buscar agências...</p>
      </div>
    </div>

    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end">
      <form method="dialog">
        <button class="px-4 py-2 text-sm border border-gray-300 rounded hover:bg-gray-100 text-gray-700">Cancelar</button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button>close</button>
  </form>
</dialog>

<script>
async function buscarClientesModal() {
  const termo = document.getElementById('busca_cliente_modal').value.trim();
  const resultados = document.getElementById('resultados_modal');

  if (termo.length < 2) {
    resultados.innerHTML = '<p class="text-center text-gray-400 py-8">Digite para buscar clientes...</p>';
    return;
  }

  try {
    const response = await fetch('/api/clientes/buscar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome: termo,
        razao: termo,
        agencia: false  // Filtrar apenas clientes (não agências)
      })
    });

    const result = await response.json();

    if (result.success && result.clientes.length > 0) {
      let html = '<div class="space-y-2">';
      result.clientes.forEach(cliente => {
        const documento = cliente.cnpj || '-';
        const clienteId = cliente.pk_id_tbl_cliente;
        html += `
          <div class="border border-gray-200 rounded p-3 hover:bg-gray-50 cursor-pointer transition" 
               onclick="selecionarClienteForm('${clienteId}', '${cliente.nome_fantasia.replace(/'/g, "\\'")}')">
            <p class="font-semibold text-sm text-gray-800">${cliente.nome_fantasia}</p>
            <p class="text-xs text-gray-500">${cliente.razao_social || '-'}</p>
            <p class="text-xs text-gray-400">${documento}</p>
          </div>
        `;
      });
      html += '</div>';
      resultados.innerHTML = html;
    } else {
      resultados.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhum cliente encontrado</p>';
    }
  } catch (error) {
    console.error('Erro ao buscar:', error);
    resultados.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao buscar clientes</p>';
  }
}

function limparBuscaModal() {
  document.getElementById('busca_cliente_modal').value = '';
  document.getElementById('resultados_modal').innerHTML = '<p class="text-center text-gray-400 py-8">Digite para buscar clientes...</p>';
}

async function selecionarClienteForm(clienteId, nomeFantasia) {
  // Preencher campo hidden
  document.getElementById('client_id').value = clienteId;
  
  // Atualizar texto exibido
  document.getElementById('nome_cliente_selecionado').textContent = nomeFantasia;
  
  // Disparar evento change para carregar contatos e briefings
  const event = new Event('change', { bubbles: true });
  document.getElementById('client_id').dispatchEvent(event);
  
  // Fechar modal
  document.getElementById('modal_escolher_cliente').close();
  
  // Buscar dados do cliente e auto-preencher responsável comercial
  try {
    const response = await fetch(`/api/cliente/${clienteId}`);
    if (response.ok) {
      const cliente = await response.json();
      if (cliente.vendas_central_comm) {
        const selectResp = document.querySelector('select[name="responsavel_comercial"]');
        if (selectResp) {
          selectResp.value = cliente.vendas_central_comm;
        }
      }
    }
  } catch (error) {
    console.error('Erro ao buscar dados do cliente:', error);
  }
}
</script>

<script>
// Auto-preencher datas ao carregar (somente para nova cotação)
document.addEventListener('DOMContentLoaded', function() {
    const periodoInicio = document.getElementById('periodo_inicio');
    const periodoFim = document.getElementById('periodo_fim');
    
    // Só preencher se os campos estiverem vazios (nova cotação)
    if (periodoInicio && !periodoInicio.value) {
        const hoje = new Date();
        const dataInicio = new Date(hoje);
        dataInicio.setDate(dataInicio.getDate() + 7); // +7 dias
        periodoInicio.value = dataInicio.toISOString().split('T')[0];
    }
    
    if (periodoFim && !periodoFim.value) {
        const hoje = new Date();
        const dataFim = new Date(hoje);
        dataFim.setDate(dataFim.getDate() + 37); // +37 dias
        periodoFim.value = dataFim.toISOString().split('T')[0];
    }
});

// Formatar moeda brasileira em tempo real
function formatarMoedaReal(input, hiddenFieldId) {
  let value = input.value.replace(/\D/g, '');
  
  if (value === '') {
    input.value = '';
    document.getElementById(hiddenFieldId).value = '';
    return;
  }
  
  // Converter para número com 2 casas decimais
  value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  input.value = value;
  
  // Armazenar valor numérico no campo hidden para enviar ao backend
  const valorNumerico = parseFloat(value.replace(/\./g, '').replace(',', '.'));
  document.getElementById(hiddenFieldId).value = valorNumerico;
}

// Ao submeter o formulário, garantir que os valores corretos são enviados
document.getElementById('cotacao_form').addEventListener('submit', function(e) {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    const hiddenInput = document.getElementById(campo + '_hidden');
    if (displayInput && displayInput.value) {
      if (!displayInput.value.includes(',')) {
        formatarMoedaReal(displayInput, campo + '_hidden');
      }
    }
  });
});

// Ao carregar a página, formatar os valores se existirem
document.addEventListener('DOMContentLoaded', function() {
  const campos = ['budget_estimado', 'valor_total_proposta'];
  campos.forEach(campo => {
    const displayInput = document.getElementById(campo);
    if (displayInput && displayInput.value) {
      formatarMoedaReal(displayInput, campo + '_hidden');
    }
  });
  
  // Atualizar briefings e contatos quando o cliente for alterado
  const clienteSelect = document.getElementById('client_id');
  if (clienteSelect) {
    clienteSelect.addEventListener('change', async function() {
      const clienteId = this.value;
      const briefingSelect = document.getElementById('briefing_id');
      const contatoSelect = document.getElementById('client_user_id');
      
      // Limpar opções atuais
      briefingSelect.innerHTML = '<option value="">Selecione um briefing</option>';
      contatoSelect.innerHTML = '<option value="">Selecione um contato</option>';
      
      if (clienteId) {
        try {
          // Buscar briefings
          const responseBriefings = await fetch(`/api/briefings/cliente/${clienteId}`);
          if (responseBriefings.ok) {
            const briefings = await responseBriefings.json();
            briefings.forEach(briefing => {
              const option = document.createElement('option');
              option.value = briefing.id;
              option.textContent = briefing.titulo + (briefing.status ? ` (${briefing.status})` : '');
              briefingSelect.appendChild(option);
            });
          }
          
          // Buscar contatos do cliente (setores Comercial e Operações)
          const responseContatos = await fetch(`/api/clientes/${clienteId}/contatos-briefing`);
          if (responseContatos.ok) {
            const contatos = await responseContatos.json();
            contatos.forEach(contato => {
              const option = document.createElement('option');
              option.value = contato.id_contato_cliente;
              option.textContent = contato.nome_completo + (contato.email ? ` - ${contato.email}` : '');
              contatoSelect.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Erro ao carregar dados do cliente:', error);
        }
      }
    });
  }
});

// ============================================
// BUSCA DE AGÊNCIA
// ============================================

async function buscarAgenciasModal() {
  const termo = document.getElementById('busca_agencia_modal').value.trim();
  const resultados = document.getElementById('resultados_agencia_modal');

  if (termo.length < 2) {
    resultados.innerHTML = '<p class="text-center text-gray-400 py-8">Digite para buscar agências...</p>';
    return;
  }

  try {
    const response = await fetch('/api/clientes/buscar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nome: termo,
        razao: termo,
        agencia: true  // Filtrar apenas agências (Agência=Sim)
      })
    });

    const result = await response.json();

    if (result.success && result.clientes.length > 0) {
      let html = '<div class="space-y-2">';
      result.clientes.forEach(cliente => {
        const documento = cliente.cnpj || '-';
        const clienteId = cliente.pk_id_tbl_cliente;
        const nomeEscapado = (cliente.nome_fantasia || '').replace(/'/g, "\\'");
        html += `
          <div class="border border-gray-200 rounded p-3 hover:bg-gray-50 cursor-pointer transition" 
               onclick="selecionarAgenciaForm('${clienteId}', '${nomeEscapado}')">
            <p class="font-semibold text-sm text-gray-800">${cliente.nome_fantasia}</p>
            <p class="text-xs text-gray-500">${cliente.razao_social || '-'}</p>
            <p class="text-xs text-gray-400">${documento}</p>
          </div>
        `;
      });
      html += '</div>';
      resultados.innerHTML = html;
    } else {
      resultados.innerHTML = '<p class="text-center text-gray-400 py-8">Nenhuma agência encontrada</p>';
    }
  } catch (error) {
    console.error('Erro ao buscar agências:', error);
    resultados.innerHTML = '<p class="text-center text-red-500 py-8">Erro ao buscar agências</p>';
  }
}

function limparBuscaAgenciaModal() {
  document.getElementById('busca_agencia_modal').value = '';
  document.getElementById('resultados_agencia_modal').innerHTML = '<p class="text-center text-gray-400 py-8">Digite para buscar agências...</p>';
}

async function selecionarAgenciaForm(agenciaId, nomeAgencia) {
  document.getElementById('agencia_id').value = agenciaId;
  document.getElementById('nome_agencia_selecionada').textContent = nomeAgencia;
  document.getElementById('modal_escolher_agencia').close();
  limparBuscaAgenciaModal();
  
  // Carregar contatos da agência
  await carregarContatosAgencia(agenciaId);
}

async function carregarContatosAgencia(agenciaId) {
  const contatoAgenciaSelect = document.getElementById('agencia_user_id');
  contatoAgenciaSelect.innerHTML = '<option value="">Selecione...</option>';
  
  if (agenciaId) {
    try {
      const response = await fetch(`/api/clientes/${agenciaId}/todos-contatos`);
      if (response.ok) {
        const contatos = await response.json();
        contatos.forEach(contato => {
          const option = document.createElement('option');
          option.value = contato.id_contato_cliente;
          option.textContent = contato.nome_completo + (contato.email ? ` - ${contato.email}` : '');
          contatoAgenciaSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Erro ao carregar contatos da agência:', error);
    }
  }
}

function limparAgenciaSelecionada() {
  document.getElementById('agencia_id').value = '';
  document.getElementById('nome_agencia_selecionada').textContent = 'Nenhuma';
  document.getElementById('agencia_user_id').innerHTML = '<option value="">Selecione...</option>';
}

// ============================================
// BUSCA DE BRIEFING COM AUTOCOMPLETE
// ============================================

let briefingBuscaTimeout = null;
let briefingsCache = [];

async function buscarBriefingsAutocomplete(termo) {
  const clienteId = document.getElementById('client_id').value;
  const sugestoesDiv = document.getElementById('briefing_sugestoes');
  
  // Limpar timeout anterior
  if (briefingBuscaTimeout) {
    clearTimeout(briefingBuscaTimeout);
  }
  
  if (!clienteId) {
    sugestoesDiv.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">Selecione um cliente primeiro</div>';
    sugestoesDiv.classList.remove('hidden');
    return;
  }
  
  if (termo.length < 2) {
    // Mostrar todos os briefings do cliente
    if (briefingsCache.length > 0) {
      renderizarSugestoesBriefing(briefingsCache, termo);
    } else {
      await carregarBriefingsCliente(clienteId);
      renderizarSugestoesBriefing(briefingsCache, termo);
    }
    return;
  }
  
  // Debounce de 300ms
  briefingBuscaTimeout = setTimeout(async () => {
    try {
      // Se não temos cache, carregar
      if (briefingsCache.length === 0) {
        await carregarBriefingsCliente(clienteId);
      }
      
      // Filtrar localmente
      const filtrados = briefingsCache.filter(b => 
        b.titulo.toLowerCase().includes(termo.toLowerCase())
      );
      
      renderizarSugestoesBriefing(filtrados, termo);
    } catch (error) {
      console.error('Erro ao buscar briefings:', error);
      sugestoesDiv.innerHTML = '<div class="px-3 py-2 text-sm text-red-500">Erro ao buscar briefings</div>';
      sugestoesDiv.classList.remove('hidden');
    }
  }, 300);
}

async function carregarBriefingsCliente(clienteId) {
  try {
    const response = await fetch(`/api/briefings/cliente/${clienteId}`);
    if (response.ok) {
      briefingsCache = await response.json();
    } else {
      briefingsCache = [];
    }
  } catch (error) {
    console.error('Erro ao carregar briefings:', error);
    briefingsCache = [];
  }
}

function renderizarSugestoesBriefing(briefings, termo) {
  const sugestoesDiv = document.getElementById('briefing_sugestoes');
  
  if (!briefings || briefings.length === 0) {
    sugestoesDiv.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">Nenhum briefing encontrado</div>';
    sugestoesDiv.classList.remove('hidden');
    return;
  }
  
  let html = '';
  briefings.forEach(briefing => {
    const statusClass = getStatusClassBriefing(briefing.status);
    html += `
      <div class="px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-0" 
           onclick="selecionarBriefing(${briefing.id}, '${briefing.titulo.replace(/'/g, "\\'")}')">
        <div class="flex justify-between items-center">
          <span class="text-sm font-medium text-gray-800">${briefing.titulo}</span>
          <span class="px-1.5 py-0.5 text-xs rounded ${statusClass}">${briefing.status || 'Rascunho'}</span>
        </div>
        ${briefing.objetivo ? `<p class="text-xs text-gray-500 truncate mt-0.5">${briefing.objetivo.substring(0, 60)}${briefing.objetivo.length > 60 ? '...' : ''}</p>` : ''}
      </div>
    `;
  });
  
  sugestoesDiv.innerHTML = html;
  sugestoesDiv.classList.remove('hidden');
}

function getStatusClassBriefing(status) {
  const classes = {
    'Rascunho': 'bg-gray-100 text-gray-600',
    'Enviado': 'bg-blue-100 text-blue-600',
    'Em Análise': 'bg-yellow-100 text-yellow-600',
    'Aprovado': 'bg-green-100 text-green-600',
    'Rejeitado': 'bg-red-100 text-red-600'
  };
  return classes[status] || 'bg-gray-100 text-gray-600';
}

function selecionarBriefing(briefingId, titulo) {
  document.getElementById('briefing_id').value = briefingId;
  document.getElementById('briefing_busca').value = titulo;
  document.getElementById('briefing_sugestoes').classList.add('hidden');
}

function limparBriefingSelecionado() {
  document.getElementById('briefing_id').value = '';
  document.getElementById('briefing_busca').value = '';
  document.getElementById('briefing_sugestoes').classList.add('hidden');
}

function mostrarSugestoesBriefing() {
  const clienteId = document.getElementById('client_id').value;
  const termo = document.getElementById('briefing_busca').value;
  
  if (clienteId) {
    buscarBriefingsAutocomplete(termo);
  } else {
    const sugestoesDiv = document.getElementById('briefing_sugestoes');
    sugestoesDiv.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">Selecione um cliente primeiro</div>';
    sugestoesDiv.classList.remove('hidden');
  }
}

// Fechar sugestões ao clicar fora
document.addEventListener('click', function(e) {
  const briefingContainer = document.getElementById('briefing_busca');
  const sugestoesDiv = document.getElementById('briefing_sugestoes');
  
  if (briefingContainer && sugestoesDiv && !briefingContainer.contains(e.target) && !sugestoesDiv.contains(e.target)) {
    sugestoesDiv.classList.add('hidden');
  }
});

// Limpar cache ao trocar cliente
document.getElementById('client_id').addEventListener('change', function() {
  briefingsCache = [];
  limparBriefingSelecionado();
});

</script>
{% endblock %}
