{% extends 'base_tailwind.html' %}

{% block title %}Cadu Subcategorias - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Cadu Subcategorias</h1>
      <p class="text-sm text-base-content/70 mt-1">Gerencie as subcategorias do catálogo de audiências</p>
    </div>
    <a href="{{ url_for('cadu_subcategorias_novo') }}" class="btn btn-primary">
      <i class="fas fa-plus mr-2"></i>Nova Subcategoria
    </a>
  </div>

  <!-- Filtro por Categoria -->
  <div class="card bg-base-100 border border-base-300">
    <div class="card-body p-4">
      <form method="GET" class="flex gap-3 items-end">
        <div class="form-control flex-1">
          <label class="label">
            <span class="label-text font-medium">Filtrar por Categoria</span>
          </label>
          <select name="categoria_id" class="select select-bordered select-sm w-full h-10 min-h-10" onchange="this.form.submit()">
            <option value="">Todas as categorias</option>
            {% for cat in categorias %}
            <option value="{{ cat.id }}" {% if categoria_id_filtro|string == cat.id|string %}selected{% endif %}>
              {{ cat.nome }}
            </option>
            {% endfor %}
          </select>
        </div>
        {% if categoria_id_filtro %}
        <a href="{{ url_for('cadu_subcategorias') }}" class="btn btn-ghost btn-sm">
          <i class="fas fa-times mr-1"></i>Limpar Filtro
        </a>
        {% endif %}
      </form>
    </div>
  </div>

  <!-- Tabela de Subcategorias -->
  <div class="bg-base-100 rounded-xl overflow-hidden">
    {% if subcategorias %}
      <div class="overflow-x-auto">
        <table class="table table-xs w-full">
          <thead class="bg-primary text-white">
            <tr>
              <th class="text-left font-bold uppercase">Subcategoria</th>
              <th class="text-left font-bold uppercase">Categoria</th>
              <th class="text-left font-bold uppercase">Descrição</th>
              <th class="text-center font-bold uppercase w-20">Ordem</th>
              <th class="text-center font-bold uppercase w-24">Status</th>
              <th class="text-center font-bold uppercase w-32">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for sub in subcategorias %}
            <tr class="hover">
              <td>
                <div class="flex items-center gap-3">
                  {% if sub.icone %}
                  <div class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-lg w-8 h-8 flex items-center justify-center">
                      <i class="{{ sub.icone }} text-sm"></i>
                    </div>
                  </div>
                  {% else %}
                  <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-lg w-8 h-8">
                      <span class="text-xs">{{ sub.nome[0:2]|upper if sub.nome else 'SC' }}</span>
                    </div>
                  </div>
                  {% endif %}
                  <div>
                    <div class="font-semibold text-base-content">{{ sub.nome }}</div>
                    {% if sub.slug %}
                    <div class="text-xs text-base-content/50 font-mono">/{{ sub.slug }}</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <span class="text-xs">{{ sub.categoria_nome or 'Sem categoria' }}</span>
              </td>
              <td>
                <div class="text-xs text-base-content/70 line-clamp-2 max-w-md">
                  {{ sub.descricao or '-' }}
                </div>
              </td>
              <td class="text-center">
                <span class="text-xs">{{ sub.ordem_exibicao or 0 }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-sm {% if sub.is_active %}badge-success{% else %}badge-ghost{% endif %}">
                  {{ 'Ativa' if sub.is_active else 'Inativa' }}
                </span>
              </td>
              <td class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <a href="{{ url_for('cadu_subcategorias_detalhes', id_subcategoria=sub.id) }}" 
                     class="btn btn-xs btn-ghost"
                     title="Ver detalhes">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ url_for('cadu_subcategorias_editar', id_subcategoria=sub.id) }}" 
                     class="btn btn-xs btn-primary"
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button onclick="confirmarExclusao({{ sub.id }}, '{{ sub.nome }}')"
                          class="btn btn-xs btn-error"
                          title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="mb-2 text-base-content/60 text-sm">
          {% if categoria_id_filtro %}
          Nenhuma subcategoria nesta categoria.
          {% else %}
          Nenhuma subcategoria cadastrada.
          {% endif %}
        </p>
        <a href="{{ url_for('cadu_subcategorias_novo') }}" class="btn btn-primary btn-sm">
          <i class="fas fa-plus mr-2 text-xs"></i>Criar Primeira Subcategoria
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
function confirmarExclusao(id, nome) {
  if (confirm(`Tem certeza que deseja excluir a subcategoria "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
    fetch(`/api/cadu_subcategorias/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => {
      alert('Erro ao excluir subcategoria: ' + error);
    });
  }
}
</script>
{% endblock %}
