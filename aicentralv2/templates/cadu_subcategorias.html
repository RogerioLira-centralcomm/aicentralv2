{% extends 'base_tailwind.html' %}

{% block title %}Subcategorias - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Subcategorias</h1>
      <p class="text-sm text-base-content/70 mt-1">Gerencie as subcategorias do catálogo de audiências</p>
    </div>
    <a href="{{ url_for('cadu_subcategorias_novo') }}" class="btn btn-primary">
      <i class="fas fa-plus mr-2"></i>Nova Subcategoria
    </a>
  </div>

  <!-- Filtros -->
  <div class="card bg-base-100 border border-base-300">
    <div class="card-body p-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <!-- Pesquisa por Nome -->
        <div class="flex items-center gap-3">
          <label class="label font-semibold text-sm py-1">Pesquisar:</label>
          <input 
            type="text" 
            id="pesquisa_subcategoria" 
            oninput="filtrarSubcategorias()" 
            class="input input-bordered input-sm flex-1" 
            placeholder="Digite o nome..."
          >
        </div>
        
        <!-- Filtro por Categoria -->
        <div class="flex items-center gap-3">
          <label class="label font-semibold text-sm py-1">Categoria:</label>
          <select id="filtro_categoria" onchange="filtrarSubcategorias()" class="select select-bordered select-sm flex-1 h-10 min-h-10">
            <option value="">Todas as categorias</option>
            {% for cat in categorias %}
            <option value="{{ cat.nome }}">{{ cat.nome }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Filtro por Status -->
        <div class="flex items-center gap-3">
          <label class="label font-semibold text-sm py-1">Status:</label>
          <select id="filtro_status" onchange="filtrarSubcategorias()" class="select select-bordered select-sm flex-1 h-10 min-h-10">
            <option value="">Todos os status</option>
            <option value="ativa">Ativa</option>
            <option value="inativa">Inativa</option>
          </select>
        </div>
      </div>
      <div class="mt-2">
        <span id="contador_filtro" class="text-sm text-base-content/70"></span>
      </div>
    </div>
  </div>

  <!-- Tabela de Subcategorias -->
  <div class="bg-base-100 rounded-xl overflow-hidden">
    {% if subcategorias %}
      <div class="overflow-x-auto">
        <table class="table table-xs w-full" id="tabela_subcategorias">
          <thead class="bg-primary text-white">
            <tr>
              <th class="text-left font-bold uppercase">Subcategoria</th>
              <th class="text-left font-bold uppercase">Categoria</th>
              <th class="text-left font-bold uppercase">Descrição</th>
              <th class="text-center font-bold uppercase w-20">Ordem</th>
              <th class="text-center font-bold uppercase w-24">Status</th>
              <th class="text-center font-bold uppercase w-32">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for sub in subcategorias %}
            <tr class="hover" data-categoria="{{ sub.categoria_nome or '' }}" data-status="{{ 'ativa' if sub.is_active else 'inativa' }}">
              <td>
                <div class="flex items-center gap-3">
                  {% if sub.icone %}
                  <div class="avatar placeholder">
                    <div class="bg-primary text-primary-content rounded-lg w-8 h-8 flex items-center justify-center">
                      <i class="{{ sub.icone }} text-sm"></i>
                    </div>
                  </div>
                  {% else %}
                  <div class="avatar placeholder">
                    <div class="bg-neutral text-neutral-content rounded-lg w-8 h-8">
                      <span class="text-xs">{{ sub.nome[0:2]|upper if sub.nome else 'SC' }}</span>
                    </div>
                  </div>
                  {% endif %}
                  <div>
                    <div class="font-semibold text-base-content">{{ sub.nome }}</div>
                    {% if sub.slug %}
                    <div class="text-xs text-base-content/50 font-mono">/{{ sub.slug }}</div>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <span class="text-xs">{{ sub.categoria_nome or 'Sem categoria' }}</span>
              </td>
              <td>
                <div class="text-xs text-base-content/70 line-clamp-2 max-w-md">
                  {{ sub.descricao or '-' }}
                </div>
              </td>
              <td class="text-center">
                <span class="text-xs">{{ sub.ordem_exibicao or 0 }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-sm {% if sub.is_active %}badge-success{% else %}badge-ghost{% endif %}">
                  {{ 'Ativa' if sub.is_active else 'Inativa' }}
                </span>
              </td>
              <td class="text-center">
                <div class="flex items-center justify-center gap-2">
                  <a href="{{ url_for('cadu_subcategorias_detalhes', id_subcategoria=sub.id) }}" 
                     class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors duration-200"
                     title="Ver detalhes">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="{{ url_for('cadu_subcategorias_editar', id_subcategoria=sub.id) }}" 
                     class="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded transition-colors duration-200"
                     title="Editar">
                    <i class="fas fa-edit"></i>
                  </a>
                  <button onclick="confirmarExclusao({{ sub.id }}, '{{ sub.nome }}')"
                          class="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors duration-200"
                          title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="mb-2 text-base-content/60 text-sm">
          {% if categoria_id_filtro %}
          Nenhuma subcategoria nesta categoria.
          {% else %}
          Nenhuma subcategoria cadastrada.
          {% endif %}
        </p>
        <a href="{{ url_for('cadu_subcategorias_novo') }}" class="btn btn-primary btn-sm">
          <i class="fas fa-plus mr-2 text-xs"></i>Criar Primeira Subcategoria
        </a>
      </div>
    {% endif %}
  </div>
</div>

<script>
function filtrarSubcategorias() {
  const pesquisa = document.getElementById('pesquisa_subcategoria').value.toLowerCase().trim();
  const categoriaFiltro = document.getElementById('filtro_categoria').value.trim();
  const statusFiltro = document.getElementById('filtro_status').value.trim();
  const tabela = document.getElementById('tabela_subcategorias');
  const tbody = tabela.querySelector('tbody');
  
  if (!tbody) {
    console.error('Tbody não encontrado');
    return;
  }
  
  const linhas = tbody.getElementsByTagName('tr');
  
  let visiveis = 0;
  const total = linhas.length;
  
  console.log('=== FILTRO DEBUG ===');
  console.log('Pesquisa:', pesquisa);
  console.log('Categoria Filtro:', categoriaFiltro);
  console.log('Status Filtro:', statusFiltro);
  console.log('Total de linhas:', total);
  
  for (let i = 0; i < linhas.length; i++) {
    const linha = linhas[i];
    const colunas = linha.getElementsByTagName('td');
    
    if (colunas.length > 0) {
      // Pegar apenas o texto do nome (dentro do div.font-semibold)
      const nomeElement = colunas[0].querySelector('.font-semibold');
      const nome = nomeElement ? nomeElement.textContent.toLowerCase().trim() : '';
      
      const categoriaAttr = linha.getAttribute('data-categoria');
      const categoria = categoriaAttr ? categoriaAttr.trim() : '';
      
      const statusAttr = linha.getAttribute('data-status');
      const status = statusAttr ? statusAttr.trim() : '';
      
      const descricao = colunas[2].textContent.toLowerCase().trim();
      
      console.log(`Linha ${i}: categoria="${categoria}", status="${status}", nome="${nome}"`);
      
      const matchPesquisa = pesquisa === '' || nome.includes(pesquisa) || descricao.includes(pesquisa);
      const matchCategoria = categoriaFiltro === '' || categoria === categoriaFiltro;
      const matchStatus = statusFiltro === '' || status === statusFiltro;
      
      // Todos filtros devem passar (AND)
      const mostrar = matchPesquisa && matchCategoria && matchStatus;
      
      console.log(`  matchPesquisa: ${matchPesquisa}, matchCategoria: ${matchCategoria}, matchStatus: ${matchStatus}, mostrar: ${mostrar}`);
      
      if (mostrar) {
        linha.style.display = '';
        visiveis++;
      } else {
        linha.style.display = 'none';
      }
    }
  }
  
  console.log('Visíveis:', visiveis);
  console.log('===================');
  
  // Atualizar contador
  const contador = document.getElementById('contador_filtro');
  if (pesquisa || categoriaFiltro || statusFiltro) {
    contador.textContent = `Mostrando ${visiveis} de ${total} subcategorias`;
  } else {
    contador.textContent = `Total: ${total} subcategorias`;
  }
}

// Inicializar contador ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
  filtrarSubcategorias();
});

function confirmarExclusao(id, nome) {
  if (confirm(`Tem certeza que deseja excluir a subcategoria "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
    fetch(`/api/cadu_subcategorias/${id}`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => {
      alert('Erro ao excluir subcategoria: ' + error);
    });
  }
}
</script>
{% endblock %}
