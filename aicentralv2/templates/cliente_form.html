{% extends 'base_tailwind.html' %}

{% block title %}{% if cliente %}Editar{% else %}Novo{% endif %} Cliente - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-4 bg-base-100 rounded-xl shadow-lg">
  <h2 class="text-lg font-semibold mb-1">{% if cliente %}Editar Cliente{% else %}Novo Cliente{% endif %}</h2>
  <p class="text-base-content/70 mb-3 text-sm">Preencha os dados abaixo para {% if cliente %}editar{% else %}cadastrar{% endif %} um cliente.</p>
  <form method="post" class="space-y-2">
          <!-- CSRF token removido pois não está definido no contexto -->

          <div class="form-control">
            <label class="label font-semibold text-sm">Pessoa <span class="text-error">*</span></label>
            <div class="flex gap-3">
              <label class="cursor-pointer flex items-center gap-2 px-4 py-2.5 border-2 border-base-300 rounded-lg hover:border-primary transition-colors bg-base-100">
                <input type="radio" name="pessoa" value="J" class="radio radio-primary radio-sm" required checked>
                <span class="font-medium">Jurídica</span>
              </label>
              <label class="cursor-pointer flex items-center gap-2 px-4 py-2.5 border-2 border-base-300 rounded-lg hover:border-primary transition-colors bg-base-100">
                <input type="radio" name="pessoa" value="F" class="radio radio-primary radio-sm" required {% if cliente and cliente.pessoa == 'F' %}checked{% endif %}>
                <span class="font-medium">Física</span>
              </label>
            </div>
          </div>

          <div id="tipo_cliente_fields" class="form-control">
            <label class="label font-semibold text-sm">Tipo <span class="text-error">*</span></label>
            <select id="select_tipo_cliente" name="id_tipo_cliente" class="select select-bordered w-full" required>
              <option value="">Selecione o tipo</option>
              {% for tipo in tipos_cliente %}
                <option value="{{ tipo.id_tipo_cliente }}" {% if cliente and cliente.id_tipo_cliente == tipo.id_tipo_cliente %}selected{% endif %}>{{ tipo.display }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-control">
            <label id="label_cnpj" class="label font-semibold text-sm">CNPJ *</label>
            <input id="input_cnpj" name="cnpj" value="{{ cliente.cnpj if cliente else '' }}" required class="input input-bordered w-full" placeholder="Digite o CNPJ">
            <span id="cnpjcpf_msg" class="text-error text-xs mt-1"></span>
          </div>

          <div id="razao_social_fields" class="form-control">
            <label class="label font-semibold text-sm">Razão Social *</label>
            <input id="input_razao_social" name="razao_social" value="{{ cliente.razao_social if cliente else '' }}" required class="input input-bordered w-full" placeholder="Digite a razão social">
          </div>

          <div class="form-control">
            <label id="label_nome_fantasia" class="label font-semibold text-sm">Nome Fantasia *</label>
            <input id="input_nome_fantasia" name="nome_fantasia" value="{{ cliente.nome_fantasia if cliente else '' }}" required class="input input-bordered w-full" placeholder="Digite o nome fantasia">
          </div>

          <div id="insc_estadual_fields" class="form-control">
            <label class="label font-semibold text-sm">Inscrição Estadual</label>
            <input name="inscricao_estadual" value="{{ cliente.inscricao_estadual if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite a inscrição estadual">
          </div>

          <div id="insc_municipal_fields" class="form-control">
            <label class="label font-semibold text-sm">Inscrição Municipal</label>
            <input name="inscricao_municipal" value="{{ cliente.inscricao_municipal if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite a inscrição municipal">
          </div>

          <div class="divider">Endereço</div>

          <div class="form-control">
            <label class="label font-semibold text-sm">CEP</label>
            <input id="cep" name="cep" value="{{ cliente.cep if cliente else '' }}" oninput="mascaraCep(this)" onblur="buscarEnderecoPorCep(this.value)" class="input input-bordered w-full" placeholder="Digite o CEP">
          </div>

          <div class="form-control">
            <label class="label font-semibold text-sm">Estado</label>
            <select id="estado" name="estado" class="select select-bordered w-full">
              <option value="">Selecione o estado</option>
              {% for estado in estados %}
                <option value="{{ estado.id_estado }}" data-sigla="{{ estado.sigla }}" {% if cliente and cliente.estado == estado.id_estado %}selected{% endif %}>{{ estado.sigla }} - {{ estado.descricao }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-control">
            <label class="label font-semibold text-sm">Cidade</label>
            <input id="cidade" name="cidade" value="{{ cliente.cidade if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite a cidade">
          </div>

          <div class="form-control">
            <label class="label font-semibold text-sm">Bairro</label>
            <input id="bairro" name="bairro" value="{{ cliente.bairro if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite o bairro">
          </div>

          <div class="form-control">

            <label class="label font-semibold text-sm">Logradouro</label>
            <input id="logradouro" name="logradouro" value="{{ cliente.logradouro if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite o logradouro">
          </div>
          <div class="form-control">
            <label class="label font-semibold text-sm">Número</label>
            <input id="numero" value="{{ cliente.numero if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite o número">
          </div>
          <div class="form-control">
            <label class="label font-semibold text-sm">Complemento</label>
            <input id="complemento" name="complemento" value="{{ cliente.complemento if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite o complemento">
          </div>

          <div id="agencia_fields" class="form-control">
            <label class="label font-semibold text-sm">Agência <span class="text-error">*</span></label>
            <select name="id_agencia" class="select select-bordered w-full" required>
              <option value="">Selecione a agência</option>
              {% for agencia in agencias %}
                <option value="{{ agencia.id_agencia }}" {% if cliente and cliente.pk_id_tbl_agencia == agencia.id_agencia %}selected{% endif %}>{{ agencia.display }}</option>
              {% endfor %}
            </select>
          </div>

          <div id="percentual_fields" class="form-control">
            <label class="label font-semibold text-sm">Percentual</label>
            <input name="percentual" value="{{ cliente.percentual if cliente else '' }}" class="input input-bordered w-full" placeholder="Digite o percentual">
          </div>

          <!-- Campo hidden pk_id_tbl_agencia_pf removido, não é necessário para o select principal -->


          <div class="flex justify-between items-center mt-6">
            <a href="{{ url_for('clientes') }}" class="btn btn-ghost btn-sm">Cancelar</a>
            <button type="submit" class="btn btn-primary btn-sm">{% if cliente %}Atualizar{% else %}Cadastrar{% endif %}</button>
          </div>
        </form>
      </div>


  <!-- Campos duplicados removidos, agora estão dentro do form principal -->
  </fieldset>
{% block scripts %}
<script>
// Validação de CPF
function validarCPF(cpf) {
  cpf = cpf.replace(/\D/g, '');
  if (cpf.length !== 11 || /^([0-9])\1+$/.test(cpf)) return false;
  let soma = 0, resto;
  for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(9, 10))) return false;
  soma = 0;
  for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(10, 11))) return false;
  return true;
}

// Busca dados da empresa pelo CNPJ (ReceitaWS ou similar)
async function buscarEmpresaPorCNPJ(cnpj) {
  cnpj = cnpj.replace(/\D/g, '');
  if (cnpj.length !== 14) return;
  try {
    const resp = await fetch('https://www.receitaws.com.br/v1/cnpj/' + cnpj);
    const data = await resp.json();
    if (data.status === 'OK') {
      if (document.getElementById('input_razao_social')) document.getElementById('input_razao_social').value = data.nome || '';
      var nomeFantasia = document.querySelector('input[name="nome_fantasia"]');
      if (nomeFantasia) nomeFantasia.value = data.fantasia || '';
      var inscEstadual = document.querySelector('input[name="inscricao_estadual"]');
      if (inscEstadual) inscEstadual.value = data.inscricao_estadual || '';
      var inscMunicipal = document.querySelector('input[name="inscricao_municipal"]');
      if (inscMunicipal) inscMunicipal.value = data.inscricao_municipal || '';
    }
  } catch (e) {}
}

// Verifica se CNPJ/CPF já existe na base e preenche campos se existir
async function verificarExistenciaDocumento(doc, tipo) {
  try {
    const resp = await fetch(`/api/verifica_documento?doc=${encodeURIComponent(doc)}&tipo=${tipo}`);
    const data = await resp.json();
    if (data.existe) {
      document.getElementById('cnpjcpf_msg').innerText = tipo === 'F' ? 'CPF já cadastrado!' : 'CNPJ já cadastrado!';
      if (data.cliente) {
        if (document.getElementById('input_razao_social') && data.cliente.razao_social)
          document.getElementById('input_razao_social').value = data.cliente.razao_social;
        var nomeFantasia = document.getElementById('input_nome_fantasia');
        if (nomeFantasia && data.cliente.nome_fantasia)
          nomeFantasia.value = data.cliente.nome_fantasia;
        var inscEstadual = document.querySelector('input[name="inscricao_estadual"]');
        if (inscEstadual && data.cliente.inscricao_estadual)
          inscEstadual.value = data.cliente.inscricao_estadual;
        var inscMunicipal = document.querySelector('input[name="inscricao_municipal"]');
        if (inscMunicipal && data.cliente.inscricao_municipal)
          inscMunicipal.value = data.cliente.inscricao_municipal;
      }
    } else {
      document.getElementById('cnpjcpf_msg').innerText = '';
    }
  } catch (e) {}
}

// Handler para blur do campo CNPJ/CPF
async function onCnpjCpfBlur() {
  var pessoa = document.querySelector('input[name="pessoa"]:checked').value;
  var doc = document.getElementById('input_cnpj').value.replace(/\D/g, '');
  if (!doc) return;
  if (pessoa === 'F') {
    if (!validarCPF(doc)) {
      document.getElementById('cnpjcpf_msg').innerText = 'CPF inválido!';
      return;
    } else {
      document.getElementById('cnpjcpf_msg').innerText = '';
    }
    await verificarExistenciaDocumento(doc, 'F');
  } else {
    if (doc.length !== 14) {
      document.getElementById('cnpjcpf_msg').innerText = 'CNPJ inválido!';
      return;
    }
    document.getElementById('cnpjcpf_msg').innerText = '';
    await verificarExistenciaDocumento(doc, 'J');
    await buscarEmpresaPorCNPJ(doc);
  }
}
// Máscara para CEP (formato 99999-999)
function mascaraCep(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length > 5) v = v.slice(0,5) + '-' + v.slice(5,8);
  input.value = v.slice(0,9);
}

// Busca endereço na API ViaCEP
function buscarEnderecoPorCep(cep) {
  cep = cep.replace(/\D/g, '');
  if (cep.length !== 8) return;
  fetch('https://viacep.com.br/ws/' + cep + '/json/')
    .then(response => response.json())
    .then(data => {
      if (!data.erro) {
        document.getElementById('estado').value = getEstadoIdBySigla(data.uf);
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('logradouro').value = data.logradouro || '';
      }
    });
}

// Função para mapear sigla do estado ao id do select
function getEstadoIdBySigla(sigla) {
  var select = document.getElementById('estado');
  console.log('Procurando estado com sigla:', sigla);
  
  // Primeiro, tenta encontrar usando o atributo data-sigla
  for (var i = 0; i < select.options.length; i++) {
    var option = select.options[i];
    if (option.dataset.sigla === sigla) {
      console.log('Estado encontrado:', option.value, option.text);
      return option.value;
    }
  }
  
  // Fallback: procura no texto da opção
  for (var i = 0; i < select.options.length; i++) {
    if (select.options[i].text.startsWith(sigla + ' ')) {
      console.log('Estado encontrado (fallback):', select.options[i].value, select.options[i].text);
      return select.options[i].value;
    }
  }
  
  console.log('Estado não encontrado para sigla:', sigla);
  return '';
}
function togglePessoaFields() {
  var pessoa = document.querySelector('input[name="pessoa"]:checked').value;
  
  // Atualizar estilos visuais dos radio buttons
  document.querySelectorAll('input[name="pessoa"]').forEach(function(radio) {
    var label = radio.closest('label');
    if (radio.checked) {
      label.classList.add('border-primary', 'bg-primary/10');
      label.classList.remove('border-base-300');
    } else {
      label.classList.remove('border-primary', 'bg-primary/10');
      label.classList.add('border-base-300');
    }
  });
  
  // Mostrar/ocultar tipo de cliente (apenas para Pessoa Jurídica)
  var tipoClienteField = document.getElementById('tipo_cliente_fields');
  var selectTipoCliente = document.getElementById('select_tipo_cliente');
  if (pessoa === 'F') {
    tipoClienteField.style.display = 'none';
    selectTipoCliente.required = false;
    selectTipoCliente.value = ''; // Limpa seleção
  } else {
    tipoClienteField.style.display = '';
    selectTipoCliente.required = true;
  }
  
  document.getElementById('agencia_fields').style.display = pessoa === 'F' ? 'none' : '';
  document.getElementById('percentual_fields').style.display = pessoa === 'F' ? 'none' : '';
  document.getElementById('insc_estadual_fields').style.display = pessoa === 'F' ? 'none' : '';
  document.getElementById('insc_municipal_fields').style.display = pessoa === 'F' ? 'none' : '';
  document.getElementById('label_cnpj').innerText = pessoa === 'F' ? 'CPF *' : 'CNPJ *';
  document.getElementById('input_cnpj').placeholder = pessoa === 'F' ? 'Digite o CPF' : 'Digite o CNPJ';
  // Razão Social
  if (pessoa === 'F') {
    document.getElementById('razao_social_fields').style.display = 'none';
    document.getElementById('input_razao_social').required = false;
    document.getElementById('label_nome_fantasia').innerText = 'Nome Completo *';
    document.getElementById('input_nome_fantasia').placeholder = 'Digite o nome completo';
    document.getElementById('input_nome_fantasia').required = true;
  } else {
    document.getElementById('razao_social_fields').style.display = '';
    document.getElementById('input_razao_social').required = true;
    document.getElementById('label_nome_fantasia').innerText = 'Nome Fantasia *';
    document.getElementById('input_nome_fantasia').placeholder = 'Digite o nome fantasia';
    document.getElementById('input_nome_fantasia').required = true;
  }
}
document.addEventListener('DOMContentLoaded', function() {
  togglePessoaFields();
  var radios = document.querySelectorAll('input[name="pessoa"]');
  radios.forEach(function(radio) {
    radio.addEventListener('change', togglePessoaFields);
  });
  // Aplica máscara inicial ao CEP se já houver valor
  var cepInput = document.getElementById('cep');
  if (cepInput && cepInput.value) mascaraCep(cepInput);

  // Adiciona listener para blur do CNPJ/CPF
  var cnpjInput = document.getElementById('input_cnpj');
  if (cnpjInput) cnpjInput.addEventListener('blur', onCnpjCpfBlur);
});
</script>
{% endblock %}

  <input type="hidden" name="pk_id_tbl_agencia_pf" value="2">

  <br>

</form>
{% endblock %}