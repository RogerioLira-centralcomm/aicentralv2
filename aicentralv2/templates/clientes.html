{% extends 'base_tailwind.html' %}

{% block title %}Clientes - CentralComm AI{% endblock %}

{% block content %}
<style>
  /* Badges de categoria ABC */
  .badge-cat-a { background-color: #10b981; color: white; }
  .badge-cat-b { background-color: #6b7280; color: white; }
  .badge-cat-c { background-color: #9ca3af; color: white; }
  
  /* Tab styles */
  .tab-btn.tab-active { color: #1f2937; border-bottom-color: #374151; }
  .modal-tab-content.hidden { display: none; }
</style>

<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (max 66px) estilo CRM -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Título -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Clientes</h1>
        {% if total %}<span class="text-xs text-gray-500">({{ total }} registros)</span>{% endif %}
      </div>
      
      <!-- Filtros Inline -->
      <form id="filtros_form" method="GET" action="{{ url_for('clientes') }}" class="flex items-center gap-3">
        <!-- Executivo -->
        <select name="executivo_id" onchange="this.form.submit()" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 160px;">
          <option value="">Todos executivos</option>
          {% for vendedor in vendedores_cc %}
            <option value="{{ vendedor.id_contato_cliente }}" {% if filtros.get('executivo_id')|string == vendedor.id_contato_cliente|string %}selected{% endif %}>
              {{ vendedor.nome_completo }}
            </option>
          {% endfor %}
        </select>
        
        <!-- Busca -->
        <input type="text" name="search" value="{{ filtros.get('search', '') }}" placeholder="Buscar cliente..."
               onkeydown="if(event.key==='Enter'){this.form.submit();}"
               class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 180px;">
        
        <!-- Hidden fields para manter filtros -->
        <input type="hidden" name="status" id="status_filter" value="{{ request.args.get('status', 'ativo') }}">
        <input type="hidden" name="categoria" id="categoria_filter" value="{{ request.args.get('categoria', '') }}">
        <input type="hidden" name="agencia" id="agencia_filter" value="{{ request.args.get('agencia', 'nao') }}">
        
        <!-- Status Icons -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          <button type="button" onclick="filtrarStatus('ativo')" 
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors {% if request.args.get('status', 'ativo') == 'ativo' %}bg-gray-200{% endif %}" 
                  title="Ativos">
            <i class="fa-solid fa-circle-check text-sm text-gray-{% if request.args.get('status', 'ativo') == 'ativo' %}800{% else %}400{% endif %}"></i>
          </button>
          <button type="button" onclick="filtrarStatus('inativo')" 
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors {% if request.args.get('status') == 'inativo' %}bg-gray-200{% endif %}" 
                  title="Inativos">
            <i class="fa-solid fa-circle-xmark text-sm text-gray-{% if request.args.get('status') == 'inativo' %}800{% else %}400{% endif %}"></i>
          </button>
          <button type="button" onclick="filtrarStatus('todos')" 
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors {% if request.args.get('status') == 'todos' %}bg-gray-200{% endif %}" 
                  title="Todos">
            <i class="fa-solid fa-list text-sm text-gray-{% if request.args.get('status') == 'todos' %}800{% else %}400{% endif %}"></i>
          </button>
        </div>
        
        <!-- Categoria ABC -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          <button type="button" onclick="filtrarCategoria('')" 
                  class="px-2 py-1 text-xs rounded hover:bg-gray-100 transition-colors {% if not request.args.get('categoria') %}bg-gray-200 text-gray-800{% else %}text-gray-400{% endif %}" 
                  title="Todas categorias">∀</button>
          <button type="button" onclick="filtrarCategoria('A')" 
                  class="px-2 py-1 text-xs rounded font-semibold transition-colors {% if request.args.get('categoria') == 'A' %}bg-green-500 text-white{% else %}text-gray-400 hover:bg-gray-100{% endif %}" 
                  title="Categoria A">A</button>
          <button type="button" onclick="filtrarCategoria('B')" 
                  class="px-2 py-1 text-xs rounded font-semibold transition-colors {% if request.args.get('categoria') == 'B' %}bg-gray-500 text-white{% else %}text-gray-400 hover:bg-gray-100{% endif %}" 
                  title="Categoria B">B</button>
          <button type="button" onclick="filtrarCategoria('C')" 
                  class="px-2 py-1 text-xs rounded font-semibold transition-colors {% if request.args.get('categoria') == 'C' %}bg-gray-400 text-white{% else %}text-gray-400 hover:bg-gray-100{% endif %}" 
                  title="Categoria C">C</button>
        </div>
        
        <!-- Agência toggle: um botão que alterna entre Clientes e Agências -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          {% if request.args.get('agencia') == 'sim' %}
          <a href="{{ url_for('clientes', executivo_id=request.args.get('executivo_id', ''), search=request.args.get('search', ''), status=request.args.get('status', 'ativo'), categoria=request.args.get('categoria', ''), agencia='nao') }}"
             class="px-2 py-1 text-xs rounded transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" 
             title="Mostrando Agências - Clique para ver Clientes">
            <i class="fa-solid fa-building text-xs"></i>
          </a>
          {% else %}
          <a href="{{ url_for('clientes', executivo_id=request.args.get('executivo_id', ''), search=request.args.get('search', ''), status=request.args.get('status', 'ativo'), categoria=request.args.get('categoria', ''), agencia='sim') }}"
             class="px-2 py-1 text-xs rounded transition-colors bg-gray-200 text-gray-800 hover:bg-gray-300" 
             title="Mostrando Clientes - Clique para ver Agências">
            <i class="fa-solid fa-user text-xs"></i>
          </a>
          {% endif %}
        </div>
      </form>
      
      <!-- Botões -->
      <div class="flex gap-2">
        <button onclick="recategorizarABC()" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors" title="Recategorizar ABC">
          <i class="fas fa-tags mr-1"></i>ABC
        </button>
        <button onclick="abrirModalNovo()" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
          <i class="fas fa-plus mr-1"></i>Novo
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabela de Clientes -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    {% if clientes %}
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="tabela_clientes">
          <thead class="bg-gray-100">
            <tr>
              <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Nome</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-24">Tipo</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-20">Cotações</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-24">Aprovação</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-20">Briefings</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-24">Aceite</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-16">Usuários</th>
              <th class="text-center py-2 px-2 text-xs font-medium text-gray-600 uppercase w-14">Cat.</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-100">
            {% for cliente in clientes %}
            <tr class="hover:bg-gray-50 transition-colors">
              <td class="py-2 px-3">
                <div>
                  <a href="#" onclick="abrirModalEditar({{ cliente.id_cliente }}); return false;" 
                     class="font-medium text-gray-800 hover:text-gray-600 cursor-pointer transition-colors">
                    {{ cliente.nome_fantasia or cliente.razao_social }}
                  </a>
                </div>
                <div class="text-xs text-gray-500">
                  {% if cliente.executivo_nome %}
                    <i class="fas fa-user-tie mr-1"></i>{{ cliente.executivo_nome }}
                  {% else %}
                    <span class="italic">Sem executivo</span>
                  {% endif %}
                </div>
              </td>
              <td class="text-center py-2 px-2">
                <span class="text-xs text-gray-600">{{ cliente.tipo_cliente_display or '-' }}</span>
              </td>
              <td class="text-center py-2 px-2">
                <span class="font-medium text-gray-700">{{ cliente.cotacoes_mes or 0 }}</span>
              </td>
              <td class="text-center py-2 px-2">
                <span class="{% if cliente.cotacoes_aprovadas_mes %}text-green-600 font-medium{% else %}text-gray-400{% endif %}">
                  {{ cliente.cotacoes_aprovadas_mes or 0 }}/{{ cliente.cotacoes_mes or 0 }}
                </span>
              </td>
              <td class="text-center py-2 px-2">
                <span class="font-medium text-gray-700">{{ cliente.briefings_mes or 0 }}</span>
              </td>
              <td class="text-center py-2 px-2">
                <span class="{% if cliente.briefings_aceitos_mes %}text-green-600 font-medium{% else %}text-gray-400{% endif %}">
                  {{ cliente.briefings_aceitos_mes or 0 }}/{{ cliente.briefings_mes or 0 }}
                </span>
              </td>
              <td class="text-center py-2 px-2">
                <span class="text-xs px-2 py-0.5 rounded bg-gray-100 text-gray-600">{{ cliente.total_usuarios or 0 }}</span>
              </td>
              <td class="text-center py-2 px-2">
                {% set cat = cliente.categoria_abc or 'C' %}
                <span class="badge badge-sm badge-cat-{{ cat|lower }}" title="Categoria {{ cat }}">
                  {{ cat }}
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Paginação -->
      {% if pages > 1 %}
      <div class="flex justify-center items-center gap-2 p-4 border-t border-gray-200">
        {% if page > 1 %}
          <a href="{{ url_for('clientes', page=page-1, **filtros) }}" class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded">
            <i class="fas fa-chevron-left"></i>
          </a>
        {% endif %}
        
        {% for p in range(1, pages + 1) %}
          {% if p == page %}
            <span class="px-3 py-1 text-sm bg-gray-800 text-white rounded">{{ p }}</span>
          {% elif p == 1 or p == pages or (p >= page - 2 and p <= page + 2) %}
            <a href="{{ url_for('clientes', page=p, **filtros) }}" class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded">{{ p }}</a>
          {% elif p == page - 3 or p == page + 3 %}
            <span class="px-2 text-gray-400">...</span>
          {% endif %}
        {% endfor %}
        
        {% if page < pages %}
          <a href="{{ url_for('clientes', page=page+1, **filtros) }}" class="px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 rounded">
            <i class="fas fa-chevron-right"></i>
          </a>
        {% endif %}
        
        <span class="text-xs text-gray-500 ml-4">
          Página {{ page }} de {{ pages }}
        </span>
      </div>
      {% endif %}
    {% else %}
      <div class="text-center py-12">
        <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
        <p class="text-gray-500 mb-4">Nenhum cliente encontrado.</p>
        <button onclick="abrirModalNovo()" class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700">
          <i class="fas fa-plus mr-2"></i>Cadastrar Cliente
        </button>
      </div>
    {% endif %}
  </div>
</div>

<script>
  // Filtros
  function filtrarStatus(status) {
    document.getElementById('status_filter').value = status;
    document.getElementById('filtros_form').submit();
  }
  
  function filtrarCategoria(cat) {
    document.getElementById('categoria_filter').value = cat;
    document.getElementById('filtros_form').submit();
  }
  
  function filtrarAgencia(valor) {
    document.getElementById('agencia_filter').value = valor;
    document.getElementById('filtros_form').submit();
  }
  
  // Recategorizar ABC
  async function recategorizarABC() {
    if (!confirm('Deseja recategorizar todos os clientes conforme regras ABC?\n\nA: aprovações >= R$200k/mês\nB: ativo, < R$200k\nC: sem briefings/cotações')) {
      return;
    }
    
    try {
      const response = await fetch('/admin/clientes/recategorizar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const data = await response.json();
      
      if (data.success) {
        alert(data.message);
        location.reload();
      } else {
        alert('Erro: ' + data.message);
      }
    } catch (error) {
      alert('Erro ao recategorizar: ' + error.message);
    }
  }
</script>

<!-- Modal de Cliente -->
<dialog id="modal_cliente" class="modal">
  <div class="modal-box w-11/12 max-w-5xl bg-white p-0 rounded-lg max-h-[90vh]">
    <!-- Header fixo -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h3 class="font-semibold text-lg text-gray-800" id="modal_title">Novo Cliente</h3>
      <button onclick="modal_cliente.close()" class="p-2 hover:bg-gray-200 rounded transition-colors">
        <i class="fa-solid fa-xmark text-gray-500"></i>
      </button>
    </div>
    
    <!-- Tabs -->
    <div id="tabs_container" class="flex border-b border-gray-200 px-6 bg-gray-50" style="display:none;">
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn tab-active" data-tab="editar" onclick="trocarAba('editar')">
        <i class="fas fa-edit mr-2"></i>Editar
      </button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="detalhes" onclick="trocarAba('detalhes')">
        <i class="fas fa-info-circle mr-2"></i>Detalhes
      </button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="contatos" onclick="trocarAba('contatos')">
        <i class="fas fa-address-book mr-2"></i>Contatos
      </button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="contratos" onclick="trocarAba('contratos')">
        <i class="fas fa-file-contract mr-2"></i>Contratos
      </button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="invites" onclick="trocarAba('invites')">
        <i class="fas fa-envelope mr-2"></i>Invites
      </button>
    </div>
    
    <!-- Conteúdo -->
    <div class="p-6">
      <!-- Conteúdo Editar -->
      <form id="form_cliente" method="post" class="space-y-3 modal-tab-content" data-tab="editar">
        <input type="hidden" id="cliente_id" name="cliente_id" value="">
        
        <!-- Linha 1: Pessoa + CNPJ + Nome Fantasia + Razão Social -->
        <div class="grid grid-cols-2 md:grid-cols-12 gap-3 items-end">
          <div class="form-control col-span-1 md:col-span-2">
            <label class="text-xs font-medium text-gray-600 mb-1">Pessoa*</label>
            <div class="flex gap-0 pessoa-toggle-group">
              <label id="label_pessoa_j" class="pessoa-toggle-btn cursor-pointer flex items-center justify-center gap-1.5 px-3 py-2 border-2 rounded-l-lg text-xs font-semibold transition-all duration-200 border-green-500 bg-green-50 text-green-700">
                <input type="radio" name="pessoa" value="J" class="hidden" required checked>
                <svg class="w-3.5 h-3.5 pessoa-check-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                <span>PJ</span>
              </label>
              <label id="label_pessoa_f" class="pessoa-toggle-btn cursor-pointer flex items-center justify-center gap-1.5 px-3 py-2 border-2 rounded-r-lg text-xs font-semibold transition-all duration-200 border-gray-300 bg-white text-gray-500 hover:bg-gray-50">
                <input type="radio" name="pessoa" value="F" class="hidden" required>
                <svg class="w-3.5 h-3.5 pessoa-check-icon hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                <span>PF</span>
              </label>
            </div>
          </div>
          <div class="form-control col-span-1 md:col-span-2">
            <label id="label_cnpj" class="text-xs font-medium text-gray-600 mb-1">CNPJ*</label>
            <input id="input_cnpj" name="cnpj" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="CNPJ" oninput="mascaraCnpjCpf(this)" maxlength="18">
            <span id="cnpjcpf_msg" class="text-red-500 text-xs"></span>
          </div>
          <div class="form-control col-span-1 md:col-span-4">
            <label id="label_nome_fantasia" class="text-xs font-medium text-gray-600 mb-1">Nome Fantasia*</label>
            <input id="input_nome_fantasia" name="nome_fantasia" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Nome fantasia">
          </div>
          <div id="razao_social_fields" class="form-control col-span-1 md:col-span-4">
            <label class="text-xs font-medium text-gray-600 mb-1">Razão Social*</label>
            <input id="input_razao_social" name="razao_social" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Razão social">
          </div>
        </div>

        <!-- Linha 2: Inscrições + Tipo + Vendas + Agência + Percentual -->
        <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
          <div id="inscricoes_fields" class="form-control col-span-2 md:col-span-2">
            <div class="grid grid-cols-2 gap-2">
              <div class="form-control">
                <label class="text-xs font-medium text-gray-600 mb-1">Insc. Estadual</label>
                <input name="inscricao_estadual" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="IE">
              </div>
              <div class="form-control">
                <label class="text-xs font-medium text-gray-600 mb-1">Insc. Municipal</label>
                <input name="inscricao_municipal" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="IM">
              </div>
            </div>
          </div>
          <div id="tipo_cliente_fields" class="form-control">
            <label class="text-xs font-medium text-gray-600 mb-1">Tipo*</label>
            <select id="select_tipo_cliente" name="id_tipo_cliente" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400 bg-white" required>
              <option value="">Selecione</option>
              {% for tipo in tipos_cliente %}
                <option value="{{ tipo.id_tipo_cliente }}">{{ tipo.display }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-control">
            <label class="text-xs font-medium text-gray-600 mb-1">Vendas CC*</label>
            <select name="vendas_central_comm" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400 bg-white" required>
              <option value="">Selecione</option>
              {% for vendedor in vendedores_cc %}
                <option value="{{ vendedor.id_contato_cliente }}">{{ vendedor.nome_completo }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="agencia_fields" class="form-control">
            <label class="text-xs font-medium text-gray-600 mb-1">Agência*</label>
            <select name="pk_id_tbl_agencia" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400 bg-white" required>
              <option value="">Selecione</option>
              {% for agencia in agencias %}
                <option value="{{ agencia.id_agencia }}">{{ agencia.display }}</option>
              {% endfor %}
            </select>
          </div>
          <div id="percentual_fields" class="form-control">
            <label class="text-xs font-medium text-gray-600 mb-1">Percentual</label>
            <input name="percentual" type="text" maxlength="5" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="00,00" oninput="mascaraPercentual(this)">
          </div>
        </div>

        <!-- ID CentralX (campo oculto) -->
        <div class="hidden">
          <div class="form-control">
            <label class="text-xs font-medium text-gray-600 mb-1">ID CentralX</label>
            <input id="input_id_centralx" name="id_centralx" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="ID CentralX">
          </div>
        </div>

        <!-- Endereço Compacto -->
        <div class="border-t border-gray-200 pt-3 mt-3">
          <h4 class="text-xs font-medium text-gray-500 uppercase mb-3">Endereço</h4>
          <div class="grid grid-cols-3 md:grid-cols-7 gap-3">
            <div class="form-control">
              <label class="text-xs font-medium text-gray-600 mb-1">CEP</label>
              <input id="cep" name="cep" oninput="mascaraCep(this)" onkeydown="buscarCepEnter(event)" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="CEP (Enter para buscar)">
            </div>
            <div class="form-control">
              <label class="text-xs font-medium text-gray-600 mb-1">UF</label>
              <select id="estado" name="pk_id_aux_estado" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400 bg-white">
                <option value="">UF</option>
                {% for estado in estados %}
                  <option value="{{ estado.id_estado }}" data-sigla="{{ estado.sigla }}">{{ estado.sigla }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-control">
              <label class="text-xs font-medium text-gray-600 mb-1">Cidade</label>
              <input id="cidade" name="cidade" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Cidade">
            </div>
            <div class="form-control">
              <label class="text-xs font-medium text-gray-600 mb-1">Bairro</label>
              <input id="bairro" name="bairro" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Bairro">
            </div>
            <div class="form-control col-span-2">
              <label class="text-xs font-medium text-gray-600 mb-1">Logradouro</label>
              <input id="logradouro" name="logradouro" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Logradouro">
            </div>
            <div class="form-control">
              <label class="text-xs font-medium text-gray-600 mb-1">Nº</label>
              <input id="numero" name="numero" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Nº">
            </div>
          </div>
          <div class="form-control mt-3">
            <label class="text-xs font-medium text-gray-600 mb-1">Complemento</label>
            <input id="complemento" name="complemento" class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400" placeholder="Complemento">
          </div>
        </div>

        <!-- Hidden field para pessoa física -->
        <input type="hidden" name="pk_id_tbl_agencia_pf" value="2">

        <!-- Botões do Form -->
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
          <button type="button" onclick="modal_cliente.close()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors">Cancelar</button>
          <button type="submit" class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
            <i class="fas fa-save mr-2"></i><span id="btn_submit_text">Cadastrar</span>
          </button>
        </div>
      </form>
      
      <!-- Conteúdo Detalhes -->
      <div id="detalhes_aba_content" class="modal-tab-content hidden" data-tab="detalhes">
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <h4 class="text-xs font-medium text-gray-500 uppercase mb-3 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>Informações Principais
          </h4>
          <div id="info_principais_aba" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
            <!-- Conteúdo via JavaScript -->
          </div>
        </div>

        <div id="endereco_section_aba" class="bg-gray-50 rounded-lg p-4" style="display:none;">
          <h4 class="text-xs font-medium text-gray-500 uppercase mb-3 flex items-center">
            <i class="fas fa-map-marker-alt mr-2"></i>Endereço
          </h4>
          <div id="info_endereco_aba" class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
            <!-- Conteúdo via JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Conteúdo Contatos -->
      <div id="contatos_aba_content" class="modal-tab-content hidden" data-tab="contatos">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-sm font-medium text-gray-700">Contatos Vinculados</h4>
          <button type="button" onclick="abrirModalNovoContato()" class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
            <i class="fas fa-plus mr-2"></i>Novo Contato
          </button>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4">
          <div id="lista_contatos_aba">
            <!-- Conteúdo via JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Conteúdo Contratos -->
      <div id="contratos_aba_content" class="modal-tab-content hidden" data-tab="contratos">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-sm font-medium text-gray-700">Contratos do Cliente</h4>
        </div>
        
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <div id="lista_contratos_aba">
            <!-- Conteúdo via JavaScript -->
          </div>
        </div>
        
        <div class="flex justify-end">
          <button type="button" onclick="criarPlanoBetaTesterAba()" class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
            <i class="fas fa-gift mr-2"></i>Criar Plano Beta
          </button>
        </div>
      </div>
      
      <!-- Conteúdo Invites -->
      <div id="invites_aba_content" class="modal-tab-content hidden" data-tab="invites">
        <div class="flex justify-between items-center mb-4">
          <h4 class="text-sm font-medium text-gray-700">Convites de Usuários</h4>
        </div>
        
        <!-- Formulário de Novo Convite -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <h5 class="text-xs font-medium text-gray-500 uppercase mb-3">Enviar Novo Convite</h5>
          <div class="flex gap-3">
            <div class="flex-1 relative">
              <input 
                type="email" 
                id="invite_email" 
                placeholder="Digite o email do convidado" 
                class="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400"
                onblur="verificarEmailInvite(this)"
              >
              <span id="invite_email_status" class="text-xs absolute -bottom-5 left-0"></span>
            </div>
            <select id="invite_role" class="px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:border-gray-400 bg-white">
              <option value="member">Membro</option>
              <option value="admin">Admin</option>
            </select>
            <button 
              type="button" 
              onclick="enviarConvite()" 
              class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
              <i class="fas fa-paper-plane mr-2"></i>Enviar
            </button>
          </div>
        </div>
        
        <!-- Lista de Convites -->
        <div class="bg-gray-50 rounded-lg p-4">
          <h5 class="text-xs font-medium text-gray-500 uppercase mb-3">Convites Enviados</h5>
          <div id="lista_invites_aba">
            <!-- Conteúdo via JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button>close</button>
  </form>
</dialog>

<!-- Modal de Detalhes do Cliente -->
<dialog id="modal_detalhes" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-6xl max-h-[90vh] overflow-y-auto">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    
    <h3 class="font-bold text-lg mb-4">
      <span id="detalhes_title">Detalhes do Cliente</span>
    </h3>
    
    <div id="detalhes_content" class="space-y-4">
      <!-- Informações Principais -->
      <div class="bg-base-200/50 rounded-lg p-4">
        <h4 class="text-md font-semibold mb-3 flex items-center">
          <i class="fas fa-info-circle mr-2 text-primary"></i>Informações Principais
        </h4>
        <div id="info_principais" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <!-- Conteúdo será preenchido via JavaScript -->
        </div>
      </div>

      <!-- Endereço -->
      <div id="endereco_section" class="bg-base-200/50 rounded-lg p-4" style="display:none;">
        <h4 class="text-md font-semibold mb-3 flex items-center">
          <i class="fas fa-map-marker-alt mr-2 text-primary"></i>Endereço
        </h4>
        <div id="info_endereco" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
          <!-- Conteúdo será preenchido via JavaScript -->
        </div>
      </div>

      <!-- Contatos Vinculados -->
      <div class="bg-base-200/50 rounded-lg p-4">
        <h4 class="text-md font-semibold mb-3 flex items-center">
          <i class="fas fa-address-book mr-2 text-primary"></i>Contatos Vinculados
        </h4>
        <div id="lista_contatos">
          <!-- Conteúdo será preenchido via JavaScript -->
        </div>
      </div>
    </div>

    <div class="modal-action mt-6">
      <button type="button" onclick="modal_detalhes.close()" class="btn btn-ghost btn-sm">Fechar</button>
      <button type="button" onclick="editarClienteDoModal()" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">
        <i class="fas fa-edit mr-2"></i>Editar Cliente
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Modal de Novo/Editar Contato -->
<dialog id="modal_contato" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-3xl">
    <form method="dialog">
      <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
    </form>
    
    <h3 class="font-bold text-lg mb-3" id="contato_modal_title">Novo Contato</h3>
    
    <form id="form_contato" class="space-y-2" autocomplete="off">
      <input type="hidden" id="contato_id" name="contato_id" value="">
      <input type="hidden" id="contato_cliente_id" name="cliente_id" value="">
      
      <!-- Linha 1: Nome, Email, Telefone -->
      <div class="grid grid-cols-12 gap-2">
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold">Nome Completo <span class="text-error">*</span></span></label>
          <input type="text" id="contato_nome_completo" name="nome_completo" class="input input-bordered input-sm w-full" required placeholder="Nome completo">
        </div>
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold">Email <span class="text-error">*</span></span></label>
          <input type="email" id="contato_email" name="email" class="input input-bordered input-sm w-full" required placeholder="email@exemplo.com">
        </div>
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold">Telefone</span></label>
          <input type="text" id="contato_telefone" name="telefone" class="input input-bordered input-sm w-full" placeholder="(00) 00000-0000">
        </div>
      </div>

      <!-- Linha 2: Setor, Cargo, Tipo Usuário -->
      <div class="grid grid-cols-12 gap-2">
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold">Setor <span class="text-error">*</span></span></label>
          <select id="contato_setor" name="pk_id_aux_setor" class="select select-bordered h-8 min-h-[2rem] text-sm leading-tight w-full" required onchange="carregarCargosPorSetor(this.value)">
            <option value="">Selecione</option>
            {% for setor in setores %}
            <option value="{{ setor.id_setor }}">{{ setor.display }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold">Cargo <span class="text-error">*</span></span></label>
          <select id="contato_cargo" name="pk_id_tbl_cargo" class="select select-bordered h-8 min-h-[2rem] text-sm leading-tight w-full" required>
            <option value="">Selecione setor</option>
          </select>
        </div>
        <!-- Tipo Usuário hidden com valor fixo -->
        <input type="hidden" id="contato_user_type" name="user_type" value="client">
        <!-- Cohorts fixo em 1 -->
        <input type="hidden" id="contato_cohorts" name="cohorts" value="1">
      </div>

      <!-- Linha 3: Senha -->
      <div class="grid grid-cols-12 gap-2">
        <div class="form-control col-span-4">
          <label class="label py-0.5"><span class="label-text text-xs font-semibold" id="senha_label">Senha <span class="text-error">*</span></span></label>
          <input type="password" id="contato_senha" name="senha" class="input input-bordered input-sm w-full" placeholder="Mín. 6 caracteres" autocomplete="new-password">
        </div>
      </div>

      <div class="modal-action mt-3 pt-2 border-t">
        <button type="button" onclick="modal_contato.close()" class="btn btn-ghost btn-sm">Cancelar</button>
        <button type="submit" class="btn text-white btn-sm" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-save mr-2"></i><span id="contato_btn_text">Criar Contato</span>
        </button>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<script>
// Funções do Modal de Cliente
document.addEventListener('DOMContentLoaded', function() {
  const formCliente = document.getElementById('form_cliente');
  
  if (formCliente) {
    // Handler para mudança de pessoa (PF/PJ) no modal
    const pessoaRadios = formCliente.querySelectorAll('input[name="pessoa"]');
    pessoaRadios.forEach(radio => {
      radio.addEventListener('change', togglePessoaFieldsModal);
    });
    
    // Handler para blur do CNPJ/CPF no modal
    const cnpjInput = document.getElementById('input_cnpj');
    if (cnpjInput) {
      cnpjInput.addEventListener('blur', onCnpjCpfBlur);
    }
    
    // Handler para submit do formulário
    formCliente.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const clienteId = document.getElementById('cliente_id').value;
      const formData = new FormData(formCliente);
      const url = clienteId ? `/clientes/${clienteId}/editar` : '/clientes/novo';
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok || response.redirected) {
          // Fechar modal
          modal_cliente.close();
          
          if (clienteId) {
            // EDIÇÃO: Recarregar página para garantir dados atualizados
            showToast('Cliente atualizado com sucesso!', 'success');
            window.location.reload();
          } else {
            // NOVO CLIENTE: Extrair ID do redirecionamento e buscar dados
            const urlParams = new URL(response.url);
            const novoClienteId = urlParams.pathname.match(/\/clientes\/(\d+)/)?.[1];
            
            if (novoClienteId) {
              const clienteResponse = await fetch(`/api/cliente/${novoClienteId}`);
              const cliente = await clienteResponse.json();
              
              // Criar nova linha na tabela
              const tbody = document.querySelector('table tbody');
              const novaLinha = document.createElement('tr');
              novaLinha.className = 'hover';
              novaLinha.innerHTML = `
                <td>
                  <div class="font-semibold text-base-content">${cliente.nome_fantasia || cliente.razao_social}</div>
                  ${cliente.nome_fantasia && cliente.razao_social !== cliente.nome_fantasia ? `<div class="text-xs text-base-content/60">${cliente.razao_social}</div>` : ''}
                </td>
                <td>
                  ${cliente.executivo_nome ? `<span class="text-base-content">${cliente.executivo_nome}</span>` : `<span class="text-base-content/40 italic">Não atribuído</span>`}
                </td>
                <td class="text-center">${cliente.pessoa}</td>
                <td class="text-center">
                  ${cliente.nome_fantasia && cliente.nome_fantasia.toUpperCase() !== 'CENTRALCOMM' ? `
                    <button type="button"
                            class="badge badge-sm cursor-pointer transition-all hover:scale-105"
                            style="${cliente.status ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : 'background-color: #ef4444; color: white; border-color: #ef4444;'}"
                            onclick="toggleStatus(${cliente.id_cliente}, this, ${cliente.status})"
                            title="Clique para ${cliente.status ? 'desativar' : 'ativar'}">
                      ${cliente.status ? 'Ativo' : 'Inativo'}
                    </button>
                  ` : `
                    <span class="badge badge-success badge-sm">
                      <i class="fas fa-lock mr-1"></i>Ativo
                    </span>
                  `}
                </td>
                <td class="text-center">
                  <span class="badge badge-sm badge-ghost">0</span>
                </td>
                <td>
                  <div class="flex items-center justify-center gap-1">
                    <button onclick="abrirModalEditar(${cliente.id_cliente})" class="btn btn-xs btn-circle btn-outline btn-primary" title="Editar">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button id="btn_detalhes_${cliente.id_cliente}" 
                       onclick="abrirModalDetalhes(${cliente.id_cliente})" 
                       class="btn btn-xs btn-circle btn-outline btn-info" 
                       title="Detalhes">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
              `;
              
              // Adicionar linha ao topo da tabela
              tbody.insertBefore(novaLinha, tbody.firstChild);
            } else {
              window.location.reload();
            }
          }
        } else {
          showToast('Erro ao salvar cliente.', 'error');
        }
      } catch (error) {
        console.error('Erro:', error);
        showToast('Erro ao salvar cliente.', 'error');
      }
    });
    
    // Inicializar campos ao abrir modal
    togglePessoaFieldsModal();
  }
});

// Função para abrir modal para novo cliente
function abrirModalNovo() {
  // Limpar formulário
  document.getElementById('form_cliente').reset();
  document.getElementById('modal_title').textContent = 'Novo Cliente';
  document.getElementById('cliente_id').value = '';
  document.getElementById('btn_submit_text').textContent = 'Cadastrar';
  
  // Resetar para Pessoa Jurídica
  document.querySelector('input[name="pessoa"][value="J"]').checked = true;
  
  // Limpar mensagens de erro
  document.getElementById('cnpjcpf_msg').innerText = '';
  
  // Atualizar campos visíveis
  togglePessoaFieldsModal();
  
  // Ocultar abas (modo novo)
  document.getElementById('tabs_container').style.display = 'none';
  
  // Mostrar apenas o formulário
  document.querySelectorAll('.modal-tab-content').forEach(content => {
    if (content.dataset.tab === 'editar') {
      content.classList.remove('hidden');
      content.style.display = '';
    } else {
      content.classList.add('hidden');
      content.style.display = 'none';
    }
  });
  
  // Abrir modal
  modal_cliente.showModal();
}

// Função para abrir modal em modo de edição
async function abrirModalEditar(clienteId) {
  try {
    // Buscar dados do cliente
    const response = await fetch(`/api/cliente/${clienteId}`);
    const cliente = await response.json();
    
    // Buscar contatos do cliente
    const contatosResponse = await fetch(`/api/cliente/${clienteId}/contatos`);
    const contatos = await contatosResponse.json();
    
    // Preencher o formulário
    document.getElementById('modal_title').textContent = cliente.nome_fantasia || cliente.razao_social;
    document.getElementById('cliente_id').value = clienteId;
    document.getElementById('btn_submit_text').textContent = 'Atualizar';
    
    // Tipo de pessoa
    const pessoaRadio = document.querySelector(`input[name="pessoa"][value="${cliente.pessoa}"]`);
    if (pessoaRadio) pessoaRadio.checked = true;
    
    // Campos básicos
    document.getElementById('select_tipo_cliente').value = cliente.id_tipo_cliente || '';
    document.getElementById('input_cnpj').value = cliente.cnpj || '';
    document.getElementById('input_razao_social').value = cliente.razao_social || '';
    document.getElementById('input_nome_fantasia').value = cliente.nome_fantasia || '';
    
    // Inscrições
    document.querySelector('input[name="inscricao_estadual"]').value = cliente.inscricao_estadual || '';
    document.querySelector('input[name="inscricao_municipal"]').value = cliente.inscricao_municipal || '';
    
    // Endereço
    document.getElementById('cep').value = cliente.cep || '';
    document.getElementById('estado').value = cliente.estado || '';
    document.getElementById('cidade').value = cliente.cidade || '';
    document.getElementById('bairro').value = cliente.bairro || '';
    document.getElementById('logradouro').value = cliente.logradouro || '';
    document.getElementById('numero').value = cliente.numero || '';
    document.getElementById('complemento').value = cliente.complemento || '';
    
    // Informações comerciais
    document.querySelector('select[name="vendas_central_comm"]').value = cliente.vendas_central_comm || '';
    document.querySelector('select[name="pk_id_tbl_agencia"]').value = cliente.pk_id_tbl_agencia || '';
    
    // Percentual - formatar com vírgula
    if (cliente.percentual) {
      const percentualFormatado = parseFloat(cliente.percentual).toFixed(2).replace('.', ',');
      document.querySelector('input[name="percentual"]').value = percentualFormatado;
    } else {
      document.querySelector('input[name="percentual"]').value = '';
    }
    
    // ID CentralX
    document.getElementById('input_id_centralx').value = cliente.id_centralx || '';
    
    // Atualizar campos visíveis baseado no tipo de pessoa
    togglePessoaFieldsModal();
    
    // Preencher aba de detalhes
    preencherAbaDetalhes(cliente, contatos);
    
    // Mostrar abas (modo edição)
    document.getElementById('tabs_container').style.display = '';
    trocarAba('editar'); // Começar na aba Editar
    
    // Abrir modal
    modal_cliente.showModal();
  } catch (error) {
    console.error('Erro ao carregar cliente:', error);
    showToast('Erro ao carregar dados do cliente.', 'error');
  }
}

// Máscara para percentual XX,XX
function mascaraPercentual(input) {
  // Remove tudo que não é dígito
  let valor = input.value.replace(/\D/g, '');
  
  // Se vazio, limpa o campo
  if (valor.length === 0) {
    input.value = '';
    return;
  }
  
  // Limita a 4 dígitos (9999 = 99,99)
  if (valor.length > 4) {
    valor = valor.substring(0, 4);
  }
  
  // Converte para número e divide por 100 para ter 2 casas decimais
  const numero = parseInt(valor) / 100;
  
  // Formata com 2 casas decimais e substitui ponto por vírgula
  input.value = numero.toFixed(2).replace('.', ',');
}

function togglePessoaFieldsModal() {
  const pessoa = document.querySelector('#form_cliente input[name="pessoa"]:checked')?.value || 'J';
  
  // Atualizar estilos dos toggle buttons
  const labelJ = document.getElementById('label_pessoa_j');
  const labelF = document.getElementById('label_pessoa_f');
  const checkIconJ = labelJ?.querySelector('.pessoa-check-icon');
  const checkIconF = labelF?.querySelector('.pessoa-check-icon');
  
  if (pessoa === 'J') {
    // PJ selecionado
    labelJ?.classList.remove('border-gray-300', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
    labelJ?.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
    checkIconJ?.classList.remove('hidden');
    
    labelF?.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
    labelF?.classList.add('border-gray-300', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
    checkIconF?.classList.add('hidden');
  } else {
    // PF selecionado
    labelF?.classList.remove('border-gray-300', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
    labelF?.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
    checkIconF?.classList.remove('hidden');
    
    labelJ?.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
    labelJ?.classList.add('border-gray-300', 'bg-white', 'text-gray-500', 'hover:bg-gray-50');
    checkIconJ?.classList.add('hidden');
  }
  
  // Campos específicos de PJ
  const tipoClienteField = document.getElementById('tipo_cliente_fields');
  const selectTipoCliente = document.getElementById('select_tipo_cliente');
  const agenciaFields = document.getElementById('agencia_fields');
  const inscricoesFields = document.getElementById('inscricoes_fields');
  const razaoSocialFields = document.getElementById('razao_social_fields');
  const inputRazaoSocial = document.getElementById('input_razao_social');
  
  if (pessoa === 'F') {
    // Pessoa Física
    tipoClienteField.style.display = 'none';
    selectTipoCliente.required = false;
    agenciaFields.style.display = 'none';
    inscricoesFields.style.display = 'none';
    razaoSocialFields.style.display = 'none';
    inputRazaoSocial.required = false;
    
    document.getElementById('label_cnpj').innerText = 'CPF *';
    document.getElementById('input_cnpj').placeholder = 'Digite o CPF';
    document.getElementById('label_nome_fantasia').innerText = 'Nome Completo *';
    document.getElementById('input_nome_fantasia').placeholder = 'Digite o nome completo';
  } else {
    // Pessoa Jurídica
    tipoClienteField.style.display = '';
    selectTipoCliente.required = true;
    agenciaFields.style.display = '';
    inscricoesFields.style.display = '';
    razaoSocialFields.style.display = '';
    inputRazaoSocial.required = true;
    
    document.getElementById('label_cnpj').innerText = 'CNPJ *';
    document.getElementById('input_cnpj').placeholder = 'Digite o CNPJ';
    document.getElementById('label_nome_fantasia').innerText = 'Nome Fantasia *';
    document.getElementById('input_nome_fantasia').placeholder = 'Digite o nome fantasia';
  }
}

function validarCPF(cpf) {
  cpf = cpf.replace(/\D/g, '');
  if (cpf.length !== 11 || /^([0-9])\1+$/.test(cpf)) return false;
  let soma = 0, resto;
  for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(9, 10))) return false;
  soma = 0;
  for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
  resto = (soma * 10) % 11;
  if (resto === 10 || resto === 11) resto = 0;
  if (resto !== parseInt(cpf.substring(10, 11))) return false;
  return true;
}

async function buscarEmpresaPorCNPJ(cnpj) {
  cnpj = cnpj.replace(/\D/g, '');
  if (cnpj.length !== 14) {
    document.getElementById('cnpjcpf_msg').innerText = 'CNPJ deve ter 14 dígitos';
    return;
  }
  
  try {
    // Mostrar loading
    document.getElementById('cnpjcpf_msg').innerText = 'Buscando dados do CNPJ...';
    document.getElementById('cnpjcpf_msg').classList.remove('text-error');
    document.getElementById('cnpjcpf_msg').classList.add('text-info');
    
    // Pegar cliente_id se estiver editando
    const clienteId = document.getElementById('cliente_id').value;
    let url = '/api/buscar_cnpj/' + cnpj;
    if (clienteId) {
      url += '?cliente_id=' + clienteId;
    }
    
    const resp = await fetch(url);
    const result = await resp.json();
    
    if (result.success) {
      const data = result.data;
      
      // Atualizar razão social e nome fantasia
      const inputRazaoSocial = document.getElementById('input_razao_social');
      const inputNomeFantasia = document.getElementById('input_nome_fantasia');
      
      if (inputRazaoSocial && data.razao_social) {
        inputRazaoSocial.value = data.razao_social;
      }
      // Se nome_fantasia vier vazio da ReceitaWS, usar razão social como fallback
      if (inputNomeFantasia) {
        if (data.nome_fantasia) {
          inputNomeFantasia.value = data.nome_fantasia;
        } else if (data.razao_social) {
          inputNomeFantasia.value = data.razao_social;
        }
      }
      
      // Atualizar inscrições
      const inscEstadual = document.querySelector('#form_cliente input[name="inscricao_estadual"]');
      if (inscEstadual && data.inscricao_estadual) {
        inscEstadual.value = data.inscricao_estadual;
      }
      const inscMunicipal = document.querySelector('#form_cliente input[name="inscricao_municipal"]');
      if (inscMunicipal && data.inscricao_municipal) {
        inscMunicipal.value = data.inscricao_municipal;
      }
      
      // Atualizar campos de endereço
      if (data.cep) {
        const cepInput = document.getElementById('cep');
        if (cepInput) {
          // Formatar CEP: 12345-678
          let cepFormatado = data.cep.replace(/\D/g, '');
          if (cepFormatado.length === 8) {
            cepFormatado = cepFormatado.slice(0, 5) + '-' + cepFormatado.slice(5);
          }
          cepInput.value = cepFormatado;
        }
      }
      if (data.uf) {
        const estadoSelect = document.getElementById('estado');
        if (estadoSelect) {
          const estadoId = getEstadoIdBySigla(data.uf);
          if (estadoId) {
            estadoSelect.value = estadoId;
          }
        }
      }
      if (data.municipio) {
        const cidadeInput = document.getElementById('cidade');
        if (cidadeInput) cidadeInput.value = data.municipio;
      }
      if (data.bairro) {
        const bairroInput = document.getElementById('bairro');
        if (bairroInput) bairroInput.value = data.bairro;
      }
      if (data.logradouro) {
        const logradouroInput = document.getElementById('logradouro');
        if (logradouroInput) logradouroInput.value = data.logradouro;
      }
      if (data.numero) {
        const numeroInput = document.getElementById('numero');
        if (numeroInput) numeroInput.value = data.numero;
      }
      if (data.complemento) {
        const complementoInput = document.getElementById('complemento');
        if (complementoInput) complementoInput.value = data.complemento;
      }
      
      // Limpar mensagem de sucesso
      document.getElementById('cnpjcpf_msg').innerText = '';
      document.getElementById('cnpjcpf_msg').classList.remove('text-info');
      
      showToast('Dados do CNPJ carregados com sucesso!', 'success');
    } else {
      // Verificar se é CNPJ já cadastrado
      if (result.ja_cadastrado) {
        document.getElementById('cnpjcpf_msg').innerText = result.message;
        document.getElementById('cnpjcpf_msg').classList.remove('text-info');
        document.getElementById('cnpjcpf_msg').classList.add('text-error');
        showToast(result.message, 'error');
      } else {
        document.getElementById('cnpjcpf_msg').innerText = result.message || 'CNPJ inválido!';
        document.getElementById('cnpjcpf_msg').classList.remove('text-info');
        document.getElementById('cnpjcpf_msg').classList.add('text-error');
      }
    }
  } catch (e) {
    console.error('Erro ao buscar CNPJ:', e);
    document.getElementById('cnpjcpf_msg').innerText = 'Erro ao consultar CNPJ';
    document.getElementById('cnpjcpf_msg').classList.remove('text-info');
    document.getElementById('cnpjcpf_msg').classList.add('text-error');
  }
}

async function verificarExistenciaDocumento(doc, tipo) {
  try {
    const resp = await fetch(`/api/verifica_documento?doc=${encodeURIComponent(doc)}&tipo=${tipo}`);
    const data = await resp.json();
    if (data.existe) {
      document.getElementById('cnpjcpf_msg').innerText = tipo === 'F' ? 'CPF já cadastrado!' : 'CNPJ já cadastrado!';
      if (data.cliente) {
        if (document.getElementById('input_razao_social') && data.cliente.razao_social)
          document.getElementById('input_razao_social').value = data.cliente.razao_social;
        if (document.getElementById('input_nome_fantasia') && data.cliente.nome_fantasia)
          document.getElementById('input_nome_fantasia').value = data.cliente.nome_fantasia;
      }
    } else {
      document.getElementById('cnpjcpf_msg').innerText = '';
    }
  } catch (e) {
    console.error('Erro ao verificar documento:', e);
  }
}

async function onCnpjCpfBlur() {
  const pessoa = document.querySelector('#form_cliente input[name="pessoa"]:checked')?.value || 'J';
  const doc = document.getElementById('input_cnpj').value.replace(/\D/g, '');
  if (!doc) return;
  
  const clienteId = document.getElementById('cliente_id').value;
  
  if (pessoa === 'F') {
    if (!validarCPF(doc)) {
      document.getElementById('cnpjcpf_msg').innerText = 'CPF inválido!';
      return;
    }
    document.getElementById('cnpjcpf_msg').innerText = '';
    
    // Se está editando, verificar se o CPF é diferente do original
    if (clienteId) {
      const response = await fetch(`/api/cliente/${clienteId}`);
      const clienteOriginal = await response.json();
      const docOriginal = clienteOriginal.cnpj ? clienteOriginal.cnpj.replace(/\D/g, '') : '';
      
      // Só verificar duplicidade se o CPF mudou
      if (doc !== docOriginal) {
        await verificarExistenciaDocumento(doc, 'F');
      }
    } else {
      await verificarExistenciaDocumento(doc, 'F');
    }
  } else {
    if (doc.length !== 14) {
      document.getElementById('cnpjcpf_msg').innerText = 'CNPJ inválido!';
      return;
    }
    document.getElementById('cnpjcpf_msg').innerText = '';
    
    // Sempre buscar dados na ReceitaWS primeiro
    await buscarEmpresaPorCNPJ(doc);
    
    // Se está editando, verificar se o CNPJ é diferente do original
    if (clienteId) {
      const response = await fetch(`/api/cliente/${clienteId}`);
      const clienteOriginal = await response.json();
      const docOriginal = clienteOriginal.cnpj ? clienteOriginal.cnpj.replace(/\D/g, '') : '';
      
      // Só verificar duplicidade se o CNPJ mudou
      if (doc !== docOriginal) {
        await verificarExistenciaDocumento(doc, 'J');
      }
    } else {
      await verificarExistenciaDocumento(doc, 'J');
    }
  }
}

function mascaraCep(input) {
  let v = input.value.replace(/\D/g, '');
  if (v.length > 5) v = v.slice(0,5) + '-' + v.slice(5,8);
  input.value = v.slice(0,9);
}

function mascaraCnpjCpf(input) {
  const pessoa = document.querySelector('#form_cliente input[name="pessoa"]:checked')?.value || 'J';
  let v = input.value.replace(/\D/g, '');
  
  if (pessoa === 'F') {
    // Máscara CPF: 999.999.999-99 (14 caracteres)
    v = v.slice(0, 11); // Limita a 11 dígitos
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d)/, '$1.$2');
    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.maxLength = 14;
  } else {
    // Máscara CNPJ: 99.999.999/9999-99 (18 caracteres)
    v = v.slice(0, 14); // Limita a 14 dígitos
    v = v.replace(/^(\d{2})(\d)/, '$1.$2');
    v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
    v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
    v = v.replace(/(\d{4})(\d)/, '$1-$2');
    input.maxLength = 18;
  }
  
  input.value = v;
}

function buscarCepEnter(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    buscarEnderecoPorCep(event.target.value);
  }
}

function buscarEnderecoPorCep(cep) {
  cep = cep.replace(/\D/g, '');
  
  // Validar tamanho do CEP
  if (cep.length === 0) {
    showToast('Digite um CEP para buscar', 'warning');
    return;
  }
  
  if (cep.length !== 8) {
    showToast('CEP inválido! Deve ter 8 dígitos', 'error');
    return;
  }
  
  // Validar se não é um CEP com todos dígitos iguais (inválido)
  if (/^(\d)\1{7}$/.test(cep)) {
    showToast('CEP inválido!', 'error');
    return;
  }
  
  // Mostrar loading
  showToast('Buscando endereço...', 'info');
  
  fetch('https://viacep.com.br/ws/' + cep + '/json/')
    .then(response => response.json())
    .then(data => {
      if (!data.erro) {
        document.getElementById('estado').value = getEstadoIdBySigla(data.uf);
        document.getElementById('cidade').value = data.localidade || '';
        document.getElementById('bairro').value = data.bairro || '';
        document.getElementById('logradouro').value = data.logradouro || '';
        showToast('Endereço carregado com sucesso!', 'success');
      } else {
        showToast('CEP inválido ou não encontrado!', 'error');
      }
    })
    .catch(e => {
      console.error('Erro ao buscar CEP:', e);
      showToast('Erro ao buscar CEP. Tente novamente.', 'error');
    });
}

function getEstadoIdBySigla(sigla) {
  const select = document.getElementById('estado');
  for (let i = 0; i < select.options.length; i++) {
    const option = select.options[i];
    if (option.dataset.sigla === sigla) {
      return option.value;
    }
  }
  // Fallback
  for (let i = 0; i < select.options.length; i++) {
    if (select.options[i].text.startsWith(sigla + ' ')) {
      return select.options[i].value;
    }
  }
  return '';
}

// Função para toggle de status de cliente
async function toggleStatus(clienteId, badgeElement, statusAtual) {
  const novoStatus = !statusAtual;
  
  // Desabilitar badge durante a requisição
  badgeElement.disabled = true;
  badgeElement.classList.add('opacity-50');
  
  try {
    const response = await fetch(`/clientes/${clienteId}/toggle-status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    if (response.ok) {
      // Atualizar o badge
      badgeElement.textContent = novoStatus ? 'Ativo' : 'Inativo';
      badgeElement.className = 'badge badge-sm cursor-pointer transition-all hover:scale-105';
      badgeElement.style = novoStatus ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : 'background-color: #ef4444; color: white; border-color: #ef4444;';
      badgeElement.title = `Clique para ${novoStatus ? 'desativar' : 'ativar'}`;
      badgeElement.setAttribute('onclick', `toggleStatus(${clienteId}, this, ${novoStatus})`);
    } else {
      showToast('Erro ao alterar status do cliente.', 'error');
    }
  } catch (error) {
    console.error('Erro:', error);
    showToast('Erro ao alterar status do cliente.', 'error');
  } finally {
    badgeElement.disabled = false;
    badgeElement.classList.remove('opacity-50');
  }
}

// Função para abrir modal de detalhes
let clienteIdAtual = null;

async function abrirModalDetalhes(clienteId) {
  clienteIdAtual = clienteId;
  try {
    // Buscar dados do cliente
    const response = await fetch(`/api/cliente/${clienteId}`);
    const cliente = await response.json();
    
    // Buscar contatos do cliente
    const contatosResponse = await fetch(`/api/cliente/${clienteId}/contatos`);
    const contatos = await contatosResponse.json();
    
    // Preencher título
    document.getElementById('detalhes_title').textContent = `Detalhes: ${cliente.nome_fantasia || cliente.razao_social}`;
    
    // Preencher informações principais
    const infoPrincipais = document.getElementById('info_principais');
    infoPrincipais.innerHTML = `
      <div class="flex"><span class="font-semibold text-base-content/70 w-40">ID:</span><span>#${cliente.id_cliente}</span></div>
      <div class="flex"><span class="font-semibold text-base-content/70 w-40">Status:</span>
        <span class="badge badge-sm ${cliente.status ? 'badge-success' : 'badge-error'}">${cliente.status ? 'Ativo' : 'Inativo'}</span>
      </div>
      ${cliente.pessoa !== 'F' ? `<div class="flex"><span class="font-semibold text-base-content/70 w-40">Razão Social:</span><span>${cliente.razao_social || '—'}</span></div>` : ''}
      <div class="flex"><span class="font-semibold text-base-content/70 w-40">${cliente.pessoa === 'F' ? 'Nome Completo' : 'Nome Fantasia'}:</span><span>${cliente.nome_fantasia || '—'}</span></div>
      <div class="flex"><span class="font-semibold text-base-content/70 w-40">${cliente.pessoa === 'F' ? 'CPF' : 'CNPJ'}:</span><span>${cliente.cnpj || 'Não informado'}</span></div>
      <div class="flex"><span class="font-semibold text-base-content/70 w-40">Tipo:</span><span>${cliente.tipo_cliente_display || 'Não informado'}</span></div>
      ${cliente.pessoa !== 'F' ? `
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">Insc. Estadual:</span><span>${cliente.inscricao_estadual || '—'}</span></div>
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">Insc. Municipal:</span><span>${cliente.inscricao_municipal || '—'}</span></div>
      ` : ''}
    `;
    
    // Preencher endereço se existir
    const enderecoSection = document.getElementById('endereco_section');
    const infoEndereco = document.getElementById('info_endereco');
    if (cliente.cep || cliente.logradouro || cliente.cidade) {
      enderecoSection.style.display = '';
      infoEndereco.innerHTML = `
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">CEP:</span><span>${cliente.cep || '—'}</span></div>
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">Estado:</span><span>${cliente.estado_nome || '—'}</span></div>
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">Cidade:</span><span>${cliente.cidade || '—'}</span></div>
        <div class="flex"><span class="font-semibold text-base-content/70 w-40">Bairro:</span><span>${cliente.bairro || '—'}</span></div>
        <div class="flex md:col-span-2"><span class="font-semibold text-base-content/70 w-40">Logradouro:</span><span>${cliente.logradouro || '—'}${cliente.numero ? ', ' + cliente.numero : ''}</span></div>
        ${cliente.complemento ? `<div class="flex md:col-span-2"><span class="font-semibold text-base-content/70 w-40">Complemento:</span><span>${cliente.complemento}</span></div>` : ''}
      `;
    } else {
      enderecoSection.style.display = 'none';
    }
    
    // Preencher contatos
    const listaContatos = document.getElementById('lista_contatos');
    if (contatos && contatos.length > 0) {
      listaContatos.innerHTML = `
        <div class="overflow-x-auto">
          <table class="table table-xs w-full">
            <thead class="bg-primary text-white">
              <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Telefone</th>
                <th>Setor</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${contatos.map(c => `
                <tr class="hover">
                  <td class="font-semibold">${c.nome_completo}</td>
                  <td>${c.email || '—'}</td>
                  <td>${c.telefone || '—'}</td>
                  <td>${c.setor || '—'}</td>
                  <td><span class="badge badge-xs ${c.status ? 'badge-success' : 'badge-error'}">${c.status ? 'Ativo' : 'Inativo'}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      listaContatos.innerHTML = '<p class="text-center text-base-content/60 text-sm py-4">Nenhum contato vinculado</p>';
    }
    
    // Abrir modal
    modal_detalhes.showModal();
  } catch (error) {
    console.error('Erro ao carregar detalhes:', error);
    showToast('Erro ao carregar dados do cliente.', 'error');
  }
}

function editarClienteDoModal() {
  if (clienteIdAtual) {
    modal_detalhes.close();
    abrirModalEditar(clienteIdAtual);
  }
}

function criarPlanoBetaTester(clienteId) {
  if (!confirm('Deseja criar um Plano Beta Tester para este cliente?\n\nDetalhes do plano:\n- 100.000 tokens/mês\n- 50 imagens/mês\n- 10 usuários\n- Válido por 3 meses')) {
    return;
  }
  
  fetch(`/api/cliente/${clienteId}/criar-plano-beta`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin'
  })
  .then(response => {
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('application/json')) {
      throw new Error('Servidor retornou resposta inválida. Verifique se está logado.');
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showToast('Plano Beta Tester criado com sucesso!', 'success');
      
      // Recarregar lista de contratos se estiver na aba de contratos
      if (document.getElementById('contratos_aba_content') && 
          document.getElementById('contratos_aba_content').style.display !== 'none') {
        carregarContratosCliente(clienteId);
      }
      
      // Atualizar a cor do botão de detalhes na listagem
      const btnDetalhes = document.getElementById(`btn_detalhes_${clienteId}`);
      if (btnDetalhes) {
        btnDetalhes.classList.remove('btn-info');
        btnDetalhes.classList.add('btn-success');
        btnDetalhes.title = 'Detalhes - 1 plano(s) ativo(s)';
      }
      modal_detalhes.close();
    } else {
      if (data.error && (data.error.includes('Sessão') || data.error.includes('login'))) {
        showToast(data.error + ' Você será redirecionado para a página de login.', 'error');
        setTimeout(() => { window.location.href = '/login'; }, 2000);
      } else {
        showToast('Erro ao criar plano: ' + (data.error || 'Erro desconhecido'), 'error');
      }
    }
  })
  .catch(error => {
    console.error('Erro completo:', error);
    showToast('Erro na requisição: ' + error.message, 'error');
  });
}

// Função para filtrar clientes por executivo e agência
function filtrarClientes() {
  const pesquisa = document.getElementById('pesquisa_cliente')?.value.toLowerCase().trim() || '';
  const filtroExecutivo = document.getElementById('filtro_executivo')?.value || '';
  const filtroAgencia = document.getElementById('filtro_agencia')?.value || '';
  const tbody = document.querySelector('table tbody');
  const linhas = tbody.querySelectorAll('tr');
  let totalVisiveis = 0;
  
  linhas.forEach(linha => {
    const nomeCell = linha.children[0]; // Primeira coluna = nome
    const executivoCell = linha.children[1]; // Segunda coluna = executivo
    
    const nomeFantasia = nomeCell.querySelector('.font-semibold')?.textContent.toLowerCase() || '';
    const razaoSocial = nomeCell.querySelector('.text-xs')?.textContent.toLowerCase() || '';
    const executivoTexto = executivoCell.textContent.trim();
    const agenciaData = linha.dataset.agencia || 'nao';
    
    // Verificar se passa no filtro de pesquisa
    const passaPesquisa = !pesquisa || nomeFantasia.includes(pesquisa) || razaoSocial.includes(pesquisa);
    
    // Verificar se passa no filtro de executivo
    let passaExecutivo = true;
    if (filtroExecutivo === 'NAO_ATRIBUIDO') {
      passaExecutivo = executivoTexto === 'Não atribuído';
    } else if (filtroExecutivo !== '') {
      passaExecutivo = executivoTexto === filtroExecutivo;
    }
    
    // Verificar se passa no filtro de agência
    let passaAgencia = true;
    if (filtroAgencia === 'sim') {
      passaAgencia = agenciaData === 'sim';
    } else if (filtroAgencia === 'nao') {
      passaAgencia = agenciaData === 'nao';
    }
    
    // Mostrar apenas se passar em todos os filtros
    if (passaPesquisa && passaExecutivo && passaAgencia) {
      linha.style.display = '';
      totalVisiveis++;
    } else {
      linha.style.display = 'none';
    }
  });
  
  // Atualizar contador
  const contador = document.getElementById('contador_filtro');
  const totalClientes = linhas.length;
  
  // Mostrar contador apenas se houver filtros ativos (agencia 'todos' não conta como filtro)
  const filtroAgenciaAtivo = filtroAgencia && filtroAgencia !== 'todos';
  if (pesquisa || filtroExecutivo || filtroAgenciaAtivo) {
    contador.textContent = `Mostrando ${totalVisiveis} de ${totalClientes} cliente(s)`;
  } else {
    contador.textContent = '';
  }
}

// Função para pesquisar cliente (chama filtrarClientes)
function pesquisarCliente() {
  filtrarClientes();
}

// Manter compatibilidade com código antigo
function filtrarPorExecutivo() {
  filtrarClientes();
}

// Função para trocar entre abas no modal
function trocarAba(aba) {
  // Atualizar botões das tabs
  document.querySelectorAll('#tabs_container .tab-btn').forEach(btn => {
    const isActive = btn.dataset.tab === aba;
    btn.classList.toggle('tab-active', isActive);
    if (isActive) {
      btn.style.borderBottomColor = '#374151';
      btn.style.color = '#1f2937';
    } else {
      btn.style.borderBottomColor = 'transparent';
      btn.style.color = '#4b5563';
    }
  });
  
  // Mostrar/ocultar conteúdos
  document.querySelectorAll('.modal-tab-content').forEach(content => {
    const tabName = content.dataset.tab;
    if (tabName === aba) {
      content.classList.remove('hidden');
      content.style.display = '';
    } else {
      content.classList.add('hidden');
      content.style.display = 'none';
    }
  });
  
  // Carregar dados específicos da aba
  if (aba === 'invites') {
    carregarInvites();
  } else if (aba === 'contratos') {
    const clienteId = document.getElementById('cliente_id').value;
    if (clienteId) {
      carregarContratosCliente(clienteId);
    }
  }
}

// Função para preencher aba de detalhes
function preencherAbaDetalhes(cliente, contatos) {
  // Preencher informações principais
  const infoPrincipais = document.getElementById('info_principais_aba');
  infoPrincipais.innerHTML = `
    <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">ID:</span><span>#${cliente.id_cliente}</span></div>
    <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Status:</span><span class="badge badge-xs ${cliente.status ? 'badge-success' : 'badge-error'}">${cliente.status ? 'Ativo' : 'Inativo'}</span></div>
    <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">${cliente.pessoa === 'F' ? 'CPF' : 'CNPJ'}:</span><span>${cliente.cnpj || '—'}</span></div>
    <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Tipo:</span><span>${cliente.tipo_cliente_display || '—'}</span></div>
    ${cliente.pessoa !== 'F' ? `<div class="flex items-center md:col-span-2"><span class="font-semibold text-base-content/70 w-16">Razão:</span><span class="truncate">${cliente.razao_social || '—'}</span></div>` : ''}
    <div class="flex items-center md:col-span-2"><span class="font-semibold text-base-content/70 w-16">${cliente.pessoa === 'F' ? 'Nome' : 'Fantasia'}:</span><span class="truncate">${cliente.nome_fantasia || '—'}</span></div>
    <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Executivo:</span><span>${cliente.executivo_nome || '—'}</span></div>
    ${cliente.pessoa !== 'F' ? `<div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Insc. Est.:</span><span>${cliente.inscricao_estadual || '—'}</span></div><div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Insc. Mun.:</span><span>${cliente.inscricao_municipal || '—'}</span></div>` : ''}
  `;
  
  // Preencher endereço se existir
  const enderecoSection = document.getElementById('endereco_section_aba');
  const infoEndereco = document.getElementById('info_endereco_aba');
  if (cliente.cep || cliente.logradouro || cliente.cidade) {
    enderecoSection.style.display = '';
    infoEndereco.innerHTML = `
      <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">CEP:</span><span>${cliente.cep || '—'}</span></div>
      <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Estado:</span><span>${cliente.estado_nome || '—'}</span></div>
      <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Cidade:</span><span>${cliente.cidade || '—'}</span></div>
      <div class="flex items-center"><span class="font-semibold text-base-content/70 w-16">Bairro:</span><span>${cliente.bairro || '—'}</span></div>
      <div class="flex items-center md:col-span-4"><span class="font-semibold text-base-content/70 w-16">Endereço:</span><span class="truncate">${cliente.logradouro || '—'}${cliente.numero ? ', ' + cliente.numero : ''}${cliente.complemento ? ' - ' + cliente.complemento : ''}</span></div>
    `;
  } else {
    enderecoSection.style.display = 'none';
  }
  
  // Preencher contatos
  const listaContatos = document.getElementById('lista_contatos_aba');
  if (contatos && contatos.length > 0) {
    listaContatos.innerHTML = `
      <div class="overflow-x-auto">
        <table class="table table-xs w-full">
          <thead class="text-white rounded-lg" style="background-color: #72cd80;">
            <tr>
              <th class="rounded-tl-lg">Nome</th>
              <th>Email</th>
              <th>Setor/Cargo</th>
              <th>Status</th>
              <th class="rounded-tr-lg text-center">Ações</th>
            </tr>
          </thead>
          <tbody>
            ${contatos.map(c => `
              <tr class="hover">
                <td class="font-semibold text-primary cursor-pointer hover:underline" onclick="abrirModalEditarContato(${c.id_contato_cliente})" title="Clique para editar">${c.nome_completo}</td>
                <td class="text-xs">${c.email || '—'}</td>
                <td class="text-xs">${c.setor || '—'}${c.cargo ? ' / ' + c.cargo : ''}</td>
                <td>
                  <button type="button"
                          class="badge badge-xs cursor-pointer transition-all hover:scale-105"
                          style="${c.status ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : 'background-color: #ef4444; color: white; border-color: #ef4444;'}"
                          onclick="toggleContatoStatus(${c.id_contato_cliente}, ${cliente.id_cliente}, this, ${c.status})"
                          title="Clique para ${c.status ? 'desativar' : 'ativar'}">
                    ${c.status ? 'Ativo' : 'Inativo'}
                  </button>
                </td>
                <td class="text-center">
                  <div class="flex items-center justify-center gap-3">
                    ${c.email ? `<i class="fas fa-paper-plane text-success cursor-pointer hover:scale-110 transition-all" onclick="enviarConviteContato('${(c.email || '').replace(/'/g, "\\'")}', '${c.nome_completo.replace(/'/g, "\\'")}')" title="Enviar convite"></i>` : '<i class="fas fa-paper-plane text-gray-300" title="Sem email cadastrado"></i>'}
                    ${c.email ? `<i class="fas fa-envelope text-primary cursor-pointer hover:scale-110 transition-all" onclick="enviarEmailBoasVindas(${c.id_contato_cliente}, '${c.nome_completo.replace(/'/g, "\\'")}', '${(c.email || '').replace(/'/g, "\\'")}')" title="Enviar email de boas-vindas"></i>` : '<i class="fas fa-envelope text-gray-300" title="Sem email cadastrado"></i>'}
                    <i class="fas fa-trash text-error cursor-pointer hover:scale-110 transition-all" onclick="deletarContato(${c.id_contato_cliente}, ${cliente.id_cliente}, '${c.nome_completo.replace(/'/g, "\\'")}')" title="Deletar"></i>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  } else {
    listaContatos.innerHTML = '<p class="text-center text-base-content/60 text-sm py-4">Nenhum contato vinculado</p>';
  }
  
  // Carregar contratos do cliente
  carregarContratosCliente(cliente.id_cliente);
}

// Função para carregar contatos na aba
async function carregarContatosAba(clienteId) {
  const listaContatos = document.getElementById('lista_contatos_aba');
  
  if (!listaContatos) {
    console.error('Elemento lista_contatos_aba não encontrado');
    return;
  }
  
  try {
    const response = await fetch(`/api/cliente/${clienteId}/contatos`);
    if (!response.ok) throw new Error('Erro ao buscar contatos');
    
    const contatos = await response.json();
    
    if (contatos && contatos.length > 0) {
      listaContatos.innerHTML = `
        <div class="overflow-x-auto">
          <table class="table table-xs w-full">
            <thead class="text-white rounded-lg" style="background-color: #72cd80;">
              <tr>
                <th class="rounded-tl-lg">Nome</th>
                <th>Email</th>
                <th>Setor/Cargo</th>
                <th>Status</th>
                <th class="rounded-tr-lg text-center">Ações</th>
              </tr>
            </thead>
            <tbody>
              ${contatos.map(c => `
                <tr class="hover">
                  <td class="font-semibold text-primary cursor-pointer hover:underline" onclick="abrirModalEditarContato(${c.id_contato_cliente})" title="Clique para editar">${c.nome_completo}</td>
                  <td class="text-xs">${c.email || '—'}</td>
                  <td class="text-xs">${c.setor || '—'}${c.cargo ? ' / ' + c.cargo : ''}</td>
                  <td>
                    <button type="button"
                            class="badge badge-xs cursor-pointer transition-all hover:scale-105"
                            style="${c.status ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : 'background-color: #ef4444; color: white; border-color: #ef4444;'}"
                            onclick="toggleContatoStatus(${c.id_contato_cliente}, ${clienteId}, this, ${c.status})"
                            title="Clique para ${c.status ? 'desativar' : 'ativar'}">
                      ${c.status ? 'Ativo' : 'Inativo'}
                    </button>
                  </td>
                  <td class="text-center">
                    <div class="flex items-center justify-center gap-3">
                      ${c.email ? `<i class="fas fa-paper-plane text-success cursor-pointer hover:scale-110 transition-all" onclick="enviarConviteContato('${(c.email || '').replace(/'/g, "\\'")}', '${c.nome_completo.replace(/'/g, "\\'")}')" title="Enviar convite"></i>` : '<i class="fas fa-paper-plane text-gray-300" title="Sem email cadastrado"></i>'}
                      ${c.email ? `<i class="fas fa-envelope text-primary cursor-pointer hover:scale-110 transition-all" onclick="enviarEmailBoasVindas(${c.id_contato_cliente}, '${c.nome_completo.replace(/'/g, "\\'")}', '${(c.email || '').replace(/'/g, "\\'")}')" title="Enviar email de boas-vindas"></i>` : '<i class="fas fa-envelope text-gray-300" title="Sem email cadastrado"></i>'}
                      <i class="fas fa-trash text-error cursor-pointer hover:scale-110 transition-all" onclick="deletarContato(${c.id_contato_cliente}, ${clienteId}, '${c.nome_completo.replace(/'/g, "\\'")}')" title="Deletar"></i>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      listaContatos.innerHTML = '<p class="text-center text-base-content/60 text-sm py-4">Nenhum contato vinculado</p>';
    }
    
  } catch (error) {
    console.error('Erro ao carregar contatos:', error);
    listaContatos.innerHTML = '<p class="text-center text-error text-sm py-4">Erro ao carregar contatos</p>';
  }
}

// Função para carregar contratos do cliente
async function carregarContratosCliente(clienteId) {
  const listaContratos = document.getElementById('lista_contratos_aba');
  
  if (!listaContratos) {
    console.error('Elemento lista_contratos_aba não encontrado');
    return;
  }
  
  listaContratos.innerHTML = '<p class="text-center text-base-content/60 text-sm py-4">Carregando...</p>';
  
  try {
    const response = await fetch(`/api/cliente/${clienteId}/planos`);
    const data = await response.json();
    
    if (data.success && data.planos && data.planos.length > 0) {
      listaContratos.innerHTML = `
        <div class="overflow-x-auto">
          <table class="table table-xs w-full">
            <thead class="text-white rounded-lg" style="background-color: #72cd80;">
              <tr>
                <th class="rounded-tl-lg">Tipo</th>
                <th>Status</th>
                <th>Tokens</th>
                <th>Imagens</th>
                <th>Usuários</th>
                <th class="rounded-tr-lg">Validade</th>
              </tr>
            </thead>
            <tbody>
              ${data.planos.map(p => `
                <tr class="hover">
                  <td class="font-semibold">${p.plan_type || '—'}</td>
                  <td>
                    <button type="button"
                            class="badge badge-xs cursor-pointer transition-all hover:scale-105"
                            style="${p.plan_status === 'active' ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : p.plan_status === 'suspended' ? 'background-color: #fbbf24; color: white; border-color: #fbbf24;' : 'background-color: #ef4444; color: white; border-color: #ef4444;'}"
                            onclick="togglePlanoStatus(${p.id}, this, '${p.plan_status}')"
                            title="Clique para ${p.plan_status === 'active' ? 'cancelar' : 'ativar'}">
                      ${p.plan_status === 'active' ? 'Ativo' : p.plan_status === 'suspended' ? 'Suspenso' : 'Cancelado'}
                    </button>
                  </td>
                  <td>
                    <div class="text-xs">
                      ${(p.tokens_used_current_month || 0).toLocaleString()} / ${(p.tokens_monthly_limit || 0).toLocaleString()}
                    </div>
                    <div class="text-xs text-base-content/60">${p.tokens_usage_percentage || 0}%</div>
                  </td>
                  <td>
                    <div class="text-xs">
                      ${p.image_credits_used_current_month || 0} / ${p.image_credits_monthly || 0}
                    </div>
                    <div class="text-xs text-base-content/60">${p.images_usage_percentage || 0}%</div>
                  </td>
                  <td>${p.max_users || '—'}</td>
                  <td class="text-xs">${p.valid_until ? new Date(p.valid_until).toLocaleDateString('pt-BR') : '—'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    } else {
      listaContratos.innerHTML = '<p class="text-center text-base-content/60 text-sm py-4">Nenhum contrato encontrado</p>';
    }
  } catch (error) {
    console.error('Erro ao carregar contratos:', error);
    listaContratos.innerHTML = '<p class="text-center text-error text-sm py-4">Erro ao carregar contratos</p>';
  }
}

// Função para toggle de status de plano
async function togglePlanoStatus(planoId, badgeElement, statusAtual) {
  try {
    const response = await fetch(`/api/plano/${planoId}/toggle-status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const data = await response.json();
      const novoStatus = data.novo_status;
      
      // Atualizar o badge
      badgeElement.textContent = novoStatus === 'active' ? 'Ativo' : novoStatus === 'suspended' ? 'Suspenso' : 'Cancelado';
      badgeElement.className = 'badge badge-xs cursor-pointer transition-all hover:scale-105';
      
      if (novoStatus === 'active') {
        badgeElement.style = 'background-color: #72cd80; color: white; border-color: #72cd80;';
        badgeElement.title = 'Clique para cancelar';
      } else if (novoStatus === 'suspended') {
        badgeElement.style = 'background-color: #fbbf24; color: white; border-color: #fbbf24;';
        badgeElement.title = 'Clique para ativar';
      } else {
        badgeElement.style = 'background-color: #ef4444; color: white; border-color: #ef4444;';
        badgeElement.title = 'Clique para ativar';
      }
      
      badgeElement.setAttribute('onclick', `togglePlanoStatus(${planoId}, this, '${novoStatus}')`);
    } else {
      showToast('Erro ao alterar status do plano.', 'error');
    }
  } catch (error) {
    console.error('Erro ao alterar status do plano:', error);
    showToast('Erro ao alterar status do plano.', 'error');
  }
}

// Função para criar plano beta tester da aba
function criarPlanoBetaTesterAba() {
  const clienteId = document.getElementById('cliente_id').value;
  if (clienteId) {
    criarPlanoBetaTester(clienteId);
  }
}

// Função para abrir modal de novo contato
function abrirModalNovoContato() {
  const clienteId = document.getElementById('cliente_id').value;
  if (clienteId) {
    // Resetar formulário
    document.getElementById('form_contato').reset();
    document.getElementById('contato_id').value = '';
    document.getElementById('contato_cliente_id').value = clienteId;
    
    // Atualizar título e botão
    document.getElementById('contato_modal_title').textContent = 'Novo Contato';
    document.getElementById('contato_btn_text').textContent = 'Criar Contato';
    
    // Tornar senha obrigatória
    document.getElementById('contato_senha').required = true;
    document.getElementById('contato_senha').placeholder = 'Mín. 6 caracteres';
    document.getElementById('senha_label').innerHTML = 'Senha <span class="text-error">*</span>';
    
    // Limpar select de cargos
    const cargoSelect = document.getElementById('contato_cargo');
    cargoSelect.innerHTML = '<option value="">Selecione setor</option>';
    
    // Abrir modal
    modal_contato.showModal();
  }
}

// Função para abrir modal de editar contato
async function abrirModalEditarContato(contatoId) {
  try {
    // Buscar dados do contato
    const response = await fetch(`/api/contato/${contatoId}`);
    if (!response.ok) throw new Error('Erro ao buscar dados do contato');
    
    const contato = await response.json();
    
    console.log('Dados do contato:', contato); // Debug
    
    // Preencher formulário
    document.getElementById('contato_id').value = contato.id_contato_cliente;
    document.getElementById('contato_cliente_id').value = contato.pk_id_tbl_cliente;
    document.getElementById('contato_nome_completo').value = contato.nome_completo;
    document.getElementById('contato_email').value = contato.email;
    document.getElementById('contato_telefone').value = contato.telefone || '';
    document.getElementById('contato_cohorts').value = contato.cohorts || 1;
    document.getElementById('contato_user_type').value = contato.user_type || 'client';
    
    // Setor e cargo
    const setorId = contato.pk_id_tbl_setor;
    if (setorId) {
      document.getElementById('contato_setor').value = setorId;
      // Carregar cargos do setor e depois selecionar o cargo
      await carregarCargosPorSetor(setorId);
      document.getElementById('contato_cargo').value = contato.pk_id_tbl_cargo || '';
    }
    
    // Atualizar título e botão
    document.getElementById('contato_modal_title').textContent = 'Editar Contato';
    document.getElementById('contato_btn_text').textContent = 'Atualizar Contato';
    
    // Tornar senha opcional na edição
    document.getElementById('contato_senha').required = false;
    document.getElementById('contato_senha').value = '';
    document.getElementById('contato_senha').placeholder = 'Deixe em branco para manter';
    document.getElementById('senha_label').innerHTML = 'Nova Senha';
    
    // Abrir modal
    modal_contato.showModal();
    
  } catch (error) {
    console.error('Erro ao carregar contato:', error);
    showToast('Erro ao carregar dados do contato!', 'error');
  }
}

// Função para carregar cargos por setor
async function carregarCargosPorSetor(setorId) {
  const cargoSelect = document.getElementById('contato_cargo');
  
  if (!setorId) {
    cargoSelect.innerHTML = '<option value="">Selecione primeiro o setor</option>';
    return;
  }
  
  try {
    const response = await fetch(`/api/setor/${setorId}/cargos`);
    if (!response.ok) throw new Error('Erro ao buscar cargos');
    
    const cargos = await response.json();
    
    cargoSelect.innerHTML = '<option value="">Selecione o cargo</option>';
    cargos.forEach(cargo => {
      const option = document.createElement('option');
      option.value = cargo.id_cargo_contato;
      option.textContent = cargo.descricao;
      cargoSelect.appendChild(option);
    });
    
  } catch (error) {
    console.error('Erro ao carregar cargos:', error);
    cargoSelect.innerHTML = '<option value="">Erro ao carregar cargos</option>';
  }
}

// Handler para submit do formulário de contato
document.addEventListener('DOMContentLoaded', function() {
  const formContato = document.getElementById('form_contato');
  
  // Máscara de telefone para contato
  const telefoneInput = document.getElementById('contato_telefone');
  if (telefoneInput) {
    telefoneInput.addEventListener('keydown', function(e) {
      // Permitir backspace, delete, tab, escape, enter, setas
      if ([8, 9, 27, 13, 46, 37, 38, 39, 40].includes(e.keyCode) ||
          // Permitir Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
          (e.keyCode === 65 && e.ctrlKey) ||
          (e.keyCode === 67 && e.ctrlKey) ||
          (e.keyCode === 86 && e.ctrlKey) ||
          (e.keyCode === 88 && e.ctrlKey)) {
        return;
      }
      // Bloquear se não for número
      if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
        e.preventDefault();
      }
    });
    
    telefoneInput.addEventListener('input', function(e) {
      let cursorPos = e.target.selectionStart;
      let oldValue = e.target.value;
      let value = oldValue.replace(/\D/g, '');
      
      if (value.length > 11) value = value.slice(0, 11);
      
      let formatted = '';
      if (value.length > 0) {
        formatted = '(' + value.substring(0, 2);
      }
      if (value.length >= 2) {
        formatted += ') ' + value.substring(2, 7);
      }
      if (value.length >= 7) {
        formatted += '-' + value.substring(7, 11);
      }
      
      // Só atualiza se o valor mudou
      if (e.target.value !== formatted) {
        e.target.value = formatted;
        
        // Ajustar posição do cursor após formatação
        let newCursorPos = cursorPos;
        if (cursorPos === 1 && formatted.length > 0) newCursorPos = 1;
        else if (cursorPos <= 3 && value.length >= 2) newCursorPos = Math.min(cursorPos + 1, formatted.length);
        else if (cursorPos <= 10 && value.length >= 7) newCursorPos = Math.min(cursorPos, formatted.length);
        
        e.target.setSelectionRange(newCursorPos, newCursorPos);
      }
    });
  }
  
  if (formContato) {
    formContato.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const contatoId = document.getElementById('contato_id').value;
      const clienteId = document.getElementById('contato_cliente_id').value;
      
      // Validar senha no modo criação
      const senha = document.getElementById('contato_senha').value;
      if (!contatoId && senha.length < 6) {
        showToast('A senha deve ter no mínimo 6 caracteres!', 'warning');
        return;
      }
      
      // Preparar dados
      const formData = new FormData(formContato);
      const data = {
        nome_completo: formData.get('nome_completo'),
        email: formData.get('email'),
        telefone: formData.get('telefone'),
        pk_id_aux_setor: parseInt(formData.get('pk_id_aux_setor')),
        pk_id_tbl_cargo: parseInt(formData.get('pk_id_tbl_cargo')),
        cohorts: 1,  // Valor fixo
        user_type: formData.get('user_type')
      };
      
      // Adicionar senha apenas se preenchida
      if (senha) {
        if (contatoId) {
          data.nova_senha = senha;
        } else {
          data.senha = senha;
        }
      }
      
      try {
        let response;
        if (contatoId) {
          // Editar contato existente
          response = await fetch(`/api/contato/${contatoId}/editar`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        } else {
          // Criar novo contato
          response = await fetch(`/api/cliente/${clienteId}/criar-contato`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
        }
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          modal_contato.close();
          
          // Recarregar lista de contatos se estiver na aba de contatos
          if (document.getElementById('contatos_aba_content').style.display !== 'none') {
            await carregarContatosAba(clienteId);
          }
        } else {
          showToast(result.message || 'Erro ao salvar contato!', 'error');
        }
        
      } catch (error) {
        console.error('Erro ao salvar contato:', error);
        showToast('Erro ao salvar contato!', 'error');
      }
    });
  }
});

// Função para alternar status do contato
async function toggleContatoStatus(contatoId, clienteId, badgeElement, statusAtual) {
  try {
    const response = await fetch(`/api/contato/${contatoId}/toggle-status`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      const novoStatus = !statusAtual;
      
      // Atualizar o badge
      badgeElement.textContent = novoStatus ? 'Ativo' : 'Inativo';
      badgeElement.className = 'badge badge-xs cursor-pointer transition-all hover:scale-105';
      badgeElement.style = novoStatus ? 'background-color: #72cd80; color: white; border-color: #72cd80;' : 'background-color: #ef4444; color: white; border-color: #ef4444;';
      badgeElement.title = `Clique para ${novoStatus ? 'desativar' : 'ativar'}`;
      badgeElement.setAttribute('onclick', `toggleContatoStatus(${contatoId}, ${clienteId}, this, ${novoStatus})`);
    } else {
      showToast(result.message || 'Erro ao alterar status!', 'error');
    }
    
  } catch (error) {
    console.error('Erro ao alterar status:', error);
    showToast('Erro ao alterar status do contato!', 'error');
  }
}

// Função para deletar contato
async function deletarContato(contatoId, clienteId, nomeContato) {
  if (!confirm(`Tem certeza que deseja deletar o contato "${nomeContato}"? Esta ação não pode ser desfeita!`)) return;
  
  try {
    const response = await fetch(`/api/contato/${contatoId}/deletar`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message, 'success');
      // Recarregar lista de contatos
      await carregarContatosAba(clienteId);
    } else {
      showToast(result.message || 'Erro ao deletar contato!', 'error');
    }
    
  } catch (error) {
    console.error('Erro ao deletar contato:', error);
    showToast('Erro ao deletar contato!', 'error');
  }
}

// Função para criar invite e enviar convite (marca contato com + LEG)
async function enviarEmailBoasVindas(contatoId, nomeContato, emailContato) {
  // Calcular novo nome e email com + LEG
  const novoNome = `${nomeContato} + LEG`;
  const emailParts = emailContato.split('@');
  const novoEmail = `${emailParts[0]}+LEG@${emailParts[1]}`;
  
  if (!confirm(`Deseja criar invite e enviar convite?\n\nO convite será enviado para: ${emailContato}\n\nO contato será alterado para:\nNome: ${novoNome}\nEmail: ${novoEmail}`)) return;
  
  try {
    const response = await fetch(`/api/contato/${contatoId}/criar-invite-boas-vindas`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message, 'success');
      // Recarregar dados do cliente para atualizar contatos na tabela
      const clienteId = document.getElementById('cliente_id').value;
      if (clienteId) {
        abrirModalEditar(parseInt(clienteId));
      }
    } else {
      showToast(result.message || 'Erro ao processar!', 'error');
    }
    
  } catch (error) {
    console.error('Erro ao criar invite:', error);
    showToast('Erro ao processar solicitação!', 'error');
  }
}

// Abrir modal automaticamente via URL params
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  const clienteId = urlParams.get('open');
  const tab = urlParams.get('tab');
  
  if (clienteId) {
    abrirModalEditar(parseInt(clienteId)).then(() => {
      if (tab === 'contratos') {
        // Aguardar modal abrir e clicar na aba contratos
        setTimeout(() => {
          const contratosTab = document.getElementById('tab_contratos');
          if (contratosTab) {
            contratosTab.click();
          }
        }, 500);
      }
    });
    
    // Limpar URL sem recarregar página
    window.history.replaceState({}, document.title, window.location.pathname);
  }
});

// ==================== FUNÇÕES DE INVITES ====================

async function carregarInvites() {
  const clienteId = document.getElementById('cliente_id').value;
  if (!clienteId) return;
  
  try {
    const response = await fetch(`/api/cliente/${clienteId}/invites`);
    const invites = await response.json();
    
    const container = document.getElementById('lista_invites_aba');
    
    if (!invites || invites.length === 0) {
      container.innerHTML = '<p class="text-sm text-base-content/60 text-center py-4">Sem invites.</p>';
      return;
    }
    
    let html = '<div class="overflow-x-auto"><table class="table table-xs w-full"><thead class="text-white rounded-lg" style="background-color: #72cd80;"><tr>';
    html += '<th class="rounded-tl-lg">Email</th><th>Role</th><th>Status</th><th>Enviado em</th><th>Expira em</th><th class="rounded-tr-lg">Ações</th>';
    html += '</tr></thead><tbody>';
    
    invites.forEach(invite => {
      let statusStyle = '';
      let statusText = '';
      
      if (invite.status === 'accepted') {
        statusStyle = 'background-color: #72cd80; color: white; border-color: #72cd80;';
        statusText = 'Aceito';
      } else if (invite.status === 'expired') {
        statusStyle = 'background-color: #ef4444; color: white; border-color: #ef4444;';
        statusText = 'Expirado';
      } else {
        statusStyle = 'background-color: #fbbf24; color: white; border-color: #fbbf24;';
        statusText = 'Pendente';
      }
      
      const createdAt = new Date(invite.created_at).toLocaleDateString('pt-BR');
      const expiresAt = new Date(invite.expires_at).toLocaleDateString('pt-BR');
      
      html += `<tr>
        <td>${invite.email}</td>
        <td><span class="badge badge-sm">${invite.role}</span></td>
        <td><span class="badge badge-sm" style="${statusStyle}">${statusText}</span></td>
        <td>${createdAt}</td>
        <td>${expiresAt}</td>
        <td>`;
      
      if (invite.status === 'pending') {
        html += `
          <button onclick="reenviarConvite(${invite.id})" class="btn btn-xs btn-ghost" title="Reenviar">
            <i class="fas fa-redo"></i>
          </button>
          <button onclick="cancelarConvite(${invite.id})" class="btn btn-xs btn-ghost text-error" title="Cancelar">
            <i class="fas fa-times"></i>
          </button>`;
      }
      
      html += '</td></tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Erro ao carregar invites:', error);
    document.getElementById('lista_invites_aba').innerHTML = 
      '<p class="text-sm text-base-content/60 text-center py-4">Sem invites.</p>';
  }
}

// Variável para controlar se email é válido para invite
let emailInviteValido = true;

async function verificarEmailInvite(input) {
  const email = input.value.trim().toLowerCase();
  const statusSpan = document.getElementById('invite_email_status');
  
  if (!email) {
    statusSpan.textContent = '';
    input.classList.remove('input-error', 'input-success');
    emailInviteValido = true;
    return;
  }
  
  if (!validateEmail(email)) {
    statusSpan.textContent = 'Email inválido';
    statusSpan.className = 'text-xs absolute -bottom-5 left-0 text-error';
    input.classList.add('input-error');
    input.classList.remove('input-success');
    emailInviteValido = false;
    return;
  }
  
  try {
    const response = await fetch('/api/verificar-email', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email })
    });
    
    const result = await response.json();
    
    if (result.existe) {
      statusSpan.textContent = 'Este email já está cadastrado no sistema';
      statusSpan.className = 'text-xs absolute -bottom-5 left-0 text-error';
      input.classList.add('input-error');
      input.classList.remove('input-success');
      emailInviteValido = false;
    } else {
      statusSpan.textContent = 'Email disponível';
      statusSpan.className = 'text-xs absolute -bottom-5 left-0 text-success';
      input.classList.add('input-success');
      input.classList.remove('input-error');
      emailInviteValido = true;
    }
  } catch (error) {
    console.error('Erro ao verificar email:', error);
    statusSpan.textContent = '';
    input.classList.remove('input-error', 'input-success');
    emailInviteValido = true;
  }
}

async function enviarConvite() {
  const clienteId = document.getElementById('cliente_id').value;
  const email = document.getElementById('invite_email').value.trim();
  const role = document.getElementById('invite_role').value;
  
  if (!clienteId) {
    showToast('Erro: Cliente não identificado.', 'error');
    return;
  }
  
  if (!email) {
    showToast('Por favor, digite um email válido.', 'warning');
    return;
  }
  
  // Verificar se email é válido antes de enviar
  if (!emailInviteValido) {
    showToast('Este email já está cadastrado no sistema!', 'error');
    return;
  }
  
  if (!validateEmail(email)) {
    showToast('Email inválido!', 'warning');
    return;
  }
  
  try {
    const response = await fetch(`/api/cliente/${clienteId}/invites`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, role })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message || 'Convite enviado com sucesso!', 'success');
      document.getElementById('invite_email').value = '';
      document.getElementById('invite_role').value = 'member';
      carregarInvites();
    } else {
      showToast(result.message || 'Erro ao enviar convite!', 'error');
    }
  } catch (error) {
    console.error('Erro ao enviar convite:', error);
    showToast('Erro ao enviar convite!', 'error');
  }
}

async function enviarConviteContato(email, nomeContato) {
  if (!confirm(`Enviar convite para ${nomeContato} (${email})?`)) return;
  
  const clienteId = document.getElementById('cliente_id').value;
  
  if (!clienteId) {
    showToast('Erro: Cliente não identificado.', 'error');
    return;
  }
  
  if (!email) {
    showToast('Erro: Email do contato não encontrado.', 'error');
    return;
  }
  
  try {
    const response = await fetch(`/api/cliente/${clienteId}/invites`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, role: 'member' })
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message || `Convite enviado para ${nomeContato}!`, 'success');
      carregarInvites();
    } else {
      showToast(result.message || 'Erro ao enviar convite!', 'error');
    }
  } catch (error) {
    console.error('Erro ao enviar convite:', error);
    showToast('Erro ao enviar convite!', 'error');
  }
}

async function reenviarConvite(inviteId) {
  if (!confirm('Deseja reenviar este convite?')) return;
  
  try {
    const response = await fetch(`/api/invites/${inviteId}/resend`, {
      method: 'POST'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message || 'Convite reenviado com sucesso!', 'success');
      carregarInvites();
    } else {
      showToast(result.message || 'Erro ao reenviar convite!', 'error');
    }
  } catch (error) {
    console.error('Erro ao reenviar convite:', error);
    showToast('Erro ao reenviar convite!', 'error');
  }
}

async function cancelarConvite(inviteId) {
  if (!confirm('Deseja cancelar este convite?')) return;
  
  try {
    const response = await fetch(`/api/invites/${inviteId}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.success) {
      showToast(result.message || 'Convite cancelado com sucesso!', 'success');
      carregarInvites();
    } else {
      showToast(result.message || 'Erro ao cancelar convite!', 'error');
    }
  } catch (error) {
    console.error('Erro ao cancelar convite:', error);
    showToast('Erro ao cancelar convite!', 'error');
  }
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

</script>

<!-- Modal de Busca de Cliente -->
{% include 'modal_busca_cliente.html' %}
{% endblock %}
