{% extends 'base_tailwind.html' %}

{% block title %}{% if contato %}Editar{% else %}Novo{% endif %} Contato - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-base-100 rounded-xl shadow-lg p-4">
  <div class="mb-3">
    <h2 class="text-lg font-semibold">{% if contato %}Editar Contato{% else %}Novo Contato{% endif %}</h2>
    <p class="text-base-content/70 text-sm">Preencha os dados abaixo para {% if contato %}editar{% else %}cadastrar{% endif %} um contato.</p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %} text-sm">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="POST" autocomplete="off" class="space-y-2">
    <!-- Informações Pessoais -->
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Nome Completo <span class="text-error">*</span></span>
      </label>
      <input 
        type="text" 
        name="nome_completo" 
        value="{{ contato.nome_completo if contato else '' }}"
        class="input input-bordered w-full" 
        required
        placeholder="Digite o nome completo"
        autocomplete="off"
      >
    </div>

    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Email <span class="text-error">*</span></span>
      </label>
      <input 
        type="email" 
        name="email" 
        value="{{ contato.email if contato else '' }}"
        class="input input-bordered w-full" 
        required
        placeholder="exemplo@email.com"
        autocomplete="off"
      >
      <label class="label">
        <span class="label-text-alt text-base-content/60">Será usado para login</span>
      </label>
    </div>

    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Telefone</span>
      </label>
      <input 
        type="tel" 
        name="telefone" 
        id="telefone"
        value="{{ contato.telefone if contato else '' }}"
        class="input input-bordered w-full" 
        placeholder="(00) 00000-0000"
        maxlength="15"
        autocomplete="off"
      >
    </div>

    <div class="divider text-sm">Organização</div>

    <!-- Setor -->
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Setor <span class="text-error">*</span></span>
      </label>
      <select 
        name="pk_id_aux_setor" 
        id="setor_select"
        class="select select-bordered w-full"
        required
      >
        <option value="">Selecione um setor</option>
        {% for setor in setores %}
          <option value="{{ setor.id_setor }}" 
            {% if contato and contato.pk_id_aux_setor == setor.id_setor %}selected{% endif %}>
            {{ setor.descricao }}
          </option>
        {% endfor %}
      </select>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Selecione o setor primeiro</span>
      </label>
    </div>

    <!-- Cargo -->
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Cargo <span class="text-error">*</span></span>
      </label>
      <select 
        name="pk_id_tbl_cargo" 
        id="cargo_select"
        class="select select-bordered w-full"
        required
      >
        <option value="">Selecione um cargo</option>
        {% for cargo in cargos %}
          <option value="{{ cargo.id_cargo_contato }}" 
            data-setor="{{ cargo.pk_id_aux_setor }}"
            {% if contato and contato.pk_id_tbl_cargo == cargo.id_cargo_contato %}selected{% endif %}>
            {{ cargo.descricao }}
          </option>
        {% endfor %}
      </select>
      <label class="label">
        <span class="label-text-alt text-base-content/60">Depende do setor selecionado</span>
      </label>
    </div>

    <div class="divider text-sm">Cliente</div>

    <!-- Cliente -->
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Cliente <span class="text-error">*</span></span>
      </label>
      <select 
        name="pk_id_cliente" 
        id="cliente_select"
        class="select select-bordered w-full"
        required
      >
        <option value="">Selecione um cliente</option>
        {% for cliente in clientes %}
          <option value="{{ cliente.id_cliente }}" 
            {% if (contato and contato.pk_id_tbl_cliente == cliente.id_cliente) or (request.args.get('cliente_id')|int == cliente.id_cliente) %}selected{% endif %}>
            {{ cliente.nome_fantasia or cliente.razao_social }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="divider text-sm">Acesso</div>

    <!-- Senha (apenas para novo contato) -->
    {% if not contato %}
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Senha <span class="text-error">*</span></span>
      </label>
      <input 
        type="password" 
        name="senha" 
        class="input input-bordered w-full" 
        required
        placeholder="Digite a senha"
        minlength="6"
        autocomplete="new-password"
      >
      <label class="label">
        <span class="label-text-alt text-base-content/60">Mínimo de 6 caracteres</span>
      </label>
    </div>
    {% else %}
    <!-- Nova Senha (opcional para edição) -->
    <div class="form-control">
      <label class="label font-semibold text-sm">
        <span>Nova Senha (opcional)</span>
      </label>
      <input 
        type="password" 
        name="nova_senha" 
        class="input input-bordered w-full" 
        placeholder="Digite a nova senha"
        minlength="6"
        autocomplete="new-password"
      >
      <label class="label">
        <span class="label-text-alt text-base-content/60">Deixe em branco para manter a senha atual</span>
      </label>
    </div>
    {% endif %}

    <!-- Ações -->
    <div class="flex gap-2 pt-4">
      <button type="submit" class="btn btn-primary flex-1">
        <i class="fas fa-save mr-2"></i>
        {% if contato %}Atualizar{% else %}Cadastrar{% endif %}
      </button>
      <a href="{{ url_for('contatos') }}" class="btn btn-ghost">
        <i class="fas fa-times mr-2"></i>
        Cancelar
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Máscara de telefone
  const telefoneInput = document.getElementById('telefone');
  if (telefoneInput) {
    telefoneInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      
      if (value.length > 6) {
        value = value.replace(/^(\d{2})(\d{5})(\d{0,4}).*/, '($1) $2-$3');
      } else if (value.length > 2) {
        value = value.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
      } else if (value.length > 0) {
        value = value.replace(/^(\d*)/, '($1');
      }
      
      e.target.value = value;
    });
  }

  // Filtrar cargos por setor
  const setorSelect = document.getElementById('setor_select');
  const cargoSelect = document.getElementById('cargo_select');
  
  console.log('Setor select:', setorSelect);
  console.log('Cargo select:', cargoSelect);
  
  if (setorSelect && cargoSelect) {
    // Guardar todos os cargos
    const todasOpcoes = Array.from(cargoSelect.querySelectorAll('option[value]')).map(opt => ({
      value: opt.value,
      text: opt.textContent,
      setor: opt.getAttribute('data-setor')
    }));
    
    console.log('Total de cargos:', todasOpcoes.length);
    console.log('Cargos:', todasOpcoes);
    
    // Função para filtrar
    function atualizarCargos() {
      console.log('=== FUNÇÃO CHAMADA ===');
      const setorSelecionado = setorSelect.value;
      const cargoAtual = cargoSelect.value;
      
      console.log('Setor selecionado:', setorSelecionado);
      console.log('Cargo atual:', cargoAtual);
      
      // Limpar
      cargoSelect.innerHTML = '<option value="">Selecione um cargo</option>';
      
      if (setorSelecionado) {
        let cargosAdicionados = 0;
        
        // Adicionar cargos do setor
        todasOpcoes.forEach(cargo => {
          console.log('Comparando:', cargo.setor, '===', setorSelecionado, '?', cargo.setor === setorSelecionado);
          if (cargo.setor === setorSelecionado) {
            const opt = document.createElement('option');
            opt.value = cargo.value;
            opt.textContent = cargo.text;
            opt.setAttribute('data-setor', cargo.setor);
            cargoSelect.appendChild(opt);
            cargosAdicionados++;
          }
        });
        
        console.log('Cargos adicionados:', cargosAdicionados);
        
        // Habilitar
        cargoSelect.disabled = false;
        
        // Tentar restaurar valor
        if (cargoAtual) {
          cargoSelect.value = cargoAtual;
        }
      } else {
        cargoSelect.disabled = true;
      }
      
      console.log('Estado final - disabled:', cargoSelect.disabled, 'options:', cargoSelect.options.length);
    }
    
    // Listener
    console.log('Adicionando listener...');
    setorSelect.addEventListener('change', function(e) {
      console.log('*** EVENTO CHANGE DISPARADO ***');
      console.log('e.target.value:', e.target.value);
      console.log('setorSelect.value:', setorSelect.value);
      console.log('selectedIndex:', setorSelect.selectedIndex);
      console.log('selected option:', setorSelect.options[setorSelect.selectedIndex]);
      
      // Usar setTimeout para garantir que o DOM foi atualizado
      setTimeout(function() {
        console.log('=== APÓS TIMEOUT ===');
        console.log('setorSelect.value:', setorSelect.value);
        atualizarCargos();
      }, 10);
    });
    
    // Inicializar
    console.log('Valor inicial do setor:', setorSelect.value);
    if (setorSelect.value) {
      atualizarCargos();
    } else {
      cargoSelect.disabled = true;
    }
  } else {
    console.error('Elementos não encontrados!');
  }
});
</script>
{% endblock %}
