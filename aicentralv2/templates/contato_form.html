<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if contato %}Editar{% else %}Novo{% endif %} Contato - CentralComm AI</title>
</head>
<body>
    {% extends 'base_tailwind.html' %}

    {% block title %}{% if contato %}Editar{% else %}Novo{% endif %} Contato - CentralComm AI{% endblock %}

    {% block content %}
    <div class="p-6">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold text-text-primary flex items-center">
                    <i class="fas fa-user text-primary mr-3"></i>
                    {% if contato %}Editar Contato{% else %}Novo Contato{% endif %}
                </h1>
                <div class="flex gap-3">
                    <a href="{{ url_for('contatos') }}" class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 shadow-md">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar
                    </a>
                </div>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-6 space-y-2">
                    {% for category, message in messages %}
                        <div class="flex items-center p-4 rounded-lg shadow-md {% if category == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} mr-3"></i>
                            <span class="flex-1">{{ message }}</span>
                            <button onclick="closeFlashMessage(this)" class="ml-4 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <form method="POST" autocomplete="off">
                <!-- Nome Completo -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-2 text-gray-500"></i>
                        Nome Completo
                        <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        name="nome_completo" 
                        id="nome_completo"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        value="{{ contato.nome_completo if contato else '' }}"
                        required
                        placeholder="Ex: João Silva"
                        autocomplete="off"
                        data-form-type="other"
                    >
                </div>

                <!-- Email -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2 text-gray-500"></i>
                        Email
                        <span class="text-red-500">*</span>
                    </label>
                    <!-- Campos falsos para desarmar autofill (mantidos fora de visão, não display:none) -->
                    <input type="text" name="email_fake" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                    <input type="password" name="password_fake" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                    <input 
                        type="email" 
                        name="email" 
                        id="email"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        value="{{ contato.email if contato else '' }}"
                        required
                        placeholder="exemplo@email.com"
                        autocomplete="nope"
                        data-form-type="other"
                        data-new-email="true"
                    >
                    <p class="mt-1 text-sm text-gray-500">Será usado para login</p>
                </div>

                <!-- Telefone -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-phone mr-2 text-gray-500"></i>
                        Telefone
                    </label>
                    <input 
                        type="tel" 
                        name="telefone" 
                        id="telefone"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        value="{{ contato.telefone if contato else '' }}"
                        placeholder="(00) 00000-0000"
                        maxlength="15"
                        autocomplete="nope"
                        data-form-type="other"
                    >
                    <p class="mt-1 text-sm text-gray-500">Opcional</p>
                </div>

                <!-- Setor -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-sitemap mr-2 text-gray-500"></i>
                        Setor
                        <span class="text-red-500">*</span>
                    </label>
                    <select 
                        name="pk_id_aux_setor" 
                        id="setor_select"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        required
                    >
                        <option value="">Selecione um setor...</option>
                        {% for setor in setores %}
                            <option value="{{ setor.id_aux_setor }}" 
                                {% if contato and contato.pk_id_aux_setor == setor.id_aux_setor %}selected{% endif %}
                                data-setor-id="{{ setor.id_setor }}">
                                {{ setor.descricao }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Obrigatório</p>
                </div>

                <!-- Cargo -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-briefcase mr-2 text-gray-500"></i>
                        Cargo
                        <span class="text-red-500">*</span>
                    </label>
                    <select 
                        name="pk_id_tbl_cargo" 
                        id="cargo_select"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        required
                        disabled
                    >
                        <option value="">Selecione um cargo...</option>
                        {% for cargo in cargos %}
                            <option value="{{ cargo.id_cargo_contato }}" 
                                data-setor-id="{{ cargo.pk_id_aux_setor }}"
                                {% if contato and contato.pk_id_tbl_cargo == cargo.id_cargo_contato %}selected{% endif %}>
                                {{ cargo.descricao }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Obrigatório</p>
                </div>

                <!-- Cohorts -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group mr-2 text-gray-500"></i>
                        Cohorts
                    </label>
                    <input 
                        type="number" 
                        name="cohorts" 
                        id="cohorts"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        value="{{ contato.cohorts if contato else 1 }}"
                        min="1"
                        placeholder="Valor do cohort"
                    >
                    <p class="mt-1 text-sm text-gray-500">Nível de agrupamento do contato</p>
                </div>

                <!-- Cliente -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building mr-2 text-gray-500"></i>
                        Cliente
                        <span class="text-red-500">*</span>
                    </label>
                    <select 
                        name="pk_id_tbl_cliente" 
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50"
                        required
                    >
                        <option value="">Selecione um cliente...</option>
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id_cliente }}" 
                                {% if contato and contato.pk_id_tbl_cliente == cliente.id_cliente %}selected{% endif %}>
                                {{ cliente.nome_fantasia }} ({{ cliente.razao_social }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Senha (apenas para novo) -->
                {% if not contato %}
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2 text-gray-500"></i>
                        Senha
                        <span class="text-red-500">*</span>
                    </label>
                    <div class="relative">
                        <!-- Campo fake para desarmar gerenciadores de senha/autofill (fora de visão) -->
                        <input type="password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                        <!-- Campo REAL enviado no POST (fora de visão) -->
                        <input type="password" id="senha_real" name="senha" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
                        <!-- Campo VISÍVEL utilizado pelo usuário (como texto, mascarado por CSS) -->
                        <input 
                            type="text" 
                            name="senha_visible" 
                            id="senha_visible"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 pr-10"
                            required
                            minlength="6"
                            placeholder="Mínimo 6 caracteres"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            data-form-type="other"
                            data-lpignore="true"
                            data-1p-ignore
                            style="-webkit-text-security: disc;"
                        >
                        <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer hover:text-gray-700"></i>
                    </div>
                    <p class="mt-1 text-sm text-gray-500">Mínimo 6 caracteres</p>
                </div>
                {% endif %}

                <!-- Nova Senha (apenas para editar) -->
                {% if contato %}
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2 text-gray-500"></i>
                        Nova Senha
                    </label>
                    <div class="relative">
                        <!-- Campo fake para desarmar gerenciadores de senha/autofill (fora de visão) -->
                        <input type="password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                        <!-- Campo REAL enviado no POST (fora de visão) -->
                        <input type="password" id="nova_senha_real" name="nova_senha" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
                        <!-- Campo VISÍVEL utilizado pelo usuário (como texto, mascarado por CSS) -->
                        <input 
                            type="text" 
                            name="nova_senha_visible" 
                            id="nova_senha_visible"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 pr-10"
                            minlength="6"
                            placeholder="Deixe vazio para manter a senha atual"
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            data-form-type="other"
                            data-lpignore="true"
                            data-1p-ignore
                            style="-webkit-text-security: disc;"
                        >
                        <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer hover:text-gray-700"></i>
                    </div>
                    <p class="mt-1 text-sm text-gray-500">Deixe vazio para não alterar</p>
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="flex justify-end space-x-4 mt-8">
                    <a href="{{ url_for('contatos') }}" class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 shadow-md">
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                    <button type="submit" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors duration-200 shadow-md">
                        <i class="fas fa-save mr-2"></i>
                        {% if contato %}Atualizar{% else %}Cadastrar{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script src="{{ url_for('static', filename='js/contato_form.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tbl_cargo_contato.js') }}"></script>
    {% endblock %}