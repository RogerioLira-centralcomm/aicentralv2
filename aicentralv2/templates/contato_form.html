{% extends 'base_tailwind.html' %}

{% block title %}{% if contato %}Editar{% else %}Novo{% endif %} Contato - CentralComm AI{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="bg-white border-b border-gray-200 sticky top-0 z-30">
  <div class="px-6 py-4">
    <!-- Breadcrumb -->
    <nav class="flex items-center text-sm text-gray-500 mb-3">
      <a href="{{ url_for('index') }}" class="hover:text-primary transition-colors">
        <i class="fas fa-home"></i>
      </a>
      <i class="fas fa-chevron-right mx-2 text-xs"></i>
      <a href="{{ url_for('contatos') }}" class="hover:text-primary transition-colors">Contatos</a>
      <i class="fas fa-chevron-right mx-2 text-xs"></i>
      <span class="text-gray-900 font-medium">{% if contato %}Editar{% else %}Novo{% endif %}</span>
    </nav>
    
    <!-- Title & Actions -->
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent-green to-accent-yellow flex items-center justify-center shadow-sm">
          <i class="fas fa-{% if contato %}user-edit{% else %}user-plus{% endif %} text-primary-dark text-lg"></i>
        </div>
        <div>
          <h1 class="text-xl font-semibold text-gray-900">{% if contato %}Editar Contato{% else %}Novo Contato{% endif %}</h1>
          <p class="text-sm text-gray-500 mt-0.5">{% if contato %}Atualize as informações do contato{% else %}Cadastre um novo contato no sistema{% endif %}</p>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="flex items-center space-x-2">
        <a href="{{ url_for('contatos') }}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
          <i class="fas fa-arrow-left mr-2 text-xs"></i>
          Voltar
        </a>
      </div>
    </div>
  </div>
</div>

<div class="p-6">
<!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for category, message in messages %}
                    <div class="flex items-center p-3 rounded-lg shadow-sm animate-slide-up {% if category == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                        <div class="flex-shrink-0">
                            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
                        </div>
                        <span class="flex-1 ml-3 text-sm font-medium">{{ message }}</span>
                        <button onclick="closeFlashMessage(this)" class="ml-4 text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="fas fa-times text-sm"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Form Container -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <!-- Form Header -->
        <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Informações do Contato</h2>
                    <p class="text-sm text-gray-500 mt-1">Preencha todos os campos obrigatórios marcados com *</p>
                </div>
                <div class="flex items-center space-x-2 text-sm text-gray-500">
                    <i class="fas fa-info-circle"></i>
                    <span>Campos com * são obrigatórios</span>
                </div>
            </div>
        </div>
        
                <!-- Form Content -->\n        <div class=\"p-6\">\n            <form method=\"POST\" autocomplete=\"off\">\n                <!-- Seção: Informações Pessoais -->\n                <div class=\"mb-8\">\n                    <h3 class=\"text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200 flex items-center\">\n                        <i class=\"fas fa-user-circle mr-2 text-primary\"></i>\n                        Informações Pessoais\n                    </h3>\n                    \n                    <div class=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        <!-- Nome Completo -->\n                        <div class=\"md:col-span-2\">\n                            <label class=\"block text-sm font-medium text-gray-700 mb-2\">\n                                <i class=\"fas fa-user mr-2 text-gray-500\"></i>\n                                Nome Completo\n                                <span class=\"text-red-500\">*</span>\n                            </label>\n                            <input \n                                type=\"text\" \n                                name=\"nome_completo\" \n                                id=\"nome_completo\"\n                                class=\"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all\"\n                                value=\"{{ contato.nome_completo if contato else '' }}\"\n                                required\n                                placeholder=\"Ex: João Silva\"\n                                autocomplete=\"off\"\n                                data-form-type=\"other\"\n                            >\n                        </div>\n\n                        <!-- Email -->\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-2\">\n                                <i class=\"fas fa-envelope mr-2 text-gray-500\"></i>\n                                Email\n                                <span class=\"text-red-500\">*</span>\n                            </label>\n                            <!-- Campos falsos para desarmar autofill -->\n                            <input type=\"text\" name=\"email_fake\" tabindex=\"-1\" aria-hidden=\"true\" style=\"position:absolute;left:-9999px;width:1px;height:1px;opacity:0;\" />\n                            <input type=\"password\" name=\"password_fake\" tabindex=\"-1\" aria-hidden=\"true\" style=\"position:absolute;left:-9999px;width:1px;height:1px;opacity:0;\" />\n                            <input \n                                type=\"email\" \n                                name=\"email\" \n                                id=\"email\"\n                                class=\"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all\"\n                                value=\"{{ contato.email if contato else '' }}\"\n                                required\n                                placeholder=\"exemplo@email.com\"\n                                autocomplete=\"nope\"\n                                data-form-type=\"other\"\n                                data-new-email=\"true\"\n                            >\n                            <p class=\"mt-1 text-xs text-gray-500\"><i class=\"fas fa-info-circle mr-1\"></i>Será usado para login</p>\n                        </div>\n\n                        <!-- Telefone -->\n                        <div>\n                            <label class=\"block text-sm font-medium text-gray-700 mb-2\">\n                                <i class=\"fas fa-phone mr-2 text-gray-500\"></i>\n                                Telefone\n                            </label>\n                            <input \n                                type=\"tel\" \n                                name=\"telefone\" \n                                id=\"telefone\"\n                                class=\"mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all\"\n                                value=\"{{ contato.telefone if contato else '' }}\"\n                                placeholder=\"(00) 00000-0000\"\n                                maxlength=\"15\"\n                                autocomplete=\"nope\"\n                                data-form-type=\"other\"\n                            >\n                            <p class=\"mt-1 text-xs text-gray-500\"><i class=\"fas fa-info-circle mr-1\"></i>Opcional</p>\n                        </div>\n                    </div>\n                </div>

                                <!-- Seção: Organização -->
                <div class="mb-8">
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200 flex items-center">
                        <i class="fas fa-sitemap mr-2 text-primary"></i>
                        Organização
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Setor -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-sitemap mr-2 text-gray-500"></i>
                                Setor
                                <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="pk_id_aux_setor" 
                                id="setor_select"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all"
                                required
                            >
                                <option value="">Selecione um setor...</option>
                                {% for setor in setores %}
                                    <option value="{{ setor.id_aux_setor }}" 
                                        {% if contato and contato.pk_id_aux_setor == setor.id_aux_setor %}selected{% endif %}>
                                        {{ setor.descricao }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Selecione o setor primeiro</p>
                        </div>

                        <!-- Cargo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-briefcase mr-2 text-gray-500"></i>
                                Cargo
                                <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="pk_id_tbl_cargo" 
                                id="cargo_select"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all disabled:bg-gray-100 disabled:cursor-not-allowed"
                                required
                                disabled
                            >
                                <option value="">Selecione um cargo...</option>
                                {% for cargo in cargos %}
                                    <option value="{{ cargo.id_cargo_contato }}" 
                                        data-setor-id="{{ cargo.pk_id_aux_setor }}"
                                        {% if contato and contato.pk_id_tbl_cargo == cargo.id_cargo_contato %}selected{% endif %}>
                                        {{ cargo.descricao }}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Depende do setor selecionado</p>
                        </div>

                        <!-- Cohorts -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-layer-group mr-2 text-gray-500"></i>
                                Cohorts
                            </label>
                            <input 
                                type="number" 
                                name="cohorts" 
                                id="cohorts"
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all"
                                value="{{ contato.cohorts if contato else 1 }}"
                                min="1"
                                placeholder="1"
                            >
                            <p class="mt-1 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Nível de agrupamento do contato</p>
                        </div>

                        <!-- Cliente -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-building mr-2 text-gray-500"></i>
                                Cliente
                                <span class="text-red-500">*</span>
                            </label>
                            <select 
                                name="pk_id_tbl_cliente" 
                                class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 transition-all"
                                required
                            >
                                <option value="">Selecione um cliente...</option>
                                {% for cliente in clientes %}
                                    <option value="{{ cliente.id_cliente }}" 
                                        {% if contato and contato.pk_id_tbl_cliente == cliente.id_cliente %}selected{% endif %}>
                                        {{ cliente.nome_fantasia }} ({{ cliente.razao_social }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Seção: Segurança -->
                <div class="mb-8">
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200 flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-primary"></i>
                        Segurança
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Senha (apenas para novo) -->
                        {% if not contato %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2 text-gray-500"></i>
                                Senha
                                <span class="text-red-500">*</span>
                            </label>
                            <div class="relative">
                                <!-- Campo fake para desarmar gerenciadores de senha/autofill (fora de visão) -->
                                <input type="password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                                <!-- Campo REAL enviado no POST (fora de visão) -->
                                <input type="password" id="senha_real" name="senha" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
                                <!-- Campo VISÍVEL utilizado pelo usuário (como texto, mascarado por CSS) -->
                                <input 
                                    type="text" 
                                    name="senha_visible" 
                                    id="senha_visible"
                                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 pr-10 transition-all"
                                    required
                                    minlength="6"
                                    placeholder="Mínimo 6 caracteres"
                                    autocomplete="off"
                                    autocapitalize="off"
                                    autocorrect="off"
                                    spellcheck="false"
                                    data-form-type="other"
                                    data-lpignore="true"
                                    data-1p-ignore
                                    style="-webkit-text-security: disc;"
                                >
                                <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer hover:text-gray-700 transition-colors"></i>
                            </div>
                            <p class="mt-1 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Mínimo 6 caracteres</p>
                        </div>
                        {% endif %}

                        <!-- Nova Senha (apenas para editar) -->
                        {% if contato %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-lock mr-2 text-gray-500"></i>
                                Nova Senha
                            </label>
                            <div class="relative">
                                <!-- Campo fake para desarmar gerenciadores de senha/autofill (fora de visão) -->
                                <input type="password" tabindex="-1" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" />
                                <!-- Campo REAL enviado no POST (fora de visão) -->
                                <input type="password" id="nova_senha_real" name="nova_senha" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">
                                <!-- Campo VISÍVEL utilizado pelo usuário (como texto, mascarado por CSS) -->
                                <input 
                                    type="text" 
                                    name="nova_senha_visible" 
                                    id="nova_senha_visible"
                                    class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-2 focus:ring-primary focus:ring-opacity-50 pr-10 transition-all"
                                    minlength="6"
                                    placeholder="Deixe vazio para manter a senha atual"
                                    autocomplete="off"
                                    autocapitalize="off"
                                    autocorrect="off"
                                    spellcheck="false"
                                    data-form-type="other"
                                    data-lpignore="true"
                                    data-1p-ignore
                                    style="-webkit-text-security: disc;"
                                >
                                <i class="fas fa-eye password-toggle absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 cursor-pointer hover:text-gray-700 transition-colors"></i>
                            </div>
                            <p class="mt-1 text-xs text-gray-500"><i class="fas fa-info-circle mr-1"></i>Deixe vazio para não alterar</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex items-center justify-between rounded-b-xl">
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-info-circle mr-2"></i>
                        Todos os campos marcados com * são obrigatórios
                    </div>
                    <div class="flex items-center space-x-3">
                        <a href="{{ url_for('contatos') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors shadow-sm">
                            <i class="fas fa-times mr-2 text-xs"></i>
                            Cancelar
                        </a>
                        <button type="submit" class="inline-flex items-center px-5 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary-dark transition-all shadow-sm hover:shadow-md">
                            <i class="fas fa-save mr-2 text-xs"></i>
                            {% if contato %}Atualizar Contato{% else %}Cadastrar Contato{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/contato_form.js') }}"></script>
<script src="{{ url_for('static', filename='js/tbl_cargo_contato.js') }}"></script>
{% endblock %}