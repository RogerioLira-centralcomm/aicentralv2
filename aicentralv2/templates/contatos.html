{% extends 'base_tailwind.html' %}

{% block title %}Contatos - CentralComm AI{% endblock %}

{% block content %}
<div class="p-6">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-2">
                {% for category, message in messages %}
                    <div class="flex items-center p-4 rounded-lg shadow-md {% if category == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                        <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} mr-3"></i>
                        <span class="flex-1">{{ message }}</span>
                        <button onclick="closeFlashMessage(this)" class="ml-4 text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-text-primary flex items-center">
                <i class="fas fa-users text-primary mr-3"></i>
                Contatos
            </h1>
            <div class="flex gap-3">
                <a href="{{ url_for('contato_novo') }}" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors duration-200 shadow-md">
                    <i class="fas fa-plus mr-2"></i>
                    Novo Contato
                </a>
                <a href="{{ url_for('index') }}" class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 shadow-md">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="bg-white rounded-lg shadow-card">
        {% if contatos %}
            <!-- Search Box and Filters -->
            <div class="p-4 border-b border-border">
                <div class="flex gap-4">
                    <!-- Search Input -->
                    <div class="relative flex-1">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input 
                            type="text" 
                            id="searchInput" 
                            class="w-full pl-10 pr-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                            placeholder="Pesquisar por Nome ou Email..."
                            autocomplete="off"
                        >
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-sm text-gray-500" id="searchResults"></span>
                    </div>
                    <!-- Status Filter -->
                    <div class="relative min-w-[200px]">
                        <select 
                            id="statusFilter" 
                            class="w-full pl-10 pr-4 py-2 border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent appearance-none bg-white"
                        >
                            <option value="todos">Todos os Status</option>
                            <option value="true">Ativos</option>
                            <option value="false">Inativos</option>
                        </select>
                        <i class="fas fa-filter absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <!-- Table Container -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                <div class="overflow-x-auto">
                    <table id="contatosTable" class="w-full table-fixed">
                        <thead>
                            <tr class="bg-gray-50 border-b border-gray-200">
                                <th class="py-5 px-8 text-left w-[25%]">
                                    <div class="flex items-center space-x-2 text-sm font-semibold text-gray-600">
                                        <span>Nome</span>
                                        <button class="hover:bg-gray-200 p-1 rounded sort-btn" data-column="nome">
                                            <i class="fas fa-sort text-gray-400"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="py-5 px-8 text-left w-[35%]">
                                    <div class="flex items-center space-x-2 text-sm font-semibold text-gray-600">
                                        <span>Email</span>
                                        <button class="hover:bg-gray-200 p-1 rounded sort-btn" data-column="email">
                                            <i class="fas fa-sort text-gray-400"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="py-5 px-8 text-left w-[25%]">
                                    <div class="flex items-center space-x-2 text-sm font-semibold text-gray-600">
                                        <span>Cliente</span>
                                        <button class="hover:bg-gray-200 p-1 rounded sort-btn" data-column="cliente">
                                            <i class="fas fa-sort text-gray-400"></i>
                                        </button>
                                    </div>
                                </th>
                                <th class="py-5 px-8 text-center w-[15%]">
                                    <span class="text-sm font-semibold text-gray-600">Ações</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for contato in contatos %}
                            <tr class="group hover:bg-gray-50 transition-all duration-200 {% if loop.index is even %}bg-gray-50/30{% endif %}">
                                <td class="py-5 px-8 truncate">
                                    <div class="font-medium text-gray-900 truncate" title="{{ contato.nome_completo }}">{{ contato.nome_completo }}</div>
                                </td>
                                <td class="py-4 px-6 truncate">
                                    <a href="mailto:{{ contato.email }}" class="text-primary hover:text-primary-dark truncate block" title="{{ contato.email }}">
                                        {{ contato.email }}
                                    </a>
                                </td>
                                <td class="py-4 px-6 truncate">
                                    <span class="text-gray-800 truncate block" title="{{ contato.nome_fantasia }}">{{ contato.nome_fantasia }}</span>
                                </td>
                                <td class="py-4 px-6">
                                    <div class="flex items-center justify-center gap-3 opacity-80 group-hover:opacity-100 transition-opacity duration-200">
                                        <a href="{{ url_for('contato_editar', contato_id=contato.id_contato_cliente) }}" 
                                           class="relative group/edit">
                                            <div class="p-2 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all duration-200">
                                                <i class="fas fa-edit text-sm"></i>
                                            </div>
                                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover/edit:block">
                                                <div class="bg-gray-900 text-white text-xs rounded py-1 px-2 text-center whitespace-nowrap">
                                                    Editar contato
                                                </div>
                                            </div>
                                        </a>
                                        
                                        {% if contato.id_contato_cliente != session.user_id %}
                                        <form method="POST" 
                                              action="{{ url_for('contato_toggle_status', contato_id=contato.id_contato_cliente) }}" 
                                              class="inline-block">
                                            <div class="relative group/status">
                                                <button type="submit" 
                                                        class="p-2 rounded-lg {% if not contato.status %}bg-orange-50 text-orange-600 hover:bg-orange-100{% else %}bg-green-50 text-green-600 hover:bg-green-100{% endif %} transition-all duration-200">
                                                    <i class="fas fa-{% if not contato.status %}ban{% else %}check{% endif %} text-sm"></i>
                                                </button>
                                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover/status:block">
                                                    <div class="bg-gray-900 text-white text-xs rounded py-1 px-2 text-center whitespace-nowrap">
                                                        {% if not contato.status %}Ativar{% else %}Desativar{% endif %} contato
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        {% endif %}
                                        
                                        <form method="POST" 
                                              action="{{ url_for('contato_deletar', contato_id=contato.id_contato_cliente) }}" 
                                              class="inline-block"
                                              onsubmit="return confirm('Tem certeza que deseja deletar este contato?');">
                                            <div class="relative group/delete">
                                                <button type="submit" 
                                                        class="p-2 rounded-lg bg-red-50 text-red-600 hover:bg-red-100 transition-all duration-200 mr-2">
                                                    <i class="fas fa-trash text-sm"></i>
                                                </button>
                                                <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden group-hover/delete:block">
                                                    <div class="bg-gray-900 text-white text-xs rounded py-1 px-2 text-center whitespace-nowrap">
                                                        Deletar contato
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Table Footer with Pagination -->
                <div class="border-t border-gray-200 px-6 py-3 flex items-center justify-between bg-gray-50/50">
                    <div class="flex items-center text-sm text-gray-500">
                        <span>Mostrando <span id="showing-start">1</span>-<span id="showing-end">{{ contatos|length }}</span> de <span id="total-items">{{ contatos|length }}</span> resultados</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="prev-page" class="px-3 py-1 rounded border border-gray-300 text-gray-600 text-sm hover:bg-gray-50 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left mr-1"></i>
                            Anterior
                        </button>
                        <button id="next-page" class="px-3 py-1 rounded border border-gray-300 text-gray-600 text-sm hover:bg-gray-50 disabled:opacity-50" disabled>
                            Próximo
                            <i class="fas fa-chevron-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- No Results Message -->
            <div class="p-8 text-center hidden" id="noResults">
                <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                <p class="text-lg text-gray-600 mb-4">Nenhum contato encontrado com esse termo de pesquisa.</p>
                <button onclick="clearSearch()" class="inline-flex items-center px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200">
                    <i class="fas fa-times mr-2"></i>
                    Limpar Pesquisa
                </button>
            </div>
        {% else %}
            <div class="p-12 text-center">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-xl text-gray-600 mb-6">Nenhum contato cadastrado</p>
                <a href="{{ url_for('contato_novo') }}" class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors duration-200 shadow-md">
                    <i class="fas fa-plus mr-2"></i>
                    Cadastrar Primeiro Contato
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block sidebar %}
<div class="space-y-6">
    <!-- Estatísticas -->
    <div class="bg-gradient-to-br from-primary to-primary-light rounded-lg p-6 text-white shadow-lg">
        <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-chart-bar mr-2"></i>
            Estatísticas
        </h3>
        <div class="space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-sm opacity-90">Total de Contatos:</span>
                <span class="text-2xl font-bold">{{ contatos|length if contatos else 0 }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm opacity-90">Ativos:</span>
                <span class="text-xl font-semibold">{{ contatos|selectattr('status')|list|length if contatos else 0 }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm opacity-90">Inativos:</span>
                <span class="text-xl font-semibold">{{ contatos|rejectattr('status')|list|length if contatos else 0 }}</span>
            </div>
        </div>
    </div>

    <!-- Ações Rápidas -->
    <div class="bg-white rounded-lg p-6 shadow-md border border-border">
        <h3 class="text-lg font-semibold mb-4 text-text-primary flex items-center">
            <i class="fas fa-bolt mr-2 text-accent-yellow"></i>
            Ações Rápidas
        </h3>
        <div class="space-y-2">
            <a href="{{ url_for('contato_novo') }}" class="block w-full px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-light transition-colors duration-200 text-center">
                <i class="fas fa-plus mr-2"></i>
                Novo Contato
            </a>
            <a href="{{ url_for('clientes') }}" class="block w-full px-4 py-2 bg-gray-100 text-text-primary rounded-lg hover:bg-gray-200 transition-colors duration-200 text-center">
                <i class="fas fa-building mr-2"></i>
                Ver Clientes
            </a>
        </div>
    </div>

    <!-- Ajuda -->
    <div class="bg-blue-50 rounded-lg p-6 border border-blue-200">
        <h3 class="text-lg font-semibold mb-2 text-blue-900 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Dica
        </h3>
        <p class="text-sm text-blue-800">
            Use a barra de pesquisa para encontrar contatos rapidamente por nome ou email.
        </p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/contatos.js') }}"></script>
{% endblock %}