{% extends 'base_tailwind.html' %}
{% block title %}Pipeline CRM - CADU{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (max 66px) -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Título + Link -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Pipeline</h1>
        <a href="{{ url_for('cotacoes_list') }}" class="text-xs text-gray-500 hover:text-gray-700">
          <i class="fa-solid fa-table-list mr-1"></i>Tabela
        </a>
      </div>
      
      <!-- Filtros Inline -->
      <form id="filtros_form" class="flex items-center gap-3">
        <!-- Executivo -->
        <select name="executivo_id" id="filtro_executivo" onchange="aplicarFiltros()" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 160px;">
          <option value="">Todos executivos</option>
          {% for vendedor in vendedores %}
            <option value="{{ vendedor.id_contato_cliente }}" {% if filtros.get('executivo_id')|string == vendedor.id_contato_cliente|string %}selected{% endif %}>
              {{ vendedor.nome_completo }}
            </option>
          {% endfor %}
        </select>
        
        <!-- Mês -->
        <select name="mes" id="filtro_mes" onchange="aplicarFiltros()" 
                class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 120px;">
          <option value="">Todos meses</option>
          <option value="01" {% if filtros.get('mes') == '01' %}selected{% endif %}>Janeiro</option>
          <option value="02" {% if filtros.get('mes') == '02' %}selected{% endif %}>Fevereiro</option>
          <option value="03" {% if filtros.get('mes') == '03' %}selected{% endif %}>Março</option>
          <option value="04" {% if filtros.get('mes') == '04' %}selected{% endif %}>Abril</option>
          <option value="05" {% if filtros.get('mes') == '05' %}selected{% endif %}>Maio</option>
          <option value="06" {% if filtros.get('mes') == '06' %}selected{% endif %}>Junho</option>
          <option value="07" {% if filtros.get('mes') == '07' %}selected{% endif %}>Julho</option>
          <option value="08" {% if filtros.get('mes') == '08' %}selected{% endif %}>Agosto</option>
          <option value="09" {% if filtros.get('mes') == '09' %}selected{% endif %}>Setembro</option>
          <option value="10" {% if filtros.get('mes') == '10' %}selected{% endif %}>Outubro</option>
          <option value="11" {% if filtros.get('mes') == '11' %}selected{% endif %}>Novembro</option>
          <option value="12" {% if filtros.get('mes') == '12' %}selected{% endif %}>Dezembro</option>
        </select>
        
        <!-- Status Icons -->
        <div class="flex items-center gap-1 border-l border-gray-200 pl-3">
          {% set status_icons = [
            ('Rascunho', 'fa-file-pen', filtros.get('status') == 'Rascunho'),
            ('Em Análise', 'fa-magnifying-glass', filtros.get('status') == 'Em Análise'),
            ('Enviada', 'fa-paper-plane', filtros.get('status') == 'Enviada'),
            ('Negociação', 'fa-handshake', filtros.get('status') == 'Negociação'),
            ('Aprovada', 'fa-circle-check', filtros.get('status') == 'Aprovada'),
            ('Rejeitada', 'fa-circle-xmark', filtros.get('status') == 'Rejeitada')
          ] %}
          {% for status, icon, active in status_icons %}
          <button type="button" onclick="filtrarPorStatus('{{ status }}')" 
                  class="p-1.5 rounded hover:bg-gray-100 transition-colors {% if active %}bg-gray-200{% endif %}" 
                  title="{{ status }}">
            <i class="fa-solid {{ icon }} text-sm text-gray-{% if active %}800{% else %}400{% endif %}"></i>
          </button>
          {% endfor %}
        </div>
      </form>
    </div>
  </div>

  <!-- Kanban Board -->
  <div class="flex gap-2 overflow-x-auto pb-4" style="min-height: calc(100vh - 120px);">
    {% set status_list = ['Rascunho', 'Em Análise', 'Enviada', 'Negociação', 'Aprovada', 'Rejeitada'] %}
    
    {% for status in status_list %}
    {% set cotacoes = colunas.get(status, []) %}
    <div class="kanban-column flex flex-col bg-gray-50 rounded border border-gray-200"
         style="min-width: 220px; max-width: 250px; flex: 1;"
         data-status="{{ status }}"
         ondragover="handleColumnDragOver(event)"
         ondragleave="handleColumnDragLeave(event)"
         ondrop="handleColumnDrop(event)">
      
      <!-- Header da Coluna -->
      <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 bg-gray-100 rounded-t">
        <span class="font-medium text-sm text-gray-700">{{ status }}</span>
        <div class="flex items-center gap-2">
          <span class="text-xs font-medium text-gray-500 bg-white px-1.5 py-0.5 rounded">{{ cotacoes|length }}</span>
          {% if totais[status].valor > 0 %}
          <span class="text-xs text-gray-400">{{ "%.0f"|format(totais[status].valor / 1000) }}k</span>
          {% endif %}
        </div>
      </div>
      
      <!-- Cards Container -->
      <div class="flex-1 p-2 space-y-2 overflow-y-auto" style="max-height: calc(100vh - 180px);">
        {% for cotacao in cotacoes %}
        {% set dias_criacao = ((now() - cotacao.created_at).days if cotacao.created_at else 0) %}
        {% set alerta_urgente = (status in ['Em Análise', 'Enviada']) and cotacao.periodo_inicio and ((cotacao.periodo_inicio - now().date()).days <= 7 if cotacao.periodo_inicio > now().date() else true) %}
        
        <div class="kanban-card bg-white rounded border {% if alerta_urgente %}border-amber-400{% else %}border-gray-200{% endif %} p-2.5 cursor-grab hover:shadow transition-shadow"
             draggable="true"
             data-cotacao-id="{{ cotacao.id }}"
             data-status="{{ status }}"
             onclick="abrirModalCotacao({{ cotacao.id }})"
             ondragstart="handleCardDragStart(event)"
             ondragend="handleCardDragEnd(event)">
          
          <!-- Row 1: Número + Dias -->
          <div class="flex items-center justify-between mb-1">
            <span class="font-mono text-xs text-gray-500">{{ cotacao.numero_cotacao }}</span>
            <span class="text-xs text-gray-400" title="Criada há {{ dias_criacao }} dias">{{ dias_criacao }}d</span>
          </div>
          
          <!-- Cliente -->
          <p class="font-medium text-sm text-gray-800 truncate" title="{{ cotacao.cliente_nome or 'Sem cliente' }}">
            {{ cotacao.cliente_nome or 'Sem cliente' }}
          </p>
          
          <!-- Campanha -->
          <p class="text-xs text-gray-500 truncate mb-2" title="{{ cotacao.nome_campanha }}">
            {{ cotacao.nome_campanha }}
          </p>
          
          <!-- Alerta de urgência -->
          {% if alerta_urgente %}
          <div class="flex items-center gap-1 text-xs text-amber-600 mb-2">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span>Início {% if cotacao.periodo_inicio %}{{ cotacao.periodo_inicio.strftime('%d/%m') }}{% endif %}</span>
          </div>
          {% endif %}
          
          <!-- Footer: Executivo + Valor -->
          <div class="flex items-center justify-between pt-2 border-t border-gray-100">
            {% if cotacao.executivo_nome %}
            <div class="flex items-center gap-1.5">
              <div class="w-5 h-5 rounded-full bg-gray-200 flex items-center justify-center">
                <span class="text-xs text-gray-600">{{ cotacao.executivo_nome[0] }}</span>
              </div>
              <span class="text-xs text-gray-500 truncate" style="max-width: 70px;">{{ cotacao.executivo_nome.split()[0] }}</span>
            </div>
            {% else %}
            <div class="flex items-center gap-1 text-xs text-red-400">
              <i class="fa-solid fa-user-slash"></i>
              <span>Sem resp.</span>
            </div>
            {% endif %}
            
            <span class="text-sm font-semibold text-gray-700">
              {% if cotacao.valor_total_proposta and cotacao.valor_total_proposta >= 1000 %}
                {{ "%.1f"|format((cotacao.valor_total_proposta or 0) / 1000) }}k
              {% elif cotacao.valor_total_proposta and cotacao.valor_total_proposta > 0 %}
                R$ {{ "%.0f"|format(cotacao.valor_total_proposta) }}
              {% else %}
                -
              {% endif %}
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal Detalhes Cotação -->
<dialog id="modal_cotacao" class="modal">
  <div class="modal-box w-11/12 max-w-5xl bg-white p-0 rounded-lg">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
      <div class="flex items-center gap-4">
        <div>
          <h3 class="font-semibold text-lg text-gray-800" id="modal_titulo">-</h3>
          <p class="text-sm text-gray-500" id="modal_subtitulo">-</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <p class="text-2xl font-bold text-gray-800" id="modal_valor">R$ 0</p>
          <span class="text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-600" id="modal_status_badge">-</span>
        </div>
        <button onclick="document.getElementById('modal_cotacao').close()" class="p-2 hover:bg-gray-200 rounded">
          <i class="fa-solid fa-xmark text-gray-500"></i>
        </button>
      </div>
    </div>
    
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 px-6 bg-gray-50" id="modal_tabs">
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn tab-active" data-tab="resumo" onclick="trocarAbaModal('resumo')">Resumo</button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="comunicacao_ia" onclick="trocarAbaModal('comunicacao_ia')">Comunicação IA</button>
      <button class="px-4 py-2.5 text-sm font-medium text-gray-600 border-b-2 border-transparent hover:text-gray-800 tab-btn" data-tab="briefing" onclick="trocarAbaModal('briefing')">Briefing</button>
    </div>
    
    <!-- Conteúdo das Abas -->
    <div id="modal_content" class="p-6" style="min-height: 400px; max-height: 60vh; overflow-y: auto;">
      <!-- Aba Resumo -->
      <div id="tab_resumo" class="modal-tab-content">
        <div class="grid grid-cols-3 gap-6">
          <!-- Coluna 1: Cliente e Campanha -->
          <div class="space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Cliente</label>
              <p class="text-sm font-medium text-gray-800 mt-1" id="resumo_cliente">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Campanha</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_campanha">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Objetivo</label>
              <p class="text-sm text-gray-600 mt-1" id="resumo_objetivo">-</p>
            </div>
          </div>
          
          <!-- Coluna 2: Datas e Período -->
          <div class="space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Período da Campanha</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_periodo">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Criada em</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_criada_em">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Validade</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_validade">-</p>
            </div>
          </div>
          
          <!-- Coluna 3: Responsáveis -->
          <div class="space-y-4">
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Executivo</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_executivo">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Contato do Cliente</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_contato">-</p>
            </div>
            <div>
              <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Email</label>
              <p class="text-sm text-gray-700 mt-1" id="resumo_email">-</p>
            </div>
          </div>
        </div>
        
        <!-- Seção de Valores -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <h4 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-3">Valores</h4>
          <div class="grid grid-cols-4 gap-4">
            <div class="p-3 bg-gray-50 rounded">
              <p class="text-xs text-gray-500">Subtotal</p>
              <p class="text-sm font-semibold text-gray-800" id="resumo_subtotal">R$ 0,00</p>
            </div>
            <div class="p-3 bg-gray-50 rounded">
              <p class="text-xs text-gray-500">Desconto</p>
              <p class="text-sm font-semibold text-red-600" id="resumo_desconto">- R$ 0,00</p>
            </div>
            <div class="p-3 bg-gray-50 rounded">
              <p class="text-xs text-gray-500">Impostos</p>
              <p class="text-sm font-semibold text-gray-800" id="resumo_impostos">R$ 0,00</p>
            </div>
            <div class="p-3 bg-green-50 rounded border border-green-200">
              <p class="text-xs text-green-600">Total</p>
              <p class="text-base font-bold text-green-700" id="resumo_total">R$ 0,00</p>
            </div>
          </div>
        </div>
        
        <!-- Resumo de Itens e Audiências -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <div class="grid grid-cols-2 gap-6">
            <div>
              <h4 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Itens (<span id="resumo_itens_count">0</span>)</h4>
              <div id="resumo_itens_lista" class="space-y-1 max-h-32 overflow-y-auto">
                <p class="text-sm text-gray-400">Nenhum item</p>
              </div>
            </div>
            <div>
              <h4 class="text-xs font-medium text-gray-400 uppercase tracking-wide mb-2">Audiências (<span id="resumo_audiencias_count">0</span>)</h4>
              <div id="resumo_audiencias_lista" class="space-y-1 max-h-32 overflow-y-auto">
                <p class="text-sm text-gray-400">Nenhuma audiência</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Observações -->
        <div class="mt-6 pt-4 border-t border-gray-100">
          <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Observações</label>
          <p class="text-sm text-gray-600 mt-2" id="resumo_observacoes">-</p>
        </div>
      </div>
      
      <!-- Aba Comunicação IA -->
      <div id="tab_comunicacao_ia" class="modal-tab-content hidden">
        <!-- Header com info do contato -->
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                <i class="fa-solid fa-user text-gray-500"></i>
              </div>
              <div>
                <p class="font-medium text-gray-800" id="ia_contato_nome">-</p>
                <p class="text-sm text-gray-500" id="ia_contato_email">-</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a id="ia_whatsapp_link" href="#" target="_blank" class="p-2 rounded bg-green-500 hover:bg-green-600 text-white transition-colors" title="Abrir WhatsApp">
                <i class="fa-brands fa-whatsapp text-lg"></i>
              </a>
              <a id="ia_email_link" href="#" class="p-2 rounded bg-gray-600 hover:bg-gray-700 text-white transition-colors" title="Enviar Email">
                <i class="fa-solid fa-envelope"></i>
              </a>
            </div>
          </div>
        </div>
        
        <!-- Seletor de tipo de comunicação -->
        <div class="flex items-center gap-4 mb-4">
          <label class="text-sm font-medium text-gray-600">Tipo:</label>
          <div class="flex items-center gap-2">
            <button type="button" onclick="selecionarTipoComunicacao('email')" id="btn_tipo_email" class="px-4 py-2 text-sm rounded border border-gray-300 bg-gray-800 text-white transition-colors">
              <i class="fa-solid fa-envelope mr-1"></i>Email
            </button>
            <button type="button" onclick="selecionarTipoComunicacao('whatsapp')" id="btn_tipo_whatsapp" class="px-4 py-2 text-sm rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors">
              <i class="fa-brands fa-whatsapp mr-1"></i>WhatsApp
            </button>
          </div>
        </div>
        
        <!-- Área de geração -->
        <div class="relative">
          <label class="text-xs font-medium text-gray-400 uppercase tracking-wide">Mensagem Gerada</label>
          <textarea id="ia_mensagem_gerada" class="w-full mt-2 p-4 border border-gray-200 rounded-lg text-sm text-gray-700 focus:outline-none focus:border-gray-400 resize-none" rows="10" placeholder="Clique em 'Gerar com IA' para criar uma mensagem personalizada..."></textarea>
          
          <!-- Indicador de loading -->
          <div id="ia_loading" class="hidden absolute inset-0 mt-6 bg-white/80 rounded-lg flex items-center justify-center">
            <div class="flex items-center gap-3 text-gray-600">
              <i class="fa-solid fa-spinner fa-spin text-xl"></i>
              <span>Gerando mensagem...</span>
            </div>
          </div>
        </div>
        
        <!-- Botões de ação -->
        <div class="flex items-center justify-between mt-4">
          <div class="text-xs text-gray-400">
            <span id="ia_assinatura_preview">Assinatura: {{ session.get('user_fullname', 'Usuário') }}</span>
          </div>
          <div class="flex items-center gap-2">
            <button type="button" onclick="limparMensagemIA()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 transition-colors">
              <i class="fa-solid fa-eraser mr-1"></i>Limpar
            </button>
            <button type="button" onclick="copiarMensagemIA()" class="px-4 py-2 text-sm border border-gray-300 rounded hover:bg-gray-50 transition-colors">
              <i class="fa-solid fa-copy mr-1"></i>Copiar
            </button>
            <button type="button" onclick="gerarMensagemIA()" id="btn_gerar_ia" class="px-4 py-2 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
              <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Gerar com IA
            </button>
          </div>
        </div>
      </div>
      
      <!-- Aba Briefing -->
      <div id="tab_briefing" class="modal-tab-content hidden">
        <div id="briefing_content">
          <p class="py-8 text-center text-gray-400">Nenhum briefing vinculado</p>
        </div>
      </div>
      

    </div>
    
    <!-- Footer do Modal -->
    <div class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
      <div class="flex items-center gap-3">
        <select id="modal_mover_status" onchange="moverCotacaoStatus(this.value)" 
                class="text-sm border border-gray-300 rounded px-3 py-1.5 bg-white text-gray-700">
          <option value="">Mover para...</option>
          <option value="Rascunho">Rascunho</option>
          <option value="Em Análise">Em Análise</option>
          <option value="Enviada">Enviada</option>
          <option value="Negociação">Negociação</option>
          <option value="Aprovada">✓ Aprovada</option>
          <option value="Rejeitada">✗ Rejeitada</option>
        </select>
        
        <a id="modal_link_editar" href="#" class="text-sm text-gray-600 hover:text-gray-800">
          <i class="fa-solid fa-pen mr-1"></i>Editar completo
        </a>
      </div>
      
      <div class="flex items-center gap-2">
        <button onclick="aprovarCotacao()" class="px-4 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700" id="btn_aprovar">
          <i class="fa-solid fa-check mr-1"></i>Aprovar
        </button>
        <button onclick="rejeitarCotacao()" class="px-4 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700" id="btn_rejeitar">
          <i class="fa-solid fa-xmark mr-1"></i>Rejeitar
        </button>
      </div>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50">
    <button>close</button>
  </form>
</dialog>

<!-- Modal Confirmar Ação -->
<dialog id="modal_confirmar" class="modal">
  <div class="modal-box max-w-md bg-white p-6 rounded-lg">
    <h3 class="font-semibold text-lg text-gray-800 mb-2" id="confirmar_titulo">Confirmar</h3>
    <p class="text-sm text-gray-600 mb-4" id="confirmar_mensagem">Deseja continuar?</p>
    <div class="mb-4">
      <label class="text-xs font-medium text-gray-500">Observação (opcional)</label>
      <textarea id="confirmar_motivo" class="w-full border border-gray-200 rounded px-3 py-2 text-sm mt-1 focus:outline-none focus:border-gray-400" rows="2" placeholder="Adicione uma observação..."></textarea>
    </div>
    <div class="flex justify-end gap-2">
      <button onclick="document.getElementById('modal_confirmar').close()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">Cancelar</button>
      <button id="confirmar_btn" class="px-4 py-2 text-sm text-white rounded" onclick="executarAcaoConfirmada()">Confirmar</button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/30">
    <button>close</button>
  </form>
</dialog>

<style>
.kanban-card.dragging { opacity: 0.5; transform: rotate(1deg); }
.kanban-column.drag-over { background-color: #f0f0f0 !important; border-style: dashed; }
.modal-tab-content.hidden { display: none; }
.tab-btn.tab-active { color: #1f2937; border-bottom-color: #374151; }
</style>

<script>
// ==================== FILTROS ====================
function aplicarFiltros() {
  const executivo = document.getElementById('filtro_executivo').value;
  const mes = document.getElementById('filtro_mes').value;
  const params = new URLSearchParams();
  if (executivo) params.set('executivo_id', executivo);
  if (mes) params.set('mes', mes);
  window.location.href = '{{ url_for("crm_pipeline") }}?' + params.toString();
}

function filtrarPorStatus(status) {
  const params = new URLSearchParams(window.location.search);
  if (params.get('status') === status) {
    params.delete('status');
  } else {
    params.set('status', status);
  }
  window.location.href = '{{ url_for("crm_pipeline") }}?' + params.toString();
}

// ==================== DRAG & DROP ====================
let draggedCard = null;
let draggedCotacaoId = null;
let originalStatus = null;

function handleCardDragStart(event) {
  event.stopPropagation();
  draggedCard = event.target;
  draggedCotacaoId = event.target.dataset.cotacaoId;
  originalStatus = event.target.dataset.status;
  event.target.classList.add('dragging');
  event.dataTransfer.effectAllowed = 'move';
}

function handleCardDragEnd(event) {
  event.target.classList.remove('dragging');
  draggedCard = null;
}

function handleColumnDragOver(event) {
  event.preventDefault();
  event.currentTarget.classList.add('drag-over');
}

function handleColumnDragLeave(event) {
  event.currentTarget.classList.remove('drag-over');
}

function handleColumnDrop(event) {
  event.preventDefault();
  event.currentTarget.classList.remove('drag-over');
  if (!draggedCard || !draggedCotacaoId) return;
  
  const novoStatus = event.currentTarget.dataset.status;
  if (novoStatus === originalStatus) return;
  
  const container = event.currentTarget.querySelector('.space-y-2');
  container.appendChild(draggedCard);
  draggedCard.dataset.status = novoStatus;
  atualizarContadores();
  atualizarStatusCotacao(draggedCotacaoId, novoStatus);
}

async function atualizarStatusCotacao(cotacaoId, novoStatus) {
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoId}/atualizar`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: novoStatus })
    });
    const result = await response.json();
    if (!result.success) location.reload();
  } catch (error) {
    location.reload();
  }
}

function atualizarContadores() {
  document.querySelectorAll('.kanban-column').forEach(col => {
    const cards = col.querySelectorAll('.kanban-card').length;
    const badge = col.querySelector('.bg-white.px-1\\.5');
    if (badge) badge.textContent = cards;
  });
}

// ==================== MODAL ====================
let cotacaoAtualId = null;
let cotacaoAtualData = null;
let acaoPendente = null;

async function abrirModalCotacao(cotacaoId) {
  cotacaoAtualId = cotacaoId;
  const modal = document.getElementById('modal_cotacao');
  document.getElementById('modal_titulo').textContent = 'Carregando...';
  modal.showModal();
  
  try {
    const response = await fetch(`/api/crm/pipeline/cotacao/${cotacaoId}`);
    const result = await response.json();
    if (result.success) {
      cotacaoAtualData = result.cotacao;
      preencherModal(result.cotacao);
    } else {
      showToast(result.message || 'Erro ao carregar', 'error');
      modal.close();
    }
  } catch (error) {
    showToast('Erro ao carregar cotação', 'error');
    modal.close();
  }
}

function preencherModal(c) {
  document.getElementById('modal_titulo').textContent = c.numero_cotacao;
  document.getElementById('modal_subtitulo').textContent = c.cliente_nome || 'Sem cliente';
  document.getElementById('modal_valor').textContent = `R$ ${formatarMoeda(c.valor_total_proposta)}`;
  document.getElementById('modal_status_badge').textContent = c.status;
  
  // Resumo básico
  document.getElementById('resumo_cliente').textContent = c.cliente_nome || '-';
  document.getElementById('resumo_campanha').textContent = c.nome_campanha || '-';
  document.getElementById('resumo_objetivo').textContent = c.objetivo_campanha || '-';
  document.getElementById('resumo_executivo').textContent = c.executivo_nome || '-';
  document.getElementById('resumo_contato').textContent = c.contato_nome || '-';
  document.getElementById('resumo_email').textContent = c.contato_email || '-';
  document.getElementById('resumo_observacoes').textContent = c.observacoes || '-';
  document.getElementById('resumo_criada_em').textContent = formatarDataHora(c.created_at);
  document.getElementById('resumo_validade').textContent = c.validade_proposta ? formatarData(c.validade_proposta) : '-';
  
  let periodo = '-';
  if (c.periodo_inicio) {
    periodo = formatarData(c.periodo_inicio);
    if (c.periodo_fim) periodo += ' a ' + formatarData(c.periodo_fim);
  }
  document.getElementById('resumo_periodo').textContent = periodo;
  
  // Valores no resumo
  document.getElementById('resumo_subtotal').textContent = `R$ ${formatarMoeda(c.valor_bruto || c.valor_total_proposta || 0)}`;
  document.getElementById('resumo_desconto').textContent = `- R$ ${formatarMoeda(c.valor_desconto || 0)}`;
  document.getElementById('resumo_impostos').textContent = `R$ ${formatarMoeda(c.valor_impostos || 0)}`;
  document.getElementById('resumo_total').textContent = `R$ ${formatarMoeda(c.valor_total_proposta || 0)}`;
  
  // Resumo de itens
  const itensLista = document.getElementById('resumo_itens_lista');
  const itensCount = document.getElementById('resumo_itens_count');
  if (c.itens && c.itens.length > 0) {
    itensCount.textContent = c.itens.length;
    itensLista.innerHTML = c.itens.slice(0, 5).map(item => `
      <div class="flex items-center justify-between text-sm">
        <span class="text-gray-600 truncate" style="max-width: 150px;">${item.plataforma || '-'} - ${item.produto || item.descricao || '-'}</span>
        <span class="font-medium text-gray-700">R$ ${formatarMoeda(item.valor_total || 0)}</span>
      </div>
    `).join('') + (c.itens.length > 5 ? `<p class="text-xs text-gray-400">+${c.itens.length - 5} mais...</p>` : '');
  } else {
    itensCount.textContent = '0';
    itensLista.innerHTML = '<p class="text-sm text-gray-400">Nenhum item</p>';
  }
  
  // Resumo de audiências
  const audienciasLista = document.getElementById('resumo_audiencias_lista');
  const audienciasCount = document.getElementById('resumo_audiencias_count');
  if (c.audiencias && c.audiencias.length > 0) {
    audienciasCount.textContent = c.audiencias.length;
    audienciasLista.innerHTML = c.audiencias.slice(0, 5).map(a => `
      <div class="flex items-center justify-between text-sm">
        <span class="text-gray-600 truncate" style="max-width: 150px;">${a.nome || 'Audiência'}</span>
        <span class="font-medium text-gray-700">R$ ${formatarMoeda(a.investimento_sugerido || 0)}</span>
      </div>
    `).join('') + (c.audiencias.length > 5 ? `<p class="text-xs text-gray-400">+${c.audiencias.length - 5} mais...</p>` : '');
  } else {
    audienciasCount.textContent = '0';
    audienciasLista.innerHTML = '<p class="text-sm text-gray-400">Nenhuma audiência</p>';
  }
  
  // Briefing
  const briefingContent = document.getElementById('briefing_content');
  if (c.briefing) {
    briefingContent.innerHTML = `
      <div class="p-4 bg-gray-50 rounded border border-gray-200">
        <p class="font-medium text-gray-800">${c.briefing.titulo || c.briefing.nome || 'Briefing'}</p>
        <p class="text-xs text-gray-500 mt-1">Status: ${c.briefing.status || '-'}</p>
        <a href="/briefings/${c.briefing.id}" target="_blank" class="inline-block mt-3 text-sm text-gray-600 hover:text-gray-800">
          <i class="fa-solid fa-external-link mr-1"></i>Abrir briefing
        </a>
      </div>
    `;
  } else {
    briefingContent.innerHTML = '<p class="py-8 text-center text-gray-400">Nenhum briefing vinculado</p>';
  }
  
  // Comunicação IA - preencher dados do contato
  document.getElementById('ia_contato_nome').textContent = c.contato_nome || c.cliente_nome || '-';
  document.getElementById('ia_contato_email').textContent = c.contato_email || '-';
  
  // Links de WhatsApp e Email
  const telefone = c.contato_telefone || '';
  const telefoneFormatado = telefone.replace(/\D/g, '');
  if (telefoneFormatado) {
    document.getElementById('ia_whatsapp_link').href = `https://wa.me/55${telefoneFormatado}`;
    document.getElementById('ia_whatsapp_link').classList.remove('opacity-50', 'pointer-events-none');
  } else {
    document.getElementById('ia_whatsapp_link').href = '#';
    document.getElementById('ia_whatsapp_link').classList.add('opacity-50', 'pointer-events-none');
  }
  
  if (c.contato_email) {
    document.getElementById('ia_email_link').href = `mailto:${c.contato_email}`;
    document.getElementById('ia_email_link').classList.remove('opacity-50', 'pointer-events-none');
  } else {
    document.getElementById('ia_email_link').href = '#';
    document.getElementById('ia_email_link').classList.add('opacity-50', 'pointer-events-none');
  }
  
  // Limpar mensagem gerada
  document.getElementById('ia_mensagem_gerada').value = '';
  tipoComunicacaoAtual = 'email';
  selecionarTipoComunicacao('email');
  
  document.getElementById('modal_link_editar').href = `/cotacoes/${c.id}/detalhes`;
  document.getElementById('modal_mover_status').value = '';
  
  // Botões de ação
  const btnAprovar = document.getElementById('btn_aprovar');
  const btnRejeitar = document.getElementById('btn_rejeitar');
  if (c.status === 'Aprovada' || c.status === 'Rejeitada') {
    btnAprovar.style.display = 'none';
    btnRejeitar.style.display = 'none';
  } else {
    btnAprovar.style.display = 'inline-flex';
    btnRejeitar.style.display = 'inline-flex';
  }
  
  trocarAbaModal('resumo');
}

function trocarAbaModal(tab) {
  document.querySelectorAll('#modal_tabs .tab-btn').forEach(t => {
    t.classList.toggle('tab-active', t.dataset.tab === tab);
  });
  document.querySelectorAll('.modal-tab-content').forEach(c => {
    c.classList.toggle('hidden', c.id !== `tab_${tab}`);
  });
}

// ==================== COMUNICAÇÃO IA ====================
let tipoComunicacaoAtual = 'email';

function selecionarTipoComunicacao(tipo) {
  tipoComunicacaoAtual = tipo;
  const btnEmail = document.getElementById('btn_tipo_email');
  const btnWhatsapp = document.getElementById('btn_tipo_whatsapp');
  
  if (tipo === 'email') {
    btnEmail.className = 'px-4 py-2 text-sm rounded border border-gray-300 bg-gray-800 text-white transition-colors';
    btnWhatsapp.className = 'px-4 py-2 text-sm rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors';
  } else {
    btnEmail.className = 'px-4 py-2 text-sm rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition-colors';
    btnWhatsapp.className = 'px-4 py-2 text-sm rounded border border-gray-300 bg-gray-800 text-white transition-colors';
  }
}

async function gerarMensagemIA() {
  if (!cotacaoAtualData) {
    showToast('Dados da cotação não carregados', 'error');
    return;
  }
  
  const loading = document.getElementById('ia_loading');
  const btnGerar = document.getElementById('btn_gerar_ia');
  const textarea = document.getElementById('ia_mensagem_gerada');
  
  loading.classList.remove('hidden');
  btnGerar.disabled = true;
  btnGerar.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>Gerando...';
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoAtualId}/gerar-comunicacao`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        tipo: tipoComunicacaoAtual,
        cotacao_data: {
          numero: cotacaoAtualData.numero_cotacao,
          cliente: cotacaoAtualData.cliente_nome,
          campanha: cotacaoAtualData.nome_campanha,
          objetivo: cotacaoAtualData.objetivo_campanha,
          valor_total: cotacaoAtualData.valor_total_proposta,
          periodo_inicio: cotacaoAtualData.periodo_inicio,
          periodo_fim: cotacaoAtualData.periodo_fim,
          contato_nome: cotacaoAtualData.contato_nome,
          status: cotacaoAtualData.status,
          itens_count: cotacaoAtualData.itens?.length || 0,
          audiencias_count: cotacaoAtualData.audiencias?.length || 0
        }
      })
    });
    
    const result = await response.json();
    if (result.success) {
      textarea.value = result.mensagem;
      showToast('Mensagem gerada com sucesso', 'success');
    } else {
      showToast(result.message || 'Erro ao gerar mensagem', 'error');
    }
  } catch (error) {
    showToast('Erro ao comunicar com o servidor', 'error');
    console.error('Erro:', error);
  } finally {
    loading.classList.add('hidden');
    btnGerar.disabled = false;
    btnGerar.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Gerar com IA';
  }
}

function copiarMensagemIA() {
  const textarea = document.getElementById('ia_mensagem_gerada');
  if (!textarea.value.trim()) {
    showToast('Nenhuma mensagem para copiar', 'error');
    return;
  }
  
  navigator.clipboard.writeText(textarea.value).then(() => {
    showToast('Mensagem copiada!', 'success');
  }).catch(() => {
    // Fallback para navegadores antigos
    textarea.select();
    document.execCommand('copy');
    showToast('Mensagem copiada!', 'success');
  });
}

function limparMensagemIA() {
  document.getElementById('ia_mensagem_gerada').value = '';
}

async function moverCotacaoStatus(novoStatus) {
  if (!novoStatus || !cotacaoAtualId) return;
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoAtualId}/atualizar`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: novoStatus })
    });
    const result = await response.json();
    if (result.success) {
      showToast('Status atualizado', 'success');
      document.getElementById('modal_cotacao').close();
      location.reload();
    } else {
      showToast(result.message || 'Erro', 'error');
    }
  } catch (error) {
    showToast('Erro ao atualizar', 'error');
  }
}

function aprovarCotacao() {
  acaoPendente = 'aprovar';
  document.getElementById('confirmar_titulo').textContent = 'Aprovar Cotação';
  document.getElementById('confirmar_mensagem').textContent = `Confirma a aprovação da cotação ${cotacaoAtualData?.numero_cotacao}?`;
  document.getElementById('confirmar_btn').className = 'px-4 py-2 text-sm text-white rounded bg-green-600 hover:bg-green-700';
  document.getElementById('confirmar_btn').textContent = 'Aprovar';
  document.getElementById('confirmar_motivo').value = '';
  document.getElementById('modal_confirmar').showModal();
}

function rejeitarCotacao() {
  acaoPendente = 'rejeitar';
  document.getElementById('confirmar_titulo').textContent = 'Rejeitar Cotação';
  document.getElementById('confirmar_mensagem').textContent = `Confirma a rejeição da cotação ${cotacaoAtualData?.numero_cotacao}?`;
  document.getElementById('confirmar_btn').className = 'px-4 py-2 text-sm text-white rounded bg-red-600 hover:bg-red-700';
  document.getElementById('confirmar_btn').textContent = 'Rejeitar';
  document.getElementById('confirmar_motivo').value = '';
  document.getElementById('modal_confirmar').showModal();
}

async function executarAcaoConfirmada() {
  const motivo = document.getElementById('confirmar_motivo').value.trim();
  const novoStatus = acaoPendente === 'aprovar' ? 'Aprovada' : 'Rejeitada';
  
  try {
    const response = await fetch(`/api/cotacoes/${cotacaoAtualId}/atualizar`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: novoStatus })
    });
    const result = await response.json();
    
    if (result.success) {
      if (motivo) {
        await fetch(`/api/cotacoes/${cotacaoAtualId}/comentarios`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comentario: `[${novoStatus.toUpperCase()}] ${motivo}` })
        });
      }
      showToast(`Cotação ${novoStatus.toLowerCase()}`, 'success');
      document.getElementById('modal_confirmar').close();
      document.getElementById('modal_cotacao').close();
      location.reload();
    } else {
      showToast(result.message || 'Erro', 'error');
    }
  } catch (error) {
    showToast('Erro ao processar', 'error');
  }
}

// ==================== UTILS ====================
function formatarMoeda(valor) {
  return (valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatarData(dataStr) {
  if (!dataStr) return '-';
  const d = new Date(dataStr);
  return d.toLocaleDateString('pt-BR');
}

function formatarDataHora(dataStr) {
  if (!dataStr) return '-';
  const d = new Date(dataStr);
  return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.getElementById('modal_confirmar').close();
    document.getElementById('modal_cotacao').close();
  }
});
</script>
{% endblock %}
