{% extends "base_tailwind.html" %}

{% block title %}Dashboard - CentralComm AI{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-3xl font-bold text-base-content flex items-center gap-3">
            <i class="fas fa-chart-line text-primary"></i>
            Dashboard
        </h1>
        <p class="text-base-content/70 mt-1">Visão geral e métricas do sistema</p>
    </div>
    <div class="flex items-center gap-2 text-sm">
        <div class="badge badge-outline gap-2">
            <i class="fas fa-sync-alt text-xs"></i>
            Atualizado: {{ "now"|datetime_format("%d/%m/%Y %H:%M") }}
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <!-- Total Clientes Ativos -->
    <div class="card bg-gradient-to-br from-primary to-primary-focus text-primary-content shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-primary-content/30">
                    <i class="fas fa-building text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.total_clientes_ativos }}</div>
                    <div class="stat-title text-primary-content/80 text-sm mt-1">Clientes Ativos</div>
                </div>
            </div>
            <div class="stat-desc text-primary-content/60 mt-2">
                <i class="fas fa-check-circle mr-1"></i>
                Total no sistema
            </div>
        </div>
    </div>

    <!-- Total Usuários -->
    <div class="card bg-gradient-to-br from-secondary to-secondary-focus text-secondary-content shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-secondary-content/30">
                    <i class="fas fa-users text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.total_usuarios }}</div>
                    <div class="stat-title text-secondary-content/80 text-sm mt-1">Usuários</div>
                </div>
            </div>
            <div class="stat-desc text-secondary-content/60 mt-2">
                <i class="fas fa-user-check mr-1"></i>
                Usuários ativos
            </div>
        </div>
    </div>

    <!-- Tokens do Mês -->
    <div class="card bg-gradient-to-br from-accent to-accent-focus text-accent-content shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-accent-content/30">
                    <i class="fas fa-coins text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-3xl font-bold">{{ "{:,}".format(stats.tokens_mes_atual).replace(',', '.') }}</div>
                    <div class="stat-title text-accent-content/80 text-sm mt-1">Tokens ({{ stats.mes_atual }})</div>
                </div>
            </div>
            <div class="stat-desc text-accent-content/60 mt-2">
                <i class="fas fa-chart-line mr-1"></i>
                Consumo atual
            </div>
        </div>
    </div>

    <!-- Imagens do Mês -->
    <div class="card bg-gradient-to-br from-info to-info-focus text-info-content shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-info-content/30">
                    <i class="fas fa-images text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.imagens_mes_atual }}</div>
                    <div class="stat-title text-info-content/80 text-sm mt-1">Imagens (Mês)</div>
                </div>
            </div>
            <div class="stat-desc text-info-content/60 mt-2">
                <i class="fas fa-camera mr-1"></i>
                Geradas este mês
            </div>
        </div>
    </div>
</div>

<!-- Alertas -->
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <!-- Planos Próximos do Limite -->
    <div class="card bg-base-100 shadow-xl border border-warning/20">
        <div class="card-body">
            <h2 class="card-title text-warning flex items-center gap-2">
                <div class="badge badge-warning badge-lg gap-2">
                    <i class="fas fa-exclamation-triangle"></i>
                    {{ stats.planos_proximo_limite }}
                </div>
                <span>Alertas de Limite</span>
            </h2>
            
            {% if planos_alerta %}
            <div class="overflow-x-auto mt-4">
                <table class="table table-sm table-zebra">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="text-xs">Cliente</th>
                            <th class="text-xs text-center">Tokens</th>
                            <th class="text-xs text-center">Imagens</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plano in planos_alerta[:5] %}
                        <tr class="hover">
                            <td>
                                <a href="{{ url_for('cliente_detalhes', cliente_id=plano.id_cliente) }}" 
                                   class="link link-primary link-hover font-medium flex items-center gap-2">
                                    <i class="fas fa-building text-xs text-base-content/50"></i>
                                    {{ plano.nome_fantasia }}
                                </a>
                            </td>
                            <td class="text-center">
                                <div class="tooltip" data-tip="{{ plano.tokens_usage_percentage }}% utilizado">
                                    <div class="radial-progress text-xs font-bold 
                                        {% if plano.tokens_usage_percentage > 90 %}text-error
                                        {% elif plano.tokens_usage_percentage > 80 %}text-warning
                                        {% else %}text-success{% endif %}" 
                                         style="--value:{{ plano.tokens_usage_percentage }}; --size:2.5rem; --thickness:3px;">
                                        {{ plano.tokens_usage_percentage|int }}%
                                    </div>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="tooltip" data-tip="{{ plano.images_usage_percentage }}% utilizado">
                                    <div class="radial-progress text-xs font-bold 
                                        {% if plano.images_usage_percentage > 90 %}text-error
                                        {% elif plano.images_usage_percentage > 80 %}text-warning
                                        {% else %}text-success{% endif %}" 
                                         style="--value:{{ plano.images_usage_percentage }}; --size:2.5rem; --thickness:3px;">
                                        {{ plano.images_usage_percentage|int }}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-success shadow-sm mt-4">
                <i class="fas fa-check-circle text-lg"></i>
                <span>Nenhum plano próximo do limite</span>
            </div>
            {% endif %}

            {% if planos_alerta|length > 5 %}
            <div class="card-actions justify-end mt-4">
                <button class="btn btn-sm btn-ghost gap-2">
                    <i class="fas fa-list"></i>
                    Ver todos ({{ planos_alerta|length }})
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Planos Vencendo -->
    <div class="card bg-base-100 shadow-xl border border-error/20">
        <div class="card-body">
            <h2 class="card-title text-error flex items-center gap-2">
                <div class="badge badge-error badge-lg gap-2">
                    <i class="fas fa-calendar-times"></i>
                    {{ stats.planos_vencendo }}
                </div>
                <span>Planos Vencendo</span>
            </h2>
            
            {% if stats.planos_vencendo > 0 %}
            <div class="alert alert-error shadow-sm mt-4">
                <i class="fas fa-exclamation-circle text-lg"></i>
                <span>{{ stats.planos_vencendo }} plano(s) vence(m) nos próximos 7 dias</span>
            </div>
            <div class="card-actions justify-end mt-4">
                <button class="btn btn-error btn-sm gap-2">
                    <i class="fas fa-eye"></i>
                    Ver Planos
                </button>
            </div>
            {% else %}
            <div class="alert alert-success shadow-sm mt-4">
                <i class="fas fa-check-circle text-lg"></i>
                <span>Nenhum plano vencendo em breve</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Atividade Recente -->
<div class="card bg-base-100 shadow-xl mb-6">
    <div class="card-body">
        <h2 class="card-title flex items-center gap-2">
            <i class="fas fa-history text-primary"></i>
            Atividade Recente
        </h2>

        {% if logs_recentes %}
        <div class="overflow-x-auto mt-4">
            <table class="table table-zebra table-sm">
                <thead>
                    <tr class="bg-base-200">
                        <th class="text-xs">Data/Hora</th>
                        <th class="text-xs">Usuário</th>
                        <th class="text-xs">Ação</th>
                        <th class="text-xs">Módulo</th>
                        <th class="text-xs">Descrição</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs_recentes %}
                    <tr class="hover">
                        <td class="text-xs whitespace-nowrap">
                            <i class="fas fa-clock text-base-content/50 mr-1"></i>
                            {{ log.data_acao.strftime('%d/%m %H:%M') }}
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <div class="avatar placeholder">
                                    <div class="bg-primary text-primary-content rounded-full w-8 h-8">
                                        <span class="text-xs font-bold">{{ log.usuario_nome[0] if log.usuario_nome else '?' }}</span>
                                    </div>
                                </div>
                                <span class="text-xs font-medium">{{ log.usuario_nome }}</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge badge-sm 
                                {% if log.acao == 'criar' %}badge-success
                                {% elif log.acao == 'excluir' %}badge-error
                                {% elif log.acao == 'editar' %}badge-warning
                                {% else %}badge-info{% endif %}">
                                {{ log.acao }}
                            </span>
                        </td>
                        <td><span class="badge badge-ghost badge-sm">{{ log.modulo }}</span></td>
                        <td class="text-xs max-w-md truncate">{{ log.descricao }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if session.user_type in ['admin', 'superadmin'] %}
        <div class="card-actions justify-end mt-4">
            <a href="{{ url_for('admin.admin_logs') }}" class="btn btn-sm btn-ghost gap-2">
                <span>Ver Todos os Logs</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        {% endif %}
        {% else %}
        <div class="alert mt-4">
            <i class="fas fa-info-circle"></i>
            <span>Nenhuma atividade registrada</span>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Actions (apenas para admins) -->
{% if session.user_type in ['admin', 'superadmin'] %}
<div class="card bg-gradient-to-br from-base-200 to-base-300 shadow-xl">
    <div class="card-body">
        <h2 class="card-title flex items-center gap-2">
            <i class="fas fa-bolt text-warning"></i>
            Ações Rápidas
        </h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
            <a href="{{ url_for('contato_novo') }}" class="btn btn-outline btn-primary gap-2 hover:scale-105 transition-transform">
                <i class="fas fa-user-plus"></i>
                <span class="hidden md:inline">Novo Usuário</span>
            </a>
            <a href="{{ url_for('cliente_novo') }}" class="btn btn-outline btn-secondary gap-2 hover:scale-105 transition-transform">
                <i class="fas fa-building"></i>
                <span class="hidden md:inline">Novo Cliente</span>
            </a>
            <a href="{{ url_for('admin.plano_novo') }}" class="btn btn-outline btn-accent gap-2 hover:scale-105 transition-transform">
                <i class="fas fa-box"></i>
                <span class="hidden md:inline">Novo Plano</span>
            </a>
            <a href="{{ url_for('admin.faturamento_lista') }}" class="btn btn-outline btn-info gap-2 hover:scale-105 transition-transform">
                <i class="fas fa-file-invoice"></i>
                <span class="hidden md:inline">Gerar Fatura</span>
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}