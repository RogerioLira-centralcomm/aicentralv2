{% extends "base_tailwind.html" %}

{% block title %}Dashboard - CentralComm AI{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-3xl font-bold text-base-content flex items-center gap-3">
            <i class="fas fa-chart-line text-primary"></i>
            Dashboard
        </h1>
        <p class="text-base-content/70 mt-1">Visão geral e métricas do sistema</p>
    </div>
    <div class="flex items-center gap-2 text-sm">
        <div class="badge badge-outline gap-2">
            <i class="fas fa-sync-alt text-xs"></i>
            Atualizado: {{ "now"|datetime_format("%d/%m/%Y %H:%M") }}
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <!-- Total Clientes Ativos -->
    <div class="card bg-blue-600 text-white">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-white/20">
                    <i class="fas fa-building text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.total_clientes_ativos }}</div>
                    <div class="stat-title text-white/90 text-sm mt-1 font-medium">Clientes Ativos</div>
                </div>
            </div>
            <div class="stat-desc text-white/70 mt-2">
                <i class="fas fa-check-circle mr-1"></i>
                Total no sistema
            </div>
        </div>
    </div>

    <!-- Total Usuários -->
    <div class="card bg-purple-600 text-white">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-white/20">
                    <i class="fas fa-users text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.total_usuarios }}</div>
                    <div class="stat-title text-white/90 text-sm mt-1 font-medium">Usuários</div>
                </div>
            </div>
            <div class="stat-desc text-white/70 mt-2">
                <i class="fas fa-user-check mr-1"></i>
                Usuários ativos
            </div>
        </div>
    </div>

    <!-- Tokens do Mês -->
    <div class="card bg-emerald-600 text-white">
        <div class="card-body">
            <div class="flex items-center gap-3">
                <div class="stat-figure text-white/20 flex-shrink-0">
                    <i class="fas fa-coins text-4xl"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="space-y-2">
                        <div>
                            <div class="text-xs text-white/70 font-medium">{{ stats.mes_atual }}</div>
                            <div class="text-2xl font-bold break-words">{{ "{:,}".format(stats.tokens_mes_atual).replace(',', '.') }}</div>
                        </div>
                        <div class="border-t border-white/20 pt-2">
                            <div class="text-xs text-white/70 font-medium">{{ stats.mes_anterior }}</div>
                            <div class="text-lg font-semibold break-words">{{ "{:,}".format(stats.tokens_mes_anterior).replace(',', '.') }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Imagens do Mês -->
    <div class="card bg-orange-600 text-white">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <div class="stat-figure text-white/20">
                    <i class="fas fa-images text-5xl"></i>
                </div>
                <div class="text-right">
                    <div class="stat-value text-4xl font-bold">{{ stats.imagens_mes_atual }}</div>
                    <div class="stat-title text-white/90 text-sm mt-1 font-medium">Imagens (Mês)</div>
                </div>
            </div>
            <div class="stat-desc text-white/70 mt-2">
                <i class="fas fa-camera mr-1"></i>
                Geradas este mês
            </div>
        </div>
    </div>
</div>

<!-- Alertas -->
{% if show_plan_alerts %}
<div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-6">
    <!-- Planos Próximos do Limite -->
    <div class="card bg-base-100 border border-warning/20 overflow-hidden">
        <div class="card-body p-3 sm:p-6">
            <h2 class="card-title text-warning flex flex-wrap items-center gap-2 text-sm sm:text-base">
                <div class="badge badge-warning badge-sm sm:badge-lg gap-1 sm:gap-2">
                    <i class="fas fa-exclamation-triangle text-xs"></i>
                    {{ stats.planos_proximo_limite }}
                </div>
                <span class="text-sm sm:text-base">Alertas de Limite</span>
            </h2>
            
            {% if planos_alerta %}
            <div class="w-full overflow-x-auto mt-4">
                <table class="table table-xs w-full min-w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="text-xs">Cliente</th>
                            <th class="text-xs text-center w-20">Tokens</th>
                            <th class="text-xs text-center w-20">Imgs</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plano in planos_alerta[:5] %}
                        <tr class="hover">
                            <td class="text-xs">
                                <a href="{{ url_for('clientes') }}?open={{ plano.id_cliente }}&tab=contratos" 
                                   class="link link-primary link-hover font-medium truncate block max-w-[100px] sm:max-w-none">
                                    {{ plano.nome_fantasia }}
                                </a>
                            </td>
                            <td class="text-center p-1">
                                <div class="radial-progress text-[10px] font-bold 
                                    {% if plano.tokens_usage_percentage > 90 %}text-error
                                    {% elif plano.tokens_usage_percentage > 80 %}text-warning
                                    {% else %}text-success{% endif %}" 
                                     style="--value:{{ plano.tokens_usage_percentage }}; --size:1.75rem; --thickness:2px;">
                                    {{ plano.tokens_usage_percentage|int }}%
                                </div>
                            </td>
                            <td class="text-center p-1">
                                <div class="radial-progress text-[10px] font-bold 
                                    {% if plano.images_usage_percentage > 90 %}text-error
                                    {% elif plano.images_usage_percentage > 80 %}text-warning
                                    {% else %}text-success{% endif %}" 
                                     style="--value:{{ plano.images_usage_percentage }}; --size:1.75rem; --thickness:2px;">
                                    {{ plano.images_usage_percentage|int }}%
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-success mt-4 text-xs sm:text-sm">
                <i class="fas fa-check-circle text-sm sm:text-lg"></i>
                <span>Nenhum plano próximo do limite</span>
            </div>
            {% endif %}

            {% if planos_alerta|length > 5 %}
            <div class="card-actions justify-end mt-4">
                <button class="btn btn-xs sm:btn-sm btn-ghost gap-1 sm:gap-2">
                    <i class="fas fa-list text-xs"></i>
                    <span class="text-xs sm:text-sm">Ver todos ({{ planos_alerta|length }})</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Planos Vencendo -->
    <div class="card bg-base-100 border border-error/20 overflow-hidden">
        <div class="card-body p-3 sm:p-6">
            <h2 class="card-title text-error flex flex-wrap items-center gap-2 text-sm sm:text-base">
                <div class="badge badge-error badge-sm sm:badge-lg gap-1 sm:gap-2">
                    <i class="fas fa-calendar-times text-xs"></i>
                    {{ stats.planos_vencendo }}
                </div>
                <span class="text-sm sm:text-base">Planos Vencendo</span>
            </h2>
            
            {% if planos_vencendo %}
            <div class="w-full overflow-x-auto mt-4">
                <table class="table table-xs w-full min-w-full">
                    <thead>
                        <tr class="bg-base-200">
                            <th class="text-xs">Cliente</th>
                            <th class="text-xs text-center w-32">Vencimento</th>
                            <th class="text-xs text-center w-16">Dias</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for plano in planos_vencendo[:5] %}
                        <tr class="hover">
                            <td class="text-xs">
                                <a href="{{ url_for('clientes') }}?open={{ plano.id_cliente }}&tab=contratos" 
                                   class="link link-primary link-hover font-medium truncate block max-w-[100px] sm:max-w-none">
                                    {{ plano.nome_fantasia }}
                                </a>
                            </td>
                            <td class="text-center text-xs">
                                {{ plano.valid_until.strftime('%d/%m/%Y') if plano.valid_until else 'N/A' }}
                            </td>
                            <td class="text-center">
                                {% set dias_restantes = (plano.valid_until - today).days if plano.valid_until else 0 %}
                                <span class="badge badge-sm 
                                    {% if dias_restantes <= 7 %}badge-error
                                    {% elif dias_restantes <= 15 %}badge-warning
                                    {% else %}badge-info{% endif %}">
                                    {{ dias_restantes }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-success mt-4 text-xs sm:text-sm">
                <i class="fas fa-check-circle text-sm sm:text-lg"></i>
                <span>Nenhum plano vencendo em {{ aviso_plan }} dias</span>
            </div>
            {% endif %}
            
            {% if planos_vencendo|length > 5 %}
            <div class="card-actions justify-end mt-4">
                <button class="btn btn-xs sm:btn-sm btn-ghost gap-1 sm:gap-2">
                    <i class="fas fa-list text-xs"></i>
                    <span class="text-xs sm:text-sm">Ver todos ({{ planos_vencendo|length }})</span>
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Atividade Recente -->
<div class="card bg-base-100 mb-6">
    <div class="card-body">
        <h2 class="card-title flex items-center gap-2">
            <i class="fas fa-history text-primary"></i>
            Atividade Recente
        </h2>

        {% if logs_recentes %}
        <div class="overflow-x-auto mt-4">
            <table class="table table-zebra table-sm">
                <thead>
                    <tr class="bg-base-200">
                        <th class="text-xs">Data/Hora</th>
                        <th class="text-xs">Módulo</th>
                        <th class="text-xs">Ação</th>
                        <th class="text-xs">Descrição</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs_recentes %}
                    <tr class="hover">
                        <td class="text-xs whitespace-nowrap">
                            <i class="fas fa-clock text-base-content/50 mr-1"></i>
                            {{ log.data_acao.strftime('%d/%m %H:%M') }}
                        </td>
                        <td><span class="badge badge-ghost badge-sm">{{ log.modulo }}</span></td>
                        <td>
                            <span class="badge badge-sm 
                                {% if log.acao == 'criar' %}badge-success
                                {% elif log.acao == 'excluir' %}badge-error
                                {% elif log.acao == 'editar' %}badge-warning
                                {% else %}badge-info{% endif %}">
                                {{ log.acao }}
                            </span>
                        </td>
                        <td class="text-xs max-w-md truncate">{{ log.descricao }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if session.user_type in ['admin', 'superadmin'] %}
        <div class="card-actions justify-end mt-4">
            <a href="{{ url_for('logs_auditoria') }}" class="btn btn-sm btn-ghost gap-2">
                <span>Ver Todos os Logs</span>
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        {% endif %}
        {% else %}
        <div class="alert mt-4">
            <i class="fas fa-info-circle"></i>
            <span>Nenhuma atividade registrada</span>
        </div>
        {% endif %}
    </div>
</div>


{% endblock %}