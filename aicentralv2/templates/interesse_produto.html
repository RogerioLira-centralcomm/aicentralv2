{% extends 'base_tailwind.html' %}

{% block title %}Interesses em Produtos - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <div class="flex items-center justify-between mb-3">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Interesses em Produtos</h1>
      <p class="text-sm text-base-content/70">Visualize os contatos interessados em nossos produtos.</p>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Filtros -->
  <div class="bg-base-100 rounded-xl shadow-lg p-4 mb-4">
    <form method="GET" action="{{ url_for('interesse_produto_listar') }}" class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="form-control">
        <label class="label">
          <span class="label-text">Tipo de Produto</span>
        </label>
        <select name="tipo_produto" class="select select-bordered w-full">
          <option value="">Todos</option>
          <option value="regenerar_resposta" {% if filtro_tipo == 'regenerar_resposta' %}selected{% endif %}>Regenerar Resposta</option>
          <option value="anexo_arquivos" {% if filtro_tipo == 'anexo_arquivos' %}selected{% endif %}>Anexo Arquivos</option>
          <option value="canais" {% if filtro_tipo == 'canais' %}selected{% endif %}>Canais</option>
          <option value="self_media" {% if filtro_tipo == 'self_media' %}selected{% endif %}>Self Media</option>
          <option value="estrategias" {% if filtro_tipo == 'estrategias' %}selected{% endif %}>Estratégias</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Status Notificação</span>
        </label>
        <select name="notificado" class="select select-bordered w-full">
          <option value="">Todos</option>
          <option value="true" {% if filtro_notificado == 'true' %}selected{% endif %}>Notificado</option>
          <option value="false" {% if filtro_notificado == 'false' %}selected{% endif %}>Não Notificado</option>
        </select>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text">Cliente</span>
        </label>
        <div class="relative">
          <input type="hidden" name="cliente_id" id="cliente_id_interesse" value="{{ filtro_cliente_id }}">
          <input
            type="text"
            id="cliente_busca_interesse"
            class="input input-bordered w-full"
            placeholder="Digite para buscar cliente..."
            value="{{ cliente_nome_prefill or '' }}"
            autocomplete="off"
            oninput="buscarClientesInteresse(this.value)"
            onfocus="mostrarResultadosInteresse()"
          >
          <div id="resultados_clientes_interesse" class="absolute z-50 w-full bg-base-100 shadow-xl rounded-lg mt-1 max-h-60 overflow-y-auto hidden border border-base-300"></div>
        </div>
      </div>

      <div class="form-control flex flex-row gap-2 items-end">
        <button type="submit" class="btn text-white btn-sm flex-1" style="background-color: #72cd80; border-color: #72cd80;">
          <i class="fas fa-filter mr-2"></i>Filtrar
        </button>
        <a href="{{ url_for('interesse_produto_listar') }}" class="btn btn-outline btn-sm">
          <i class="fas fa-times"></i>
        </a>
      </div>
    </form>
  </div>

  <div class="bg-base-100 rounded-xl shadow-lg overflow-hidden">
    {% if interesses %}
      <!-- Desktop -->
      <div class="hidden md:block overflow-x-auto">
        <table class="table table-xs w-full">
          <thead style="background-color: #72cd80;" class="text-white">
            <tr>
              <th class="text-left font-bold uppercase">Contato</th>
              <th class="text-left font-bold uppercase">Cliente</th>
              <th class="text-left font-bold uppercase">Tipo Produto</th>
              <th class="text-center font-bold uppercase w-32">Notificado</th>
              <th class="text-center font-bold uppercase w-32">Data Registro</th>
            </tr>
          </thead>
          <tbody>
            {% for interesse in interesses %}
            <tr class="hover">
              <td>
                <div class="font-semibold text-base-content">{{ interesse.nome_completo }}</div>
                <div class="text-xs text-base-content/60">{{ interesse.email }}</div>
              </td>
              <td>
                <span class="text-base-content">{{ interesse.nome_fantasia or interesse.razao_social or 'N/A' }}</span>
              </td>
              <td>
                <span class="badge badge-sm badge-outline">{{ interesse.tipo_produto }}</span>
              </td>
              <td class="text-center">
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
                  {% if interesse.notificado %}bg-green-100 text-green-800 border border-green-300{% else %}bg-yellow-100 text-yellow-700 border border-yellow-300{% endif %}">
                  {% if interesse.notificado %}
                    <i class="fas fa-check-circle mr-1 text-green-500"></i>Sim
                  {% else %}
                    <i class="fas fa-clock mr-1 text-yellow-500"></i>Não
                  {% endif %}
                </span>
              </td>
              <td class="text-center text-xs text-base-content/70">
                {{ interesse.data_registro.strftime('%d/%m/%Y %H:%M') if interesse.data_registro else '-' }}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Mobile -->
      <div class="md:hidden divide-y divide-base-300">
        {% for interesse in interesses %}
        <div class="p-4 hover:bg-base-200">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <div class="font-semibold text-base-content">{{ interesse.nome_completo }}</div>
              <div class="text-xs text-base-content/60">{{ interesse.email }}</div>
            </div>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold
              {% if interesse.notificado %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-700{% endif %}">
              {% if interesse.notificado %}
                <i class="fas fa-check-circle mr-1"></i>Notificado
              {% else %}
                <i class="fas fa-clock mr-1"></i>Pendente
              {% endif %}
            </span>
          </div>
          <div class="grid grid-cols-2 gap-2 text-xs mt-2">
            <div>
              <span class="text-base-content/60">Cliente:</span>
              <div class="font-medium">{{ interesse.nome_fantasia or interesse.razao_social or 'N/A' }}</div>
            </div>
            <div>
              <span class="text-base-content/60">Produto:</span>
              <div><span class="badge badge-sm badge-outline">{{ interesse.tipo_produto }}</span></div>
            </div>
          </div>
          {% if interesse.observacoes %}
          <div class="text-xs text-base-content/70 mt-2 p-2 bg-base-300 rounded">
            {{ interesse.observacoes }}
          </div>
          {% endif %}
          <div class="text-xs text-base-content/50 mt-2">
            <i class="fas fa-calendar mr-1"></i>{{ interesse.data_registro.strftime('%d/%m/%Y %H:%M') if interesse.data_registro else '-' }}
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-8">
        <p class="mb-2 text-base-content/60 text-sm">Nenhum interesse cadastrado com os filtros selecionados.</p>
        {% if filtro_tipo or filtro_notificado or filtro_cliente %}
        <a href="{{ url_for('interesse_produto_listar') }}" class="btn btn-outline btn-sm">
          <i class="fas fa-times mr-2"></i>Limpar Filtros
        </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Busca de clientes (mesma UX do briefing)
let timeoutIdInteresse = null;
let currentIndexInteresse = -1;

function buscarClientesInteresse(termo) {
  clearTimeout(timeoutIdInteresse);

  if (!termo || termo.length < 2) {
    document.getElementById('resultados_clientes_interesse').style.display = 'none';
    document.getElementById('cliente_id_interesse').value = '';
    return;
  }

  timeoutIdInteresse = setTimeout(() => {
    fetch('/api/clientes/buscar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome: termo, razao: termo })
    })
      .then(response => response.json())
      .then(data => {
        if (data && data.success) {
          renderizarResultadosInteresse(data.clientes || []);
        } else {
          renderizarResultadosInteresse([]);
        }
      })
      .catch(error => {
        console.error('Erro ao buscar clientes:', error);
      });
  }, 300);
}

function renderizarResultadosInteresse(clientes) {
  const resultadosDiv = document.getElementById('resultados_clientes_interesse');

  if (!clientes.length) {
    resultadosDiv.innerHTML = '<div class="p-2 text-sm text-gray-500">Nenhum cliente encontrado</div>';
    resultadosDiv.style.display = 'block';
    return;
  }

  resultadosDiv.innerHTML = clientes.map((cliente, index) => {
    const id = cliente.id_cliente || cliente.pk_id_tbl_cliente || '';
    const nome = cliente.nome_fantasia || '';
    const razao = cliente.razao_social || '';
    return `
    <div class="p-2 hover:bg-base-200 cursor-pointer border-b border-base-300 last:border-b-0 cliente-resultado-interesse"
         data-index="${index}"
         onclick="selecionarClienteInteresse('${id}', '${nome.replace(/'/g, "\\'")}')">
      <div class="font-medium">${nome}</div>
      <div class="text-sm text-gray-500">${razao}</div>
    </div>
  `;}).join('');

  resultadosDiv.style.display = 'block';
  currentIndexInteresse = -1;
}

function selecionarClienteInteresse(id, nome) {
  document.getElementById('cliente_id_interesse').value = id;
  document.getElementById('cliente_busca_interesse').value = nome;
  document.getElementById('resultados_clientes_interesse').style.display = 'none';
}

function mostrarResultadosInteresse() {
  const resultadosDiv = document.getElementById('resultados_clientes_interesse');
  if (resultadosDiv.innerHTML.trim() !== '') {
    resultadosDiv.style.display = 'block';
  }
}

// Fechar dropdown ao clicar fora
document.addEventListener('click', function(event) {
  const campo = document.getElementById('cliente_busca_interesse');
  const resultados = document.getElementById('resultados_clientes_interesse');

  if (campo && resultados) {
    if (!campo.contains(event.target) && !resultados.contains(event.target)) {
      resultados.style.display = 'none';
    }
  }
});

// Navegar com teclado
document.getElementById('cliente_busca_interesse').addEventListener('keydown', function(e) {
  const resultadosDiv = document.getElementById('resultados_clientes_interesse');
  const resultados = resultadosDiv.querySelectorAll('.cliente-resultado-interesse');

  if (!resultados.length) return;

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    currentIndexInteresse = (currentIndexInteresse + 1) % resultados.length;
    atualizarSelecaoInteresse(resultados);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    currentIndexInteresse = currentIndexInteresse <= 0 ? resultados.length - 1 : currentIndexInteresse - 1;
    atualizarSelecaoInteresse(resultados);
  } else if (e.key === 'Enter' && currentIndexInteresse >= 0) {
    e.preventDefault();
    resultados[currentIndexInteresse].click();
  } else if (e.key === 'Escape') {
    resultadosDiv.style.display = 'none';
    currentIndexInteresse = -1;
  }
});

function atualizarSelecaoInteresse(resultados) {
  resultados.forEach((el, idx) => {
    if (idx === currentIndexInteresse) {
      el.classList.add('bg-base-200');
      el.scrollIntoView({ block: 'nearest' });
    } else {
      el.classList.remove('bg-base-200');
    }
  });
}

// Limpar cliente_id quando o usuário altera o texto
document.getElementById('cliente_busca_interesse').addEventListener('input', function() {
  document.getElementById('cliente_id_interesse').value = '';
});
</script>
{% endblock %}
