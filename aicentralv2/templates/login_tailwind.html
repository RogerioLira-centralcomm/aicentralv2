{% extends "base_auth.html" %}

{% block title %}Login - CentralX v2{% endblock %}

{% block styles %}
<style>
    /* Reset e Base */
    * {
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Background Gradient Animado */
    .animated-gradient {
        background: linear-gradient(-45deg, #1a1f2e, #0f1419, #1E4D4F, #153638);
        background-size: 400% 400%;
        animation: gradientShift 15s ease infinite;
    }
    
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    
    /* Floating Shapes Modernos */
    .floating-shapes .shape {
        position: absolute;
        border-radius: 50%;
        opacity: 0.05;
        animation: float 20s infinite ease-in-out;
        filter: blur(40px);
    }
    
    .floating-shapes .shape-1 {
        width: 300px;
        height: 300px;
        background: linear-gradient(135deg, #9CCF31, #F3B71B);
        top: -10%;
        left: -10%;
        animation-delay: 0s;
    }
    
    .floating-shapes .shape-2 {
        width: 200px;
        height: 200px;
        background: linear-gradient(135deg, #1E4D4F, #2A6D70);
        top: 50%;
        left: -5%;
        animation-delay: 3s;
    }
    
    .floating-shapes .shape-3 {
        width: 250px;
        height: 250px;
        background: linear-gradient(135deg, #2A6D70, #153638);
        top: 10%;
        right: -10%;
        animation-delay: 6s;
    }
    
    .floating-shapes .shape-4 {
        width: 180px;
        height: 180px;
        background: linear-gradient(135deg, #F3B71B, #9CCF31);
        bottom: 10%;
        right: -5%;
        animation-delay: 9s;
    }
    
    @keyframes float {
        0%, 100% {
            transform: translate(0, 0) rotate(0deg) scale(1);
        }
        33% {
            transform: translate(30px, -30px) rotate(120deg) scale(1.1);
        }
        66% {
            transform: translate(-20px, 20px) rotate(240deg) scale(0.9);
        }
    }
    
    /* Input Styles */
    .input-group {
        position: relative;
    }
    
    .input-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        z-index: 10;
        pointer-events: none;
        transition: color 0.2s;
    }
    
    .input-with-icon {
        padding-left: 2.75rem !important;
        padding-right: 2.75rem;
        transition: all 0.2s;
    }
    
    .input-with-icon:focus + .input-icon {
        color: #1E4D4F;
    }
    
    .password-toggle {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        cursor: pointer;
        transition: color 0.2s;
        padding: 0.25rem;
        border-radius: 0.25rem;
    }
    
    .password-toggle:hover {
        color: #1E4D4F;
        background-color: rgba(30, 77, 79, 0.05);
    }
    
    /* Checkbox Custom */
    .checkbox-custom {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.125rem;
        height: 1.125rem;
        border: 2px solid #d1d5db;
        border-radius: 0.25rem;
        background-color: white;
        margin-right: 0.625rem;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .checkbox-custom:hover {
        border-color: #1E4D4F;
    }
    
    input[type="checkbox"]:checked + .checkbox-custom {
        background-color: #1E4D4F;
        border-color: #1E4D4F;
        transform: scale(1.05);
    }
    
    input[type="checkbox"]:checked + .checkbox-custom i {
        display: block;
        color: white;
        font-size: 0.625rem;
    }
    
    .checkbox-custom i {
        display: none;
    }
    
    /* Loading States */
    .spinner {
        width: 1.25rem;
        height: 1.25rem;
        border: 2px solid white;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Modal Styles */
    .modal-backdrop {
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
    }
    
    .modal-content {
        animation: slideUp 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Responsive */
    @media (max-width: 640px) {
        .floating-shapes .shape {
            filter: blur(60px);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Background Animado -->
<div class="fixed inset-0 z-0 animated-gradient overflow-hidden">
    <div class="floating-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>
</div>

<!-- Container de Login -->
<div class="min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8 py-8 sm:py-12 relative z-10">
    <!-- Card de Login Principal -->
    <div class="w-full max-w-md">
        <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-2xl overflow-hidden transition-all duration-300 hover:shadow-[0_20px_60px_rgba(0,0,0,0.3)] animate-fade-in">
            <!-- Seção do Logo -->
            <div class="p-6 sm:p-8 text-center bg-base-100 border-b border-gray-100">
                <div class="flex items-center justify-center mb-4 gap-3">
                    <img src="{{ url_for('static', filename='images/cc_logo.png') }}" alt="CentralComm" class="h-16 w-auto"
                        />
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">CentralX v2</h1>
                        <p class="text-xs text-gray-500 mt-0.5">AI Central</p>
                    </div>
                </div>
                <p class="text-sm text-gray-600">Plataforma de Gestão Corporativa</p>
            </div>

            <!-- Mensagens Flash (ocultas - usaremos modais) -->
            <div id="flashMessages" class="hidden">
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div data-category="{{ category }}" data-message="{{ message }}"></div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
            </div>

            <!-- Formulário de Login -->
            <form action="{{ url_for('login') }}" class="p-6 sm:p-8" id="loginForm" method="POST" autocomplete="off">
                <!-- Campo de Email -->
                <div class="mb-5">
                    <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-envelope text-gray-400 mr-1.5"></i>
                        Email
                    </label>
                    <div class="input-group">
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            placeholder="seu.email@empresa.com"
                            required
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            data-form-type="other"
                            data-lpignore="true"
                            data-1p-ignore
                            value="{{ request.form.get('email', '') }}"
                            class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm"
                        >
                        <div class="input-icon">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                    </div>
                </div>

                <!-- Campo de Senha -->
                <div class="mb-6">
                    <label for="password_visible" class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-lock text-gray-400 mr-1.5"></i>
                        Senha
                    </label>
                    <div class="input-group">
                        <!-- Campo REAL enviado no POST (oculto) -->
                        <input type="password" id="real_password" name="password" aria-hidden="true" style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;" autocomplete="off">
                        <!-- Campo VISÍVEL usado pelo usuário -->
                        <input 
                            type="text" 
                            id="password_visible" 
                            name="password_visible" 
                            placeholder="Digite sua senha"
                            required
                            autocomplete="off"
                            autocapitalize="off"
                            autocorrect="off"
                            spellcheck="false"
                            data-form-type="other"
                            data-lpignore="true"
                            data-1p-ignore
                            class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm"
                            style="-webkit-text-security: disc;"
                        >
                        <div class="input-icon">
                            <i class="fas fa-key text-sm"></i>
                        </div>
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye text-sm" id="toggleIcon"></i>
                        </button>
                    </div>
                </div>

                <!-- Opções do Formulário -->
                <div class="flex items-center justify-between mb-6 sm:mb-8">
                    <label class="flex items-center cursor-pointer group">
                        <input type="checkbox" id="remember" name="remember" class="sr-only">
                        <span class="checkbox-custom">
                            <i class="fas fa-check"></i>
                        </span>
                        <span class="text-sm text-gray-600 group-hover:text-gray-900 transition-colors">Lembrar-me</span>
                    </label>
                    <a href="{{ url_for('forgot_password') }}" class="text-sm text-primary hover:text-primary-dark transition-colors font-medium">
                        Esqueceu a senha?
                    </a>
                </div>

                <!-- Botão de Envio -->
                <button type="submit" id="submitBtn" class="w-full bg-primary hover:bg-primary-focus text-white font-semibold py-3.5 px-6 rounded-lg transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center">
                    <span id="btnText" class="flex items-center">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Entrar
                    </span>
                    <div id="btnLoading" class="hidden">
                        <div class="spinner mx-auto"></div>
                    </div>
                </button>
            </form>

            <!-- Informações Adicionais -->
            <div class="px-6 sm:px-8 py-4 bg-base-200 border-t border-gray-100">
                <div class="flex items-center justify-center space-x-6 text-xs text-gray-500">
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt mr-1.5 text-primary"></i>
                        <span>Conexão Segura</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-lock mr-1.5 text-primary"></i>
                        <span>Dados Criptografados</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Versão -->
        <div class="mt-6 text-center">
            <p class="text-xs text-white/60">
                CentralX v2.0 © 2026 CentralComm
            </p>
        </div>
    </div>
</div>

<!-- Botão de Suporte Flutuante -->
<button onclick="openWhatsAppSupport()" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-2xl transition-all hover:shadow-green-500/50 hover:scale-110 group z-50">
    <i class="fab fa-whatsapp text-2xl"></i>
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-xs py-2 px-3 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap shadow-xl">
        <i class="fas fa-headset mr-1"></i>
        Suporte TI
    </span>
</button>

<!-- Modal de Feedback -->
<div id="feedbackModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 hidden modal-backdrop">
    <div class="bg-white rounded-2xl p-6 sm:p-8 max-w-sm w-full mx-4 shadow-2xl modal-content">
        <div class="text-center">
            <!-- Ícone -->
            <div id="modalIcon" class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center">
                <i id="modalIconClass" class="text-3xl"></i>
            </div>
            
            <!-- Título -->
            <h3 id="modalTitle" class="text-xl font-bold text-gray-900 mb-2"></h3>
            
            <!-- Mensagem -->
            <p id="modalMessage" class="text-gray-600 mb-6"></p>
            
            <!-- Botão -->
            <button onclick="closeModal()" class="w-full bg-primary hover:bg-primary-dark text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg">
                <i class="fas fa-check mr-2"></i>
                Entendi
            </button>
        </div>
    </div>
</div>

<!-- Overlay de Carregamento -->
<div class="fixed inset-0 bg-black/60 backdrop-blur-sm items-center justify-center z-50 hidden" id="loadingOverlay">
    <div class="bg-white rounded-2xl p-8 max-w-xs w-full mx-4 text-center shadow-2xl">
        <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-700 font-semibold mb-1">Autenticando...</p>
        <p class="text-gray-500 text-sm">Aguarde um momento</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ========== Funções de Modal ==========
    function showModal(type, title, message) {
        const modal = document.getElementById('feedbackModal');
        const modalIcon = document.getElementById('modalIcon');
        const modalIconClass = document.getElementById('modalIconClass');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        
        // Configurar ícone e cores baseado no tipo
        modalIcon.className = 'w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center';
        
        if (type === 'error') {
            modalIcon.classList.add('bg-red-100');
            modalIconClass.className = 'fas fa-exclamation-circle text-3xl text-red-600';
        } else if (type === 'success') {
            modalIcon.classList.add('bg-green-100');
            modalIconClass.className = 'fas fa-check-circle text-3xl text-green-600';
        } else if (type === 'warning') {
            modalIcon.classList.add('bg-yellow-100');
            modalIconClass.className = 'fas fa-exclamation-triangle text-3xl text-yellow-600';
        } else {
            modalIcon.classList.add('bg-blue-100');
            modalIconClass.className = 'fas fa-info-circle text-3xl text-blue-600';
        }
        
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }
    
    function closeModal() {
        const modal = document.getElementById('feedbackModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
    
    // ========== Toggle de Senha ==========
    function togglePassword() {
        const passwordInput = document.getElementById('password_visible');
        const toggleIcon = document.getElementById('toggleIcon');
        if (!passwordInput) return;
        
        const revealed = passwordInput.dataset.revealed === '1';
        if (revealed) {
            passwordInput.style.webkitTextSecurity = 'disc';
            passwordInput.dataset.revealed = '0';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        } else {
            passwordInput.style.webkitTextSecurity = 'none';
            passwordInput.dataset.revealed = '1';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        }
    }
    
    // ========== Suporte WhatsApp ==========
    function openWhatsAppSupport() {
        window.open('https://wa.me/5511999999999?text=Olá,%20preciso%20de%20suporte%20com%20o%20CentralX.', '_blank');
    }
    
    // ========== Inicialização ==========
    document.addEventListener('DOMContentLoaded', function() {
        // Sincronizar campos de senha
        const pwdVisible = document.getElementById('password_visible');
        const pwdReal = document.getElementById('real_password');
        
        if (pwdVisible && pwdReal) {
            pwdVisible.value = '';
            pwdReal.value = '';
            
            const sync = () => { pwdReal.value = pwdVisible.value; };
            ['input', 'change', 'keyup', 'paste'].forEach(ev => {
                pwdVisible.addEventListener(ev, sync);
            });
            
            // Inicializar mascarado
            pwdVisible.style.webkitTextSecurity = 'disc';
            pwdVisible.dataset.revealed = '0';
        }
        
        // Verificar e exibir mensagens flash em modal
        const flashMessages = document.querySelectorAll('#flashMessages > div');
        if (flashMessages.length > 0) {
            flashMessages.forEach(msg => {
                const category = msg.dataset.category;
                const message = msg.dataset.message;
                
                let title = 'Informação';
                if (category === 'error') title = 'Erro de Autenticação';
                else if (category === 'success') title = 'Sucesso';
                else if (category === 'warning') title = 'Atenção';
                
                showModal(category, title, message);
            });
        }
        
        // Adicionar animação de entrada nos inputs
        const inputs = document.querySelectorAll('input[type="email"], input[type="text"]');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('scale-[1.01]');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('scale-[1.01]');
            });
        });
    });
    
    // ========== Validação e Envio do Formulário ==========
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password_visible');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnLoading = document.getElementById('btnLoading');
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        let valid = true;
        let errorMessage = '';
        
        // Validar email
        if (!emailInput.value.trim()) {
            errorMessage = 'Por favor, informe seu email.';
            valid = false;
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim())) {
            errorMessage = 'Por favor, informe um email válido.';
            valid = false;
        }
        
        // Validar senha
        if (valid && (!passwordInput || !passwordInput.value)) {
            errorMessage = 'Por favor, informe sua senha.';
            valid = false;
        }
        
        if (!valid) {
            showModal('error', 'Campos Obrigatórios', errorMessage);
            return;
        }
        
        // Sincronizar senha real
        const pwdVisible = document.getElementById('password_visible');
        const pwdReal = document.getElementById('real_password');
        if (pwdVisible && pwdReal) {
            pwdReal.value = pwdVisible.value;
        }
        
        // Mostrar loading
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        
        // Enviar formulário
        this.submit();
    });
    
    // ========== Fechar modal com ESC ==========
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });
    
    // ========== Fechar modal clicando fora ==========
    document.getElementById('feedbackModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });
</script>
{% endblock %}
