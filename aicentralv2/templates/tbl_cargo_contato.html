{% extends "base_tailwind.html" %}

{% block title %}Cargos - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (max 66px) estilo CRM -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Título -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Cargos</h1>
        {% if cargos %}<span class="text-xs text-gray-500">({{ cargos|length }} registros)</span>{% endif %}
      </div>
      
      <!-- Busca Inline -->
      <div class="flex items-center gap-3">
        <input type="text" id="searchInput" placeholder="Buscar cargo..." 
               class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 180px;">
      </div>
      
      <!-- Botões -->
      <div class="flex gap-2">
        <button onclick="window.location.reload()" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">
          <i class="fas fa-sync-alt mr-1"></i>Atualizar
        </button>
        <button onclick="openCreateModal()" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
          <i class="fas fa-plus mr-1"></i>Novo Cargo
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="p-3 rounded-lg text-sm
            {%- if category == 'success' %} bg-green-100 text-green-800
            {%- elif category == 'error' %} bg-red-100 text-red-800
            {%- else %} bg-gray-100 text-gray-800
            {%- endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabela de Cargos -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="tabela_cargos">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">ID</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Descrição</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Setor</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Status</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Data Cadastro</th>
            <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-24">Ações</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="cargosTableBody">
          {% for cargo in cargos %}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-2 px-3 text-gray-600 font-medium">{{ cargo.id_cargo_contato }}</td>
            <td class="py-2 px-3 text-gray-800">{{ cargo.descricao }}</td>
            <td class="py-2 px-3 text-gray-500">{{ cargo.setor_display or 'Nenhum' }}</td>
            <td class="py-2 px-3">
              <span class="px-2 py-0.5 text-xs font-medium rounded-full {% if cargo.status %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {{ "Ativo" if cargo.status else "Inativo" }}
              </span>
            </td>
            <td class="py-2 px-3 text-gray-500">
              {{ cargo.data_cadastro.strftime('%d/%m/%Y %H:%M') }}
            </td>
            <td class="py-2 px-3">
              <div class="flex items-center justify-center gap-2">
                {% set cargo_json = {
                    'id_cargo_contato': cargo.id_cargo_contato,
                    'descricao': cargo.descricao,
                    'pk_id_aux_setor': cargo.pk_id_aux_setor,
                    'id_centralx': cargo.id_centralx,
                    'indice': cargo.indice,
                    'status': cargo.status
                }|tojson|safe %}
                <button onclick='openEditModal({{ cargo_json }})' 
                    class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                    title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="toggleStatus({{ cargo.id_cargo_contato }}, {{ cargo.status|tojson }})" 
                    class="p-2 {% if cargo.status %}text-red-600 hover:text-red-800 hover:bg-red-50{% else %}text-green-600 hover:text-green-800 hover:bg-green-50{% endif %} rounded transition-colors"
                    title="{% if cargo.status %}Desativar{% else %}Ativar{% endif %}">
                    <i class="fas {% if cargo.status %}fa-times-circle{% else %}fa-check-circle{% endif %}"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal de Criação/Edição -->
<dialog id="modal_cargo" class="modal">
  <div class="modal-box w-11/12 max-w-lg bg-white p-0 rounded-lg">
    <!-- Header fixo -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h3 class="font-semibold text-lg text-gray-800" id="modalTitle">Novo Cargo</h3>
      <button onclick="closeModal()" class="p-2 hover:bg-gray-200 rounded transition-colors">
        <i class="fa-solid fa-xmark text-gray-500"></i>
      </button>
    </div>
    
    <!-- Conteúdo -->
    <div class="p-6">
      <form id="cargoForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="cargoId" name="id_cargo_contato">
        
        <div class="mb-4">
          <label for="descricao" class="block text-sm font-medium text-gray-700 mb-1">
            Descrição <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="descricao" 
                 name="descricao" 
                 required
                 maxlength="60"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
        </div>

        <div class="mb-4">
          <label for="setor" class="block text-sm font-medium text-gray-700 mb-1">
            Setor <span class="text-red-500">*</span>
          </label>
          <select id="setor" 
                  name="pk_id_aux_setor" 
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
            <option value="">Selecione um setor</option>
            {% for setor in setores %}
              <option value="{{ setor.id_setor }}">{{ setor.display }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-4">
          <label for="id_centralx" class="block text-sm font-medium text-gray-700 mb-1">
            ID CentralX
          </label>
          <input type="text" 
                 id="id_centralx" 
                 name="id_centralx" 
                 maxlength="100"
                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
        </div>

        <div class="mb-4">
          <label for="indice" class="block text-sm font-medium text-gray-700 mb-1">
            Índice
          </label>
          <input type="number" 
                 id="indice" 
                 name="indice" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
        </div>
        
        <div class="mb-4">
          <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
            Status
          </label>
          <select id="status" 
                  name="status" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
            <option value="true">Ativo</option>
            <option value="false">Inativo</option>
          </select>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" 
                  onclick="closeModal()"
                  class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">
            Cancelar
          </button>
          <button type="submit" 
                  class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
            Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50"><button>close</button></form>
</dialog>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tbl_cargo_contato.js') }}"></script>
{% endblock %}
