{% extends "base_tailwind.html" %}

{% block title %}Setores - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-full mx-auto px-2">
  <!-- Header Compacto (max 66px) estilo CRM -->
  <div class="bg-white border-b border-gray-200 px-4 py-2 mb-3 sticky top-0 z-40" style="max-height: 66px;">
    <div class="flex items-center justify-between gap-4">
      <!-- Título -->
      <div class="flex items-center gap-4">
        <h1 class="text-lg font-semibold text-gray-800">Setores</h1>
        {% if setores %}<span class="text-xs text-gray-500">({{ setores|length }} registros)</span>{% endif %}
      </div>
      
      <!-- Busca Inline -->
      <div class="flex items-center gap-3">
        <input type="text" id="searchInput" placeholder="Buscar setor..." 
               class="text-sm bg-gray-50 border border-gray-200 rounded px-3 py-1.5 text-gray-700 focus:outline-none focus:border-gray-400" style="min-width: 180px;">
      </div>
      
      <!-- Botões -->
      <div class="flex gap-2">
        <button onclick="window.location.reload()" class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">
          <i class="fas fa-sync-alt mr-1"></i>Atualizar
        </button>
        <button onclick="openCreateModal()" class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
          <i class="fas fa-plus mr-1"></i>Novo Setor
        </button>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4 space-y-2">
        {% for category, message in messages %}
          <div class="p-3 rounded-lg text-sm
            {%- if category == 'success' %} bg-green-100 text-green-800
            {%- elif category == 'error' %} bg-red-100 text-red-800
            {%- else %} bg-gray-100 text-gray-800
            {%- endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Tabela de Setores -->
  <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full text-sm" id="tabela_setores">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">ID</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Display</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Status</th>
            <th class="text-left py-2 px-3 text-xs font-medium text-gray-600 uppercase">Data Cadastro</th>
            <th class="text-center py-2 px-3 text-xs font-medium text-gray-600 uppercase w-24">Ações</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100" id="setoresTableBody">
          {% for setor in setores %}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="py-2 px-3 text-gray-600 font-medium">{{ setor.id_setor }}</td>
            <td class="py-2 px-3 text-gray-800">{{ setor.display }}</td>
            <td class="py-2 px-3">
              <span class="px-2 py-0.5 text-xs font-medium rounded-full {% if setor.status %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {{ "Ativo" if setor.status else "Inativo" }}
              </span>
            </td>
            <td class="py-2 px-3 text-gray-500">
              {{ setor.data_cadastro.strftime('%d/%m/%Y %H:%M') if setor.data_cadastro else '' }}
            </td>
            <td class="py-2 px-3">
              <div class="flex items-center justify-center gap-2">
                <button 
                    data-id="{{ setor.id_setor }}"
                    data-display="{{ setor.display }}"
                    data-status="{{ 'true' if setor.status else 'false' }}"
                    onclick="openEditModalFromButton(this)"
                    class="p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded transition-colors"
                    title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button 
                    data-id="{{ setor.id_setor }}"
                    data-status="{{ 'true' if setor.status else 'false' }}"
                    onclick="toggleStatusFromButton(this)" 
                    class="p-2 {% if setor.status %}text-red-600 hover:text-red-800 hover:bg-red-50{% else %}text-green-600 hover:text-green-800 hover:bg-green-50{% endif %} rounded transition-colors"
                    title="{% if setor.status %}Desativar{% else %}Ativar{% endif %}">
                    <i class="fas {% if setor.status %}fa-times-circle{% else %}fa-check-circle{% endif %}"></i>
                </button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal de Criação/Edição -->
<dialog id="modal_setor" class="modal">
  <div class="modal-box w-11/12 max-w-lg bg-white p-0 rounded-lg">
    <!-- Header fixo -->
    <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
      <h3 class="font-semibold text-lg text-gray-800" id="modalTitle">Novo Setor</h3>
      <button onclick="closeModal()" class="p-2 hover:bg-gray-200 rounded transition-colors">
        <i class="fa-solid fa-xmark text-gray-500"></i>
      </button>
    </div>
    
    <!-- Conteúdo -->
    <div class="p-6">
      <form id="setorForm" onsubmit="handleSubmit(event)">
        <input type="hidden" id="setorId" name="id_setor">
        
        <div class="mb-4">
          <label for="display" class="block text-sm font-medium text-gray-700 mb-1">
            Display <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="display" 
                 name="display" 
                 required
                 class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
        </div>
        
        <div class="mb-4">
          <label for="status" class="block text-sm font-medium text-gray-700 mb-1">
            Status
          </label>
          <select id="status" 
                  name="status" 
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-gray-400 focus:border-gray-400">
            <option value="true">Ativo</option>
            <option value="false">Inativo</option>
          </select>
        </div>
        
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" 
                  onclick="closeModal()"
                  class="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 text-gray-700 transition-colors">
            Cancelar
          </button>
          <button type="submit" 
                  class="px-3 py-1.5 text-sm bg-gray-800 text-white rounded hover:bg-gray-700 transition-colors">
            Salvar
          </button>
        </div>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop bg-black/50"><button>close</button></form>
</dialog>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/tbl_setor.js') }}"></script>
<script>
  function openEditModalFromButton(btn) {
    const setor = {
      id_setor: parseInt(btn.dataset.id, 10),
      display: btn.dataset.display,
      status: btn.dataset.status === 'true'
    };
    if (typeof openEditModal === 'function') {
      openEditModal(setor);
    }
  }
  
  function toggleStatusFromButton(btn) {
    const id = parseInt(btn.dataset.id, 10);
    const status = btn.dataset.status === 'true';
    if (typeof toggleStatus === 'function') {
      toggleStatus(id, status);
    }
  }
</script>
{% endblock %}
