{% extends 'base_tailwind.html' %}

{% block title %}Analisador de Audiência - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Analisador de Audiência IA</h1>
      <p class="text-sm text-base-content/70 mt-1">Extração inteligente de dados de imagens de audiências</p>
    </div>
    
    <!-- Steps -->
    <div class="hidden lg:flex items-center gap-2">
      <div class="flex items-center gap-2">
        <div class="badge badge-primary badge-lg">1</div>
        <span class="text-sm font-medium">Upload</span>
      </div>
      <i class="fas fa-chevron-right text-xs text-base-content/30"></i>
      <div class="flex items-center gap-2">
        <div class="badge badge-ghost badge-lg">2</div>
        <span class="text-sm text-base-content/70">Análise</span>
      </div>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Layout em Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- CARD 1: Upload & Configuração -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">
          <i class="fas fa-upload text-primary"></i>
          Upload da Audiência
        </h2>
        <div class="divider my-1"></div>
        
        <form id="upAudienciaForm" method="POST" enctype="multipart/form-data" class="space-y-4">
          
          <!-- Plataforma -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Plataforma</span>
            </label>
            <select id="platform" name="platform" class="select select-bordered w-full">
              <option value="google-dv360">Google DV360</option>
              <option value="meta-ads">Meta Ads Manager</option>
              <option value="google-ads">Google Ads</option>
              <option value="linkedin-ads">LinkedIn Ads</option>
              <option value="tiktok-ads">TikTok Ads</option>
            </select>
          </div>

          <!-- Drag & Drop Zone -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Imagem da Audiência</span>
            </label>
            <div id="dropZone" class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary hover:bg-base-200/50 transition-all">
              <input id="upimagem" type="file" name="upimagem" accept="image/*" class="hidden" required />
              <div id="dropZoneContent">
                <i class="fas fa-cloud-upload-alt text-5xl text-base-content/30 mb-3"></i>
                <p class="font-medium text-base-content mb-1">Arraste a imagem aqui</p>
                <p class="text-sm text-base-content/60 mb-3">ou clique para selecionar</p>
                <button type="button" id="chooseFileBtn" class="btn btn-sm btn-outline">
                  <i class="fas fa-folder-open mr-2"></i>
                  Escolher Arquivo
                </button>
              </div>
              <div id="imagePreview" class="hidden">
                <img id="previewImg" src="" alt="Preview" class="max-h-48 mx-auto rounded-lg shadow-md mb-3" />
                <p id="fileName" class="font-medium text-base-content mb-2"></p>
                <button type="button" onclick="clearImage()" class="btn btn-sm btn-error btn-outline">
                  <i class="fas fa-times mr-2"></i>Remover
                </button>
              </div>
            </div>
          </div>

          <!-- Prompt (Collapsible) -->
          <div class="form-control">
            <details class="collapse collapse-arrow bg-base-200">
              <summary class="collapse-title text-sm font-semibold cursor-pointer">
                <i class="fas fa-magic mr-2"></i>Prompt de Extração (Avançado)
              </summary>
              <div class="collapse-content">
                <textarea id="prompt" name="prompt" rows="12" class="textarea textarea-bordered w-full text-sm font-mono" placeholder="Digite seu prompt personalizado...">Você é um assistente especialista em análise de dados de publicidade digital. Sua tarefa é analisar uma imagem de uma plataforma de anúncios, extrair informações de audiência e estruturá-las em um formato JSON específico, seguindo rigorosamente as regras abaixo.

*REGRAS DE EXTRAÇÃO E PROCESSAMENTO:*

1. *Análise de Segmentos (segments):*
   * source: Extraia o prefixo de texto que identifica a origem do dado (ex: "OAN", "LiveRamp","Navegg","Semasio").
   * id: Extraia APENAS a sequência numérica do identificador do segmento.
   * name_original: Copie a string completa do nome do segmento.
   * name_ptbr_normalized: Crie uma descrição clara e acionável em Português-Brasil, focando na intenção e perfil do público, não em uma tradução literal.
   * cpm: Extraia o valor numérico do Custo Por Mil. Assuma a moeda como "BRL" se o símbolo for "R$".
   * categories: Atribua categorias como type, industry, interest, etc., com base na sua interpretação do nome.

2. *Análise do Resumo (audienceSummary):*
   * Extraia valores como overallReach, convertendo abreviações como "M" para seu valor numérico completo (ex: "26.3M" se torna 26300000).

3. *Análise Demográfica (demographics):*
   * Analise os gráficos e estime as porcentagens para gender, age, e devices.

*FORMATO DE SAÍDA OBRIGATÓRIO:*

Sua resposta deve ser *APENAS o objeto JSON*, sem nenhum texto ou explicação adicional. Preencha todos os campos possíveis e use null para informações não encontradas. A resposta deve ser um JSON válido.
Retorne apenas o JSON limpo e estruturado.</textarea>
                <p class="label-text-alt mt-2 text-base-content/60">Personalize o prompt para extrações específicas</p>
              </div>
            </details>
          </div>

          <!-- Modelo LLM -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Modelo IA</span>
            </label>
            <select id="model" name="model" class="select select-bordered w-full">
              {% set sel_model = selected_model_id or '' %}
              {% for m in models or [] %}
                <option value="{{ m.id }}" {% if m.id == sel_model %}selected{% endif %}>{{ m.label or m.id }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Submit Button -->
          <div class="card-actions justify-end pt-4">
            <button id="submitBtn" type="submit" class="btn btn-primary w-full" disabled>
              <i class="fas fa-magic mr-2"></i>
              Analisar Imagem
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- CARD 2: Análise & Resultados -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">
          <i class="fas fa-chart-line text-success"></i>
          Análise & Resultados
        </h2>
        <div class="divider my-1"></div>
        
        {% if result %}
          <!-- Status Success -->
          <div class="alert alert-success">
            <i class="fas fa-check-circle text-xl"></i>
            <div>
              <h3 class="font-semibold">Análise Concluída!</h3>
              <p class="text-sm">Dados extraídos com sucesso</p>
            </div>
          </div>

          <!-- Metrics -->
          {% if result.usage or result.cost_usd is not none %}
          <div class="stats shadow w-full">
            <div class="stat">
              <div class="stat-title">Tokens</div>
              <div class="stat-value text-2xl">{{ result.usage.total_tokens if result.usage else '—' }}</div>
            </div>
            <div class="stat">
              <div class="stat-title">Custo (USD)</div>
              <div class="stat-value text-2xl">{% if result.cost_usd is not none %}${{ '%.3f'|format(result.cost_usd) }}{% else %}—{% endif %}</div>
            </div>
          </div>
          {% endif %}

          <!-- JSON Viewer -->
          <div class="card bg-base-200 shadow-sm">
            <div class="card-body p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-sm">Dados Extraídos (JSON)</h4>
                <button type="button" id="copyJsonBtn" class="btn btn-xs btn-ghost">
                  <i class="fas fa-copy mr-1"></i>Copiar
                </button>
              </div>
              <div class="max-h-96 overflow-y-auto">
                <pre id="json_output" class="text-xs font-mono bg-base-100 p-3 rounded">{{ result.json_text | safe }}</pre>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions justify-end gap-2">
            <button type="button" onclick="retryAnalysis()" class="btn btn-ghost btn-sm">
              <i class="fas fa-redo mr-2"></i>Nova Análise
            </button>
          </div>

        {% else %}
          <!-- Empty State -->
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <i class="fas fa-robot text-6xl text-base-content/20 mb-4"></i>
            <p class="font-medium text-base-content/70">Aguardando análise...</p>
            <p class="text-sm text-base-content/50 mt-1">Faça upload de uma imagem para começar</p>
          </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- Loading Overlay -->
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 hidden" id="loadingOverlay">
  <div class="card bg-base-100 shadow-xl max-w-xs">
    <div class="card-body items-center text-center">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="font-medium mt-4">Processando imagem...</p>
      <p class="text-sm text-base-content/60">Aguarde enquanto a IA analisa</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('upimagem');
  const dropZone = document.getElementById('dropZone');
  const dropZoneContent = document.getElementById('dropZoneContent');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const fileName = document.getElementById('fileName');
  const promptEl = document.getElementById('prompt');
  const submitBtn = document.getElementById('submitBtn');
  const chooseFileBtn = document.getElementById('chooseFileBtn');

  // Drag & Drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('border-primary', 'bg-primary/10');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('border-primary', 'bg-primary/10');
    }, false);
  });

  dropZone.addEventListener('drop', handleDrop, false);
  
  // Clique no botão abre o seletor de arquivo
  if (chooseFileBtn) {
    chooseFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      input.click();
    });
  }
  
  // Clique na área de drop também abre (exceto quando já tem preview)
  dropZone.addEventListener('click', (e) => {
    if (!imagePreview.classList.contains('hidden')) {
      return; // Não faz nada se já tem preview
    }
    if (e.target !== chooseFileBtn && !chooseFileBtn.contains(e.target)) {
      input.click();
    }
  });

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) {
      input.files = files;
      handleFiles(files);
    }
  }

  input.addEventListener('change', function() {
    if (this.files.length) {
      handleFiles(this.files);
    }
  });

  function handleFiles(files) {
    const file = files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        fileName.textContent = file.name;
        dropZoneContent.classList.add('hidden');
        imagePreview.classList.remove('hidden');
        updateSubmitState();
      };
      reader.readAsDataURL(file);
    }
  }

  window.clearImage = function() {
    input.value = '';
    previewImg.src = '';
    fileName.textContent = '';
    dropZoneContent.classList.remove('hidden');
    imagePreview.classList.add('hidden');
    updateSubmitState();
  };

  // Update Submit State
  function updateSubmitState() {
    const okPrompt = !!(promptEl && promptEl.value && promptEl.value.trim().length > 0);
    const okFile = !!(input && input.files && input.files.length > 0);
    const can = okPrompt && okFile;
    if (submitBtn) {
      submitBtn.disabled = !can;
    }
  }

  if (promptEl) {
    ['input','change','keyup','paste'].forEach(ev => promptEl.addEventListener(ev, updateSubmitState));
  }
  updateSubmitState();

  // Copiar JSON
  const copyBtn = document.getElementById('copyJsonBtn');
  const jsonOutput = document.getElementById('json_output');
  if (copyBtn && jsonOutput) {
    copyBtn.addEventListener('click', async () => {
      try {
        const text = jsonOutput.textContent || jsonOutput.innerText;
        await navigator.clipboard.writeText(text);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Copiado!';
        copyBtn.classList.add('btn-success');
        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.classList.remove('btn-success');
        }, 2000);
      } catch (e) {
        console.error('Erro ao copiar:', e);
      }
    });
  }

  // Retry Analysis
  window.retryAnalysis = function() {
    window.location.reload();
  };

  // Loading Overlay on Submit
  const form = document.getElementById('upAudienciaForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (form && loadingOverlay) {
    form.addEventListener('submit', function(e) {
      if (!submitBtn || submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      loadingOverlay.classList.remove('hidden');
      loadingOverlay.classList.add('flex');
      const btns = form.querySelectorAll('button, input[type="submit"]');
      btns.forEach(b => b.setAttribute('disabled', 'disabled'));
    });
  }
});
</script>
{% endblock %}