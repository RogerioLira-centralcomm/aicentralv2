{% extends 'base_tailwind.html' %}

{% block title %}Analisador de Audi√™ncia - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-4">
  <!-- Header -->
  <div class="flex items-center justify-between mb-3">
    <div>
      <h1 class="text-lg font-bold text-base-content">Analisador de Audi√™ncia IA</h1>
      <p class="text-xs text-base-content/70">Extra√ß√£o inteligente de dados de imagens</p>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-sm {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% else %}alert-info{% endif %} py-2">
            <span class="text-sm">{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Layout em Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    
    <!-- CARD 1: Upload & Configura√ß√£o -->
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <h2 class="text-sm font-bold flex items-center gap-2 mb-2">
          <i class="fas fa-upload text-primary"></i>Upload da Audi√™ncia
        </h2>
        
        <form id="upAudienciaForm" method="POST" enctype="multipart/form-data">
          
          <!-- Linha 1: Plataforma + Modelo -->
          <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="form-control">
              <label class="label py-0 text-xs font-semibold">Plataforma</label>
              <select id="platform" name="platform" class="select select-bordered h-8 min-h-8 text-xs w-full">
                {% for plat in plataformas %}
                  <option value="{{ plat.nome }}">{{ plat.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-control">
              <label class="label py-0 text-xs font-semibold">Modelo IA</label>
              <select id="model" name="model" class="select select-bordered h-8 min-h-8 text-xs w-full">
                {% set sel_model = selected_model_id or '' %}
                {% for m in models or [] %}
                  <option value="{{ m.id }}" {% if m.id == sel_model %}selected{% endif %}>{{ m.label or m.id }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Linha 2: Categoria + Subcategoria -->
          <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="form-control">
              <label class="label py-0 text-xs font-semibold">Categoria</label>
              <select id="categoria_id" name="categoria_id" class="select select-bordered h-8 min-h-8 text-xs w-full">
                <option value="">Selecione</option>
                {% for cat in categorias or [] %}
                  <option value="{{ cat.id }}">{{ cat.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-control">
              <label class="label py-0 text-xs font-semibold">Subcategoria</label>
              <select id="subcategoria_id" name="subcategoria_id" class="select select-bordered h-8 min-h-8 text-xs w-full" disabled>
                <option value="">Selecione categoria primeiro</option>
              </select>
            </div>
          </div>

          <!-- Drag & Drop Zone - Compacto -->
          <div class="form-control mb-2">
            <label class="label py-0 text-xs font-semibold">Imagem</label>
            <div id="dropZone" class="border-2 border-dashed border-base-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary transition-all">
              <input id="upimagem" type="file" name="upimagem" accept="image/*" class="hidden" required />
              <div id="dropZoneContent">
                <i class="fas fa-cloud-upload-alt text-2xl text-base-content/30 mb-1"></i>
                <p class="text-xs text-base-content/60 mb-1">Arraste ou clique</p>
                <button type="button" id="chooseFileBtn" class="btn btn-xs btn-outline">
                  <i class="fas fa-folder-open mr-1"></i>Escolher
                </button>
              </div>
              <div id="imagePreview" class="hidden">
                <img id="previewImg" src="" alt="Preview" class="max-h-24 mx-auto rounded mb-2" />
                <p id="fileName" class="text-xs mb-1"></p>
                <button type="button" onclick="clearImage()" class="btn btn-xs btn-error btn-outline">
                  <i class="fas fa-times mr-1"></i>Remover
                </button>
              </div>
            </div>
          </div>

          <!-- Prompt (Collapsible) -->
          <details class="collapse collapse-arrow bg-base-200 mb-2">
            <summary class="collapse-title text-xs font-semibold py-2 min-h-0">
              <i class="fas fa-magic mr-1"></i>Prompt (Avan√ßado)
            </summary>
            <div class="collapse-content px-2 pb-2">
              <textarea id="prompt" name="prompt" rows="8" class="textarea textarea-bordered w-full text-xs font-mono" placeholder="Prompt...">Voc√™ √© um assistente especialista em an√°lise de dados de publicidade digital. Sua tarefa √© analisar uma imagem de uma plataforma de an√∫ncios, extrair informa√ß√µes de audi√™ncia e estrutur√°-las em um formato JSON espec√≠fico, seguindo rigorosamente as regras abaixo.

*REGRAS DE EXTRA√á√ÉO E PROCESSAMENTO:*

1. *An√°lise de Segmentos (segments):*
   * source: Extraia o prefixo de texto que identifica a origem do dado (ex: "OAN", "LiveRamp","Navegg","Semasio","TallTarget","Lotame").
   * id: Extraia APENAS a sequ√™ncia num√©rica do identificador do segmento. (verifique 2 vezes esse id, est√° vindo errado, n√£o invente n√∫meros)
   * name_original: Copie a string completa do nome do segmento.
   * name_ptbr_normalized: Crie uma descri√ß√£o clara e acion√°vel em Portugu√™s-Brasil, focando na inten√ß√£o e perfil do p√∫blico, n√£o em uma tradu√ß√£o literal.
   * cpm: Extraia o valor num√©rico do Custo Por Mil. Assuma a moeda como "BRL" se o s√≠mbolo for "R$".
   * categories: Atribua categorias como type, industry, interest, etc., com base na sua interpreta√ß√£o do nome.

2. *An√°lise do Resumo (audienceSummary):*
   * Extraia valores como overallReach, convertendo abrevia√ß√µes como "M" para seu valor num√©rico completo (ex: "26.3M" se torna 26300000).

3. *An√°lise Demogr√°fica (demographics):*
   * Analise os gr√°ficos e estime as porcentagens para gender, age, e devices.

*FORMATO DE SA√çDA OBRIGAT√ìRIO:*

Sua resposta deve ser *APENAS o objeto JSON*, sem nenhum texto ou explica√ß√£o adicional. Preencha todos os campos poss√≠veis e use null para informa√ß√µes n√£o encontradas. A resposta deve ser um JSON v√°lido.
Retorne apenas o JSON limpo e estruturado.</textarea>
            </div>
          </details>

          <!-- Submit Button -->
          <button id="submitBtn" type="submit" class="btn btn-sm w-full text-white" style="background-color: #72cd80;" disabled>
            <i class="fas fa-magic mr-1"></i>Analisar Imagem
          </button>
        </form>
      </div>
    </div>

    <!-- CARD 2: An√°lise & Resultados -->
    <div class="card bg-base-100 shadow-lg">
      <div class="card-body p-4">
        <h2 class="text-sm font-bold flex items-center gap-2 mb-2">
          <i class="fas fa-chart-line text-success"></i>Resultados
        </h2>
        
        {% if result %}
          <!-- Status Success -->
          <div class="alert alert-success py-2 mb-2">
            <i class="fas fa-check-circle"></i>
            <span class="text-sm">An√°lise conclu√≠da!</span>
          </div>

          <!-- Metrics -->
          {% if result.usage or result.cost_usd is not none %}
          <div class="flex gap-2 mb-2">
            <div class="bg-base-200 rounded p-2 flex-1 text-center">
              <p class="text-[10px] text-base-content/60">Tokens</p>
              <p class="text-sm font-bold text-primary">{{ result.usage.total_tokens if result.usage else '‚Äî' }}</p>
            </div>
            <div class="bg-base-200 rounded p-2 flex-1 text-center">
              <p class="text-[10px] text-base-content/60">Custo</p>
              <p class="text-sm font-bold text-success font-mono">{% if result.cost_usd is not none %}${{ '%.3f'|format(result.cost_usd) }}{% else %}‚Äî{% endif %}</p>
            </div>
          </div>
          {% endif %}

          <!-- DEBUG Collapse -->
          <details class="collapse collapse-arrow bg-warning/10 border border-warning/30 mb-2">
            <summary class="collapse-title text-[10px] font-mono py-1 min-h-0">üîç DEBUG</summary>
            <div class="collapse-content text-[10px] font-mono">
              <p><strong>fields.segments:</strong> {{ (result.fields.segments|length) if result.fields.segments else 'None' }}</p>
              <p><strong>raw.segments:</strong> {{ (result.raw.segments|length) if result.raw.segments else 'None' }}</p>
            </div>
          </details>

          <!-- JSON Viewer -->
          <div class="bg-base-200 rounded p-2 mb-2">
            <p class="text-xs font-semibold mb-1">JSON Extra√≠do</p>
            <div class="max-h-40 overflow-y-auto">
              <pre class="text-[10px] font-mono bg-base-100 p-2 rounded">{{ result.json_text | safe }}</pre>
            </div>
          </div>

          <!-- Dados Customizados -->
          <div class="bg-base-200 rounded p-2">
            <p class="text-xs font-semibold mb-1">Dados Customizados</p>
            <textarea id="customData" class="textarea textarea-bordered w-full text-[10px] font-mono h-20" placeholder='{"audienceSummary": {...}}'>{% if result %}{% set custom_obj = {} %}{% if result.fields.audienceSummary %}{% set _ = custom_obj.update({"audienceSummary": result.fields.audienceSummary}) %}{% endif %}{% if result.fields.demographics %}{% set _ = custom_obj.update({"demographics": result.fields.demographics}) %}{% endif %}{% if custom_obj %}{{ custom_obj|tojson(indent=2) }}{% endif %}{% endif %}</textarea>
          </div>

        {% else %}
          <!-- Empty State -->
          <div class="flex flex-col items-center justify-center py-8 text-center">
            <i class="fas fa-robot text-4xl text-base-content/20 mb-2"></i>
            <p class="text-sm text-base-content/70">Aguardando an√°lise...</p>
            <p class="text-xs text-base-content/50">Fa√ßa upload de uma imagem</p>
          </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Tabela de Audi√™ncias (Full Width abaixo do grid) -->
  {% if result %}
    {% set segments = result.fields.segments or result.fields.audienceSegments or result.raw.segments or result.raw.audienceSegments or [] %}
    {% if segments and segments|length > 0 %}
    <div class="card bg-base-100 shadow-lg mt-4">
      <div class="card-body p-3">
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <i class="fas fa-table text-primary text-sm"></i>
            <div>
              <h4 class="text-sm font-semibold">Audi√™ncias Encontradas</h4>
              <p class="text-[10px] text-base-content/60">
                <span class="badge badge-success badge-xs">{{ segments|length }}</span> extra√≠das
              </p>
            </div>
          </div>
        </div>
        
        <!-- Tabela compacta -->
        <div class="overflow-x-auto">
          <table class="table table-xs w-full">
            <thead>
              <tr style="background-color: #72cd80;" class="text-white">
                <th class="text-xs">ID</th>
                <th class="text-xs">Nome</th>
                <th class="text-xs">Parceiro</th>
                <th class="text-xs text-right">CPM</th>
                <th class="text-xs text-center">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for segment in segments %}
              <tr class="hover">
                <td class="font-mono text-[10px]">{{ segment.id or '‚Äî' }}</td>
                <td class="max-w-xs">
                  <p class="text-[10px] truncate" title="{{ segment.name_ptbr_normalized }}">{{ segment.name_ptbr_normalized or '‚Äî' }}</p>
                  {% if segment.name_original %}
                  <p class="text-[9px] text-base-content/50 truncate italic">{{ segment.name_original }}</p>
                  {% endif %}
                </td>
                <td><span class="badge badge-xs badge-outline">{{ segment.source or '‚Äî' }}</span></td>
                <td class="text-right font-mono text-[10px]">
                  {% if segment.cpm is mapping %}{{ '%.2f'|format(segment.cpm.value) if segment.cpm.value is number else (segment.cpm.value or '‚Äî') }}{% elif segment.cpm is number %}{{ '%.2f'|format(segment.cpm) }}{% elif segment.cpm %}{{ segment.cpm }}{% else %}‚Äî{% endif %}
                </td>
                <td class="text-center">
                  <button type="button" class="btn btn-xs btn-primary btn-outline btn-enviar-webhook" data-segment='{{ segment|tojson }}'><i class="fas fa-plus"></i></button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}
</div>

<!-- Loading Overlay -->
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 hidden" id="loadingOverlay">
  <div class="card bg-base-100 shadow-lg p-4 text-center">
    <span class="loading loading-spinner loading-md text-primary"></span>
    <p class="text-sm mt-2">Processando...</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Vari√°vel global para audienceSummary
{% if result %}
  {% set audience_summary = result.fields.audienceSummary or result.fields.audience_summary or result.raw.audienceSummary or result.raw.audience_summary or {} %}
  window.audienceSummary = {{ audience_summary|tojson|safe }};
{% else %}
  window.audienceSummary = null;
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('upimagem');
  const dropZone = document.getElementById('dropZone');
  const dropZoneContent = document.getElementById('dropZoneContent');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const fileName = document.getElementById('fileName');
  const promptEl = document.getElementById('prompt');
  const submitBtn = document.getElementById('submitBtn');
  const chooseFileBtn = document.getElementById('chooseFileBtn');
  const categoriaSelect = document.getElementById('categoria_id');
  const subcategoriaSelect = document.getElementById('subcategoria_id');

  // Popular subcategorias quando categoria for selecionada
  if (categoriaSelect && subcategoriaSelect) {
    categoriaSelect.addEventListener('change', async function() {
      const categoriaId = this.value;
      
      // Limpar subcategorias
      subcategoriaSelect.innerHTML = '<option value="">Carregando...</option>';
      subcategoriaSelect.disabled = true;
      
      if (!categoriaId) {
        subcategoriaSelect.innerHTML = '<option value="">Selecione uma categoria primeiro</option>';
        return;
      }
      
      try {
        // Buscar subcategorias da categoria selecionada
        const response = await fetch(`/api/cadu_subcategorias?categoria_id=${categoriaId}`);
        const data = await response.json();
        
        // Popular dropdown
        subcategoriaSelect.innerHTML = '<option value="">Nenhuma subcategoria</option>';
        
        if (data && data.length > 0) {
          data.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = sub.nome;
            subcategoriaSelect.appendChild(option);
          });
          subcategoriaSelect.disabled = false;
        } else {
          subcategoriaSelect.innerHTML = '<option value="">Nenhuma subcategoria dispon√≠vel</option>';
        }
      } catch (error) {
        console.error('Erro ao carregar subcategorias:', error);
        subcategoriaSelect.innerHTML = '<option value="">Erro ao carregar</option>';
      }
    });
  }

  // Drag & Drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('border-primary', 'bg-primary/10');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('border-primary', 'bg-primary/10');
    }, false);
  });

  dropZone.addEventListener('drop', handleDrop, false);
  
  // Clique no bot√£o abre o seletor de arquivo
  if (chooseFileBtn) {
    chooseFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      input.click();
    });
  }
  
  // Clique na √°rea de drop tamb√©m abre (exceto quando j√° tem preview)
  dropZone.addEventListener('click', (e) => {
    if (!imagePreview.classList.contains('hidden')) {
      return; // N√£o faz nada se j√° tem preview
    }
    if (e.target !== chooseFileBtn && !chooseFileBtn.contains(e.target)) {
      input.click();
    }
  });

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) {
      input.files = files;
      handleFiles(files);
    }
  }

  input.addEventListener('change', function() {
    if (this.files.length) {
      handleFiles(this.files);
    }
  });

  function handleFiles(files) {
    const file = files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        fileName.textContent = file.name;
        dropZoneContent.classList.add('hidden');
        imagePreview.classList.remove('hidden');
        updateSubmitState();
      };
      reader.readAsDataURL(file);
    }
  }

  window.clearImage = function() {
    input.value = '';
    previewImg.src = '';
    fileName.textContent = '';
    dropZoneContent.classList.remove('hidden');
    imagePreview.classList.add('hidden');
    updateSubmitState();
  };

  // Update Submit State
  function updateSubmitState() {
    const okPrompt = !!(promptEl && promptEl.value && promptEl.value.trim().length > 0);
    const okFile = !!(input && input.files && input.files.length > 0);
    const can = okPrompt && okFile;
    if (submitBtn) {
      submitBtn.disabled = !can;
    }
  }

  if (promptEl) {
    ['input','change','keyup','paste'].forEach(ev => promptEl.addEventListener(ev, updateSubmitState));
  }
  updateSubmitState();

  // Event delegation para bot√µes de webhook (enviar e reenviar)
  document.addEventListener('click', async function(e) {
    const button = e.target.closest('.btn-enviar-webhook, .btn-reenviar-webhook');
    if (!button) return;
    
    e.preventDefault();
    
    const isResend = button.classList.contains('btn-reenviar-webhook');
    
    // Usar proxy local para contornar CORS
    const webhookUrl = '{{ url_for("webhook_proxy") }}';
    
    // Obter dados completos da lista
    let segmentData;
    try {
      segmentData = JSON.parse(button.getAttribute('data-segment'));
    } catch (error) {
      console.error('Erro ao parsear dados do segment:', error);
      showToast('Erro ao processar dados da audi√™ncia', 'error');
      return;
    }
    
    // Obter categoria selecionada
    const categoriaSelect = document.getElementById('categoria_id');
    const categoriaId = categoriaSelect ? categoriaSelect.value : null;
    const categoriaNome = categoriaSelect ? categoriaSelect.options[categoriaSelect.selectedIndex]?.text : null;
    
    // Obter subcategoria selecionada
    const subcategoriaSelect = document.getElementById('subcategoria_id');
    const subcategoriaId = subcategoriaSelect ? subcategoriaSelect.value : null;
    const subcategoriaNome = subcategoriaSelect && subcategoriaId ? subcategoriaSelect.options[subcategoriaSelect.selectedIndex]?.text : null;
    
    // Obter dados customizados do textarea
    let customData = {};
    const customDataTextarea = document.getElementById('customData');
    if (customDataTextarea && customDataTextarea.value.trim()) {
      try {
        const jsonText = customDataTextarea.value.trim();
        customData = JSON.parse(jsonText);
        console.log('Dados customizados parseados:', customData);
      } catch (error) {
        console.error('Erro ao parsear dados customizados:', error);
        console.error('Texto que causou erro:', customDataTextarea.value);
        
        // Tentar identificar a posi√ß√£o do erro
        let errorMsg = 'Erro: O JSON dos dados customizados √© inv√°lido.';
        if (error.message.includes('position')) {
          const match = error.message.match(/position (\d+)/);
          if (match) {
            const pos = parseInt(match[1]);
            errorMsg += ` Erro na posi√ß√£o ${pos}.`;
          }
        }
        
        showToast(errorMsg, 'error');
        return;
      }
    }
    
    // Preparar payload - dados do segment + dados estruturados do textarea
    const payload = {
      id: segmentData.id,
      name_original: segmentData.name_original,
      name_ptbr_normalized: segmentData.name_ptbr_normalized,
      source: segmentData.source,
      cpm: segmentData.cpm,
      categoria_id: categoriaId,
      categoria_nome: categoriaNome,
      subcategoria_id: subcategoriaId,
      subcategoria_nome: subcategoriaNome,
      audienceSummary: customData.audienceSummary || null,
      demographics: customData.demographics || null,
      timestamp: new Date().toISOString(),
      source_page: 'up_audiencia'
    };
    
    console.log('Enviando payload:', payload);
    
    // Salvar estado original do bot√£o
    const originalHTML = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });
      
      if (response.ok) {
        // Sucesso
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline');
        button.classList.add('btn-success');
        
        // Se foi envio inicial, mostrar bot√£o de reenvio
        if (!isResend) {
          // Encontrar o bot√£o de reenvio correspondente (mesmo card/row)
          const container = button.closest('td, .card-body');
          const resendBtn = container?.querySelector('.btn-reenviar-webhook');
          if (resendBtn) {
            resendBtn.classList.remove('hidden');
          }
        }
        
        // Mostrar toast de sucesso
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        toast.innerHTML = `
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span>${isResend ? 'Reenviado' : 'Enviado'} com sucesso!</span>
          </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
        
      } else {
        const errorText = await response.text();
        console.error('Resposta do webhook:', response.status, errorText);
        throw new Error(`Webhook retornou status ${response.status}`);
      }
    } catch (error) {
      console.error('Erro ao enviar webhook:', error);
      console.error('Detalhes:', error.message);
      
      // Erro
      button.innerHTML = '<i class="fas fa-times"></i>';
      button.classList.add('btn-error');
      
      // Mostrar toast de erro
      const toast = document.createElement('div');
      toast.className = 'toast toast-top toast-end';
      toast.innerHTML = `
        <div class="alert alert-error">
          <i class="fas fa-exclamation-circle"></i>
          <span>Erro ao enviar: ${error.message}</span>
        </div>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      
      // Restaurar bot√£o ap√≥s 2 segundos (apenas se foi erro)
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        button.classList.remove('btn-error');
        if (!isResend) {
          button.classList.add('btn-outline');
        }
      }, 2000);
    }
  });

  // Loading Overlay on Submit
  const form = document.getElementById('upAudienciaForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (form && loadingOverlay) {
    form.addEventListener('submit', function(e) {
      if (!submitBtn || submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      loadingOverlay.classList.remove('hidden');
      loadingOverlay.classList.add('flex');
      const btns = form.querySelectorAll('button, input[type="submit"]');
      btns.forEach(b => b.setAttribute('disabled', 'disabled'));
    });
  }
});
</script>
{% endblock %}