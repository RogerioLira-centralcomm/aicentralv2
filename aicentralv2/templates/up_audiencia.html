{% extends 'base_tailwind.html' %}

{% block title %}Analisador de Audiência de Imagem{% endblock %}

{% block content %}
<div class="p-6">
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-text-primary flex items-center">
      <i class="fas fa-upload text-primary mr-3"></i>
      Analisador de Audiência de Imagem
    </h1>
  <p class="text-sm text-gray-600">Envie um arquivo de imagem para extrair automaticamente os campos: cliente, pedido, data e valor total.</p>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-6 space-y-2">
        {% for category, message in messages %}
          <div class="flex items-center p-3 rounded-lg shadow-sm {% if category == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif category == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %} mr-3"></i>
            <span class="flex-1">{{ message }}</span>
            <button onclick="closeFlashMessage(this)" class="ml-4 text-gray-500 hover:text-gray-700">
              <i class="fas fa-times"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="bg-white rounded-lg shadow p-6">
    <form id="upAudienciaForm" method="POST" enctype="multipart/form-data" class="space-y-4">
      <!-- Prompt -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="prompt">Prompt</label>
  <textarea id="prompt" name="prompt" rows="12" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring focus:ring-primary focus:ring-opacity-50 min-h-[220px] md:min-h-[280px]" placeholder="Descreva aqui o que deseja extrair da imagem, instruções ou contexto adicional...">{{ prompt or '' }}</textarea>
        <p class="text-xs text-gray-500 mt-1">Obrigatório: escreva as instruções para a extração.</p>
        <p class="text-xs text-gray-500 mt-1">Opcional: escreva instruções para orientar a extração.</p>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="upimagem">Arquivo de imagem</label>
        <div class="flex items-center">
          <input id="upimagem" type="file" name="upimagem" accept="image/*" class="sr-only" required />
          <label for="upimagem" class="inline-flex items-center px-3 py-2 bg-primary text-white rounded hover:bg-primary-dark cursor-pointer">
            <i class="fas fa-file-upload mr-2"></i>
            Escolher arquivo
          </label>
          <span id="upimagemFilename" class="ml-3 text-sm text-gray-600" aria-live="polite">Nenhum arquivo selecionado</span>
        </div>
        <p class="text-xs text-gray-500 mt-1">Formatos aceitos: PNG, JPG, JPEG, etc.</p>
      </div>
      <div class="flex justify-end">
        <button id="submitBtn" type="submit" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary-dark transition opacity-50 cursor-not-allowed" disabled>Enviar</button>
      </div>
    </form>
  </div>

  {% if result %}
    {% if result.usage or result.cost_usd is not none %}
    <div class="mt-6 bg-white rounded-lg shadow p-4 flex flex-wrap items-center gap-4">
      <div class="text-sm text-gray-700"><span class="font-medium">Modelo:</span> {{ result.model_used or '—' }}</div>
      <div class="text-sm text-gray-700"><span class="font-medium">Prompt tokens:</span> {{ result.usage.prompt_tokens if result.usage else '—' }}</div>
      <div class="text-sm text-gray-700"><span class="font-medium">Completion tokens:</span> {{ result.usage.completion_tokens if result.usage else '—' }}</div>
      <div class="text-sm text-gray-700"><span class="font-medium">Total tokens:</span> {{ result.usage.total_tokens if result.usage else '—' }}</div>
      <div class="text-sm text-gray-700"><span class="font-medium">Custo (USD):</span> {% if result.cost_usd is not none %}${{ '%.6f'|format(result.cost_usd) }}{% else %}—{% endif %}
        {% if result.usage_estimated %}<span class="ml-2 text-xs text-yellow-700 bg-yellow-100 border border-yellow-200 px-2 py-0.5 rounded">estimado</span>{% endif %}
      </div>
      <div class="text-sm text-gray-700"><span class="font-medium">Custo (BRL):</span> {% if result.cost_brl is not none %}R${{ '%.2f'|format(result.cost_brl) }}{% else %}—{% endif %}
        {% if result.usd_brl_rate %}<span class="ml-2 text-xs text-gray-600">(USD/BRL {{ '%.4f'|format(result.usd_brl_rate) }}, fonte: {{ result.usd_brl_source or '—' }})</span>{% endif %}
      </div>
      <div class="text-xs text-gray-500">Obs.: usamos o custo da OpenRouter quando disponível (headers/usage); caso contrário, exibimos uma estimativa.</div>
    </div>
    {% endif %}
    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Campos extraídos</h2>
          <button type="button" id="copyKvBtn" class="text-sm px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-300">
            <i class="fas fa-copy mr-1"></i>Copiar
          </button>
        </div>
  <textarea id="kv_output" rows="18" readonly class="w-full font-mono text-sm bg-gray-50 rounded p-3 border border-gray-200 focus:outline-none min-h-[260px] md:min-h-[320px]">{{ result.kv_text }}</textarea>
      </div>
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Saída (JSON)</h2>
          <button type="button" id="copyJsonBtn" class="text-sm px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded border border-gray-300">
            <i class="fas fa-copy mr-1"></i>Copiar
          </button>
        </div>
        <textarea id="json_output" rows="18" readonly class="w-full font-mono text-xs bg-gray-50 rounded p-3 border border-gray-200 focus:outline-none min-h-[260px] md:min-h-[320px]">{{ result.raw | tojson(indent=2) }}</textarea>
      </div>
    </div>
  {% endif %}
</div>
<!-- Overlay de Carregamento -->
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 hidden" id="loadingOverlay">
  <div class="bg-white/90 backdrop-blur rounded-xl p-6 max-w-[220px] w-full text-center shadow-xl">
    <div class="w-10 h-10 border-3 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
    <p class="text-gray-600 text-sm font-medium">Processando...</p>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('upimagem');
    const out = document.getElementById('upimagemFilename');
    const promptEl = document.getElementById('prompt');
    const submitBtn = document.getElementById('submitBtn');
    function updateSubmitState() {
      const okPrompt = !!(promptEl && promptEl.value && promptEl.value.trim().length > 0);
      const okFile = !!(input && input.files && input.files.length > 0);
      const can = okPrompt && okFile;
      if (submitBtn) {
        submitBtn.disabled = !can;
        submitBtn.classList.toggle('opacity-50', !can);
        submitBtn.classList.toggle('cursor-not-allowed', !can);
      }
    }

    if (input && out) {
      input.addEventListener('change', function() {
        const name = this.files && this.files.length ? this.files[0].name : 'Nenhum arquivo selecionado';
        out.textContent = name;
        updateSubmitState();
      });
    }
    if (promptEl) {
      ['input','change','keyup','paste'].forEach(ev => promptEl.addEventListener(ev, updateSubmitState));
    }
    // Estado inicial do botão
    updateSubmitState();

    // Copiar JSON de saída para a área de transferência
    const copyBtn = document.getElementById('copyJsonBtn');
    const jsonTa = document.getElementById('json_output');
    if (copyBtn && jsonTa) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(jsonTa.value);
          copyBtn.textContent = 'Copiado!';
          setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copiar'; }, 1200);
        } catch (e) {
          // Fallback
          jsonTa.select();
          document.execCommand('copy');
          copyBtn.textContent = 'Copiado!';
          setTimeout(() => { copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copiar'; }, 1200);
        }
      });
    }

    // Copiar chave:valor (esquerda)
    const copyKvBtn = document.getElementById('copyKvBtn');
    const kvTa = document.getElementById('kv_output');
    if (copyKvBtn && kvTa) {
      copyKvBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(kvTa.value);
          copyKvBtn.textContent = 'Copiado!';
          setTimeout(() => { copyKvBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copiar'; }, 1200);
        } catch (e) {
          kvTa.select();
          document.execCommand('copy');
          copyKvBtn.textContent = 'Copiado!';
          setTimeout(() => { copyKvBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copiar'; }, 1200);
        }
      });
    }

    // Overlay de aguarde no submit (como no login)
    const form = document.getElementById('upAudienciaForm');
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (form && loadingOverlay) {
      form.addEventListener('submit', function(e) {
        // Proteção extra caso algum atributo required seja removido no futuro
        if (!submitBtn || submitBtn.disabled) {
          e.preventDefault();
          return;
        }
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
        // Desabilita botões para evitar múltiplos envios
        const btns = form.querySelectorAll('button, input[type="submit"]');
        btns.forEach(b => b.setAttribute('disabled', 'disabled'));
      });
    }
  });
  // Observação: o texto nativo "Escolher ficheiro" é do sistema/idioma do navegador.
  // Aqui usamos um botão customizado com "Escolher arquivo" e exibimos o nome manualmente.
  // Assim garantimos a palavra "arquivo" independentemente da localidade do navegador.
</script>
{% endblock %}
