{% extends 'base_tailwind.html' %}

{% block title %}Analisador de Audi√™ncia - CentralComm AI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-base-content">Analisador de Audi√™ncia IA</h1>
      <p class="text-sm text-base-content/70 mt-1">Extra√ß√£o inteligente de dados de imagens de audi√™ncias</p>
    </div>
    
    <!-- Steps -->
    <div class="hidden lg:flex items-center gap-2">
      <div class="flex items-center gap-2">
        <div class="badge badge-primary badge-lg">1</div>
        <span class="text-sm font-medium">Upload</span>
      </div>
      <i class="fas fa-chevron-right text-xs text-base-content/30"></i>
      <div class="flex items-center gap-2">
        <div class="badge badge-ghost badge-lg">2</div>
        <span class="text-sm text-base-content/70">An√°lise</span>
      </div>
    </div>
  </div>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="space-y-2">
        {% for category, message in messages %}
          <div class="alert {% if category == 'error' %}alert-error{% elif category == 'success' %}alert-success{% elif category == 'warning' %}alert-warning{% else %}alert-info{% endif %}">
            <i class="fas fa-{% if category == 'error' %}exclamation-circle{% elif category == 'success' %}check-circle{% elif category == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}"></i>
            <span>{{ message }}</span>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Layout em Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    
    <!-- CARD 1: Upload & Configura√ß√£o -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">
          <i class="fas fa-upload text-primary"></i>
          Upload da Audi√™ncia
        </h2>
        <div class="divider my-1"></div>
        
        <form id="upAudienciaForm" method="POST" enctype="multipart/form-data" class="space-y-4">
          
          <!-- Plataforma -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Plataforma</span>
            </label>
            <select id="platform" name="platform" class="select select-bordered w-full">
              <option value="google-dv360">Google DV360</option>
              <option value="meta-ads">Meta Ads Manager</option>
              <option value="google-ads">Google Ads</option>
              <option value="linkedin-ads">LinkedIn Ads</option>
              <option value="tiktok-ads">TikTok Ads</option>
            </select>
          </div>

          <!-- Drag & Drop Zone -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Imagem da Audi√™ncia</span>
            </label>
            <div id="dropZone" class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary hover:bg-base-200/50 transition-all">
              <input id="upimagem" type="file" name="upimagem" accept="image/*" class="hidden" required />
              <div id="dropZoneContent">
                <i class="fas fa-cloud-upload-alt text-5xl text-base-content/30 mb-3"></i>
                <p class="font-medium text-base-content mb-1">Arraste a imagem aqui</p>
                <p class="text-sm text-base-content/60 mb-3">ou clique para selecionar</p>
                <button type="button" id="chooseFileBtn" class="btn btn-sm btn-outline">
                  <i class="fas fa-folder-open mr-2"></i>
                  Escolher Arquivo
                </button>
              </div>
              <div id="imagePreview" class="hidden">
                <img id="previewImg" src="" alt="Preview" class="max-h-48 mx-auto rounded-lg shadow-md mb-3" />
                <p id="fileName" class="font-medium text-base-content mb-2"></p>
                <button type="button" onclick="clearImage()" class="btn btn-sm btn-error btn-outline">
                  <i class="fas fa-times mr-2"></i>Remover
                </button>
              </div>
            </div>
          </div>

          <!-- Prompt (Collapsible) -->
          <div class="form-control">
            <details class="collapse collapse-arrow bg-base-200">
              <summary class="collapse-title text-sm font-semibold cursor-pointer">
                <i class="fas fa-magic mr-2"></i>Prompt de Extra√ß√£o (Avan√ßado)
              </summary>
              <div class="collapse-content">
                <textarea id="prompt" name="prompt" rows="12" class="textarea textarea-bordered w-full text-sm font-mono" placeholder="Digite seu prompt personalizado...">Voc√™ √© um assistente especialista em an√°lise de dados de publicidade digital. Sua tarefa √© analisar uma imagem de uma plataforma de an√∫ncios, extrair informa√ß√µes de audi√™ncia e estrutur√°-las em um formato JSON espec√≠fico, seguindo rigorosamente as regras abaixo.

*REGRAS DE EXTRA√á√ÉO E PROCESSAMENTO:*

1. *An√°lise de Segmentos (segments):*
   * source: Extraia o prefixo de texto que identifica a origem do dado (ex: "OAN", "LiveRamp","Navegg","Semasio","TallTarget","Lotame").
   * id: Extraia APENAS a sequ√™ncia num√©rica do identificador do segmento. (verifique 2 vezes esse id, est√° vindo errado, n√£o invente n√∫meros)
   * name_original: Copie a string completa do nome do segmento.
   * name_ptbr_normalized: Crie uma descri√ß√£o clara e acion√°vel em Portugu√™s-Brasil, focando na inten√ß√£o e perfil do p√∫blico, n√£o em uma tradu√ß√£o literal.
   * cpm: Extraia o valor num√©rico do Custo Por Mil. Assuma a moeda como "BRL" se o s√≠mbolo for "R$".
   * categories: Atribua categorias como type, industry, interest, etc., com base na sua interpreta√ß√£o do nome.

2. *An√°lise do Resumo (audienceSummary):*
   * Extraia valores como overallReach, convertendo abrevia√ß√µes como "M" para seu valor num√©rico completo (ex: "26.3M" se torna 26300000).

3. *An√°lise Demogr√°fica (demographics):*
   * Analise os gr√°ficos e estime as porcentagens para gender, age, e devices.

*FORMATO DE SA√çDA OBRIGAT√ìRIO:*

Sua resposta deve ser *APENAS o objeto JSON*, sem nenhum texto ou explica√ß√£o adicional. Preencha todos os campos poss√≠veis e use null para informa√ß√µes n√£o encontradas. A resposta deve ser um JSON v√°lido.
Retorne apenas o JSON limpo e estruturado.</textarea>
                <p class="label-text-alt mt-2 text-base-content/60">Personalize o prompt para extra√ß√µes espec√≠ficas</p>
              </div>
            </details>
          </div>

          <!-- Modelo LLM -->
          <div class="form-control">
            <label class="label">
              <span class="label-text font-semibold">Modelo IA</span>
            </label>
            <select id="model" name="model" class="select select-bordered w-full">
              {% set sel_model = selected_model_id or '' %}
              {% for m in models or [] %}
                <option value="{{ m.id }}" {% if m.id == sel_model %}selected{% endif %}>{{ m.label or m.id }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Submit Button -->
          <div class="card-actions justify-end pt-4">
            <button id="submitBtn" type="submit" class="btn btn-primary w-full" disabled>
              <i class="fas fa-magic mr-2"></i>
              Analisar Imagem
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- CARD 2: An√°lise & Resultados -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">
          <i class="fas fa-chart-line text-success"></i>
          An√°lise & Resultados
        </h2>
        <div class="divider my-1"></div>
        
        {% if result %}
          <!-- Status Success -->
          <div class="alert alert-success">
            <i class="fas fa-check-circle text-xl"></i>
            <div>
              <h3 class="font-semibold">An√°lise Conclu√≠da!</h3>
              <p class="text-sm">Dados extra√≠dos com sucesso</p>
            </div>
          </div>

          <!-- Metrics -->
          {% if result.usage or result.cost_usd is not none %}
          <div class="stats shadow w-full">
            <div class="stat">
              <div class="stat-title">Tokens</div>
              <div class="stat-value text-2xl">{{ result.usage.total_tokens if result.usage else '‚Äî' }}</div>
            </div>
            <div class="stat">
              <div class="stat-title">Custo (USD)</div>
              <div class="stat-value text-2xl">{% if result.cost_usd is not none %}${{ '%.3f'|format(result.cost_usd) }}{% else %}‚Äî{% endif %}</div>
            </div>
          </div>
          {% endif %}

          <!-- DEBUG: Mostrar estrutura do result -->
          <details class="collapse collapse-arrow bg-warning/10 border border-warning/30" open>
            <summary class="collapse-title text-xs font-mono cursor-pointer">
              üîç DEBUG: Estrutura de dados (clique para expandir)
            </summary>
            <div class="collapse-content">
              <div class="text-xs font-mono bg-base-100 p-3 rounded space-y-2">
                <p><strong>result.raw type:</strong> {{ result.raw.__class__.__name__ if result.raw else 'None' }}</p>
                <p><strong>result.raw keys:</strong> {{ result.raw.keys()|list if result.raw is mapping else 'N/A' }}</p>
                <p><strong>result.fields type:</strong> {{ result.fields.__class__.__name__ if result.fields else 'None' }}</p>
                <p><strong>result.fields keys:</strong> {{ result.fields.keys()|list if result.fields is mapping else 'N/A' }}</p>
                <p><strong>Has segments in raw?</strong> {{ 'segments' in result.raw if result.raw is mapping else 'N/A' }}</p>
                <p><strong>Has segments in fields?</strong> {{ 'segments' in result.fields if result.fields is mapping else 'N/A' }}</p>
                {% if result.raw is mapping and 'content' in result.raw %}
                <p><strong>result.raw.content type:</strong> {{ result.raw.content.__class__.__name__ }}</p>
                {% endif %}
                {% if result.raw is mapping and '_parse_error' in result.raw %}
                <p class="text-error"><strong>‚ö†Ô∏è Parse Error:</strong> {{ result.raw._parse_error }}</p>
                {% endif %}
                {% if result.raw is mapping and '_content_parse_attempt_error' in result.raw %}
                <p class="text-warning"><strong>‚ö†Ô∏è Content Parse Attempt Error:</strong> {{ result.raw._content_parse_attempt_error }}</p>
                {% endif %}
                
                {# Check if response was truncated #}
                {% set raw_response = result.raw._raw if result.raw is mapping and '_raw' in result.raw else {} %}
                {% set choices = raw_response.choices if raw_response and 'choices' in raw_response else [] %}
                {% set finish_reason = choices[0].finish_reason if choices and choices|length > 0 else none %}
                {% if finish_reason == 'length' %}
                <div class="alert alert-error mt-2">
                  <i class="fas fa-exclamation-triangle"></i>
                  <div>
                    <strong>‚ö†Ô∏è RESPOSTA TRUNCADA!</strong>
                    <p class="text-xs">O modelo atingiu o limite de tokens (max_tokens) antes de completar o JSON. A resposta foi cortada e est√° incompleta. Tente novamente - o c√≥digo j√° foi corrigido para permitir respostas maiores.</p>
                  </div>
                </div>
                {% endif %}
                
                <div class="divider my-2"></div>
                <p class="font-bold text-warning">üîç VERIFICANDO LOCALIZA√á√ïES DE SEGMENTS:</p>
                
                {% set test_segments_1 = result.fields.segments if result.fields is mapping else none %}
                <p><strong>result.fields.segments:</strong> {{ test_segments_1|length if test_segments_1 else 'None/Empty' }} - Type: {{ test_segments_1.__class__.__name__ if test_segments_1 else 'N/A' }}</p>
                
                {% set test_segments_2 = result.fields.audienceSegments if result.fields is mapping else none %}
                <p><strong>result.fields.audienceSegments:</strong> {{ test_segments_2|length if test_segments_2 else 'None/Empty' }} - Type: {{ test_segments_2.__class__.__name__ if test_segments_2 else 'N/A' }}</p>
                
                {% set test_segments_3 = result.raw.segments if result.raw is mapping else none %}
                <p><strong>result.raw.segments:</strong> {{ test_segments_3|length if test_segments_3 else 'None/Empty' }} - Type: {{ test_segments_3.__class__.__name__ if test_segments_3 else 'N/A' }}</p>
                
                {% set test_segments_4 = result.raw.audienceSegments if result.raw is mapping else none %}
                <p><strong>result.raw.audienceSegments:</strong> {{ test_segments_4|length if test_segments_4 else 'None/Empty' }} - Type: {{ test_segments_4.__class__.__name__ if test_segments_4 else 'N/A' }}</p>
                
                <div class="divider my-2"></div>
                <p class="font-bold text-info">üìÑ AMOSTRA DE result.fields (primeiras 500 chars):</p>
                <pre class="bg-base-200 p-2 rounded overflow-x-auto text-[10px]">{{ result.fields|string|truncate(500) }}</pre>
                
                <div class="divider my-2"></div>
                <p class="font-bold text-info">üìÑ AMOSTRA DE result.raw (primeiras 500 chars):</p>
                <pre class="bg-base-200 p-2 rounded overflow-x-auto text-[10px]">{{ result.raw|string|truncate(500) }}</pre>
                
                {% if result.raw is mapping and 'content' in result.raw %}
                <div class="divider my-2"></div>
                <p class="font-bold text-error">üìù CONTE√öDO COMPLETO DE result.raw.content:</p>
                <pre class="bg-base-200 p-2 rounded overflow-x-auto text-[10px] max-h-96">{{ result.raw.content }}</pre>
                {% endif %}
              </div>
            </div>
          </details>

          <!-- JSON Viewer -->
          <div class="card bg-base-200 shadow-sm">
            <div class="card-body p-4">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-sm">Dados Extra√≠dos (JSON)</h4>
                <button type="button" id="copyJsonBtn" class="btn btn-xs btn-ghost">
                  <i class="fas fa-copy mr-1"></i>Copiar
                </button>
              </div>
              <div class="max-h-96 overflow-y-auto">
                <pre id="json_output" class="text-xs font-mono bg-base-100 p-3 rounded">{{ result.json_text | safe }}</pre>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions justify-end gap-2">
            <button type="button" onclick="retryAnalysis()" class="btn btn-ghost btn-sm">
              <i class="fas fa-redo mr-2"></i>Nova An√°lise
            </button>
          </div>

        {% else %}
          <!-- Empty State -->
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <i class="fas fa-robot text-6xl text-base-content/20 mb-4"></i>
            <p class="font-medium text-base-content/70">Aguardando an√°lise...</p>
            <p class="text-sm text-base-content/50 mt-1">Fa√ßa upload de uma imagem para come√ßar</p>
          </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Tabela de Audi√™ncias (Full Width abaixo do grid) -->
  {% if result %}
    {% set segments = result.fields.segments or result.fields.audienceSegments or result.raw.segments or result.raw.audienceSegments or [] %}
    {% if segments and segments|length > 0 %}
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body p-4">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2">
            <i class="fas fa-table text-primary"></i>
            <div>
              <h4 class="font-semibold">Audi√™ncias Encontradas</h4>
              <p class="text-xs text-base-content/60">
                <span class="badge badge-success badge-sm">{{ segments|length }}</span> 
                audi√™ncias extra√≠das com sucesso
              </p>
            </div>
          </div>
        </div>
        <div>
          <table class="table table-xs">
            <thead>
              <tr class="bg-gradient-to-r from-primary to-accent text-primary-content">
                <th class="w-16">ID</th>
                <th>Nome</th>
                <th>Parceiro</th>
                <th class="text-right">CPM</th>
                <th>Gender</th>
                <th>Age</th>
                <th>Parental</th>
                <th>Dispositivo</th>
                <th class="text-center w-24">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% for segment in segments %}
              <tr class="hover">
                <td class="font-mono text-xs">{{ segment.id or '‚Äî' }}</td>
                <td class="max-w-xs truncate" title="{{ segment.name_ptbr_normalized or segment.name_original }}">
                  {{ segment.name_ptbr_normalized or segment.name_original or '‚Äî' }}
                </td>
                <td>
                  <span class="badge badge-sm badge-outline text-xs">{{ segment.source or '‚Äî' }}</span>
                </td>
                <td class="text-right font-mono text-xs">
                  {% if segment.cpm is mapping %}
                    {% if segment.cpm.value is number %}
                      {{ '%.2f'|format(segment.cpm.value) }}
                    {% else %}
                      {{ segment.cpm.value or '‚Äî' }}
                    {% endif %}
                  {% elif segment.cpm is number %}
                    {{ '%.2f'|format(segment.cpm) }}
                  {% elif segment.cpm %}
                    {{ segment.cpm }}
                  {% else %}
                    ‚Äî
                  {% endif %}
                </td>
                <td class="text-xs text-base-content/70">‚Äî</td>
                <td class="text-xs text-base-content/70">‚Äî</td>
                <td class="text-xs text-base-content/70">‚Äî</td>
                <td class="text-xs text-base-content/70">‚Äî</td>
                <td class="text-center">
                  <button type="button" class="btn btn-xs btn-primary btn-outline" title="Enriquecer audi√™ncia">
                    <i class="fas fa-plus"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}
</div>

<!-- Loading Overlay -->
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm items-center justify-center z-50 hidden" id="loadingOverlay">
  <div class="card bg-base-100 shadow-xl max-w-xs">
    <div class="card-body items-center text-center">
      <span class="loading loading-spinner loading-lg text-primary"></span>
      <p class="font-medium mt-4">Processando imagem...</p>
      <p class="text-sm text-base-content/60">Aguarde enquanto a IA analisa</p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('upimagem');
  const dropZone = document.getElementById('dropZone');
  const dropZoneContent = document.getElementById('dropZoneContent');
  const imagePreview = document.getElementById('imagePreview');
  const previewImg = document.getElementById('previewImg');
  const fileName = document.getElementById('fileName');
  const promptEl = document.getElementById('prompt');
  const submitBtn = document.getElementById('submitBtn');
  const chooseFileBtn = document.getElementById('chooseFileBtn');

  // Drag & Drop
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.add('border-primary', 'bg-primary/10');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, () => {
      dropZone.classList.remove('border-primary', 'bg-primary/10');
    }, false);
  });

  dropZone.addEventListener('drop', handleDrop, false);
  
  // Clique no bot√£o abre o seletor de arquivo
  if (chooseFileBtn) {
    chooseFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      input.click();
    });
  }
  
  // Clique na √°rea de drop tamb√©m abre (exceto quando j√° tem preview)
  dropZone.addEventListener('click', (e) => {
    if (!imagePreview.classList.contains('hidden')) {
      return; // N√£o faz nada se j√° tem preview
    }
    if (e.target !== chooseFileBtn && !chooseFileBtn.contains(e.target)) {
      input.click();
    }
  });

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length) {
      input.files = files;
      handleFiles(files);
    }
  }

  input.addEventListener('change', function() {
    if (this.files.length) {
      handleFiles(this.files);
    }
  });

  function handleFiles(files) {
    const file = files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImg.src = e.target.result;
        fileName.textContent = file.name;
        dropZoneContent.classList.add('hidden');
        imagePreview.classList.remove('hidden');
        updateSubmitState();
      };
      reader.readAsDataURL(file);
    }
  }

  window.clearImage = function() {
    input.value = '';
    previewImg.src = '';
    fileName.textContent = '';
    dropZoneContent.classList.remove('hidden');
    imagePreview.classList.add('hidden');
    updateSubmitState();
  };

  // Update Submit State
  function updateSubmitState() {
    const okPrompt = !!(promptEl && promptEl.value && promptEl.value.trim().length > 0);
    const okFile = !!(input && input.files && input.files.length > 0);
    const can = okPrompt && okFile;
    if (submitBtn) {
      submitBtn.disabled = !can;
    }
  }

  if (promptEl) {
    ['input','change','keyup','paste'].forEach(ev => promptEl.addEventListener(ev, updateSubmitState));
  }
  updateSubmitState();

  // Copiar JSON
  const copyBtn = document.getElementById('copyJsonBtn');
  const jsonOutput = document.getElementById('json_output');
  if (copyBtn && jsonOutput) {
    copyBtn.addEventListener('click', async () => {
      try {
        const text = jsonOutput.textContent || jsonOutput.innerText;
        await navigator.clipboard.writeText(text);
        const originalHTML = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Copiado!';
        copyBtn.classList.add('btn-success');
        setTimeout(() => {
          copyBtn.innerHTML = originalHTML;
          copyBtn.classList.remove('btn-success');
        }, 2000);
      } catch (e) {
        console.error('Erro ao copiar:', e);
      }
    });
  }

  // Retry Analysis
  window.retryAnalysis = function() {
    window.location.reload();
  };

  // Loading Overlay on Submit
  const form = document.getElementById('upAudienciaForm');
  const loadingOverlay = document.getElementById('loadingOverlay');
  if (form && loadingOverlay) {
    form.addEventListener('submit', function(e) {
      if (!submitBtn || submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      loadingOverlay.classList.remove('hidden');
      loadingOverlay.classList.add('flex');
      const btns = form.querySelectorAll('button, input[type="submit"]');
      btns.forEach(b => b.setAttribute('disabled', 'disabled'));
    });
  }
});
</script>
{% endblock %}